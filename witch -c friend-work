[1mdiff --git a/app/Console/Commands/GenerateMonthlyBills.php b/app/Console/Commands/GenerateMonthlyBills.php[m
[1mindex af60772..7cfd8d3 100644[m
[1m--- a/app/Console/Commands/GenerateMonthlyBills.php[m
[1m+++ b/app/Console/Commands/GenerateMonthlyBills.php[m
[36m@@ -91,6 +91,7 @@[m [mpublic function handle()[m
                     ->first();[m
 [m
                 if ($latestReading) {[m
[32m+[m[32m                    // Bill with actual consumption[m
                     $consumption = $latestReading->current_reading - $latestReading->previous_reading;[m
                     Billing::updateOrCreate([m
                         [[m
[36m@@ -110,6 +111,29 @@[m [mpublic function handle()[m
                             'status' => 'unpaid'[m
                         ][m
                     );[m
[32m+[m[32m                    $this->info("  Electricity bill: {$consumption} kWh Ã— â‚±{$electricityRate} = â‚±" . ($consumption * $electricityRate));[m
[32m+[m[32m                } else {[m
[32m+[m[32m                    // Create placeholder bill even if no reading exists (amount = 0)[m
[32m+[m[32m                    // This ensures electricity bills always appear in outstanding balance[m
[32m+[m[32m                    Billing::updateOrCreate([m
[32m+[m[32m                        [[m
[32m+[m[32m                            'stall_id' => $stall->id,[m
[32m+[m[32m                            'utility_type' => 'Electricity',[m
[32m+[m[32m                            'period_start' => $utilityPeriodStart->toDateString(),[m
[32m+[m[32m                        ],[m
[32m+[m[32m                        [[m
[32m+[m[32m                            'period_end' => $utilityPeriodEnd->toDateString(),[m
[32m+[m[32m                            'amount' => 0,[m
[32m+[m[32m                            'previous_reading' => 0,[m
[32m+[m[32m                            'current_reading' => 0,[m
[32m+[m[32m                            'consumption' => 0,[m[41m [m
[32m+[m[32m                            'rate' => $electricityRate,[m
[32m+[m[32m                            'due_date' => $this->getDueDate('Electricity', $rentPeriodStart, $schedules),[m
[32m+[m[32m                            'disconnection_date' => $this->getDisconnectionDate('Electricity', $rentPeriodStart, $schedules),[m
[32m+[m[32m                            'status' => 'unpaid'[m
[32m+[m[32m                        ][m
[32m+[m[32m                    );[m
[32m+[m[32m                    $this->info("  Electricity bill: Placeholder created (no reading yet)");[m
                 }[m
             }[m
         }[m
[1mdiff --git a/app/Console/Commands/GenerateNewVendorBills.php b/app/Console/Commands/GenerateNewVendorBills.php[m
[1mindex 67d58f1..68d64c9 100644[m
[1m--- a/app/Console/Commands/GenerateNewVendorBills.php[m
[1m+++ b/app/Console/Commands/GenerateNewVendorBills.php[m
[36m@@ -111,13 +111,7 @@[m [mprivate function processSingleStall($stall)[m
         // --- 1. Rent Bill (Current Month) ---[m
         Billing::updateOrCreate([m
             ['stall_id' => $stall->id, 'utility_type' => 'Rent', 'period_start' => $rentPeriodStart->toDateString()],[m
[31m-            [[m
[31m-                'period_end' => $rentPeriodEnd->toDateString(), [m
[31m-                'amount' => $stall->monthly_rate ?? 0, // Default to 0 if null[m
[31m-                'due_date' => $this->getDueDate('Rent', $rentPeriodStart, $schedules), [m
[31m-                'disconnection_date' => $this->getDisconnectionDate('Rent', $rentPeriodStart, $schedules), [m
[31m-                'status' => 'unpaid'[m
[31m-            ][m
[32m+[m[32m            ['period_end' => $rentPeriodEnd->toDateString(), 'amount' => $stall->monthly_rate, 'due_date' => $this->getDueDate('Rent', $rentPeriodStart, $schedules), 'disconnection_date' => $this->getDisconnectionDate('Rent', $rentPeriodStart, $schedules), 'status' => 'unpaid'][m
         );[m
         $this->info("  âœ“ Rent bill for current month processed.");[m
 [m
[36m@@ -154,7 +148,7 @@[m [mprivate function processSingleStall($stall)[m
                     // Use a consistent date for the reading record, e.g., the end of the current month.[m
                     'reading_date' => $rentPeriodEnd->toDateString() [m
                 ],[m
[31m-                ['previous_reading' => 0, 'current_reading' => 0, 'consumption' => 0][m
[32m+[m[32m                ['previous_reading' => 0, 'current_reading' => 0][m
             );[m
             $this->info("  âœ“ Initial Electricity reading record for current month processed.");[m
         }[m
[36m@@ -166,36 +160,14 @@[m [mprivate function getDueDate($type, Carbon $billingPeriod, $schedules)[m
             return $billingPeriod->copy()->endOfMonth()->toDateString();[m
         }[m
         $key = "Due Date - {$type}";[m
[31m-        // Safe access using optional() or check existence[m
[31m-        $scheduleItem = $schedules->get($key);[m
[31m-        $day = $scheduleItem ? $scheduleItem->description : null;[m
[31m-        [m
[31m-        // Fallback to end of month if schedule is missing or invalid[m
[31m-        if (!is_numeric($day)) {[m
[31m-            return $billingPeriod->copy()->endOfMonth()->toDateString();[m
[31m-        }[m
[31m-        [m
[31m-        // Handle cases where day might be greater than days in month (e.g. 31st in Feb)[m
[31m-        try {[m
[31m-            return $billingPeriod->copy()->day((int)$day)->toDateString();[m
[31m-        } catch (\Exception $e) {[m
[31m-             return $billingPeriod->copy()->endOfMonth()->toDateString();[m
[31m-        }[m
[32m+[m[32m        $day = $schedules->get($key)->description ?? null;[m
[32m+[m[32m        return is_numeric($day) ? $billingPeriod->copy()->day((int)$day)->toDateString() : null;[m
     }[m
 [m
     private function getDisconnectionDate($type, Carbon $billingPeriod, $schedules)[m
     {[m
         $key = "Disconnection - {$type}";[m
[31m-        $scheduleItem = $schedules->get($key);[m
[31m-        $day = $scheduleItem ? $scheduleItem->description : null;[m
[31m-        [m
[31m-        if (is_numeric($day)) {[m
[31m-             try {[m
[31m-                return $billingPeriod->copy()->day((int)$day)->toDateString();[m
[31m-             } catch (\Exception $e) {[m
[31m-                return null;[m
[31m-             }[m
[31m-        }[m
[31m-        return null;[m
[32m+[m[32m        $day = $schedules->get($key)->description ?? null;[m
[32m+[m[32m        return is_numeric($day) ? $billingPeriod->copy()->day((int)$day)->toDateString() : null;[m
     }[m
 }[m
\ No newline at end of file[m
[1mdiff --git a/app/Console/Commands/RemoveTestContactNumbers.php b/app/Console/Commands/RemoveTestContactNumbers.php[m
[1mnew file mode 100644[m
[1mindex 0000000..01e0561[m
[1m--- /dev/null[m
[1m+++ b/app/Console/Commands/RemoveTestContactNumbers.php[m
[36m@@ -0,0 +1,52 @@[m
[32m+[m[32m<?php[m
[32m+[m
[32m+[m[32mnamespace App\Console\Commands;[m
[32m+[m
[32m+[m[32muse Illuminate\Console\Command;[m
[32m+[m[32muse App\Models\User;[m
[32m+[m[32muse Illuminate\Support\Facades\DB;[m
[32m+[m
[32m+[m[32mclass RemoveTestContactNumbers extends Command[m
[32m+[m[32m{[m
[32m+[m[32m    protected $signature = 'users:remove-test-contacts';[m
[32m+[m[32m    protected $description = 'Removes test contact numbers (6391712345...) from vendor records.';[m
[32m+[m
[32m+[m[32m    public function handle()[m
[32m+[m[32m    {[m
[32m+[m[32m        $this->info('Searching for vendors with test contact numbers...');[m
[32m+[m
[32m+[m[32m        // Find users with contact numbers starting with 6391712345[m
[32m+[m[32m        $users = User::where('contact_number', 'like', '6391712345%')->get();[m
[32m+[m
[32m+[m[32m        if ($users->isEmpty()) {[m
[32m+[m[32m            $this->info('No users found with test contact numbers.');[m
[32m+[m[32m            return 0;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        $this->info("Found {$users->count()} user(s) with test contact numbers:");[m
[32m+[m[41m        [m
[32m+[m[32m        $tableData = [];[m
[32m+[m[32m        foreach ($users as $user) {[m
[32m+[m[32m            $tableData[] = [[m
[32m+[m[32m                'id' => $user->id,[m
[32m+[m[32m                'name' => $user->name,[m
[32m+[m[32m                'username' => $user->username,[m
[32m+[m[32m                'contact_number' => $user->contact_number,[m
[32m+[m[32m            ];[m
[32m+[m[32m            $this->line("  - ID: {$user->id}, Name: {$user->name}, Contact: {$user->contact_number}");[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        if ($this->confirm('Do you want to remove these contact numbers?', true)) {[m
[32m+[m[32m            $updated = DB::table('users')[m
[32m+[m[32m                ->where('contact_number', 'like', '6391712345%')[m
[32m+[m[32m                ->update(['contact_number' => null]);[m
[32m+[m
[32m+[m[32m            $this->info("Successfully removed contact numbers from {$updated} user(s).");[m
[32m+[m[32m            return 0;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        $this->info('Operation cancelled.');[m
[32m+[m[32m        return 0;[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[1mdiff --git a/app/Console/Commands/SendBillingStatements.php b/app/Console/Commands/SendBillingStatements.php[m
[1mindex ee816e2..f0a31d2 100644[m
[1m--- a/app/Console/Commands/SendBillingStatements.php[m
[1m+++ b/app/Console/Commands/SendBillingStatements.php[m
[36m@@ -5,33 +5,78 @@[m
 use Illuminate\Console\Command;[m
 use App\Models\User;[m
 use App\Services\SmsService;[m
[32m+[m[32muse App\Models\Schedule;[m
 use Illuminate\Support\Facades\Log;[m
 [m
 class SendBillingStatements extends Command[m
 {[m
[31m-    protected $signature = 'sms:send-billing-statements';[m
[32m+[m[32m    protected $signature = 'sms:send-billing-statements {--force : Force send even if not the scheduled day} {--stall= : Send only to specific stall number (e.g., MS-04)}';[m
     protected $description = 'Sends a monthly billing statement SMS to all vendors with unpaid bills.';[m
 [m
     public function handle(SmsService $smsService)[m
     {[m
         $this->info('Starting to send monthly billing statements...');[m
 [m
[31m-        $vendors = User::vendors()->active()[m
[32m+[m[32m        // Get the scheduled day from database (default to day 1 if not set)[m
[32m+[m[32m        $schedule = Schedule::where('schedule_type', 'SMS - Billing Statements')->first();[m
[32m+[m[32m        $scheduledDay = $schedule && $schedule->schedule_day ? (int)$schedule->schedule_day : 1;[m
[32m+[m[41m        [m
[32m+[m[32m        // Only send if today is the scheduled day (unless --force is used)[m
[32m+[m[32m        $today = now();[m
[32m+[m[32m        if (!$this->option('force') && $today->day != $scheduledDay) {[m
[32m+[m[32m            $this->info("Today is not the scheduled day ({$scheduledDay}). Skipping.");[m
[32m+[m[32m            $this->info("Use --force to send anyway.");[m
[32m+[m[32m            return 0;[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        if ($this->option('force')) {[m
[32m+[m[32m            $this->warn("âš ï¸  FORCE MODE: Sending billing statements regardless of scheduled day.");[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        $vendorsQuery = User::vendors()->active()[m
             ->whereHas('stall')[m
             ->whereNotNull('contact_number')[m
[31m-            ->whereHas('billings', fn ($q) => $q->where('status', 'unpaid'))[m
[31m-            ->get();[m
[32m+[m[32m            ->whereHas('billings', fn ($q) => $q->where('status', 'unpaid'));[m
[32m+[m[41m        [m
[32m+[m[32m        // Filter by specific stall if provided[m
[32m+[m[32m        if ($this->option('stall')) {[m
[32m+[m[32m            $stallNumber = $this->option('stall');[m
[32m+[m[32m            $vendorsQuery->whereHas('stall', function($q) use ($stallNumber) {[m
[32m+[m[32m                $q->where('table_number', $stallNumber);[m
[32m+[m[32m            });[m
[32m+[m[32m            $this->info("Filtering for stall: {$stallNumber}");[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        $vendors = $vendorsQuery->get();[m
             [m
[31m-        $this->info("Found {$vendors->count()} vendors with outstanding bills to notify.");[m
[32m+[m[32m        if ($vendors->isEmpty()) {[m
[32m+[m[32m            $this->warn("No vendors found with outstanding bills" . ($this->option('stall') ? " for stall {$this->option('stall')}" : '') . ".");[m
[32m+[m[32m            return 0;[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        $this->info("Found {$vendors->count()} vendor(s) with outstanding bills to notify.");[m
 [m
[32m+[m[32m        $successCount = 0;[m
[32m+[m[32m        $failCount = 0;[m
[32m+[m[41m        [m
         foreach ($vendors as $vendor) {[m
[32m+[m[32m            $this->line("Processing {$vendor->name} (ID: {$vendor->id})...");[m
[32m+[m[32m            $this->line("  Contact Number: " . ($vendor->contact_number ?? 'NULL'));[m
[32m+[m[41m            [m
             $result = $smsService->sendTemplatedSms($vendor, 'bill_statement');[m
             if ($result['success']) {[m
[31m-                $this->info("Sent statement to {$vendor->name}.");[m
[32m+[m[32m                $this->info("âœ“ Sent statement to {$vendor->name}.");[m
[32m+[m[32m                $successCount++;[m
             } else {[m
[31m-                $this->warn("Failed to send statement to {$vendor->name}: {$result['message']}");[m
[32m+[m[32m                $this->warn("âœ— Failed to send statement to {$vendor->name}: {$result['message']}");[m
[32m+[m[32m                $failCount++;[m
             }[m
         }[m
[32m+[m[41m        [m
[32m+[m[32m        $this->info("\n=== Summary ===");[m
[32m+[m[32m        $this->info("Successfully sent: {$successCount}");[m
[32m+[m[32m        $this->info("Failed: {$failCount}");[m
[32m+[m[32m        $this->info("Total vendors processed: " . $vendors->count());[m
 [m
         $this->info('Finished sending billing statements.');[m
         return 0;[m
[1mdiff --git a/app/Console/Commands/SendOverdueAlerts.php b/app/Console/Commands/SendOverdueAlerts.php[m
[1mindex 70a00f0..fe2f190 100644[m
[1m--- a/app/Console/Commands/SendOverdueAlerts.php[m
[1m+++ b/app/Console/Commands/SendOverdueAlerts.php[m
[36m@@ -24,10 +24,22 @@[m [mpublic function handle(SmsService $smsService)[m
     $today = $this->argument('date') ? Carbon::parse($this->argument('date')) : Carbon::today();[m
     $this->info("Checking for overdue bills at key milestones as of: " . $today->toDateString());[m
 [m
[31m-    // âœ… START OF FIX: Define the specific overdue intervals.[m
[31m-    $overdueDays = [1, 3, 7, 14, 21, 30];[m
[32m+[m[32m    // Get overdue days from database (default to [1, 3, 7, 14, 21, 30] if not set)[m
[32m+[m[32m    $schedule = \App\Models\Schedule::where('schedule_type', 'SMS - Overdue Alerts')->first();[m
[32m+[m[32m    $overdueDays = $schedule && $schedule->sms_days && is_array($schedule->sms_days)[m[41m [m
[32m+[m[32m        ? $schedule->sms_days[m[41m [m
[32m+[m[32m        : [1, 3, 7, 14, 21, 30];[m
[32m+[m[41m    [m
[32m+[m[32m    // Sort and filter valid days[m
[32m+[m[32m    $overdueDays = array_filter(array_map('intval', $overdueDays), fn($d) => $d > 0 && $d <= 365);[m
[32m+[m[32m    sort($overdueDays);[m
[32m+[m[41m    [m
[32m+[m[32m    if (empty($overdueDays)) {[m
[32m+[m[32m        $this->info("No overdue days configured. Using default: [1, 3, 7, 14, 21, 30]");[m
[32m+[m[32m        $overdueDays = [1, 3, 7, 14, 21, 30];[m
[32m+[m[32m    }[m
[32m+[m[41m    [m
     $targetDueDates = collect($overdueDays)->map(fn($days) => $today->copy()->subDays($days)->toDateString());[m
[31m-    // âœ… END OF FIX[m
 [m
     // Find vendors with unpaid bills that were due on one of the target dates.[m
     $vendors = User::vendors()->active()[m
[1mdiff --git a/app/Console/Commands/SendPaymentReminders.php b/app/Console/Commands/SendPaymentReminders.php[m
[1mindex 8d96814..4669bdd 100644[m
[1m--- a/app/Console/Commands/SendPaymentReminders.php[m
[1m+++ b/app/Console/Commands/SendPaymentReminders.php[m
[36m@@ -20,10 +20,22 @@[m [mpublic function handle(SmsService $smsService)[m
 [m
     $today = Carbon::today();[m
     [m
[31m-    // âœ… START OF FIX: Define the specific days before the due date to send a reminder.[m
[31m-    $reminderDays = [7, 5, 3, 1];[m
[32m+[m[32m    // Get reminder days from database (default to [7, 5, 3, 1] if not set)[m
[32m+[m[32m    $schedule = \App\Models\Schedule::where('schedule_type', 'SMS - Payment Reminders')->first();[m
[32m+[m[32m    $reminderDays = $schedule && $schedule->sms_days && is_array($schedule->sms_days)[m[41m [m
[32m+[m[32m        ? $schedule->sms_days[m[41m [m
[32m+[m[32m        : [7, 5, 3, 1];[m
[32m+[m[41m    [m
[32m+[m[32m    // Sort and filter valid days[m
[32m+[m[32m    $reminderDays = array_filter(array_map('intval', $reminderDays), fn($d) => $d > 0 && $d <= 365);[m
[32m+[m[32m    sort($reminderDays);[m
[32m+[m[41m    [m
[32m+[m[32m    if (empty($reminderDays)) {[m
[32m+[m[32m        $this->info("No reminder days configured. Using default: [7, 5, 3, 1]");[m
[32m+[m[32m        $reminderDays = [7, 5, 3, 1];[m
[32m+[m[32m    }[m
[32m+[m[41m    [m
     $targetDates = collect($reminderDays)->map(fn($days) => $today->copy()->addDays($days)->toDateString());[m
[31m-    // âœ… END OF FIX[m
 [m
     // Find vendors with unpaid bills that are due on one of the target dates.[m
     $vendors = User::vendors()->active()[m
[1mdiff --git a/app/Console/Kernel.php b/app/Console/Kernel.php[m
[1mindex 6e9b4d1..0e90534 100644[m
[1m--- a/app/Console/Kernel.php[m
[1m+++ b/app/Console/Kernel.php[m
[36m@@ -13,17 +13,18 @@[m [mclass Kernel extends ConsoleKernel[m
      *[m
      * @var array[m
      */[m
[32m+[m
     protected $commands = [[m
[31m-        \App\Console\Commands\GenerateMonthlyBills::class,[m
[31m-        \App\Console\Commands\GenerateNewVendorBills::class,[m
[31m-        \App\Console\Commands\CleanupBillingData::class,[m
[31m-        \App\Console\Commands\ResetCurrentMonthReadings::class,[m
[31m-        \App\Console\Commands\ClearCurrentMonthReadings::class,[m
[31m-        \App\Console\Commands\SendBillingStatements::class, [m
[31m-        \App\Console\Commands\SendPaymentReminders::class,  [m
[31m-        \App\Console\Commands\SendOverdueAlerts::class,   [m
[31m-        \App\Console\Commands\DeletePayment::class,[m
[31m-        \App\Console\Commands\CleanupSpecificMonthBilling::class,[m
[32m+[m[32m    \App\Console\Commands\GenerateMonthlyBills::class,[m
[32m+[m[32m    \App\Console\Commands\CleanupBillingData::class,[m
[32m+[m[32m    \App\Console\Commands\ResetCurrentMonthReadings::class,[m
[32m+[m[32m    \App\Console\Commands\ClearCurrentMonthReadings::class, // Registering the new command[m
[32m+[m[32m    \App\Console\Commands\SendBillingStatements::class,[m[41m [m
[32m+[m[32m    \App\Console\Commands\SendPaymentReminders::class,[m[41m  [m
[32m+[m[32m    \App\Console\Commands\SendOverdueAlerts::class,[m[41m   [m
[32m+[m[32m    \App\Console\Commands\DeletePayment::class,[m
[32m+[m[32m    \App\Console\Commands\CleanupSpecificMonthBilling::class,[m
[32m+[m[32m    \App\Console\Commands\RemoveTestContactNumbers::class,[m
     ];[m
 [m
     /**[m
[36m@@ -35,8 +36,6 @@[m [mclass Kernel extends ConsoleKernel[m
     protected function schedule(Schedule $schedule)[m
     {[m
         $schedule->command('billing:generate')->monthlyOn(1, '00:00');[m
[31m-        $schedule->command('sms:send-payment-reminders')->dailyAt('08:00');[m
[31m-        $schedule->command('sms:send-overdue-alerts')->dailyAt('09:00');[m
     }[m
 [m
     /**[m
[1mdiff --git a/app/Http/Controllers/AdminCommandController.php b/app/Http/Controllers/AdminCommandController.php[m
[1mnew file mode 100644[m
[1mindex 0000000..cb62acf[m
[1m--- /dev/null[m
[1m+++ b/app/Http/Controllers/AdminCommandController.php[m
[36m@@ -0,0 +1,202 @@[m
[32m+[m[32m<?php[m
[32m+[m
[32m+[m[32mnamespace App\Http\Controllers;[m
[32m+[m
[32m+[m[32muse Illuminate\Http\Request;[m
[32m+[m[32muse Illuminate\Support\Facades\Artisan;[m
[32m+[m[32muse Illuminate\Support\Facades\RateLimiter;[m
[32m+[m[32muse Illuminate\Support\Facades\Log;[m
[32m+[m
[32m+[m[32mclass AdminCommandController extends Controller[m
[32m+[m[32m{[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Execute a single admin command[m
[32m+[m[32m     *[m[41m [m
[32m+[m[32m     * Security improvements:[m
[32m+[m[32m     * - Uses POST instead of GET (secret not in URL)[m
[32m+[m[32m     * - Rate limiting (max 5 requests per minute per IP)[m
[32m+[m[32m     * - IP whitelist check (optional, via env)[m
[32m+[m[32m     * - Proper logging[m
[32m+[m[32m     */[m
[32m+[m[32m    public function runCommand(Request $request, $command)[m
[32m+[m[32m    {[m
[32m+[m[32m        // Rate limiting: max 5 requests per minute per IP[m
[32m+[m[32m        $key = 'admin-command:' . $request->ip();[m
[32m+[m[32m        if (RateLimiter::tooManyAttempts($key, 5)) {[m
[32m+[m[32m            Log::warning('Admin command rate limit exceeded', [[m
[32m+[m[32m                'ip' => $request->ip(),[m
[32m+[m[32m                'command' => $command[m
[32m+[m[32m            ]);[m
[32m+[m[32m            return response()->json([[m
[32m+[m[32m                'success' => false,[m
[32m+[m[32m                'message' => 'Too many requests. Please try again later.'[m
[32m+[m[32m            ], 429);[m
[32m+[m[32m        }[m
[32m+[m[32m        RateLimiter::hit($key, 60); // 60 seconds window[m
[32m+[m
[32m+[m[32m        // Security check - secret must be in request body, not URL[m
[32m+[m[32m        $secret = $request->input('secret');[m
[32m+[m[32m        if ($secret !== env('ADMIN_SECRET')) {[m
[32m+[m[32m            Log::warning('Invalid admin command secret attempt', [[m
[32m+[m[32m                'ip' => $request->ip(),[m
[32m+[m[32m                'command' => $command[m
[32m+[m[32m            ]);[m
[32m+[m[32m            abort(403, 'Unauthorized - Invalid secret key!');[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // Optional IP whitelist check[m
[32m+[m[32m        $allowedIPs = env('ADMIN_ALLOWED_IPS', '');[m
[32m+[m[32m        if (!empty($allowedIPs)) {[m
[32m+[m[32m            $allowedIPsArray = array_map('trim', explode(',', $allowedIPs));[m
[32m+[m[32m            if (!in_array($request->ip(), $allowedIPsArray)) {[m
[32m+[m[32m                Log::warning('Admin command from unauthorized IP', [[m
[32m+[m[32m                    'ip' => $request->ip(),[m
[32m+[m[32m                    'command' => $command[m
[32m+[m[32m                ]);[m
[32m+[m[32m                abort(403, 'Unauthorized - IP not whitelisted!');[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        $result = ['success' => false, 'message' => ''];[m
[32m+[m[41m        [m
[32m+[m[32m        try {[m
[32m+[m[32m            // Whitelist of allowed commands[m
[32m+[m[32m            $allowedCommands = [[m
[32m+[m[32m                'billing:generate',[m
[32m+[m[32m                'sms:send-billing-statements',[m
[32m+[m[32m                'sms:send-overdue-alerts',[m
[32m+[m[32m                'sms:send-payment-reminders'[m
[32m+[m[32m            ];[m
[32m+[m
[32m+[m[32m            if (!in_array($command, $allowedCommands)) {[m
[32m+[m[32m                return response()->json([[m
[32m+[m[32m                    'success' => false,[m
[32m+[m[32m                    'message' => 'Unknown or unauthorized command: ' . $command[m
[32m+[m[32m                ], 400);[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            Artisan::call($command);[m
[32m+[m[32m            $output = Artisan::output();[m
[32m+[m[41m            [m
[32m+[m[32m            Log::info('Admin command executed', [[m
[32m+[m[32m                'command' => $command,[m
[32m+[m[32m                'ip' => $request->ip()[m
[32m+[m[32m            ]);[m
[32m+[m
[32m+[m[32m            $result = [[m
[32m+[m[32m                'success' => true,[m
[32m+[m[32m                'message' => "Command '{$command}' executed successfully!",[m
[32m+[m[32m                'output' => $output[m
[32m+[m[32m            ];[m
[32m+[m[32m        } catch (\Exception $e) {[m
[32m+[m[32m            Log::error('Admin command execution failed', [[m
[32m+[m[32m                'command' => $command,[m
[32m+[m[32m                'error' => $e->getMessage(),[m
[32m+[m[32m                'ip' => $request->ip()[m
[32m+[m[32m            ]);[m
[32m+[m[41m            [m
[32m+[m[32m            $result = [[m
[32m+[m[32m                'success' => false,[m
[32m+[m[32m                'message' => 'Error: ' . $e->getMessage()[m
[32m+[m[32m            ];[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        return response()->json($result);[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Run multiple monthly tasks at once[m
[32m+[m[32m     */[m
[32m+[m[32m    public function runMonthlyTasks(Request $request)[m
[32m+[m[32m    {[m
[32m+[m[32m        // Rate limiting: max 2 requests per hour per IP[m
[32m+[m[32m        $key = 'admin-monthly-tasks:' . $request->ip();[m
[32m+[m[32m        if (RateLimiter::tooManyAttempts($key, 2)) {[m
[32m+[m[32m            Log::warning('Monthly tasks rate limit exceeded', [[m
[32m+[m[32m                'ip' => $request->ip()[m
[32m+[m[32m            ]);[m
[32m+[m[32m            return response()->json([[m
[32m+[m[32m                'success' => false,[m
[32m+[m[32m                'message' => 'Too many requests. Please try again later.'[m
[32m+[m[32m            ], 429);[m
[32m+[m[32m        }[m
[32m+[m[32m        RateLimiter::hit($key, 3600); // 1 hour window[m
[32m+[m
[32m+[m[32m        // Security check[m
[32m+[m[32m        $secret = $request->input('secret');[m
[32m+[m[32m        if ($secret !== env('ADMIN_SECRET')) {[m
[32m+[m[32m            Log::warning('Invalid monthly tasks secret attempt', [[m
[32m+[m[32m                'ip' => $request->ip()[m
[32m+[m[32m            ]);[m
[32m+[m[32m            abort(403, 'Unauthorized - Invalid secret key!');[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // Optional IP whitelist check[m
[32m+[m[32m        $allowedIPs = env('ADMIN_ALLOWED_IPS', '');[m
[32m+[m[32m        if (!empty($allowedIPs)) {[m
[32m+[m[32m            $allowedIPsArray = array_map('trim', explode(',', $allowedIPs));[m
[32m+[m[32m            if (!in_array($request->ip(), $allowedIPsArray)) {[m
[32m+[m[32m                Log::warning('Monthly tasks from unauthorized IP', [[m
[32m+[m[32m                    'ip' => $request->ip()[m
[32m+[m[32m                ]);[m
[32m+[m[32m                abort(403, 'Unauthorized - IP not whitelisted!');[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        $results = [];[m
[32m+[m[41m        [m
[32m+[m[32m        try {[m
[32m+[m[32m            // 1. Generate monthly bills[m
[32m+[m[32m            Artisan::call('billing:generate');[m
[32m+[m[32m            $results[] = [[m
[32m+[m[32m                'command' => 'Generate Monthly Bills',[m
[32m+[m[32m                'success' => true,[m
[32m+[m[32m                'output' => Artisan::output()[m
[32m+[m[32m            ];[m
[32m+[m[41m            [m
[32m+[m[32m            // Small delay to ensure bills are generated before sending statements[m
[32m+[m[32m            sleep(2);[m
[32m+[m[41m            [m
[32m+[m[32m            // 2. Send billing statements[m
[32m+[m[32m            Artisan::call('sms:send-billing-statements');[m
[32m+[m[32m            $results[] = [[m
[32m+[m[32m                'command' => 'Send Billing Statements',[m
[32m+[m[32m                'success' => true,[m
[32m+[m[32m                'message' => 'Statements sent',[m
[32m+[m[32m                'output' => Artisan::output()[m
[32m+[m[32m            ];[m
[32m+[m[41m            [m
[32m+[m[32m            // 3. Send overdue alerts (for existing unpaid bills)[m
[32m+[m[32m            Artisan::call('sms:send-overdue-alerts');[m
[32m+[m[32m            $results[] = [[m
[32m+[m[32m                'command' => 'Send Overdue Alerts',[m
[32m+[m[32m                'success' => true,[m
[32m+[m[32m                'message' => 'Overdue alerts sent',[m
[32m+[m[32m                'output' => Artisan::output()[m
[32m+[m[32m            ];[m
[32m+[m
[32m+[m[32m            Log::info('Monthly tasks executed', [[m
[32m+[m[32m                'ip' => $request->ip()[m
[32m+[m[32m            ]);[m
[32m+[m[41m            [m
[32m+[m[32m            return response()->json([[m
[32m+[m[32m                'success' => true,[m
[32m+[m[32m                'message' => 'All monthly tasks completed successfully!',[m
[32m+[m[32m                'results' => $results[m
[32m+[m[32m            ]);[m
[32m+[m[41m            [m
[32m+[m[32m        } catch (\Exception $e) {[m
[32m+[m[32m            Log::error('Monthly tasks execution failed', [[m
[32m+[m[32m                'error' => $e->getMessage(),[m
[32m+[m[32m                'ip' => $request->ip()[m
[32m+[m[32m            ]);[m
[32m+[m
[32m+[m[32m            return response()->json([[m
[32m+[m[32m                'success' => false,[m
[32m+[m[32m                'message' => 'Error during monthly tasks: ' . $e->getMessage(),[m
[32m+[m[32m                'results' => $results[m
[32m+[m[32m            ], 500);[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[1mdiff --git a/app/Http/Controllers/Api/AnnouncementController.php b/app/Http/Controllers/Api/AnnouncementController.php[m
[1mindex 655c832..9fee841 100644[m
[1m--- a/app/Http/Controllers/Api/AnnouncementController.php[m
[1m+++ b/app/Http/Controllers/Api/AnnouncementController.php[m
[36m@@ -4,7 +4,11 @@[m
 [m
 use App\Http\Controllers\Controller;[m
 use App\Models\Announcement;[m
[32m+[m[32muse App\Models\User;[m
[32m+[m[32muse App\Services\SmsService;[m
 use Illuminate\Http\Request;[m
[32m+[m[32muse Illuminate\Support\Facades\Log;[m
[32m+[m[32muse Illuminate\Support\Facades\DB;[m
 [m
 class AnnouncementController extends Controller[m
 {[m
[36m@@ -13,29 +17,212 @@[m [mpublic function index()[m
         return Announcement::latest()->get();[m
     }[m
 [m
[31m-    public function store(Request $request)[m
[32m+[m[32m    public function active(Request $request)[m
[32m+[m[32m    {[m
[32m+[m[32m        // Get all active announcements[m
[32m+[m[32m        $announcements = Announcement::where('is_active', true)[m
[32m+[m[32m            ->latest()[m
[32m+[m[32m            ->get();[m
[32m+[m
[32m+[m[32m        // If user is authenticated and is a vendor, filter announcements appropriately[m
[32m+[m[32m        $user = $request->user();[m
[32m+[m[32m        if ($user && $user->isVendor()) {[m
[32m+[m[32m            // Load relationships[m
[32m+[m[32m            $user->load('stall', 'section');[m
[32m+[m[41m            [m
[32m+[m[32m            $userSection = $user->section;[m
[32m+[m[32m            // Check if user is in Wet Section (handle variations: "Wet Section", "Wet")[m
[32m+[m[32m            $isWetSection = $userSection && in_array($userSection->name, ['Wet Section', 'Wet']);[m
[32m+[m[41m            [m
[32m+[m[32m            // Get user's stall ID if they have one[m
[32m+[m[32m            $userStallId = $user->stall ? $user->stall->id : null;[m
[32m+[m[41m            [m
[32m+[m[32m            $announcements = $announcements->filter(function($announcement) use ($isWetSection, $userStallId) {[m
[32m+[m[32m                // If it's a water-related announcement and user is not in Wet Section, exclude it[m
[32m+[m[32m                // This excludes Dry Section, Semi-Wet, Semi-Dry, Dry Goods vendors[m
[32m+[m[32m                if ($announcement->related_utility === 'Water' && !$isWetSection) {[m
[32m+[m[32m                    return false;[m
[32m+[m[32m                }[m
[32m+[m[41m                [m
[32m+[m[32m                // If it's a rent announcement, only show it to the vendor who owns that specific stall[m
[32m+[m[32m                if ($announcement->related_utility === 'Rent' && $announcement->related_stall_id) {[m
[32m+[m[32m                    return $announcement->related_stall_id == $userStallId;[m
[32m+[m[32m                }[m
[32m+[m[41m                [m
[32m+[m[32m                return true;[m
[32m+[m[32m            });[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // Exclude dismissed announcements if user is authenticated[m
[32m+[m[32m        if ($user) {[m
[32m+[m[32m            $dismissedIds = DB::table('dismissed_announcements')[m
[32m+[m[32m                ->where('user_id', $user->id)[m
[32m+[m[32m                ->pluck('announcement_id')[m
[32m+[m[32m                ->toArray();[m
[32m+[m[41m            [m
[32m+[m[32m            $announcements = $announcements->reject(function($announcement) use ($dismissedIds) {[m
[32m+[m[32m                return in_array($announcement->id, $dismissedIds);[m
[32m+[m[32m            });[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        return $announcements->values();[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Get all announcements for the current user (including dismissed ones)[m
[32m+[m[32m     * This is used for the notifications page[m
[32m+[m[32m     * Optimized for performance with limits and efficient filtering[m
[32m+[m[32m     */[m
[32m+[m[32m    public function allForUser(Request $request)[m
[32m+[m[32m    {[m
[32m+[m[32m        $user = $request->user();[m
[32m+[m[41m        [m
[32m+[m[32m        if (!$user) {[m
[32m+[m[32m            return response()->json(['message' => 'Unauthorized'], 401);[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // Get dismissed announcement IDs first (single optimized query)[m
[32m+[m[32m        $dismissedIds = DB::table('dismissed_announcements')[m
[32m+[m[32m            ->where('user_id', $user->id)[m
[32m+[m[32m            ->pluck('announcement_id')[m
[32m+[m[32m            ->toArray();[m
[32m+[m
[32m+[m[32m        // Get recent active announcements with limit (most recent 50 for performance)[m
[32m+[m[32m        $announcements = Announcement::where('is_active', true)[m
[32m+[m[32m            ->latest()[m
[32m+[m[32m            ->limit(50)[m
[32m+[m[32m            ->get();[m
[32m+[m
[32m+[m[32m        // Pre-load user relationships once if vendor[m
[32m+[m[32m        $userSection = null;[m
[32m+[m[32m        $userStallId = null;[m
[32m+[m[32m        $userRole = null;[m
[32m+[m[41m        [m
[32m+[m[32m        if ($user->isVendor()) {[m
[32m+[m[32m            $user->load('stall', 'section');[m
[32m+[m[32m            $userSection = $user->section;[m
[32m+[m[32m            $userStallId = $user->stall ? $user->stall->id : null;[m
[32m+[m[32m        } else {[m
[32m+[m[32m            $userRole = $user->role ? $user->role->name : null;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // Filter announcements efficiently[m
[32m+[m[32m        $announcements = $announcements->filter(function($announcement) use ($user, $userSection, $userStallId, $userRole) {[m
[32m+[m[32m            if ($user->isVendor()) {[m
[32m+[m[32m                $isWetSection = $userSection && in_array($userSection->name, ['Wet Section', 'Wet']);[m
[32m+[m[41m                [m
[32m+[m[32m                // Filter water-related announcements[m
[32m+[m[32m                if ($announcement->related_utility === 'Water' && !$isWetSection) {[m
[32m+[m[32m                    return false;[m
[32m+[m[32m                }[m
[32m+[m[41m                [m
[32m+[m[32m                // Filter rent announcements[m
[32m+[m[32m                if ($announcement->related_utility === 'Rent' && $announcement->related_stall_id) {[m
[32m+[m[32m                    return $announcement->related_stall_id == $userStallId;[m
[32m+[m[32m                }[m
[32m+[m[41m                [m
[32m+[m[32m                return true;[m
[32m+[m[32m            } else {[m
[32m+[m[32m                // For staff/admin, filter based on recipients[m
[32m+[m[32m                $recipients = $announcement->recipients ?? [];[m
[32m+[m[41m                [m
[32m+[m[32m                // If staff is selected in recipients, show to staff/admin[m
[32m+[m[32m                if (!empty($recipients['staff'])) {[m
[32m+[m[32m                    return in_array($userRole, ['Staff', 'Meter Reader Clerk', 'Admin']);[m
[32m+[m[32m                }[m
[32m+[m[41m                [m
[32m+[m[32m                // If no recipients specified, show to all (legacy behavior)[m
[32m+[m[32m                if (empty($recipients)) {[m
[32m+[m[32m                    return true;[m
[32m+[m[32m                }[m
[32m+[m[41m                [m
[32m+[m[32m                // If only sections are specified, don't show to staff unless staff is also selected[m
[32m+[m[32m                return false;[m
[32m+[m[32m            }[m
[32m+[m[32m        });[m
[32m+[m
[32m+[m[32m        // Add dismissed flag efficiently[m
[32m+[m[32m        $announcements = $announcements->map(function($announcement) use ($dismissedIds) {[m
[32m+[m[32m            $announcement->is_dismissed = in_array($announcement->id, $dismissedIds);[m
[32m+[m[32m            return $announcement;[m
[32m+[m[32m        });[m
[32m+[m
[32m+[m[32m        return response()->json($announcements->values());[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Mark an announcement as dismissed for the current user[m
[32m+[m[32m     */[m
[32m+[m[32m    public function dismiss(Request $request, Announcement $announcement)[m
[32m+[m[32m    {[m
[32m+[m[32m        $user = $request->user();[m
[32m+[m[41m        [m
[32m+[m[32m        if (!$user) {[m
[32m+[m[32m            return response()->json(['message' => 'Unauthorized'], 401);[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // Check if already dismissed[m
[32m+[m[32m        $exists = DB::table('dismissed_announcements')[m
[32m+[m[32m            ->where('user_id', $user->id)[m
[32m+[m[32m            ->where('announcement_id', $announcement->id)[m
[32m+[m[32m            ->exists();[m
[32m+[m
[32m+[m[32m        if (!$exists) {[m
[32m+[m[32m            DB::table('dismissed_announcements')->insert([[m
[32m+[m[32m                'user_id' => $user->id,[m
[32m+[m[32m                'announcement_id' => $announcement->id,[m
[32m+[m[32m                'created_at' => now(),[m
[32m+[m[32m                'updated_at' => now(),[m
[32m+[m[32m            ]);[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        return response()->json(['message' => 'Announcement dismissed successfully']);[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    public function store(Request $request, SmsService $smsService)[m
     {[m
         $validated = $request->validate([[m
             'title' => 'required|string|max:255',[m
             'content' => 'required|string',[m
             'is_active' => 'boolean',[m
[32m+[m[32m            'recipients' => 'nullable|array',[m
[32m+[m[32m            'recipients.staff' => 'boolean',[m
[32m+[m[32m            'recipients.all_sections' => 'boolean',[m
[32m+[m[32m            'recipients.sections' => 'nullable|array',[m
         ]);[m
 [m
         $announcement = Announcement::create($validated);[m
 [m
[32m+[m[32m        // Send SMS and create in-app notifications to selected recipients if announcement is active[m
[32m+[m[32m        if ($announcement->is_active) {[m
[32m+[m[32m            $this->sendAnnouncementSms($announcement, $smsService);[m
[32m+[m[32m            $this->createAnnouncementNotifications($announcement);[m
[32m+[m[32m        }[m
[32m+[m
         return response()->json($announcement, 201);[m
     }[m
 [m
[31m-    public function update(Request $request, Announcement $announcement)[m
[32m+[m[32m    public function update(Request $request, Announcement $announcement, SmsService $smsService)[m
     {[m
         $validated = $request->validate([[m
             'title' => 'sometimes|string|max:255',[m
             'content' => 'sometimes|string',[m
             'is_active' => 'boolean',[m
[32m+[m[32m            'recipients' => 'nullable|array',[m
[32m+[m[32m            'recipients.staff' => 'boolean',[m
[32m+[m[32m            'recipients.all_sections' => 'boolean',[m
[32m+[m[32m            'recipients.sections' => 'nullable|array',[m
         ]);[m
 [m
[32m+[m[32m        $wasActive = $announcement->is_active;[m
         $announcement->update($validated);[m
 [m
[32m+[m[32m        // Send SMS and create in-app notifications if announcement was just activated[m
[32m+[m[32m        if ($announcement->is_active && !$wasActive) {[m
[32m+[m[32m            $this->sendAnnouncementSms($announcement, $smsService);[m
[32m+[m[32m            $this->createAnnouncementNotifications($announcement);[m
[32m+[m[32m        }[m
[32m+[m
         return response()->json($announcement);[m
     }[m
 [m
[36m@@ -45,4 +232,199 @@[m [mpublic function destroy(Announcement $announcement)[m
 [m
         return response()->json(['message' => 'Announcement deleted successfully']);[m
     }[m
[32m+[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Send announcement SMS to selected recipients[m
[32m+[m[32m     */[m
[32m+[m[32m    private function sendAnnouncementSms(Announcement $announcement, SmsService $smsService)[m
[32m+[m[32m    {[m
[32m+[m[32m        try {[m
[32m+[m[32m            $recipients = collect();[m
[32m+[m[32m            $recipientSettings = $announcement->recipients ?? [];[m
[32m+[m
[32m+[m[32m            // Get vendors based on recipient settings[m
[32m+[m[32m            if (!empty($recipientSettings['all_sections']) || !empty($recipientSettings['sections'])) {[m
[32m+[m[32m                $vendorsQuery = User::vendors()[m
[32m+[m[32m                    ->active()[m
[32m+[m[32m                    ->whereNotNull('contact_number');[m
[32m+[m
[32m+[m[32m                // If "All Sections" is selected, get all vendors[m
[32m+[m[32m                // Otherwise, filter by specific sections[m
[32m+[m[32m                if (empty($recipientSettings['all_sections']) && !empty($recipientSettings['sections']) && is_array($recipientSettings['sections'])) {[m
[32m+[m[32m                    $vendorsQuery->whereHas('section', function($query) use ($recipientSettings) {[m
[32m+[m[32m                        $query->whereIn('name', $recipientSettings['sections']);[m
[32m+[m[32m                    });[m
[32m+[m[32m                }[m
[32m+[m
[32m+[m[32m                $vendors = $vendorsQuery->get();[m
[32m+[m[32m                $recipients = $recipients->merge($vendors);[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            // Legacy support: if no recipients specified, use old logic[m
[32m+[m[32m            if ($recipients->isEmpty() && empty($recipientSettings)) {[m
[32m+[m[32m                // For rent announcements, only send to the specific vendor who owns the stall[m
[32m+[m[32m                if ($announcement->related_utility === 'Rent' && $announcement->related_stall_id) {[m
[32m+[m[32m                    $stall = \App\Models\Stall::with('vendor')->find($announcement->related_stall_id);[m
[32m+[m[32m                    if ($stall && $stall->vendor && $stall->vendor->contact_number) {[m
[32m+[m[32m                        $recipients = collect([$stall->vendor]);[m
[32m+[m[32m                    }[m
[32m+[m[32m                } else {[m
[32m+[m[32m                    // Get all vendors with contact numbers[m
[32m+[m[32m                    $vendorsQuery = User::vendors()[m
[32m+[m[32m                        ->active()[m
[32m+[m[32m                        ->whereNotNull('contact_number');[m
[32m+[m
[32m+[m[32m                    // Filter vendors by section if this is a water-related announcement[m
[32m+[m[32m                    if ($announcement->related_utility === 'Water') {[m
[32m+[m[32m                        // Only send to vendors in Wet Section (exclude Dry Section, Semi-Wet, Semi-Dry, Dry Goods)[m
[32m+[m[32m                        $vendorsQuery->whereHas('section', function($query) {[m
[32m+[m[32m                            $query->whereIn('name', ['Wet Section', 'Wet']);[m
[32m+[m[32m                        });[m
[32m+[m[32m                    }[m
[32m+[m
[32m+[m[32m                    $recipients = $vendorsQuery->get();[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            // Add staff if selected[m
[32m+[m[32m            if (!empty($recipientSettings['staff']) || empty($recipientSettings)) {[m
[32m+[m[32m                $staff = User::whereHas('role', function($query) {[m
[32m+[m[32m                    $query->whereIn('name', ['Staff', 'Meter Reader Clerk']);[m
[32m+[m[32m                })[m
[32m+[m[32m                ->active()[m
[32m+[m[32m                ->whereNotNull('contact_number')[m
[32m+[m[32m                ->get();[m
[32m+[m
[32m+[m[32m                $recipients = $recipients->merge($staff);[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
[32m+[m[32m            Log::info("Sending announcement SMS to {$recipients->count()} recipients");[m
[32m+[m
[32m+[m[32m            $message = "ANNOUNCEMENT: {$announcement->title}\n\n{$announcement->content}\n\n- Virac Public Market";[m
[32m+[m
[32m+[m[32m            $successCount = 0;[m
[32m+[m[32m            $failCount = 0;[m
[32m+[m
[32m+[m[32m            foreach ($recipients as $user) {[m
[32m+[m[32m                $contactNumber = $user->getSemaphoreReadyContactNumber();[m
[32m+[m[32m                if ($contactNumber) {[m
[32m+[m[32m                    $result = $smsService->send($contactNumber, $message);[m
[32m+[m[32m                    if ($result['success']) {[m
[32m+[m[32m                        $successCount++;[m
[32m+[m[32m                    } else {[m
[32m+[m[32m                        $failCount++;[m
[32m+[m[32m                        Log::warning("Failed to send announcement SMS to user {$user->id}: {$result['message']}");[m
[32m+[m[32m                    }[m
[32m+[m[32m                } else {[m
[32m+[m[32m                    $failCount++;[m
[32m+[m[32m                    Log::warning("Skipping user {$user->id} - no valid contact number");[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            Log::info("Announcement SMS sent: {$successCount} successful, {$failCount} failed");[m
[32m+[m[32m        } catch (\Exception $e) {[m
[32m+[m[32m            Log::error("Error sending announcement SMS: " . $e->getMessage());[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Create in-app notifications for selected recipients when announcement is created/activated[m
[32m+[m[32m     */[m
[32m+[m[32m    private function createAnnouncementNotifications(Announcement $announcement)[m
[32m+[m[32m    {[m
[32m+[m[32m        try {[m
[32m+[m[32m            $recipients = collect();[m
[32m+[m[32m            $recipientSettings = $announcement->recipients ?? [];[m
[32m+[m
[32m+[m[32m            // Get vendors based on recipient settings[m
[32m+[m[32m            if (!empty($recipientSettings['all_sections']) || !empty($recipientSettings['sections'])) {[m
[32m+[m[32m                $vendorsQuery = User::vendors()[m
[32m+[m[32m                    ->active();[m
[32m+[m
[32m+[m[32m                // If "All Sections" is selected, get all vendors[m
[32m+[m[32m                // Otherwise, filter by specific sections[m
[32m+[m[32m                if (empty($recipientSettings['all_sections']) && !empty($recipientSettings['sections']) && is_array($recipientSettings['sections'])) {[m
[32m+[m[32m                    $vendorsQuery->whereHas('section', function($query) use ($recipientSettings) {[m
[32m+[m[32m                        $query->whereIn('name', $recipientSettings['sections']);[m
[32m+[m[32m                    });[m
[32m+[m[32m                }[m
[32m+[m
[32m+[m[32m                $vendors = $vendorsQuery->get();[m
[32m+[m[32m                $recipients = $recipients->merge($vendors);[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            // Legacy support: if no recipients specified, use old logic[m
[32m+[m[32m            if ($recipients->isEmpty() && empty($recipientSettings)) {[m
[32m+[m[32m                // For rent announcements, only send to the specific vendor who owns the stall[m
[32m+[m[32m                if ($announcement->related_utility === 'Rent' && $announcement->related_stall_id) {[m
[32m+[m[32m                    $stall = \App\Models\Stall::with('vendor')->find($announcement->related_stall_id);[m
[32m+[m[32m                    if ($stall && $stall->vendor) {[m
[32m+[m[32m                        $recipients = collect([$stall->vendor]);[m
[32m+[m[32m                    }[m
[32m+[m[32m                } else {[m
[32m+[m[32m                    // Get all vendors[m
[32m+[m[32m                    $vendorsQuery = User::vendors()[m
[32m+[m[32m                        ->active();[m
[32m+[m
[32m+[m[32m                    // Filter vendors by section if this is a water-related announcement[m
[32m+[m[32m                    if ($announcement->related_utility === 'Water') {[m
[32m+[m[32m                        // Only send to vendors in Wet Section (exclude Dry Section, Semi-Wet, Semi-Dry, Dry Goods)[m
[32m+[m[32m                        $vendorsQuery->whereHas('section', function($query) {[m
[32m+[m[32m                            $query->whereIn('name', ['Wet Section', 'Wet']);[m
[32m+[m[32m                        });[m
[32m+[m[32m                    }[m
[32m+[m
[32m+[m[32m                    $recipients = $vendorsQuery->get();[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            // Add staff if selected[m
[32m+[m[32m            if (!empty($recipientSettings['staff']) || empty($recipientSettings)) {[m
[32m+[m[32m                $staff = User::whereHas('role', function($query) {[m
[32m+[m[32m                    $query->whereIn('name', ['Staff', 'Meter Reader Clerk']);[m
[32m+[m[32m                })[m
[32m+[m[32m                ->active()[m
[32m+[m[32m                ->get();[m
[32m+[m
[32m+[m[32m                $recipients = $recipients->merge($staff);[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
[32m+[m[32m            Log::info("Creating in-app notifications for announcement to {$recipients->count()} recipients");[m
[32m+[m
[32m+[m[32m            $adminUser = User::whereHas('role', function($query) {[m
[32m+[m[32m                $query->where('name', 'Admin');[m
[32m+[m[32m            })->first();[m
[32m+[m
[32m+[m[32m            $senderId = $adminUser ? $adminUser->id : null;[m
[32m+[m[32m            $now = now();[m
[32m+[m
[32m+[m[32m            // Prepare notification data[m
[32m+[m[32m            $notificationData = [];[m
[32m+[m[32m            foreach ($recipients as $user) {[m
[32m+[m[32m                $notificationData[] = [[m
[32m+[m[32m                    'recipient_id' => $user->id,[m
[32m+[m[32m                    'sender_id' => $senderId,[m
[32m+[m[32m                    'channel' => 'in_app',[m
[32m+[m[32m                    'title' => $announcement->title,[m
[32m+[m[32m                    'message' => json_encode([[m
[32m+[m[32m                        'text' => $announcement->content,[m
[32m+[m[32m                        'type' => 'announcement',[m
[32m+[m[32m                        'announcement_id' => $announcement->id,[m
[32m+[m[32m                    ]),[m
[32m+[m[32m                    'status' => 'sent',[m
[32m+[m[32m                    'sent_at' => $now,[m
[32m+[m[32m                    'created_at' => $now,[m
[32m+[m[32m                    'updated_at' => $now,[m
[32m+[m[32m                ];[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            // Insert notifications in batches for better performance[m
[32m+[m[32m            if (!empty($notificationData)) {[m
[32m+[m[32m                DB::table('notifications')->insert($notificationData);[m
[32m+[m[32m                Log::info("Created {$recipients->count()} in-app notifications for announcement");[m
[32m+[m[32m            }[m
[32m+[m[32m        } catch (\Exception $e) {[m
[32m+[m[32m            Log::error("Error creating announcement notifications: " . $e->getMessage());[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
 }[m
[1mdiff --git a/app/Http/Controllers/Api/BillingSettingsController.php b/app/Http/Controllers/Api/BillingSettingsController.php[m
[1mindex c12e2c9..5450876 100644[m
[1m--- a/app/Http/Controllers/Api/BillingSettingsController.php[m
[1m+++ b/app/Http/Controllers/Api/BillingSettingsController.php[m
[36m@@ -11,6 +11,7 @@[m
 use Illuminate\Support\Facades\Cache;[m
 use App\Models\AuditTrail;[m
 use App\Services\AuditLogger;[m
[32m+[m[32muse App\Services\AnnouncementService;[m
 [m
 class BillingSettingsController extends Controller[m
 {[m
[36m@@ -62,15 +63,32 @@[m [mpublic function update(Request $request)[m
                     foreach ($fieldsToCompare as $field) {[m
                         // Check if the field exists in the submitted data and is different from the DB value[m
                         if (isset($settingData[$field]) && $setting->$field != $settingData[$field]) {[m
[32m+[m[32m                            $oldValue = $setting->$field;[m
[32m+[m[32m                            $newValue = $settingData[$field];[m
[32m+[m[41m                            [m
                             $changes[] = [[m
                                 'billing_setting_id' => $setting->id,[m
                                 'changed_by' => $request->user_id, // Use user_id from the request[m
                                 'field_changed' => str_replace('_', ' ', ucwords($field, '_')), // Format for readability[m
[31m-                                'old_value' => $setting->$field * 100, // Store as percentage[m
[31m-                                'new_value' => $settingData[$field] * 100, // Store as percentage[m
[32m+[m[32m                                'old_value' => $oldValue * 100, // Store as percentage[m
[32m+[m[32m                                'new_value' => $newValue * 100, // Store as percentage[m
                                 'changed_at' => now(),[m
                             ];[m
[31m-                            $setting->$field = $settingData[$field];[m
[32m+[m[32m                            $setting->$field = $newValue;[m
[32m+[m
[32m+[m[32m                            // Create draft announcement for billing setting change[m
[32m+[m[32m                            try {[m
[32m+[m[32m                                $announcementService = new AnnouncementService();[m
[32m+[m[32m                                $announcementService->createBillingSettingChangeAnnouncement([m
[32m+[m[32m                                    $setting->utility_type,[m
[32m+[m[32m                                    $field,[m
[32m+[m[32m                                    $oldValue,[m
[32m+[m[32m                                    $newValue[m
[32m+[m[32m                                );[m
[32m+[m[32m                            } catch (\Exception $e) {[m
[32m+[m[32m                                // Log error but don't fail the transaction[m
[32m+[m[32m                                \Illuminate\Support\Facades\Log::error('Failed to create billing setting change announcement: ' . $e->getMessage());[m
[32m+[m[32m                            }[m
                         }[m
                     }[m
 [m
[36m@@ -80,6 +98,9 @@[m [mpublic function update(Request $request)[m
                         $allChanges = array_merge($allChanges, $changes);[m
                     }[m
                 }[m
[32m+[m[41m                [m
[32m+[m[32m                // Clear cache when settings are updated[m
[32m+[m[32m                Cache::forget('billing_settings');[m
 [m
                 if (!empty($allChanges)) {[m
                     AuditLogger::log([m
[1mdiff --git a/app/Http/Controllers/Api/DashboardController.php b/app/Http/Controllers/Api/DashboardController.php[m
[1mindex 144b83f..06c2da2 100644[m
[1m--- a/app/Http/Controllers/Api/DashboardController.php[m
[1m+++ b/app/Http/Controllers/Api/DashboardController.php[m
[36m@@ -186,6 +186,23 @@[m [mpublic function getTopPerformingVendors(Request $request)[m
     {[m
         $year = $request->input('year', Carbon::now()->year);[m
 [m
[32m+[m[32m        // Get vendor IDs that need support (have overdue bills) to exclude them[m
[32m+[m[32m        // Apply section filter if provided[m
[32m+[m[32m        $vendorsNeedingSupportQuery = User::whereHas('role', fn ($q) => $q->where('name', 'Vendor'))[m
[32m+[m[32m            ->whereHas('billings', function ($query) use ($year) {[m
[32m+[m[32m                $query->whereYear('period_start', $year)[m
[32m+[m[32m                    ->where('status', 'unpaid')[m
[32m+[m[32m                    ->where('due_date', '<', now());[m
[32m+[m[32m            });[m
[32m+[m
[32m+[m[32m        // Apply section filter to exclusion query if provided[m
[32m+[m[32m        if ($request->filled('section') && $request->section !== 'All') {[m
[32m+[m[32m            $sectionName = $request->section;[m
[32m+[m[32m            $vendorsNeedingSupportQuery->whereHas('stall.section', fn($q) => $q->where('name', $sectionName));[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        $vendorsNeedingSupportIds = $vendorsNeedingSupportQuery->pluck('id')->toArray();[m
[32m+[m
         // Start building the query[m
         $query = DB::table('users')[m
             ->join('stalls', 'users.id', '=', 'stalls.vendor_id')[m
[36m@@ -195,6 +212,11 @@[m [mpublic function getTopPerformingVendors(Request $request)[m
             ->where('billing.status', 'paid')[m
             ->whereYear('billing.period_start', $year);[m
 [m
[32m+[m[32m        // Exclude vendors that need support[m
[32m+[m[32m        if (!empty($vendorsNeedingSupportIds)) {[m
[32m+[m[32m            $query->whereNotIn('users.id', $vendorsNeedingSupportIds);[m
[32m+[m[32m        }[m
[32m+[m
         // âœ… **FIX APPLIED HERE**[m
         // This block checks if a section filter was provided in the request.[m
         // If it exists and isn't "All", it adds a 'where' clause to the query[m
[36m@@ -234,54 +256,66 @@[m [mpublic function getTopPerformingVendors(Request $request)[m
 [m
     /**[m
      * âœ… OPTIMIZED VERSION: Fetch top 5 vendors with the most overdue bills, with section filtering.[m
[32m+[m[32m     * Note: No need to exclude top performers here since top performers already exclude vendors with overdue bills.[m
      */[m
     public function getVendorsNeedingSupport(Request $request)[m
 {[m
     // Add year variable[m
     $year = $request->input('year', Carbon::now()->year);[m
 [m
[31m-    $query = User::whereHas('role', fn ($q) => $q->where('name', 'Vendor'))[m
[31m-        ->whereHas('billings', function ($query) use ($year) {[m
[31m-            $query->whereYear('period_start', $year)[m
[31m-                ->where('status', 'unpaid')[m
[31m-                ->where('due_date', '<', now());[m
[31m-        })[m
[31m-        ->with(['stall:id,vendor_id,table_number', 'billings' => function ($query) use ($year) {[m
[31m-            // Apply year filter[m
[31m-            $query->whereYear('period_start', $year)[m
[31m-                  ->where('status', 'unpaid')[m
[31m-                  ->where('due_date', '<', now())[m
[31m-                  ->select('stall_id', 'utility_type', 'period_start', 'amount');[m
[31m-        }])[m
[31m-        ->withCount(['billings as overdue_bills_count' => function ($query) use ($year) {[m
[31m-            // Apply year filter[m
[31m-            $query->whereYear('period_start', $year)->where('status', 'unpaid')->where('due_date', '<', now());[m
[31m-        }]);[m
[31m-[m
[32m+[m[32m    // Use direct DB query to avoid hasManyThrough relationship issues[m
[32m+[m[32m    $query = DB::table('users')[m
[32m+[m[32m        ->join('roles', 'users.role_id', '=', 'roles.id')[m
[32m+[m[32m        ->join('stalls', 'users.id', '=', 'stalls.vendor_id')[m
[32m+[m[32m        ->join('billing', 'stalls.id', '=', 'billing.stall_id')[m
[32m+[m[32m        ->where('roles.name', 'Vendor')[m
[32m+[m[32m        ->whereYear('billing.period_start', $year)[m
[32m+[m[32m        ->where('billing.status', 'unpaid')[m
[32m+[m[32m        ->where('billing.due_date', '<', now());[m
[32m+[m
[32m+[m[32m    // Apply section filter if provided[m
     if ($request->filled('section') && $request->section !== 'All') {[m
[31m-        $sectionName = $request->section;[m
[31m-        $query->whereHas('stall.section', fn($q) => $q->where('name', $sectionName));[m
[32m+[m[32m        $query->join('sections', 'stalls.section_id', '=', 'sections.id')[m
[32m+[m[32m              ->where('sections.name', $request->section);[m
     }[m
 [m
[31m-    $paginatedVendors = $query[m
[31m-            ->orderByDesc('overdue_bills_count')[m
[31m-            ->paginate(15);[m
[32m+[m[32m    // Get vendors with overdue bills count[m
[32m+[m[32m    $vendorStats = $query->select([m
[32m+[m[32m            'users.id',[m
[32m+[m[32m            'users.name',[m
[32m+[m[32m            'stalls.table_number',[m
[32m+[m[32m            DB::raw('COUNT(billing.id) as overdue_bills_count')[m
[32m+[m[32m        )[m
[32m+[m[32m        ->groupBy('users.id', 'users.name', 'stalls.table_number')[m
[32m+[m[32m        ->orderByDesc('overdue_bills_count')[m
[32m+[m[32m        ->limit(5)[m
[32m+[m[32m        ->get();[m
[32m+[m
[32m+[m[32m    // Get detailed overdue bills for each vendor[m
[32m+[m[32m    $formattedVendors = $vendorStats->map(function ($vendor) use ($year) {[m
[32m+[m[32m        $overdueBills = DB::table('billing')[m
[32m+[m[32m            ->join('stalls', 'billing.stall_id', '=', 'stalls.id')[m
[32m+[m[32m            ->where('stalls.vendor_id', $vendor->id)[m
[32m+[m[32m            ->whereYear('billing.period_start', $year)[m
[32m+[m[32m            ->where('billing.status', 'unpaid')[m
[32m+[m[32m            ->where('billing.due_date', '<', now())[m
[32m+[m[32m            ->select('billing.utility_type', 'billing.period_start')[m
[32m+[m[32m            ->get();[m
 [m
[31m-    $paginatedVendors->getCollection()->transform(function ($vendor) {[m
[31m-        $overdueDetails = $vendor->billings->map(function ($bill) {[m
[32m+[m[32m        $overdueDetails = $overdueBills->map(function ($bill) {[m
             return $bill->utility_type . ' - ' . \Carbon\Carbon::parse($bill->period_start)->format('F Y');[m
         });[m
 [m
         return [[m
             'id' => $vendor->id,[m
             'name' => $vendor->name,[m
[31m-            'stall_number' => $vendor->stall->table_number ?? 'N/A',[m
[32m+[m[32m            'stall_number' => $vendor->table_number ?? 'N/A',[m
             'metric' => $vendor->overdue_bills_count . ' Overdue Bill(s)',[m
[31m-            'overdue_bills_details' => $overdueDetails,[m
[32m+[m[32m            'overdue_bills_details' => $overdueDetails->toArray(),[m
         ];[m
     });[m
 [m
[31m-    return response()->json($paginatedVendors);[m
[32m+[m[32m    return response()->json($formattedVendors);[m
     }[m
     [m
 }[m
\ No newline at end of file[m
[1mdiff --git a/app/Http/Controllers/Api/RentalRateController.php b/app/Http/Controllers/Api/RentalRateController.php[m
[1mindex 1ae8848..4b3fc85 100644[m
[1m--- a/app/Http/Controllers/Api/RentalRateController.php[m
[1m+++ b/app/Http/Controllers/Api/RentalRateController.php[m
[36m@@ -7,6 +7,7 @@[m
 use Illuminate\Support\Facades\DB;[m
 use App\Models\Stall; // It's better to use the model[m
 use App\Services\AuditLogger;[m
[32m+[m[32muse App\Services\AnnouncementService;[m
 [m
 class RentalRateController extends Controller[m
 {[m
[36m@@ -115,30 +116,180 @@[m [mpublic function batchUpdate(Request $request)[m
         ]);[m
 [m
         DB::transaction(function () use ($validatedData) {[m
[32m+[m[32m            $announcementService = new AnnouncementService();[m
[32m+[m[32m            $auditDetails = [[m
[32m+[m[32m                'count' => count($validatedData['stalls']),[m
[32m+[m[32m                'changes' => [][m
[32m+[m[32m            ];[m
[32m+[m[41m            [m
             foreach ($validatedData['stalls'] as $stallData) {[m
[31m-                $stall = Stall::find($stallData['id']);[m
[32m+[m[32m                $stall = Stall::with('section')->find($stallData['id']);[m
                 if ($stall) {[m
[32m+[m[32m                    // Capture old values BEFORE update[m
[32m+[m[32m                    $oldDailyRate = (float) $stall->daily_rate;[m
[32m+[m[32m                    $oldMonthlyRate = (float) $stall->monthly_rate;[m
[32m+[m[32m                    $oldTableNumber = $stall->table_number;[m
[32m+[m[32m                    $newDailyRate = (float) $stallData['dailyRate'];[m
[32m+[m[41m                    [m
[32m+[m[32m                    // Calculate new monthly rate (typically daily_rate * 30, but check if it's stored)[m
[32m+[m[32m                    $newMonthlyRate = isset($stallData['monthlyRate']) ? (float) $stallData['monthlyRate'] : ($newDailyRate * 30);[m
[32m+[m[41m                    [m
                     $stall->update([[m
                         'table_number' => $stallData['tableNumber'],[m
[31m-                        'daily_rate' => $stallData['dailyRate'],[m
[31m-                        // 'monthly_rate' => $stallData['monthlyRate'], // <-- REMOVE THIS LINE[m
[32m+[m[32m                        'daily_rate' => $newDailyRate,[m
                         'area' => $stallData['area'],[m
                     ]);[m
[32m+[m[41m                    [m
[32m+[m[32m                    // Refresh to get updated monthly_rate if it's calculated by DB[m
[32m+[m[32m                    $stall->refresh();[m
[32m+[m[32m                    $newMonthlyRate = (float) $stall->monthly_rate;[m
[32m+[m[41m                    [m
[32m+[m[32m                    // Create draft announcement if rates changed[m
[32m+[m[32m                    // Use small epsilon for floating point comparison[m
[32m+[m[32m                    $epsilon = 0.01;[m
[32m+[m[32m                    $dailyRateChanged = abs($oldDailyRate - $newDailyRate) > $epsilon;[m
[32m+[m[32m                    $monthlyRateChanged = abs($oldMonthlyRate - $newMonthlyRate) > $epsilon;[m
[32m+[m[32m                    $tableNumberChanged = $oldTableNumber !== $stallData['tableNumber'];[m
[32m+[m[41m                    [m
[32m+[m[32m                    // Only store change details for audit log if something actually changed[m
[32m+[m[32m                    if ($dailyRateChanged || $monthlyRateChanged || $tableNumberChanged) {[m
[32m+[m[32m                        $auditDetails['changes'][] = [[m
[32m+[m[32m                            'id' => $stall->id,[m
[32m+[m[32m                            'table_number' => $stallData['tableNumber'],[m
[32m+[m[32m                            'old_table_number' => $oldTableNumber,[m
[32m+[m[32m                            'section' => $stall->section->name ?? 'N/A',[m
[32m+[m[32m                            'old_daily_rate' => $oldDailyRate,[m
[32m+[m[32m                            'new_daily_rate' => $newDailyRate,[m
[32m+[m[32m                            'old_monthly_rate' => $oldMonthlyRate,[m
[32m+[m[32m                            'new_monthly_rate' => $newMonthlyRate,[m
[32m+[m[32m                        ];[m
[32m+[m[32m                    }[m
[32m+[m[41m                    [m
[32m+[m[32m                    if ($dailyRateChanged || $monthlyRateChanged) {[m
[32m+[m[32m                        try {[m
[32m+[m[32m                            \Illuminate\Support\Facades\Log::info('Creating rental rate change announcement', [[m
[32m+[m[32m                                'stall_id' => $stall->id,[m
[32m+[m[32m                                'table_number' => $stall->table_number,[m
[32m+[m[32m                                'old_daily' => $oldDailyRate,[m
[32m+[m[32m                                'new_daily' => $newDailyRate,[m
[32m+[m[32m                                'old_monthly' => $oldMonthlyRate,[m
[32m+[m[32m                                'new_monthly' => $newMonthlyRate,[m
[32m+[m[32m                            ]);[m
[32m+[m[41m                            [m
[32m+[m[32m                            $announcement = $announcementService->createRentalRateChangeAnnouncement([m
[32m+[m[32m                                $stall,[m
[32m+[m[32m                                $oldDailyRate,[m
[32m+[m[32m                                $newDailyRate,[m
[32m+[m[32m                                $oldMonthlyRate,[m
[32m+[m[32m                                $newMonthlyRate[m
[32m+[m[32m                            );[m
[32m+[m[41m                            [m
[32m+[m[32m                            if ($announcement) {[m
[32m+[m[32m                                \Illuminate\Support\Facades\Log::info('Rental rate change announcement created successfully', [[m
[32m+[m[32m                                    'announcement_id' => $announcement->id,[m
[32m+[m[32m                                    'stall_id' => $stall->id,[m
[32m+[m[32m                                ]);[m
[32m+[m[32m                            }[m
[32m+[m[32m                        } catch (\Exception $e) {[m
[32m+[m[32m                            // Log error but don't fail the transaction[m
[32m+[m[32m                            \Illuminate\Support\Facades\Log::error('Failed to create rental rate change announcement', [[m
[32m+[m[32m                                'stall_id' => $stall->id,[m
[32m+[m[32m                                'error' => $e->getMessage(),[m
[32m+[m[32m                                'trace' => $e->getTraceAsString(),[m
[32m+[m[32m                            ]);[m
[32m+[m[32m                        }[m
[32m+[m[32m                    } else {[m
[32m+[m[32m                        \Illuminate\Support\Facades\Log::debug('No rate change detected for stall', [[m
[32m+[m[32m                            'stall_id' => $stall->id,[m
[32m+[m[32m                            'old_daily' => $oldDailyRate,[m
[32m+[m[32m                            'new_daily' => $newDailyRate,[m
[32m+[m[32m                            'old_monthly' => $oldMonthlyRate,[m
[32m+[m[32m                            'new_monthly' => $newMonthlyRate,[m
[32m+[m[32m                        ]);[m
[32m+[m[32m                    }[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
[32m+[m[32m            // Only log if there were actual changes[m
[32m+[m[32m            if (count($auditDetails['changes']) > 0) {[m
[32m+[m[32m                AuditLogger::log([m
[32m+[m[32m                    'Updated Rental Rates',[m
[32m+[m[32m                    'Rental Rates',[m
[32m+[m[32m                    'Success',[m
[32m+[m[32m                    $auditDetails[m
[32m+[m[32m                );[m
[32m+[m[32m            }[m
[32m+[m[32m        });[m
[32m+[m
[32m+[m[32m        return response()->json(['message' => 'Rates updated successfully!']);[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Update a specific stall's rental rate.[m
[32m+[m[32m     */[m
[32m+[m[32m    public function update(Request $request, $stall)[m
[32m+[m[32m    {[m
[32m+[m[32m        $validatedData = $request->validate([[m
[32m+[m[32m            'tableNumber' => 'sometimes|string',[m
[32m+[m[32m            'dailyRate' => 'sometimes|numeric|min:0',[m
[32m+[m[32m            'area' => 'sometimes|numeric|min:0',[m
[32m+[m[32m        ]);[m
[32m+[m
[32m+[m[32m        DB::transaction(function () use ($validatedData, $stall) {[m
[32m+[m[32m            $stallModel = Stall::with('section')->find($stall);[m
[32m+[m[41m            [m
[32m+[m[32m            if (!$stallModel) {[m
[32m+[m[32m                throw new \Exception('Stall not found.');[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            $oldDailyRate = (float) $stallModel->daily_rate;[m
[32m+[m[32m            $oldMonthlyRate = (float) $stallModel->monthly_rate;[m
[32m+[m[41m            [m
[32m+[m[32m            $stallModel->update(array_filter($validatedData));[m
[32m+[m[32m            $stallModel->refresh();[m
[32m+[m[41m            [m
[32m+[m[32m            $newDailyRate = (float) $stallModel->daily_rate;[m
[32m+[m[32m            $newMonthlyRate = (float) $stallModel->monthly_rate;[m
[32m+[m[41m            [m
[32m+[m[32m            // Create draft announcement if rates changed[m
[32m+[m[32m            if ($oldDailyRate !== $newDailyRate || $oldMonthlyRate !== $newMonthlyRate) {[m
[32m+[m[32m                try {[m
[32m+[m[32m                    $announcementService = new AnnouncementService();[m
[32m+[m[32m                    $announcementService->createRentalRateChangeAnnouncement([m
[32m+[m[32m                        $stallModel,[m
[32m+[m[32m                        $oldDailyRate,[m
[32m+[m[32m                        $newDailyRate,[m
[32m+[m[32m                        $oldMonthlyRate,[m
[32m+[m[32m                        $newMonthlyRate[m
[32m+[m[32m                    );[m
[32m+[m[32m                } catch (\Exception $e) {[m
[32m+[m[32m                    \Illuminate\Support\Facades\Log::error('Failed to create rental rate change announcement: ' . $e->getMessage());[m
                 }[m
             }[m
             [m
[32m+[m[32m            // Store audit details with old/new values[m
[32m+[m[32m            $auditDetails = [[m
[32m+[m[32m                'stall_id' => $stallModel->id,[m
[32m+[m[32m                'table_number' => $stallModel->table_number,[m
[32m+[m[32m                'section' => $stallModel->section->name ?? 'N/A',[m
[32m+[m[32m                'old_daily_rate' => $oldDailyRate,[m
[32m+[m[32m                'new_daily_rate' => $newDailyRate,[m
[32m+[m[32m                'old_monthly_rate' => $oldMonthlyRate,[m
[32m+[m[32m                'new_monthly_rate' => $newMonthlyRate,[m
[32m+[m[32m            ];[m
[32m+[m[41m            [m
             AuditLogger::log([m
[31m-                'Updated Rental Rates',[m
[32m+[m[32m                'Updated Rental Rate',[m
                 'Rental Rates',[m
                 'Success',[m
[31m-                ['count' => count($validatedData['stalls']), 'changes' => $validatedData['stalls']][m
[32m+[m[32m                $auditDetails[m
             );[m
         });[m
 [m
[31m-        return response()->json(['message' => 'Rates updated successfully!']);[m
[32m+[m[32m        return response()->json(['message' => 'Rental rate updated successfully!']);[m
     }[m
 [m
[31m-[m
     /**[m
      * Remove the specified resource from storage.[m
      */[m
[36m@@ -156,4 +307,212 @@[m [mpublic function destroy($id)[m
         }[m
         return response()->json(null, 204);[m
     }[m
[32m+[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Get the history of rental rate changes.[m
[32m+[m[32m     */[m
[32m+[m[32m    public function history(Request $request)[m
[32m+[m[32m    {[m
[32m+[m[32m        $page = $request->input('page', 1);[m
[32m+[m
[32m+[m[32m        // Get rental rate changes from audit trails[m
[32m+[m[32m        // Check if details column exists, if not, select without it[m
[32m+[m[32m        $hasDetailsColumn = DB::getSchemaBuilder()->hasColumn('audit_trails', 'details');[m
[32m+[m[41m        [m
[32m+[m[32m        $selectFields = ['id', 'action', 'created_at as changed_at'];[m
[32m+[m[32m        if ($hasDetailsColumn) {[m
[32m+[m[32m            $selectFields[] = 'details';[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        // Debug: Log what we're querying[m
[32m+[m[32m        \Log::info('Rental Rate History Query', [[m
[32m+[m[32m            'hasDetailsColumn' => $hasDetailsColumn,[m
[32m+[m[32m            'selectFields' => $selectFields[m
[32m+[m[32m        ]);[m
[32m+[m[41m        [m
[32m+[m[32m        // Query audit trails for rental rate changes[m
[32m+[m[32m        // Try to match the exact action names used in AuditLogger::log calls[m
[32m+[m[32m        $historyData = DB::table('audit_trails')[m
[32m+[m[32m            ->where('module', 'Rental Rates')[m
[32m+[m[32m            ->where(function ($query) {[m
[32m+[m[32m                $query->where('action', 'Updated Rental Rate')[m
[32m+[m[32m                      ->orWhere('action', 'Updated Rental Rates')[m
[32m+[m[32m                      ->orWhere('action', 'Created Stall')[m
[32m+[m[32m                      ->orWhere('action', 'Deleted Stall');[m
[32m+[m[32m            })[m
[32m+[m[32m            ->select($selectFields)[m
[32m+[m[32m            ->orderBy('created_at', 'desc')[m
[32m+[m[32m            ->paginate(20);[m
[32m+[m[41m        [m
[32m+[m[32m        // Debug: Log what we found[m
[32m+[m[32m        \Log::info('Rental Rate History Query Results', [[m
[32m+[m[32m            'total_found' => $historyData->total(),[m
[32m+[m[32m            'count' => $historyData->count(),[m
[32m+[m[32m            'has_details_column' => $hasDetailsColumn,[m
[32m+[m[32m            'first_record' => $historyData->first() ? [[m
[32m+[m[32m                'id' => $historyData->first()->id ?? null,[m
[32m+[m[32m                'action' => $historyData->first()->action ?? null,[m
[32m+[m[32m                'has_details' => isset($historyData->first()->details),[m
[32m+[m[32m                'details_preview' => isset($historyData->first()->details) ? substr($historyData->first()->details, 0, 100) : null,[m
[32m+[m[32m            ] : null[m
[32m+[m[32m        ]);[m
[32m+[m[41m        [m
[32m+[m[32m        // If no results, try a broader query to see what actions exist[m
[32m+[m[32m        if ($historyData->total() === 0) {[m
[32m+[m[32m            $sampleActions = DB::table('audit_trails')[m
[32m+[m[32m                ->where('module', 'Rental Rates')[m
[32m+[m[32m                ->select('action')[m
[32m+[m[32m                ->distinct()[m
[32m+[m[32m                ->pluck('action');[m
[32m+[m[41m            [m
[32m+[m[32m            $allModules = DB::table('audit_trails')[m
[32m+[m[32m                ->select('module')[m
[32m+[m[32m                ->distinct()[m
[32m+[m[32m                ->pluck('module');[m
[32m+[m[41m            [m
[32m+[m[32m            $totalRentalRatesRecords = DB::table('audit_trails')[m
[32m+[m[32m                ->where('module', 'Rental Rates')[m
[32m+[m[32m                ->count();[m
[32m+[m[41m            [m
[32m+[m[32m            \Log::info('No rental rate history found. Debug info:', [[m
[32m+[m[32m                'actions_for_rental_rates' => $sampleActions->toArray(),[m
[32m+[m[32m                'all_modules' => $allModules->toArray(),[m
[32m+[m[32m                'total_audit_records' => DB::table('audit_trails')->count(),[m
[32m+[m[32m                'total_rental_rates_records' => $totalRentalRatesRecords,[m
[32m+[m[32m                'sample_actions_all_modules' => DB::table('audit_trails')[m
[32m+[m[32m                    ->select('module', 'action')[m
[32m+[m[32m                    ->distinct()[m
[32m+[m[32m                    ->get()[m
[32m+[m[32m                    ->map(function($item) {[m
[32m+[m[32m                        return $item->module . ' - ' . $item->action;[m
[32m+[m[32m                    })[m
[32m+[m[32m                    ->take(20)[m
[32m+[m[32m                    ->toArray()[m
[32m+[m[32m            ]);[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        // Debug: Log what we found (already logged above)[m
[32m+[m
[32m+[m[32m        // Transform the data to match the expected format[m
[32m+[m[32m        // For batch updates, we need to expand each change into a separate entry[m
[32m+[m[32m        $expandedHistory = collect();[m
[32m+[m[41m        [m
[32m+[m[32m        $historyData->getCollection()->each(function ($item) use ($hasDetailsColumn, $expandedHistory) {[m
[32m+[m[32m            $details = [];[m
[32m+[m[32m            if ($hasDetailsColumn && isset($item->details) && !empty($item->details)) {[m
[32m+[m[32m                $details = json_decode($item->details, true) ?? [];[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
[32m+[m[32m            // Check if this is a batch update with multiple changes[m
[32m+[m[32m            if (isset($details['changes']) && is_array($details['changes']) && count($details['changes']) > 0) {[m
[32m+[m[32m                // Expand each change into a separate history entry[m
[32m+[m[32m                foreach ($details['changes'] as $change) {[m
[32m+[m[32m                    $expandedHistory->push((object) [[m
[32m+[m[32m                        'id' => $item->id . '_' . ($change['id'] ?? ''),[m
[32m+[m[32m                        'action' => $item->action,[m
[32m+[m[32m                        'table_number' => $change['table_number'] ?? 'N/A',[m
[32m+[m[32m                        'section' => $change['section'] ?? 'N/A',[m
[32m+[m[32m                        'stall_id' => $change['id'] ?? null,[m
[32m+[m[32m                        'old_daily_rate' => isset($change['old_daily_rate']) ? (float) $change['old_daily_rate'] : null,[m
[32m+[m[32m                        'new_daily_rate' => isset($change['new_daily_rate']) ? (float) $change['new_daily_rate'] : null,[m
[32m+[m[32m                        'old_monthly_rate' => isset($change['old_monthly_rate']) ? (float) $change['old_monthly_rate'] : null,[m
[32m+[m[32m                        'new_monthly_rate' => isset($change['new_monthly_rate']) ? (float) $change['new_monthly_rate'] : null,[m
[32m+[m[32m                        'changed_at' => (new \DateTime($item->changed_at))->format(\DateTime::ATOM),[m
[32m+[m[32m                    ]);[m
[32m+[m[32m                }[m
[32m+[m[32m            } else {[m
[32m+[m[32m                // Single update - extract from details[m
[32m+[m[32m                $tableNumber = $details['table_number'] ?? 'N/A';[m
[32m+[m[32m                $section = $details['section'] ?? '';[m
[32m+[m[32m                $stallId = $details['stall_id'] ?? null;[m
[32m+[m[32m                $oldDailyRate = isset($details['old_daily_rate']) ? (float) $details['old_daily_rate'] : null;[m
[32m+[m[32m                $newDailyRate = isset($details['new_daily_rate']) ? (float) $details['new_daily_rate'] : null;[m
[32m+[m[32m                $oldMonthlyRate = isset($details['old_monthly_rate']) ? (float) $details['old_monthly_rate'] : null;[m
[32m+[m[32m                $newMonthlyRate = isset($details['new_monthly_rate']) ? (float) $details['new_monthly_rate'] : null;[m
[32m+[m[41m                [m
[32m+[m[32m                // If we don't have rate info but have stall_id, try to get it from the database[m
[32m+[m[32m                if (($oldDailyRate === null || $newDailyRate === null) && isset($details['stall_id'])) {[m
[32m+[m[32m                    $stall = DB::table('stalls')[m
[32m+[m[32m                        ->join('sections', 'stalls.section_id', '=', 'sections.id')[m
[32m+[m[32m                        ->where('stalls.id', $details['stall_id'])[m
[32m+[m[32m                        ->select('stalls.table_number', 'sections.name as section')[m
[32m+[m[32m                        ->first();[m
[32m+[m[41m                    [m
[32m+[m[32m                    if ($stall) {[m
[32m+[m[32m                        $tableNumber = $stall->table_number;[m
[32m+[m[32m                        $section = $stall->section;[m
[32m+[m[32m                    }[m
[32m+[m[32m                }[m
[32m+[m[41m                [m
[32m+[m[32m                // Only add to history if we have at least some meaningful data[m
[32m+[m[32m                // Skip entries that have no rate information at all (old or new)[m
[32m+[m[32m                if ($oldDailyRate !== null || $newDailyRate !== null || $oldMonthlyRate !== null || $newMonthlyRate !== null || $tableNumber !== 'N/A') {[m
[32m+[m[32m                    $expandedHistory->push((object) [[m
[32m+[m[32m                        'id' => $item->id,[m
[32m+[m[32m                        'action' => $item->action,[m
[32m+[m[32m                        'table_number' => $tableNumber,[m
[32m+[m[32m                        'section' => $section,[m
[32m+[m[32m                        'stall_id' => $stallId,[m
[32m+[m[32m                        'old_daily_rate' => $oldDailyRate,[m
[32m+[m[32m                        'new_daily_rate' => $newDailyRate,[m
[32m+[m[32m                        'old_monthly_rate' => $oldMonthlyRate,[m
[32m+[m[32m                        'new_monthly_rate' => $newMonthlyRate,[m
[32m+[m[32m                        'changed_at' => (new \DateTime($item->changed_at))->format(\DateTime::ATOM),[m
[32m+[m[32m                    ]);[m
[32m+[m[32m                } else {[m
[32m+[m[32m                    // Log skipped entries for debugging[m
[32m+[m[32m                    \Log::debug('Skipped rental rate history entry (no rate data)', [[m
[32m+[m[32m                        'audit_id' => $item->id,[m
[32m+[m[32m                        'action' => $item->action,[m
[32m+[m[32m                        'has_details' => !empty($details),[m
[32m+[m[32m                        'details_keys' => array_keys($details)[m
[32m+[m[32m                    ]);[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m[32m        });[m
[32m+[m[41m        [m
[32m+[m[32m        // Replace the collection with expanded history[m
[32m+[m[32m        // Note: We need to manually paginate the expanded collection[m
[32m+[m[32m        $totalExpanded = $expandedHistory->count();[m
[32m+[m[32m        $perPage = 20;[m
[32m+[m[32m        $currentPage = request()->input('page', 1);[m
[32m+[m[32m        $offset = ($currentPage - 1) * $perPage;[m
[32m+[m[32m        $paginatedItems = $expandedHistory->slice($offset, $perPage)->values();[m
[32m+[m[41m        [m
[32m+[m[32m        // Create a custom paginator-like response[m
[32m+[m[32m        $hasMore = $currentPage < ceil($totalExpanded / $perPage);[m
[32m+[m[32m        $response = [[m
[32m+[m[32m            'data' => $paginatedItems->toArray(), // Convert collection to array[m
[32m+[m[32m            'current_page' => (int) $currentPage,[m
[32m+[m[32m            'per_page' => $perPage,[m
[32m+[m[32m            'total' => $totalExpanded,[m
[32m+[m[32m            'last_page' => (int) ceil($totalExpanded / $perPage),[m
[32m+[m[32m            'from' => $offset + 1,[m
[32m+[m[32m            'to' => min($offset + $perPage, $totalExpanded),[m
[32m+[m[32m            'has_more' => $hasMore,[m
[32m+[m[32m            'next_page_url' => $hasMore[m[41m [m
[32m+[m[32m                ? url("/api/rental-rates/history?page=" . ($currentPage + 1))[m[41m [m
[32m+[m[32m                : null,[m
[32m+[m[32m            'prev_page_url' => $currentPage > 1[m[41m [m
[32m+[m[32m                ? url("/api/rental-rates/history?page=" . ($currentPage - 1))[m[41m [m
[32m+[m[32m                : null,[m
[32m+[m[32m        ];[m
[32m+[m[41m        [m
[32m+[m[32m        // Debug: Log the final result[m
[32m+[m[32m        \Log::info('Rental Rate History Final Result', [[m
[32m+[m[32m            'total_audit_records' => $historyData->total(),[m
[32m+[m[32m            'total_expanded' => $totalExpanded,[m
[32m+[m[32m            'count_returned' => count($paginatedItems),[m
[32m+[m[32m            'current_page' => $currentPage,[m
[32m+[m[32m            'has_more' => $hasMore,[m
[32m+[m[32m            'first_item_sample' => count($paginatedItems) > 0 ? [[m
[32m+[m[32m                'action' => $paginatedItems->first()->action ?? 'N/A',[m
[32m+[m[32m                'table_number' => $paginatedItems->first()->table_number ?? 'N/A',[m
[32m+[m[32m                'old_daily_rate' => $paginatedItems->first()->old_daily_rate ?? null,[m
[32m+[m[32m                'new_daily_rate' => $paginatedItems->first()->new_daily_rate ?? null,[m
[32m+[m[32m            ] : 'No items to display'[m
[32m+[m[32m        ]);[m
[32m+[m
[32m+[m[32m        return response()->json($response);[m
[32m+[m[32m    }[m
 }[m
[1mdiff --git a/app/Http/Controllers/Api/ScheduleController.php b/app/Http/Controllers/Api/ScheduleController.php[m
[1mindex 514cd44..16e5ab9 100644[m
[1m--- a/app/Http/Controllers/Api/ScheduleController.php[m
[1m+++ b/app/Http/Controllers/Api/ScheduleController.php[m
[36m@@ -10,6 +10,7 @@[m
 use App\Models\Schedule;[m
 use Illuminate\Support\Facades\Cache;[m
 use App\Services\AuditLogger;[m
[32m+[m[32muse App\Services\AnnouncementService;[m
 [m
 class ScheduleController extends Controller[m
 {[m
[36m@@ -124,7 +125,14 @@[m [mpublic function getBillingDates()[m
             [m
             $schedules = DB::table('schedules')[m
                 ->whereIn('schedule_type', $scheduleTypes)[m
[31m-                ->get();[m
[32m+[m[32m                ->get()[m
[32m+[m[32m                ->map(function ($schedule) {[m
[32m+[m[32m                    // Ensure description is converted to string if it's numeric[m
[32m+[m[32m                    if (isset($schedule->description) && is_numeric($schedule->description)) {[m
[32m+[m[32m                        $schedule->description = (string) $schedule->description;[m
[32m+[m[32m                    }[m
[32m+[m[32m                    return $schedule;[m
[32m+[m[32m                });[m
 [m
             return response()->json($schedules);[m
         });[m
[36m@@ -135,7 +143,7 @@[m [mpublic function updateBillingDates(Request $request)[m
         $validator = Validator::make($request->all(), [[m
             'schedules' => 'required|array|min:1',[m
             'schedules.*.type' => 'required|string',[m
[31m-            'schedules.*.day' => 'required|string|max:15',[m
[32m+[m[32m            'schedules.*.day' => 'required|string|max:20', // Increased to accommodate "End of the month" (18 chars)[m
         ]);[m
 [m
         if ($validator->fails()) {[m
[36m@@ -182,6 +190,25 @@[m [mpublic function updateBillingDates(Request $request)[m
                             'Success',[m
                             ['type' => $type, 'old_value' => $oldDay, 'new_value' => $newDay][m
                         );[m
[32m+[m
[32m+[m[32m                        // Create draft announcement for date schedule change (only for Due Date and Disconnection)[m
[32m+[m[32m                        if (str_contains($type, 'Due Date') || str_contains($type, 'Disconnection')) {[m
[32m+[m[32m                            try {[m
[32m+[m[32m                                // Extract utility type from schedule type (e.g., "Due Date - Electricity" -> "Electricity")[m
[32m+[m[32m                                $utilityType = str_replace(['Due Date - ', 'Disconnection - '], '', $type);[m
[32m+[m[41m                                [m
[32m+[m[32m                                $announcementService = new AnnouncementService();[m
[32m+[m[32m                                $announcementService->createDateScheduleChangeAnnouncement([m
[32m+[m[32m                                    $type,[m
[32m+[m[32m                                    $utilityType,[m
[32m+[m[32m                                    $oldDay,[m
[32m+[m[32m                                    $newDay[m
[32m+[m[32m                                );[m
[32m+[m[32m                            } catch (\Exception $e) {[m
[32m+[m[32m                                // Log error but don't fail the transaction[m
[32m+[m[32m                                \Illuminate\Support\Facades\Log::error('Failed to create date schedule change announcement: ' . $e->getMessage());[m
[32m+[m[32m                            }[m
[32m+[m[32m                        }[m
                     }[m
                 }[m
             });[m
[36m@@ -238,7 +265,15 @@[m [mpublic function getSmsSchedules()[m
             ];[m
             $schedules = DB::table('schedules')[m
                 ->whereIn('schedule_type', $scheduleTypes)[m
[31m-                ->get();[m
[32m+[m[32m                ->select('id', 'schedule_type', 'description', 'schedule_day', 'sms_days')[m
[32m+[m[32m                ->get()[m
[32m+[m[32m                ->map(function ($schedule) {[m
[32m+[m[32m                    // Decode JSON if it exists[m
[32m+[m[32m                    if ($schedule->sms_days) {[m
[32m+[m[32m                        $schedule->sms_days = json_decode($schedule->sms_days, true);[m
[32m+[m[32m                    }[m
[32m+[m[32m                    return $schedule;[m
[32m+[m[32m                });[m
 [m
             return response()->json($schedules);[m
         });[m
[36m@@ -253,6 +288,9 @@[m [mpublic function updateSmsSchedules(Request $request)[m
             'schedules' => 'required|array|min:1',[m
             'schedules.*.type' => 'required|string',[m
             'schedules.*.time' => 'required|date_format:H:i',[m
[32m+[m[32m            'schedules.*.day' => 'nullable|integer|min:1|max:31', // For Billing Statements (day of month)[m
[32m+[m[32m            'schedules.*.days' => 'nullable|array', // For Payment Reminders and Overdue Alerts (array of days)[m
[32m+[m[32m            'schedules.*.days.*' => 'integer|min:0|max:365',[m
         ]);[m
 [m
         if ($validator->fails()) {[m
[36m@@ -264,29 +302,95 @@[m [mpublic function updateSmsSchedules(Request $request)[m
                 foreach ($request->input('schedules') as $scheduleData) {[m
                     $type = $scheduleData['type'];[m
                     $newTime = $scheduleData['time'];[m
[32m+[m[32m                    $newDay = isset($scheduleData['day']) ? (int)$scheduleData['day'] : null;[m
[32m+[m[32m                    $newDays = isset($scheduleData['days']) && is_array($scheduleData['days'])[m[41m [m
[32m+[m[32m                        ? array_map('intval', $scheduleData['days'])[m[41m [m
[32m+[m[32m                        : null;[m
 [m
                     $existingSchedule = Schedule::where('schedule_type', $type)->first();[m
                     $oldTime = $existingSchedule ? $existingSchedule->description : 'Not Set';[m
[32m+[m[32m                    $oldDay = $existingSchedule ? $existingSchedule->schedule_day : null;[m
[32m+[m[32m                    $oldDays = $existingSchedule && $existingSchedule->sms_days[m[41m [m
[32m+[m[32m                        ? $existingSchedule->sms_days[m[41m [m
[32m+[m[32m                        : null;[m
[32m+[m
[32m+[m[32m                    $updateData = ['description' => $newTime];[m
[32m+[m[32m                    $timeChanged = $oldTime != $newTime;[m
[32m+[m[32m                    $dayChanged = false;[m
[32m+[m[32m                    $daysChanged = false;[m
[32m+[m
[32m+[m[32m                    // Handle Billing Statements (uses schedule_day)[m
[32m+[m[32m                    if ($type === 'SMS - Billing Statements') {[m
[32m+[m[32m                        if ($newDay !== null) {[m
[32m+[m[32m                            $updateData['schedule_day'] = $newDay;[m
[32m+[m[32m                            $dayChanged = $oldDay != $newDay;[m
[32m+[m[32m                        }[m
[32m+[m[32m                    }[m
[32m+[m[32m                    // Handle Payment Reminders and Overdue Alerts (uses sms_days array)[m
[32m+[m[32m                    else {[m
[32m+[m[32m                        if ($newDays !== null) {[m
[32m+[m[32m                            // Sort days array[m
[32m+[m[32m                            sort($newDays);[m
[32m+[m[32m                            $updateData['sms_days'] = $newDays;[m
[32m+[m[32m                            $daysChanged = json_encode($oldDays) !== json_encode($newDays);[m
[32m+[m[32m                        }[m
[32m+[m[32m                    }[m
 [m
[31m-                    if ($oldTime != $newTime) {[m
[32m+[m[32m                    if ($timeChanged || $dayChanged || $daysChanged) {[m
                         $schedule = Schedule::updateOrCreate([m
                             ['schedule_type' => $type],[m
[31m-                            ['description' => $newTime][m
[32m+[m[32m                            $updateData[m
                         );[m
 [m
[31m-                        DB::table('schedule_histories')->insert([[m
[31m-                            'schedule_id' => $schedule->id,[m
[31m-                            'field_changed' => $schedule->schedule_type,[m
[31m-                            'old_value' => $oldTime,[m
[31m-                            'new_value' => $newTime,[m
[31m-                            'changed_by' => Auth::id() ?? 1,[m
[31m-                        ]);[m
[32m+[m[32m                        // Log time change[m
[32m+[m[32m                        if ($timeChanged) {[m
[32m+[m[32m                            DB::table('schedule_histories')->insert([[m
[32m+[m[32m                                'schedule_id' => $schedule->id,[m
[32m+[m[32m                                'field_changed' => $schedule->schedule_type . ' - Time',[m
[32m+[m[32m                                'old_value' => $oldTime,[m
[32m+[m[32m                                'new_value' => $newTime,[m
[32m+[m[32m                                'changed_by' => Auth::id() ?? 1,[m
[32m+[m[32m                            ]);[m
[32m+[m[32m                        }[m
[32m+[m
[32m+[m[32m                        // Log day change (for Billing Statements)[m
[32m+[m[32m                        if ($dayChanged) {[m
[32m+[m[32m                            DB::table('schedule_histories')->insert([[m
[32m+[m[32m                                'schedule_id' => $schedule->id,[m
[32m+[m[32m                                'field_changed' => $schedule->schedule_type . ' - Day',[m
[32m+[m[32m                                'old_value' => $oldDay ?? 'Not Set',[m
[32m+[m[32m                                'new_value' => (string)$newDay,[m
[32m+[m[32m                                'changed_by' => Auth::id() ?? 1,[m
[32m+[m[32m                            ]);[m
[32m+[m[32m                        }[m
[32m+[m
[32m+[m[32m                        // Log days change (for Payment Reminders and Overdue Alerts)[m
[32m+[m[32m                        if ($daysChanged) {[m
[32m+[m[32m                            $oldDaysStr = $oldDays ? implode(', ', $oldDays) : 'Not Set';[m
[32m+[m[32m                            $newDaysStr = implode(', ', $newDays);[m
[32m+[m[41m                            [m
[32m+[m[32m                            DB::table('schedule_histories')->insert([[m
[32m+[m[32m                                'schedule_id' => $schedule->id,[m
[32m+[m[32m                                'field_changed' => $schedule->schedule_type . ' - Days',[m
[32m+[m[32m                                'old_value' => $oldDaysStr,[m
[32m+[m[32m                                'new_value' => $newDaysStr,[m
[32m+[m[32m                                'changed_by' => Auth::id() ?? 1,[m
[32m+[m[32m                            ]);[m
[32m+[m[32m                        }[m
 [m
                         AuditLogger::log([m
                             'Updated SMS Schedule',[m
                             'Schedules',[m
                             'Success',[m
[31m-                            ['type' => $type, 'old_value' => $oldTime, 'new_value' => $newTime][m
[32m+[m[32m                            [[m
[32m+[m[32m                                'type' => $type,[m
[32m+[m[32m                                'old_time' => $oldTime,[m
[32m+[m[32m                                'new_time' => $newTime,[m
[32m+[m[32m                                'old_day' => $oldDay,[m
[32m+[m[32m                                'new_day' => $newDay,[m
[32m+[m[32m                                'old_days' => $oldDays,[m
[32m+[m[32m                                'new_days' => $newDays[m
[32m+[m[32m                            ][m
                         );[m
                     }[m
                 }[m
[1mdiff --git a/app/Http/Controllers/Api/StaffController.php b/app/Http/Controllers/Api/StaffController.php[m
[1mindex ad27243..cbed409 100644[m
[1m--- a/app/Http/Controllers/Api/StaffController.php[m
[1m+++ b/app/Http/Controllers/Api/StaffController.php[m
[36m@@ -14,9 +14,11 @@[m
 use App\Models\Payment;[m
 use App\Models\BillingSetting;[m
 use App\Models\Rate;[m
[32m+[m[32muse App\Models\UtilityReading;[m
 use Carbon\Carbon;[m
 use Illuminate\Support\Facades\Artisan;[m
 use Illuminate\Support\Facades\Auth; // <-- Import the Auth facade[m
[32m+[m[32muse Illuminate\Support\Facades\Storage;[m
 use App\Services\AuditLogger;[m
 [m
 class StaffController extends Controller[m
[36m@@ -24,33 +26,19 @@[m [mclass StaffController extends Controller[m
     public function getVendors()[m
     {[m
         // Fixed N+1 by eager loading with lean selects[m
[31m-        // Removed pagination to return all vendors for the Vendor Management section[m
[31m-        $vendors = User::select('id', 'name', 'contact_number', 'application_date', 'profile_picture')[m
[32m+[m[32m        $vendors = User::select('users.id', 'users.name', 'users.contact_number', 'users.application_date', 'users.profile_picture')[m
             ->with(['role:id,name', 'stall:id,vendor_id,table_number,daily_rate,area,section_id', 'stall.section:id,name'])[m
[32m+[m[32m            ->leftJoin('stalls', 'users.id', '=', 'stalls.vendor_id')[m
             ->whereHas('role', function ($query) {[m
                 $query->where('name', 'Vendor');[m
             })[m
[31m-            ->get()[m
[31m-            ->map(function ($user) {[m
[32m+[m[32m            ->orderBy('stalls.table_number', 'asc') // Sort alphabetically by stall/table number[m
[32m+[m[32m            ->groupBy('users.id', 'users.name', 'users.contact_number', 'users.application_date', 'users.profile_picture')[m
[32m+[m[32m            ->paginate(15) // Replaced get() with paginate()[m
[32m+[m[32m            ->through(function ($user) {[m
                 $appDate = $user->application_date [m
                 ? $user->application_date->format('Y-m-d') [m
                 : null;[m
[31m-                [m
[31m-                // Generate profile picture URL (handles base64, B2 path, or null)[m
[31m-                $profilePictureUrl = null;[m
[31m-                if ($user->profile_picture) {[m
[31m-                    if (str_starts_with($user->profile_picture, 'data:')) {[m
[31m-                        // Legacy base64 data[m
[31m-                        $profilePictureUrl = $user->profile_picture;[m
[31m-                    } else {[m
[31m-                        // B2 path - generate temporary signed URL (valid for 7 days)[m
[31m-                        $profilePictureUrl = \Storage::disk('b2')->temporaryUrl([m
[31m-                            $user->profile_picture,[m
[31m-                            now()->addDays(7)[m
[31m-                        );[m
[31m-                    }[m
[31m-                }[m
[31m-                [m
                 return [[m
                     'id' => $user->id,[m
                     'vendorName' => $user->name,[m
[36m@@ -60,7 +48,7 @@[m [mpublic function getVendors()[m
                     'stallNumber' => optional($user->stall)->table_number ?? 'N/A',[m
                     'daily_rate' => optional($user->stall)->daily_rate,[m
                     'area' => optional($user->stall)->area,[m
[31m-                    'profile_picture_url' => $profilePictureUrl,[m
[32m+[m[32m                    'profile_picture' => $user->profile_picture ? Storage::url($user->profile_picture) : null,[m
                 ];[m
             });[m
     [m
[36m@@ -85,6 +73,7 @@[m [mpublic function getBillManagementData()[m
                       });[m
             })[m
             ->with('vendor:id,name')[m
[32m+[m[32m            ->orderBy('table_number', 'asc') // Sort alphabetically by stall/table number[m
             ->paginate(15) // Replaced get() with paginate()[m
             ->through(function ($stall) {[m
                 return [[m
[36m@@ -216,34 +205,149 @@[m [mpublic function getFilteredPaymentHistory(Request $request, User $user)[m
         $year = $request->get('year');[m
         $month = $request->get('month');[m
         $search = $request->get('search');[m
[32m+[m[32m        $page = $request->get('page', 1);[m
[32m+[m[32m        $perPage = 20;[m
 [m
         $stallId = DB::table('stalls')->where('vendor_id', $user->id)->value('id');[m
 [m
         if (!$stallId) {[m
[31m-            return response()->json([]);[m
[32m+[m[32m            return response()->json(['data' => [], 'total' => 0, 'has_more' => false]);[m
         }[m
 [m
[31m-        $query = Billing::with('payment')[m
[31m-            ->join('payments', 'billing.id', '=', 'payments.billing_id')[m
[31m-            ->where('billing.stall_id', $stallId)[m
[31m-            ->where('billing.status', 'paid')[m
[31m-            ->whereDate('payments.payment_date', '<', Carbon::now()->startOfMonth());[m
[32m+[m[32m        // Build cache key[m
[32m+[m[32m        $cacheKey = "payment_history_staff_vendor_{$user->id}_y{$year}_m{$month}_s{$search}_p{$page}";[m
         [m
[31m-        if ($year) {[m
[31m-            $query->whereYear('payments.payment_date', $year);[m
[32m+[m[32m        // Cache results for 5 minutes (short cache for search results)[m
[32m+[m[32m        $cachedResult = cache()->get($cacheKey);[m
[32m+[m[32m        if ($cachedResult && !$search) {[m
[32m+[m[32m            return response()->json($cachedResult);[m
         }[m
 [m
[31m-        if ($month && $month !== "all") {[m
[31m-            $query->whereMonth('payments.payment_date', $month);[m
[32m+[m[32m        // Optimized query: Start from payments table for better index usage[m
[32m+[m[32m        $baseQuery = DB::table('payments')[m
[32m+[m[32m            ->join('billing', 'payments.billing_id', '=', 'billing.id')[m
[32m+[m[32m            ->where('billing.stall_id', $stallId)[m
[32m+[m[32m            ->where('billing.status', 'paid');[m
[32m+[m[41m        [m
[32m+[m[32m        // Use date range instead of whereYear/whereMonth for better index usage[m
[32m+[m[32m        if ($year) {[m
[32m+[m[32m            $startDate = Carbon::create($year, 1, 1)->startOfYear();[m
[32m+[m[32m            $endDate = Carbon::create($year, 12, 31)->endOfYear();[m
[32m+[m[41m            [m
[32m+[m[32m            if ($month && $month !== "all") {[m
[32m+[m[32m                $startDate = Carbon::create($year, $month, 1)->startOfMonth();[m
[32m+[m[32m                $endDate = Carbon::create($year, $month, 1)->endOfMonth();[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
[32m+[m[32m            $baseQuery->whereBetween('payments.payment_date', [[m
[32m+[m[32m                $startDate->toDateString(),[m
[32m+[m[32m                $endDate->toDateString()[m
[32m+[m[32m            ]);[m
[32m+[m[32m        } elseif ($month && $month !== "all") {[m
[32m+[m[32m            $year = Carbon::now()->year;[m
[32m+[m[32m            $startDate = Carbon::create($year, $month, 1)->startOfMonth();[m
[32m+[m[32m            $endDate = Carbon::create($year, $month, 1)->endOfMonth();[m
[32m+[m[32m            $baseQuery->whereBetween('payments.payment_date', [[m
[32m+[m[32m                $startDate->toDateString(),[m
[32m+[m[32m                $endDate->toDateString()[m
[32m+[m[32m            ]);[m
         }[m
 [m
         if ($search) {[m
[31m-            $query->where('billing.utility_type', 'like', '%' . $search . '%');[m
[32m+[m[32m            $baseQuery->where('billing.utility_type', 'like', '%' . $search . '%');[m
         }[m
 [m
[31m-        $bills = $query->orderBy('payments.payment_date', 'desc')->select('billing.*')->get();[m
[32m+[m[32m        // Get total count[m
[32m+[m[32m        $total = (clone $baseQuery)->count();[m
[32m+[m[41m        [m
[32m+[m[32m        // Get paginated results[m
[32m+[m[32m        $bills = (clone $baseQuery)[m
[32m+[m[32m            ->select([m
[32m+[m[32m                'billing.id',[m
[32m+[m[32m                'billing.stall_id',[m
[32m+[m[32m                'billing.utility_type',[m
[32m+[m[32m                'billing.period_start',[m
[32m+[m[32m                'billing.period_end',[m
[32m+[m[32m                'billing.amount',[m
[32m+[m[32m                'billing.due_date',[m
[32m+[m[32m                'billing.disconnection_date',[m
[32m+[m[32m                'billing.status',[m
[32m+[m[32m                'payments.amount_paid',[m
[32m+[m[32m                'payments.payment_date'[m
[32m+[m[32m            )[m
[32m+[m[32m            ->orderBy('payments.payment_date', 'desc')[m
[32m+[m[32m            ->skip(($page - 1) * $perPage)[m
[32m+[m[32m            ->take($perPage)[m
[32m+[m[32m            ->get();[m
[32m+[m
[32m+[m[32m        // Get billing settings for recalculation[m
[32m+[m[32m        $billingSettings = \App\Models\BillingSetting::all()->keyBy('utility_type');[m
[32m+[m[41m        [m
[32m+[m[32m        // Format response[m
[32m+[m[32m        $formattedBills = $bills->map(function ($bill) use ($billingSettings) {[m
[32m+[m[32m            $originalAmount = (float) $bill->amount;[m
[32m+[m[32m            $paymentDate = Carbon::parse($bill->payment_date);[m
[32m+[m[32m            $dueDate = Carbon::parse($bill->due_date);[m
[32m+[m[32m            $finalAmount = $originalAmount;[m
[32m+[m[32m            $settings = $billingSettings->get($bill->utility_type);[m
[32m+[m[41m            [m
[32m+[m[32m            // Recalculate the correct amount based on payment date[m
[32m+[m[32m            if ($paymentDate->gt($dueDate)) {[m
[32m+[m[32m                // Payment was LATE, calculate penalties[m
[32m+[m[32m                if ($bill->utility_type === 'Rent' && $settings) {[m
[32m+[m[32m                    $interest_months = (int) floor($dueDate->floatDiffInMonths($paymentDate));[m
[32m+[m[32m                    $surcharge = $originalAmount * (float)($settings->surcharge_rate ?? 0);[m
[32m+[m[32m                    $interest = $originalAmount * (float)($settings->monthly_interest_rate ?? 0) * $interest_months;[m
[32m+[m[32m                    $finalAmount = $originalAmount + $surcharge + $interest;[m
[32m+[m[32m                } else if ($settings) {[m
[32m+[m[32m                    $penalty = $originalAmount * (float)($settings->penalty_rate ?? 0);[m
[32m+[m[32m                    $finalAmount = $originalAmount + $penalty;[m
[32m+[m[32m                }[m
[32m+[m[32m            } else if ($paymentDate->day <= 15) {[m
[32m+[m[32m                // Payment was ON TIME (before due date and within discount period), check for discount[m
[32m+[m[32m                $billMonth = Carbon::parse($bill->period_start)->format('Y-m');[m
[32m+[m[32m                $paymentMonth = $paymentDate->format('Y-m');[m
[32m+[m
[32m+[m[32m                if ($billMonth === $paymentMonth && $bill->utility_type === 'Rent' && $settings && (float)$settings->discount_rate > 0) {[m
[32m+[m[32m                    $discountAmount = $originalAmount * (float)$settings->discount_rate;[m
[32m+[m[32m                    $finalAmount = $originalAmount - $discountAmount;[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
[32m+[m[32m            return (object) [[m
[32m+[m[32m                'id' => $bill->id,[m
[32m+[m[32m                'stall_id' => $bill->stall_id,[m
[32m+[m[32m                'utility_type' => $bill->utility_type,[m
[32m+[m[32m                'period_start' => $bill->period_start,[m
[32m+[m[32m                'period_end' => $bill->period_end,[m
[32m+[m[32m                'amount' => $bill->amount,[m
[32m+[m[32m                'due_date' => $bill->due_date,[m
[32m+[m[32m                'disconnection_date' => $bill->disconnection_date,[m
[32m+[m[32m                'status' => $bill->status,[m
[32m+[m[32m                'payment' => (object) [[m
[32m+[m[32m                    'amount_paid' => $finalAmount, // Use recalculated amount[m
[32m+[m[32m                    'payment_date' => $bill->payment_date,[m
[32m+[m[32m                ],[m
[32m+[m[32m            ];[m
[32m+[m[32m        });[m
[32m+[m
[32m+[m[32m        $lastPage = (int) ceil($total / $perPage);[m
[32m+[m[41m        [m
[32m+[m[32m        $response = [[m
[32m+[m[32m            'data' => $formattedBills,[m
[32m+[m[32m            'current_page' => (int) $page,[m
[32m+[m[32m            'last_page' => $lastPage,[m
[32m+[m[32m            'per_page' => $perPage,[m
[32m+[m[32m            'total' => $total,[m
[32m+[m[32m            'has_more' => $page < $lastPage,[m
[32m+[m[32m        ];[m
[32m+[m[41m        [m
[32m+[m[32m        // Cache result for 5 minutes (only if no search)[m
[32m+[m[32m        if (!$search) {[m
[32m+[m[32m            cache()->put($cacheKey, $response, 300);[m
[32m+[m[32m        }[m
         [m
[31m-        return response()->json($bills);[m
[32m+[m[32m        return response()->json($response);[m
     }[m
 [m
     public function markAsPaid(Request $request, $billingId)[m
[36m@@ -395,16 +499,7 @@[m [mpublic function getVendorDashboardData(User $user)[m
         $vendor->load('stall.section');[m
 [m
         $outstandingBills = Billing::where('stall_id', $vendor->stall->id)[m
[31m-            ->where(function ($query) {[m
[31m-                $query->where('status', 'unpaid')[m
[31m-                      ->orWhere(function ($subQuery) {[m
[31m-                          $subQuery->where('status', 'paid')[m
[31m-                                   ->whereHas('payment', function ($paymentQuery) {[m
[31m-                                       $paymentQuery->whereMonth('payment_date', Carbon::now()->month)[m
[31m-                                                    ->whereYear('payment_date', Carbon::now()->year);[m
[31m-                                   });[m
[31m-                      });[m
[31m-            })[m
[32m+[m[32m            ->where('status', 'unpaid')[m
             ->with('payment')[m
             ->orderBy('due_date', 'desc')[m
             ->get();[m
[36m@@ -436,6 +531,121 @@[m [mpublic function getVendorDashboardData(User $user)[m
             'outstandingBills' => $outstandingBills,[m
         ]);[m
     }[m
[32m+[m
[32m+[m[32m    public function getVendorAnalytics(User $user)[m
[32m+[m[32m    {[m
[32m+[m[32m        if (!$user->stall) {[m
[32m+[m[32m            return response()->json(['error' => 'Vendor or stall not found.'], 404);[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        $stallId = $user->stall->id;[m
[32m+[m
[32m+[m[32m        // Get electricity consumption data (last 12 months)[m
[32m+[m[32m        $electricityReadings = UtilityReading::where('stall_id', $stallId)[m
[32m+[m[32m            ->where('utility_type', 'Electricity')[m
[32m+[m[32m            ->orderBy('reading_date', 'desc')[m
[32m+[m[32m            ->limit(12)[m
[32m+[m[32m            ->get()[m
[32m+[m[32m            ->reverse();[m
[32m+[m
[32m+[m[32m        $consumptionData = [];[m
[32m+[m[32m        $consumptionLabels = [];[m
[32m+[m[41m        [m
[32m+[m[32m        foreach ($electricityReadings as $index => $reading) {[m
[32m+[m[32m            if ($index > 0) {[m
[32m+[m[32m                $previousReading = $electricityReadings[$index - 1];[m
[32m+[m[32m                $consumption = $reading->current_reading - $previousReading->current_reading;[m
[32m+[m[32m                $consumptionData[] = max(0, $consumption); // Ensure non-negative[m
[32m+[m[32m                $consumptionLabels[] = Carbon::parse($reading->reading_date)->format('M Y');[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // Get payment tracking data (on-time vs late payments)[m
[32m+[m[32m        // Get ALL billings for this stall (both paid and unpaid)[m
[32m+[m[32m        $billings = Billing::where('stall_id', $stallId)[m
[32m+[m[32m            ->with('payment')[m
[32m+[m[32m            ->orderBy('due_date', 'desc')[m
[32m+[m[32m            ->get();[m
[32m+[m
[32m+[m[32m        $today = Carbon::today();[m
[32m+[m[32m        $onTimeCount = 0;[m
[32m+[m[32m        $lateCount = 0;[m
[32m+[m[32m        $paymentTimeline = [];[m
[32m+[m
[32m+[m[32m        foreach ($billings as $billing) {[m
[32m+[m[32m            $dueDate = Carbon::parse($billing->due_date)->startOfDay();[m
[32m+[m[32m            $isOnTime = false;[m
[32m+[m[32m            $recordDate = null;[m
[32m+[m[41m            [m
[32m+[m[32m            if ($billing->status === 'paid' && $billing->payment) {[m
[32m+[m[32m                // For paid bills: check if payment was made on or before due date[m
[32m+[m[32m                $paymentDate = Carbon::parse($billing->payment->payment_date)->startOfDay();[m
[32m+[m[32m                $isOnTime = $paymentDate->lte($dueDate);[m
[32m+[m[32m                $recordDate = $paymentDate;[m
[32m+[m[32m            } else {[m
[32m+[m[32m                // For unpaid bills: check if due date has passed[m
[32m+[m[32m                if ($today->gt($dueDate)) {[m
[32m+[m[32m                    // Unpaid and past due date = late[m
[32m+[m[32m                    $isOnTime = false;[m
[32m+[m[32m                    $recordDate = $dueDate; // Use due date for timeline grouping[m
[32m+[m[32m                } else {[m
[32m+[m[32m                    // Unpaid but not yet due = not counted (not late, not on-time yet)[m
[32m+[m[32m                    continue; // Skip bills that aren't due yet[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
[32m+[m[32m            if ($isOnTime) {[m
[32m+[m[32m                $onTimeCount++;[m
[32m+[m[32m            } else {[m
[32m+[m[32m                $lateCount++;[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            // Add to timeline for trend analysis[m
[32m+[m[32m            if ($recordDate) {[m
[32m+[m[32m                $paymentTimeline[] = [[m
[32m+[m[32m                    'date' => $recordDate->format('Y-m'),[m
[32m+[m[32m                    'on_time' => $isOnTime ? 1 : 0,[m
[32m+[m[32m                    'late' => $isOnTime ? 0 : 1,[m
[32m+[m[32m                ];[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // Group timeline by month[m
[32m+[m[32m        $timelineGrouped = [];[m
[32m+[m[32m        foreach ($paymentTimeline as $item) {[m
[32m+[m[32m            $month = $item['date'];[m
[32m+[m[32m            if (!isset($timelineGrouped[$month])) {[m
[32m+[m[32m                $timelineGrouped[$month] = ['on_time' => 0, 'late' => 0];[m
[32m+[m[32m            }[m
[32m+[m[32m            $timelineGrouped[$month]['on_time'] += $item['on_time'];[m
[32m+[m[32m            $timelineGrouped[$month]['late'] += $item['late'];[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // Sort by date and get last 12 months[m
[32m+[m[32m        ksort($timelineGrouped);[m
[32m+[m[32m        $timelineGrouped = array_slice($timelineGrouped, -12, 12, true);[m
[32m+[m
[32m+[m[32m        $timelineLabels = array_keys($timelineGrouped);[m
[32m+[m[32m        $timelineOnTime = array_column($timelineGrouped, 'on_time');[m
[32m+[m[32m        $timelineLate = array_column($timelineGrouped, 'late');[m
[32m+[m
[32m+[m[32m        return response()->json([[m
[32m+[m[32m            'electricity' => [[m
[32m+[m[32m                'labels' => $consumptionLabels,[m
[32m+[m[32m                'data' => $consumptionData,[m
[32m+[m[32m            ],[m
[32m+[m[32m            'paymentTracking' => [[m
[32m+[m[32m                'onTime' => $onTimeCount,[m
[32m+[m[32m                'late' => $lateCount,[m
[32m+[m[32m                'total' => $onTimeCount + $lateCount,[m
[32m+[m[32m            ],[m
[32m+[m[32m            'paymentTimeline' => [[m
[32m+[m[32m                'labels' => $timelineLabels,[m
[32m+[m[32m                'onTime' => $timelineOnTime,[m
[32m+[m[32m                'late' => $timelineLate,[m
[32m+[m[32m            ],[m
[32m+[m[32m        ]);[m
[32m+[m[32m    }[m
     [m
     public function getUnassignedVendors()[m
     {[m
[36m@@ -508,7 +718,6 @@[m [mpublic function assignStall(Request $request)[m
         } catch (\Exception $e) {[m
             DB::rollBack();[m
             Log::error('Stall assignment failed: ' . $e->getMessage());[m
[31m-            Log::error($e->getTraceAsString()); // Log trace for more details[m
 [m
              // <-- START: Audit Trail for Failed Assignment -->[m
              // <-- START: Audit Trail for Failed Assignment -->[m
[36m@@ -521,70 +730,106 @@[m [mpublic function assignStall(Request $request)[m
             // <-- END: Audit Trail -->[m
             // <-- END: Audit Trail -->[m
             [m
[31m-            // Return the actual error message for debugging[m
[31m-            return response()->json(['message' => 'Stall assignment error: ' . $e->getMessage()], 500);[m
[32m+[m[32m            return response()->json(['message' => 'An error occurred during stall assignment.'], 500);[m
         }[m
     }[m
 [m
     /**[m
[31m-     * Upload a profile picture for a vendor.[m
[31m-     * Stores the image in Backblaze B2 object storage.[m
[32m+[m[32m     * Upload profile picture for a vendor (staff only)[m
      */[m
[31m-    public function uploadProfilePicture(Request $request)[m
[32m+[m[32m    public function uploadVendorProfilePicture(Request $request, $vendorId)[m
     {[m
[31m-        $validator = Validator::make($request->all(), [[m
[31m-            'vendor_id' => 'required|integer|exists:users,id',[m
[31m-            'profile_picture' => 'required|image|mimes:jpg,jpeg,png,gif,webp|max:5120', // 5MB max[m
[31m-        ]);[m
[31m-[m
[31m-        if ($validator->fails()) {[m
[31m-            return response()->json(['message' => $validator->errors()->first()], 422);[m
[32m+[m[32m        $vendor = User::with('role')->findOrFail($vendorId);[m
[32m+[m[41m        [m
[32m+[m[32m        // Ensure the user is a vendor[m
[32m+[m[32m        if (!$vendor->role || $vendor->role->name !== 'Vendor') {[m
[32m+[m[32m            Log::warning('Attempted to upload profile picture for non-vendor user', [[m
[32m+[m[32m                'user_id' => $vendorId,[m
[32m+[m[32m                'role' => $vendor->role ? $vendor->role->name : 'No role'[m
[32m+[m[32m            ]);[m
[32m+[m[32m            return response()->json(['message' => 'User is not a vendor.'], 403);[m
         }[m
 [m
[32m+[m[32m        $validated = $request->validate([[m
[32m+[m[32m            'profile_picture' => 'required|image|mimes:jpeg,png,jpg,gif|max:2048', // 2MB max[m
[32m+[m[32m        ], [[m
[32m+[m[32m            'profile_picture.required' => 'Please select an image to upload.',[m
[32m+[m[32m            'profile_picture.image' => 'The file must be an image.',[m
[32m+[m[32m            'profile_picture.mimes' => 'The image must be a jpeg, png, jpg, or gif file.',[m
[32m+[m[32m            'profile_picture.max' => 'The image must not be larger than 2MB.',[m
[32m+[m[32m        ]);[m
[32m+[m
         try {[m
[31m-            $vendor = User::findOrFail($request->vendor_id);[m
[31m-            [m
[31m-            // Delete old profile picture from B2 if exists (and it's a path, not base64)[m
[31m-            if ($vendor->profile_picture && !str_starts_with($vendor->profile_picture, 'data:')) {[m
[31m-                // Check if file exists before deleting to avoid errors[m
[31m-                if (\Storage::disk('b2')->exists($vendor->profile_picture)) {[m
[31m-                    \Storage::disk('b2')->delete($vendor->profile_picture);[m
[31m-                }[m
[32m+[m[32m            // Delete old profile picture if exists[m
[32m+[m[32m            if ($vendor->profile_picture) {[m
[32m+[m[32m                Storage::disk('public')->delete($vendor->profile_picture);[m
             }[m
 [m
[31m-            // Store new profile picture in B2[m
[31m-            $file = $request->file('profile_picture');[m
[31m-            $filename = 'profile_pictures/vendor_' . $vendor->id . '_' . time() . '.' . $file->getClientOriginalExtension();[m
[31m-            [m
[31m-            // Store the file in B2 (visibility doesn't matter for private buckets, but good practice)[m
[31m-            \Storage::disk('b2')->put($filename, file_get_contents($file->getRealPath()));[m
[31m-            [m
[31m-            // Get a temporary signed URL (valid for 7 days)[m
[31m-            $url = \Storage::disk('b2')->temporaryUrl([m
[31m-                $filename,[m
[31m-                now()->addDays(7)[m
[31m-            );[m
[32m+[m[32m            // Store the image[m
[32m+[m[32m            $image = $request->file('profile_picture');[m
[32m+[m[32m            $filename = 'profile_' . $vendor->id . '_' . time() . '.' . $image->getClientOriginalExtension();[m
[32m+[m[32m            $path = $image->storeAs('profile-pictures', $filename, 'public');[m
 [m
[31m-            // Update user record with the B2 path[m
[31m-            $vendor->profile_picture = $filename;[m
[32m+[m[32m            // Update vendor record[m
[32m+[m[32m            $vendor->profile_picture = $path;[m
             $vendor->save();[m
 [m
[31m-            // Log the action[m
             AuditLogger::log([m
[31m-                'Updated profile picture',[m
[32m+[m[32m                'Uploaded Vendor Profile Picture',[m
                 'Vendor Management',[m
                 'Success',[m
[31m-                ['vendor_id' => $vendor->id, 'vendor_name' => $vendor->name][m
[32m+[m[32m                ['vendor_id' => $vendor->id, 'staff_id' => Auth::id()][m
             );[m
 [m
[32m+[m[32m            // Generate absolute URL for the profile picture[m
[32m+[m[32m            $url = Storage::disk('public')->url($path);[m
[32m+[m[32m            // Ensure it's an absolute URL[m
[32m+[m[32m            if (!filter_var($url, FILTER_VALIDATE_URL)) {[m
[32m+[m[32m                $url = asset($url);[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
             return response()->json([[m
[31m-                'message' => 'Profile picture uploaded successfully!',[m
[31m-                'profile_picture_url' => $url,[m
[32m+[m[32m                'message' => 'Vendor profile picture uploaded successfully.',[m
[32m+[m[32m                'profile_picture_url' => $url[m
             ]);[m
[31m-[m
         } catch (\Exception $e) {[m
[31m-            Log::error('Profile picture upload failed: ' . $e->getMessage());[m
[31m-            return response()->json(['message' => 'Failed to upload profile picture: ' . $e->getMessage()], 500);[m
[32m+[m[32m            Log::error('Vendor profile picture upload failed: ' . $e->getMessage(), [[m
[32m+[m[32m                'vendor_id' => $vendorId,[m
[32m+[m[32m                'trace' => $e->getTraceAsString()[m
[32m+[m[32m            ]);[m
[32m+[m[32m            return response()->json([[m
[32m+[m[32m                'message' => 'Failed to upload vendor profile picture: ' . $e->getMessage()[m
[32m+[m[32m            ], 500);[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Remove profile picture for a vendor (staff only)[m
[32m+[m[32m     */[m
[32m+[m[32m    public function removeVendorProfilePicture(Request $request, $vendorId)[m
[32m+[m[32m    {[m
[32m+[m[32m        $vendor = User::findOrFail($vendorId);[m
[32m+[m[41m        [m
[32m+[m[32m        // Ensure the user is a vendor[m
[32m+[m[32m        if (!$vendor->role || $vendor->role->name !== 'Vendor') {[m
[32m+[m[32m            return response()->json(['message' => 'User is not a vendor.'], 403);[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        if ($vendor->profile_picture) {[m
[32m+[m[32m            Storage::disk('public')->delete($vendor->profile_picture);[m
[32m+[m[32m            $vendor->profile_picture = null;[m
[32m+[m[32m            $vendor->save();[m
[32m+[m
[32m+[m[32m            AuditLogger::log([m
[32m+[m[32m                'Removed Vendor Profile Picture',[m
[32m+[m[32m                'Vendor Management',[m
[32m+[m[32m                'Success',[m
[32m+[m[32m                ['vendor_id' => $vendor->id, 'staff_id' => Auth::id()][m
[32m+[m[32m            );[m
[32m+[m
[32m+[m[32m            return response()->json(['message' => 'Vendor profile picture removed successfully.']);[m
         }[m
[32m+[m
[32m+[m[32m        return response()->json(['message' => 'No profile picture to remove.'], 400);[m
     }[m
 }[m
\ No newline at end of file[m
[1mdiff --git a/app/Http/Controllers/Api/UserSettingsController.php b/app/Http/Controllers/Api/UserSettingsController.php[m
[1mindex 27775c9..b4e0bfc 100644[m
[1m--- a/app/Http/Controllers/Api/UserSettingsController.php[m
[1m+++ b/app/Http/Controllers/Api/UserSettingsController.php[m
[36m@@ -5,6 +5,10 @@[m
 use App\Http\Controllers\Controller;[m
 use Illuminate\Http\Request;[m
 use Illuminate\Support\Facades\DB;[m
[32m+[m[32muse Illuminate\Support\Facades\Auth;[m
[32m+[m[32muse Illuminate\Support\Facades\Hash;[m
[32m+[m[32muse Illuminate\Support\Facades\Storage;[m
[32m+[m[32muse Illuminate\Validation\Rules\Password;[m
 use App\Services\AuditLogger;[m
 [m
 class UserSettingsController extends Controller[m
[36m@@ -44,4 +48,128 @@[m [mpublic function updateRoleContacts(Request $request)[m
 [m
         return response()->json(['message' => 'Contact numbers updated successfully.']);[m
     }[m
[32m+[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Change user password[m
[32m+[m[32m     */[m
[32m+[m[32m    public function changePassword(Request $request)[m
[32m+[m[32m    {[m
[32m+[m[32m        $user = Auth::user();[m
[32m+[m[41m        [m
[32m+[m[32m        $validated = $request->validate([[m
[32m+[m[32m            'current_password' => ['required', function ($attribute, $value, $fail) use ($user) {[m
[32m+[m[32m                if (!Hash::check($value, $user->password)) {[m
[32m+[m[32m                    $fail('The current password is incorrect.');[m
[32m+[m[32m                }[m
[32m+[m[32m            }],[m
[32m+[m[32m            'password' => [[m
[32m+[m[32m                'required',[m
[32m+[m[32m                'confirmed',[m
[32m+[m[32m                Password::min(8)[m
[32m+[m[32m                    ->letters()[m
[32m+[m[32m                    ->numbers()[m
[32m+[m[32m                    ->symbols()[m
[32m+[m[32m                    ->mixedCase()[m
[32m+[m[32m            ],[m
[32m+[m[32m        ], [[m
[32m+[m[32m            'current_password.required' => 'Current password is required.',[m
[32m+[m[32m            'password.required' => 'New password is required.',[m
[32m+[m[32m            'password.confirmed' => 'Password confirmation does not match.',[m
[32m+[m[32m            'password.min' => 'Password must be at least 8 characters.',[m
[32m+[m[32m        ]);[m
[32m+[m
[32m+[m[32m        $user->password = Hash::make($validated['password']);[m
[32m+[m[32m        $user->save();[m
[32m+[m
[32m+[m[32m        AuditLogger::log([m
[32m+[m[32m            'Changed Password',[m
[32m+[m[32m            'User Settings',[m
[32m+[m[32m            'Success',[m
[32m+[m[32m            ['user_id' => $user->id][m
[32m+[m[32m        );[m
[32m+[m
[32m+[m[32m        return response()->json(['message' => 'Password changed successfully.']);[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Upload profile picture[m
[32m+[m[32m     */[m
[32m+[m[32m    public function uploadProfilePicture(Request $request)[m
[32m+[m[32m    {[m
[32m+[m[32m        $user = Auth::user();[m
[32m+[m[41m        [m
[32m+[m[32m        $validated = $request->validate([[m
[32m+[m[32m            'profile_picture' => 'required|image|mimes:jpeg,png,jpg,gif|max:2048', // 2MB max[m
[32m+[m[32m        ], [[m
[32m+[m[32m            'profile_picture.required' => 'Please select an image to upload.',[m
[32m+[m[32m            'profile_picture.image' => 'The file must be an image.',[m
[32m+[m[32m            'profile_picture.mimes' => 'The image must be a jpeg, png, jpg, or gif file.',[m
[32m+[m[32m            'profile_picture.max' => 'The image must not be larger than 2MB.',[m
[32m+[m[32m        ]);[m
[32m+[m
[32m+[m[32m        try {[m
[32m+[m[32m            // Delete old profile picture if exists[m
[32m+[m[32m            if ($user->profile_picture) {[m
[32m+[m[32m                Storage::disk('public')->delete($user->profile_picture);[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            // Store the image[m
[32m+[m[32m            $image = $request->file('profile_picture');[m
[32m+[m[32m            $filename = 'profile_' . $user->id . '_' . time() . '.' . $image->getClientOriginalExtension();[m
[32m+[m[32m            $path = $image->storeAs('profile-pictures', $filename, 'public');[m
[32m+[m
[32m+[m[32m            // Update user record[m
[32m+[m[32m            $user->profile_picture = $path;[m
[32m+[m[32m            $user->save();[m
[32m+[m
[32m+[m[32m            AuditLogger::log([m
[32m+[m[32m                'Uploaded Profile Picture',[m
[32m+[m[32m                'User Settings',[m
[32m+[m[32m                'Success',[m
[32m+[m[32m                ['user_id' => $user->id][m
[32m+[m[32m            );[m
[32m+[m
[32m+[m[32m            // Generate absolute URL for the profile picture[m
[32m+[m[32m            $url = Storage::disk('public')->url($path);[m
[32m+[m[32m            // Ensure it's an absolute URL[m
[32m+[m[32m            if (!filter_var($url, FILTER_VALIDATE_URL)) {[m
[32m+[m[32m                $url = asset($url);[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
[32m+[m[32m            return response()->json([[m
[32m+[m[32m                'message' => 'Profile picture uploaded successfully.',[m
[32m+[m[32m                'profile_picture_url' => $url[m
[32m+[m[32m            ]);[m
[32m+[m[32m        } catch (\Exception $e) {[m
[32m+[m[32m            \Log::error('Profile picture upload failed: ' . $e->getMessage());[m
[32m+[m[32m            return response()->json([[m
[32m+[m[32m                'message' => 'Failed to upload profile picture. Please try again.'[m
[32m+[m[32m            ], 500);[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Remove profile picture[m
[32m+[m[32m     */[m
[32m+[m[32m    public function removeProfilePicture(Request $request)[m
[32m+[m[32m    {[m
[32m+[m[32m        $user = Auth::user();[m
[32m+[m[41m        [m
[32m+[m[32m        if ($user->profile_picture) {[m
[32m+[m[32m            Storage::disk('public')->delete($user->profile_picture);[m
[32m+[m[32m            $user->profile_picture = null;[m
[32m+[m[32m            $user->save();[m
[32m+[m
[32m+[m[32m            AuditLogger::log([m
[32m+[m[32m                'Removed Profile Picture',[m
[32m+[m[32m                'User Settings',[m
[32m+[m[32m                'Success',[m
[32m+[m[32m                ['user_id' => $user->id][m
[32m+[m[32m            );[m
[32m+[m
[32m+[m[32m            return response()->json(['message' => 'Profile picture removed successfully.']);[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        return response()->json(['message' => 'No profile picture to remove.'], 400);[m
[32m+[m[32m    }[m
 }[m
\ No newline at end of file[m
[1mdiff --git a/app/Http/Controllers/Api/UtilityRateController.php b/app/Http/Controllers/Api/UtilityRateController.php[m
[1mindex 49d3807..1b61428 100644[m
[1m--- a/app/Http/Controllers/Api/UtilityRateController.php[m
[1m+++ b/app/Http/Controllers/Api/UtilityRateController.php[m
[36m@@ -9,6 +9,7 @@[m
 use Illuminate\Support\Facades\Auth;[m
 use Illuminate\Support\Facades\Cache;[m
 use App\Services\AuditLogger;[m
[32m+[m[32muse App\Services\AnnouncementService;[m
 [m
 class UtilityRateController extends Controller[m
 {[m
[36m@@ -91,6 +92,21 @@[m [mpublic function update(Request $request, $id)[m
                     'Success',[m
                     ['rate_id' => $id, 'old_rate' => $oldRateValue, 'new_rate' => $newRateValue, 'old_monthly_rate' => $oldMonthlyRateValue, 'new_monthly_rate' => $newMonthlyRateValue][m
                 );[m
[32m+[m
[32m+[m[32m                // Create draft announcement for rate change[m
[32m+[m[32m                try {[m
[32m+[m[32m                    $announcementService = new AnnouncementService();[m
[32m+[m[32m                    $announcementService->createRateChangeAnnouncement([m
[32m+[m[32m                        $rate->utility_type,[m
[32m+[m[32m                        $oldRateValue,[m
[32m+[m[32m                        $newRateValue,[m
[32m+[m[32m                        $oldMonthlyRateValue,[m
[32m+[m[32m                        $newMonthlyRateValue[m
[32m+[m[32m                    );[m
[32m+[m[32m                } catch (\Exception $e) {[m
[32m+[m[32m                    // Log error but don't fail the transaction[m
[32m+[m[32m                    \Illuminate\Support\Facades\Log::error('Failed to create rate change announcement: ' . $e->getMessage());[m
[32m+[m[32m                }[m
             }[m
         });[m
 [m
[36m@@ -130,16 +146,22 @@[m [mpublic function batchUpdate(Request $request)[m
 [m
                     $oldRateValue = (float) $currentRate->rate;[m
                     $newRateValue = (float) $rateData['rate'];[m
[32m+[m[32m                    $oldMonthlyRateValue = (float) $currentRate->monthly_rate;[m
[32m+[m[32m                    $newMonthlyRateValue = isset($rateData['monthlyRate']) ? (float) $rateData['monthlyRate'] : $oldMonthlyRateValue;[m
 [m
                     // Only update and log if the rate is different[m
[31m-                    if ($oldRateValue !== $newRateValue) {[m
[32m+[m[32m                    if ($oldRateValue !== $newRateValue || $oldMonthlyRateValue !== $newMonthlyRateValue) {[m
                         // Update the rate in the main table[m
[32m+[m[32m                        $updateData = [[m
[32m+[m[32m                            'rate'       => $newRateValue,[m
[32m+[m[32m                            'updated_at' => now(),[m
[32m+[m[32m                        ];[m
[32m+[m[32m                        if (isset($rateData['monthlyRate'])) {[m
[32m+[m[32m                            $updateData['monthly_rate'] = $newMonthlyRateValue;[m
[32m+[m[32m                        }[m
                         DB::table('rates')[m
                             ->where('id', $rateData['id'])[m
[31m-                            ->update([[m
[31m-                                'rate'       => $newRateValue,[m
[31m-                                'updated_at' => now(),[m
[31m-                            ]);[m
[32m+[m[32m                            ->update($updateData);[m
 [m
                         // Add a new entry to the history table[m
                         DB::table('rate_histories')->insert([[m
[36m@@ -149,6 +171,21 @@[m [mpublic function batchUpdate(Request $request)[m
                             'changed_by' => $loggedInUserId,[m
                             'changed_at' => now(),[m
                         ]);[m
[32m+[m
[32m+[m[32m                        // Create draft announcement for rate change[m
[32m+[m[32m                        try {[m
[32m+[m[32m                            $announcementService = new AnnouncementService();[m
[32m+[m[32m                            $announcementService->createRateChangeAnnouncement([m
[32m+[m[32m                                $currentRate->utility_type,[m
[32m+[m[32m                                $oldRateValue,[m
[32m+[m[32m                                $newRateValue,[m
[32m+[m[32m                                $oldMonthlyRateValue,[m
[32m+[m[32m                                $newMonthlyRateValue[m
[32m+[m[32m                            );[m
[32m+[m[32m                        } catch (\Exception $e) {[m
[32m+[m[32m                            // Log error but don't fail the transaction[m
[32m+[m[32m                            \Illuminate\Support\Facades\Log::error('Failed to create rate change announcement: ' . $e->getMessage());[m
[32m+[m[32m                        }[m
                     }[m
                 }[m
 [m
[1mdiff --git a/app/Http/Controllers/Auth/LoginController.php b/app/Http/Controllers/Auth/LoginController.php[m
[1mindex f22b215..26ca919 100644[m
[1m--- a/app/Http/Controllers/Auth/LoginController.php[m
[1m+++ b/app/Http/Controllers/Auth/LoginController.php[m
[36m@@ -17,9 +17,8 @@[m [mpublic function login(Request $request)[m
         ]);[m
 [m
         $credentials = $request->only('username', 'password');[m
[31m-        $remember = $request->filled('remember');[m
 [m
[31m-        if (Auth::attempt($credentials, $remember)) {[m
[32m+[m[32m        if (Auth::attempt($credentials)) {[m
             $user = Auth::user();[m
             $user->last_login = Carbon::now(); // Record the login time[m
             $user->save(); // Save the user[m
[1mdiff --git a/app/Http/Controllers/MeterReaderController.php b/app/Http/Controllers/MeterReaderController.php[m
[1mindex 4dedd2e..c07356e 100644[m
[1m--- a/app/Http/Controllers/MeterReaderController.php[m
[1m+++ b/app/Http/Controllers/MeterReaderController.php[m
[36m@@ -32,7 +32,8 @@[m [mpublic function index(Request $request)[m
         // --- END OF LOGIC CHANGE ---[m
 [m
         DB::transaction(function () use ($billingPeriodMonth) {[m
[31m-            $allStalls = Stall::pluck('id');[m
[32m+[m[32m            // Only get stalls with vendors[m
[32m+[m[32m            $allStalls = Stall::whereHas('vendor')->pluck('id');[m
             $stallsWithReading = UtilityReading::whereIn('stall_id', $allStalls)[m
                 ->whereYear('reading_date', $billingPeriodMonth->year)[m
                 ->whereMonth('reading_date', $billingPeriodMonth->month)[m
[36m@@ -80,12 +81,14 @@[m [mpublic function index(Request $request)[m
         // --- END OF TASK DISPLAY FIX ---[m
 [m
         // Fixed N+1 and used lean selects[m
[32m+[m[32m        // Get only stalls with assigned vendors (frontend handles pagination)[m
         $stalls = Stall::select('id', 'table_number', 'section_id')[m
[32m+[m[32m            ->whereHas('vendor') // Only stalls with vendors[m
             ->with(['section:id,name', 'utilityReadings' => function ($query) use ($billingPeriodMonth) {[m
             $query->whereYear('reading_date', $billingPeriodMonth->year)[m
                   ->whereMonth('reading_date', $billingPeriodMonth->month)[m
                   ->with('editRequests');[m
[31m-        }])->orderBy('section_id')->paginate(15); // Replaced get() with paginate()[m
[32m+[m[32m        }])->orderBy('section_id')->get();[m
 [m
         $stallData = $stalls->map(function ($stall) use ($billingPeriodMonth) {[m
             $latestReading = $stall->utilityReadings->first();[m
[1mdiff --git a/app/Http/Controllers/NotificationController.php b/app/Http/Controllers/NotificationController.php[m
[1mindex d10637a..b90ca6b 100644[m
[1m--- a/app/Http/Controllers/NotificationController.php[m
[1m+++ b/app/Http/Controllers/NotificationController.php[m
[36m@@ -22,16 +22,9 @@[m [mpublic function print(User $user, $month)[m
 [m
         foreach ($users as $u) {[m
             $allBillsForPeriod = $u->billings()[m
[31m-                ->where(function ($query) use ($today) {[m
[31m-                    $query->where('status', 'unpaid')[m
[31m-                          ->orWhere(function ($subQuery) use ($today) {[m
[31m-                              $subQuery->where('status', 'paid')[m
[31m-                                       ->whereHas('payment', function ($paymentQuery) use ($today) {[m
[31m-                                           $paymentQuery->whereMonth('payment_date', $today->month)[m
[31m-                                                        ->whereYear('payment_date', $today->year);[m
[31m-                                       });[m
[31m-                          });[m
[31m-                })->with('payment')->get();[m
[32m+[m[32m                ->where('status', 'unpaid')[m
[32m+[m[32m                ->with('payment')[m
[32m+[m[32m                ->get();[m
     [m
             foreach ($allBillsForPeriod as $bill) {[m
                 $bill->original_amount = $bill->amount;[m
[36m@@ -178,6 +171,45 @@[m [mpublic function fetch(Request $request)[m
         ]);[m
     }[m
 [m
[32m+[m[32m    /**[m
[32m+[m[32m     * Fetch all notifications for the current user (for notifications page)[m
[32m+[m[32m     */[m
[32m+[m[32m    public function fetchAll(Request $request)[m
[32m+[m[32m    {[m
[32m+[m[32m        $user = Auth::user();[m
[32m+[m
[32m+[m[32m        // Optimize: Use single query with subquery for unread count[m
[32m+[m[32m        $unreadCount = DB::table('notifications')[m
[32m+[m[32m            ->where('recipient_id', $user->id)[m
[32m+[m[32m            ->where('channel', 'in_app')[m
[32m+[m[32m            ->whereNull('read_at')[m
[32m+[m[32m            ->count();[m
[32m+[m
[32m+[m[32m        // Optimize: Use select with COALESCE for sender name to avoid leftJoin overhead[m
[32m+[m[32m        $notifications = DB::table('notifications')[m
[32m+[m[32m            ->leftJoin('users as senders', 'notifications.sender_id', '=', 'senders.id')[m
[32m+[m[32m            ->where('notifications.recipient_id', $user->id)[m
[32m+[m[32m            ->where('notifications.channel', 'in_app')[m
[32m+[m[32m            ->select([m
[32m+[m[32m                'notifications.id',[m
[32m+[m[32m                'notifications.title',[m
[32m+[m[32m                'notifications.message',[m
[32m+[m[32m                'notifications.status',[m
[32m+[m[32m                'notifications.read_at',[m
[32m+[m[32m                'notifications.created_at',[m
[32m+[m[32m                'notifications.sent_at',[m
[32m+[m[32m                DB::raw('COALESCE(senders.name, NULL) as sender_name')[m
[32m+[m[32m            )[m
[32m+[m[32m            ->orderBy('notifications.created_at', 'desc')[m
[32m+[m[32m            ->limit(100) // Limit to most recent 100 notifications for performance[m
[32m+[m[32m            ->get();[m
[32m+[m
[32m+[m[32m        return response()->json([[m
[32m+[m[32m            'notifications' => $notifications,[m
[32m+[m[32m            'unread_count' => $unreadCount,[m
[32m+[m[32m        ]);[m
[32m+[m[32m    }[m
[32m+[m
     /**[m
      * Mark all pending notifications for the user as 'read'.[m
      */[m
[36m@@ -192,4 +224,24 @@[m [mpublic function markAsRead(Request $request)[m
 [m
         return response()->json(['message' => 'Notifications marked as read.']);[m
     }[m
[32m+[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Mark a single notification as read[m
[32m+[m[32m     */[m
[32m+[m[32m    public function markNotificationAsRead(Request $request, $id)[m
[32m+[m[32m    {[m
[32m+[m[32m        $user = Auth::user();[m
[32m+[m
[32m+[m[32m        $updated = DB::table('notifications')[m
[32m+[m[32m            ->where('id', $id)[m
[32m+[m[32m            ->where('recipient_id', $user->id)[m
[32m+[m[32m            ->whereNull('read_at')[m
[32m+[m[32m            ->update(['read_at' => now()]);[m
[32m+[m
[32m+[m[32m        if ($updated) {[m
[32m+[m[32m            return response()->json(['message' => 'Notification marked as read.']);[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        return response()->json(['message' => 'Notification not found or already read.'], 404);[m
[32m+[m[32m    }[m
 }[m
\ No newline at end of file[m
[1mdiff --git a/app/Http/Controllers/ReportController.php b/app/Http/Controllers/ReportController.php[m
[1mindex 57d05f4..76b7611 100644[m
[1m--- a/app/Http/Controllers/ReportController.php[m
[1m+++ b/app/Http/Controllers/ReportController.php[m
[36m@@ -3,6 +3,7 @@[m
 namespace App\Http\Controllers;[m
 [m
 use Illuminate\Http\Request;[m
[32m+[m[32muse Spatie\Browsershot\Browsershot;[m
 use App\Models\User;[m
 use App\Models\Payment;[m
 use App\Models\Billing;[m
[36m@@ -22,6 +23,37 @@[m [mpublic function download(Request $request)[m
         [m
         $notes = $request->input('notes', '');[m
 [m
[32m+[m[32m        // Read Chart.js directly from node_modules[m
[32m+[m[32m        $chartJsPath = base_path('node_modules/chart.js/dist/chart.umd.js');[m
[32m+[m[32m        $chartJsContent = '';[m
[32m+[m[41m        [m
[32m+[m[32m        if (file_exists($chartJsPath)) {[m
[32m+[m[32m            $chartJsContent = file_get_contents($chartJsPath);[m
[32m+[m[32m        } else {[m
[32m+[m[32m            // Fallback: try to find it in a different location[m
[32m+[m[32m            $altPath = base_path('node_modules/chart.js/dist/chart.js');[m
[32m+[m[32m            if (file_exists($altPath)) {[m
[32m+[m[32m                $chartJsContent = file_get_contents($altPath);[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // Render a dedicated Blade view for the PDF content[m
[32m+[m[32m        $html = view('printing.report', [[m
[32m+[m[32m            'data' => $data,[m[41m [m
[32m+[m[32m            'notes' => $notes,[m
[32m+[m[32m            'chartJsContent' => $chartJsContent[m
[32m+[m[32m        ])->render();[m
[32m+[m
[32m+[m[32m        // Use Browsershot to generate the PDF from the rendered HTML[m
[32m+[m[32m        // Added delay to ensure Chart.js is loaded before rendering[m
[32m+[m[32m        $pdf = Browsershot::html($html)[m
[32m+[m[32m            ->format('Letter')[m
[32m+[m[32m            ->showBrowserHeaderAndFooter(false)[m
[32m+[m[32m            ->waitUntilNetworkIdle()[m
[32m+[m[32m            ->delay(3000) // Increase to 3 seconds to ensure charts render[m
[32m+[m[32m            ->setOption('args', ['--no-sandbox'])[m
[32m+[m[32m            ->pdf();[m
[32m+[m
         // Create a filename based on the report period[m
         $filename = 'Monthly_Report_' . str_replace(' ', '_', $data['report_period']) . '.pdf';[m
 [m
[36m@@ -34,12 +66,10 @@[m [mpublic function download(Request $request)[m
             'created_at' => now(),[m
         ]);[m
 [m
[31m-        // Return the view directly for client-side PDF generation[m
[31m-        return view('printing.report', [[m
[31m-            'data' => $data, [m
[31m-            'notes' => $notes,[m
[31m-            'filename' => $filename,[m
[31m-        ]);[m
[32m+[m[32m        // Return the generated PDF as a download[m
[32m+[m[32m        return response($pdf)[m
[32m+[m[32m            ->header('Content-Type', 'application/pdf')[m
[32m+[m[32m            ->header('Content-Disposition', 'attachment; filename="' . $filename . '"');[m
     }[m
 [m
     /**[m
[1mdiff --git a/app/Http/Controllers/StaffPortalController.php b/app/Http/Controllers/StaffPortalController.php[m
[1mindex 997d638..d1e3d03 100644[m
[1m--- a/app/Http/Controllers/StaffPortalController.php[m
[1m+++ b/app/Http/Controllers/StaffPortalController.php[m
[36m@@ -4,12 +4,14 @@[m
 [m
 use Illuminate\Http\Request;[m
 use Illuminate\Support\Facades\DB;[m
[32m+[m[32muse Illuminate\Support\Facades\Storage;[m
 use App\Models\User;[m
 use App\Models\Section;[m
 use App\Models\Billing;[m
 use App\Models\Payment;[m
 use Illuminate\View\View;[m
 use App\Models\BillingSetting;[m
[32m+[m[32muse App\Models\Rate;[m
 use App\Http\Controllers\Api\DashboardController;[m
 use Carbon\Carbon;[m
 [m
[36m@@ -42,8 +44,16 @@[m [mpublic function index(): View[m
                     'stallNumber' => optional($user->stall)->table_number ?? 'N/A',[m
                     'daily_rate' => optional($user->stall)->daily_rate,[m
                     'area' => optional($user->stall)->area,[m
[32m+[m[32m                    'profile_picture' => $user->profile_picture ? Storage::url($user->profile_picture) : null,[m
                 ];[m
[31m-            });[m
[32m+[m[32m            })[m
[32m+[m[32m            ->sort(function ($a, $b) {[m
[32m+[m[32m                // Sort alphabetically by stall number using natural sort for alphanumeric values[m
[32m+[m[32m                $stallA = strtoupper($a['stallNumber'] ?? '');[m
[32m+[m[32m                $stallB = strtoupper($b['stallNumber'] ?? '');[m
[32m+[m[32m                return strnatcasecmp($stallA, $stallB);[m
[32m+[m[32m            })[m
[32m+[m[32m            ->values(); // Re-index the collection[m
 [m
         $sections = Section::query()->distinct()->pluck('name');[m
 [m
[36m@@ -75,7 +85,7 @@[m [mpublic function index(): View[m
                 'utilityConsumption' => $dashboardApiController->getUtilityConsumption($request)->getData(true),[m
                 'vendorPulse' => [[m
                     'topPerformers' => $dashboardApiController->getTopPerformingVendors($request)->getData(true),[m
[31m-                    'needsSupport' => $needsSupportResponse['data'] ?? [],[m
[32m+[m[32m                    'needsSupport' => $needsSupportResponse,[m
                 ],[m
                 'filterData' => [[m
                     'years' => $years,[m
[36m@@ -139,10 +149,41 @@[m [mpublic function storePayment(Request $request, User $vendor)[m
                     throw new \Exception("This vendor has no outstanding bills to pay.");[m
                 }[m
 [m
[32m+[m[32m                $billingSettings = BillingSetting::all()->keyBy('utility_type');[m
[32m+[m[32m                $paymentDate = Carbon::parse($request->payment_date);[m
[32m+[m
                 foreach ($unpaidBills as $bill) {[m
[32m+[m[32m                    $originalAmount = (float) $bill->amount;[m
[32m+[m[32m                    $dueDate = Carbon::parse($bill->due_date);[m
[32m+[m[32m                    $finalAmount = $originalAmount;[m
[32m+[m[32m                    $settings = $billingSettings->get($bill->utility_type);[m
[32m+[m
[32m+[m[32m                    // Calculate the correct amount based on payment date[m
[32m+[m[32m                    if ($paymentDate->gt($dueDate)) {[m
[32m+[m[32m                        // Payment was LATE, calculate penalties[m
[32m+[m[32m                        if ($bill->utility_type === 'Rent' && $settings) {[m
[32m+[m[32m                            $interest_months = (int) floor($dueDate->floatDiffInMonths($paymentDate));[m
[32m+[m[32m                            $surcharge = $originalAmount * (float)($settings->surcharge_rate ?? 0);[m
[32m+[m[32m                            $interest = $originalAmount * (float)($settings->monthly_interest_rate ?? 0) * $interest_months;[m
[32m+[m[32m                            $finalAmount += $surcharge + $interest;[m
[32m+[m[32m                        } else if ($settings) {[m
[32m+[m[32m                            $penalty = $originalAmount * (float)($settings->penalty_rate ?? 0);[m
[32m+[m[32m                            $finalAmount += $penalty;[m
[32m+[m[32m                        }[m
[32m+[m[32m                    } else if ($paymentDate->day <= 15) {[m
[32m+[m[32m                        // Payment was ON TIME (before due date and within discount period), check for discount[m
[32m+[m[32m                        $billMonth = Carbon::parse($bill->period_start)->format('Y-m');[m
[32m+[m[32m                        $paymentMonth = $paymentDate->format('Y-m');[m
[32m+[m
[32m+[m[32m                        if ($billMonth === $paymentMonth && $bill->utility_type === 'Rent' && $settings && (float)$settings->discount_rate > 0) {[m
[32m+[m[32m                            $discountAmount = $originalAmount * (float)$settings->discount_rate;[m
[32m+[m[32m                            $finalAmount -= $discountAmount;[m
[32m+[m[32m                        }[m
[32m+[m[32m                    }[m
[32m+[m
                     Payment::create([[m
                         'billing_id' => $bill->id,[m
[31m-                        'amount_paid' => $bill->amount,[m
[32m+[m[32m                        'amount_paid' => $finalAmount,[m
                         'payment_date' => $request->payment_date,[m
                     ]);[m
 [m
[36m@@ -166,21 +207,21 @@[m [mpublic function viewAsVendorPartial(User $vendor): View[m
         $vendor->load('stall.section');[m
 [m
         $outstandingBills = Billing::where('stall_id', $vendor->stall->id)[m
[31m-            ->where(function ($query) {[m
[31m-                $query->where('status', 'unpaid')[m
[31m-                    ->orWhere(function ($subQuery) {[m
[31m-                        $subQuery->where('status', 'paid')[m
[31m-                            ->whereHas('payment', function ($paymentQuery) {[m
[31m-                                $paymentQuery->whereMonth('payment_date', Carbon::now()->month)[m
[31m-                                    ->whereYear('payment_date', Carbon::now()->year);[m
[31m-                            });[m
[31m-                    });[m
[31m-            })[m
[32m+[m[32m            ->where('status', 'unpaid')[m
             ->with('payment')[m
             ->orderBy('due_date', 'desc')[m
             ->get();[m
 [m
         $billingSettings = BillingSetting::all()->keyBy('utility_type');[m
[32m+[m[41m        [m
[32m+[m[32m        // Get current utility rates[m
[32m+[m[32m        $utilityRates = cache()->remember('utility_rates', 3600, function () {[m
[32m+[m[32m            return Rate::whereIn('utility_type', ['Electricity', 'Water'])[m
[32m+[m[32m                ->select('id', 'utility_type', 'rate', 'monthly_rate')[m
[32m+[m[32m                ->get()[m
[32m+[m[32m                ->keyBy('utility_type');[m
[32m+[m[32m        });[m
[32m+[m[41m        [m
         $today = Carbon::today();[m
 [m
         foreach ($outstandingBills as $bill) {[m
[36m@@ -271,6 +312,7 @@[m [mpublic function viewAsVendorPartial(User $vendor): View[m
             'groupedBills' => $groupedBills,[m
             'outstandingBills' => $outstandingBills,[m
             'billingSettings' => $billingSettings,[m
[32m+[m[32m            'utilityRates' => $utilityRates,[m
         ]);[m
     }[m
 [m
[1mdiff --git a/app/Http/Controllers/SuperAdminController.php b/app/Http/Controllers/SuperAdminController.php[m
[1mindex 9e438bd..45e952f 100644[m
[1m--- a/app/Http/Controllers/SuperAdminController.php[m
[1m+++ b/app/Http/Controllers/SuperAdminController.php[m
[36m@@ -63,6 +63,7 @@[m [mpublic function index()[m
 [m
         // Fetch data for all other sections, passing the $request object[m
         $rentalRates = $rentalRateController->index($request)->getData(true);[m
[32m+[m[32m        $rentalRateHistory = $rentalRateController->history($request)->getData(true);[m
         $utilityRates = $utilityRateController->index($request)->getData(true);[m
         $utilityRateHistory = $utilityRateController->history($request)->getData(true);[m
         $meterReadingSchedule = $scheduleController->show($request)->getData(true);[m
[36m@@ -90,7 +91,7 @@[m [mpublic function index()[m
             'utilityConsumption' => $utilityConsumption,[m
             'vendorPulse' => [[m
                 'topPerformers' => $topPerformers,[m
[31m-                'needsSupport' => $vendorsNeedingSupport['data'],[m
[32m+[m[32m                'needsSupport' => $vendorsNeedingSupport,[m
             ],[m
             'filterData' => [[m
                 'years' => $years,[m
[36m@@ -98,6 +99,7 @@[m [mpublic function index()[m
             ],[m
             // Add all the new data to the initial state[m
             'rentalRates' => $rentalRates,[m
[32m+[m[32m            'rentalRateHistory' => $rentalRateHistory,[m
             'utilityRates' => $utilityRates,[m
             'utilityRateHistory' => $utilityRateHistory,[m
             'meterReadingSchedule' => $meterReadingSchedule,[m
[1mdiff --git a/app/Http/Controllers/VendorController.php b/app/Http/Controllers/VendorController.php[m
[1mindex e50954e..cf2c4ca 100644[m
[1m--- a/app/Http/Controllers/VendorController.php[m
[1m+++ b/app/Http/Controllers/VendorController.php[m
[36m@@ -10,6 +10,8 @@[m
 use App\Models\Rate;[m
 use App\Models\Stall;[m
 use App\Models\BillingSetting;[m
[32m+[m[32muse App\Models\UtilityReading;[m
[32m+[m[32muse App\Models\Payment;[m
 use Illuminate\Support\Facades\DB;[m
 use Illuminate\View\View;[m
 use App\Models\User;[m
[36m@@ -25,30 +27,30 @@[m [mpublic function dashboard(?User $vendor = null)[m
         }[m
 [m
         if (!$vendor || !$vendor->stall) {[m
[31m-            // Instead of aborting 404, show a friendly "No Stall Assigned" page[m
[31m-            return view('vendor_portal.no-stall');[m
[32m+[m[32m            abort(404, 'Vendor or stall not found.');[m
         }[m
 [m
         $vendor->load('stall.section');[m
 [m
         $outstandingBills = Billing::where('stall_id', $vendor->stall->id)[m
[31m-            ->where(function ($query) {[m
[31m-                $query->where('status', 'unpaid')[m
[31m-                      ->orWhere(function ($subQuery) {[m
[31m-                          $subQuery->where('status', 'paid')[m
[31m-                                   ->whereHas('payment', function ($paymentQuery) {[m
[31m-                                       $paymentQuery->whereMonth('payment_date', Carbon::now()->month)[m
[31m-                                                    ->whereYear('payment_date', Carbon::now()->year);[m
[31m-                                   });[m
[31m-                      });[m
[31m-            })[m
[31m-            ->with('payment')[m
[32m+[m[32m            ->where('status', 'unpaid')[m
[32m+[m[32m            ->with('payment:id,billing_id,amount_paid,payment_date')[m
[32m+[m[32m            ->select('id', 'stall_id', 'utility_type', 'period_start', 'period_end', 'amount', 'due_date', 'disconnection_date', 'status', 'consumption', 'current_reading', 'previous_reading', 'rate')[m
             ->orderBy('due_date', 'desc')[m
             ->get();[m
 [m
[31m-        $billingSettings = BillingSetting::all()->keyBy('utility_type');[m
[32m+[m[32m        // Cache billing settings (rarely changes)[m
[32m+[m[32m        $billingSettings = cache()->remember('billing_settings', 3600, function () {[m
[32m+[m[32m            return BillingSetting::all()->keyBy('utility_type');[m
[32m+[m[32m        });[m
[32m+[m[41m        [m
         $today = Carbon::today();[m
 [m
[32m+[m[32m        // Pre-parse dates to avoid repeated parsing[m
[32m+[m[32m        $today = Carbon::today();[m
[32m+[m[32m        $todayDay = $today->day;[m
[32m+[m[32m        $currentMonth = $today->format('Y-m');[m
[32m+[m
         foreach ($outstandingBills as $bill) {[m
             $bill->original_amount = (float) $bill->amount;[m
             $originalDueDate = Carbon::parse($bill->due_date);[m
[36m@@ -96,9 +98,8 @@[m [mpublic function dashboard(?User $vendor = null)[m
                     $bill->display_amount_due = $bill->original_amount;[m
 [m
                     // Check for early payment discount[m
[31m-                    if ($today->day <= 15) {[m
[32m+[m[32m                    if ($todayDay <= 15) {[m
                         $billMonth = Carbon::parse($bill->period_start)->format('Y-m');[m
[31m-                        $currentMonth = $today->format('Y-m');[m
                         if ($billMonth === $currentMonth && $bill->utility_type === 'Rent' && $settings && (float)$settings->discount_rate > 0) {[m
                             $discountAmount = $bill->original_amount * (float)$settings->discount_rate;[m
                             $bill->display_amount_due = $bill->original_amount - $discountAmount;[m
[36m@@ -119,16 +120,29 @@[m [mpublic function dashboard(?User $vendor = null)[m
             }[m
         }[m
 [m
[32m+[m[32m        // Optimize grouping by pre-parsing dates[m
         $groupedBills = $outstandingBills->groupBy(function ($bill) {[m
             $periodDate = Carbon::parse($bill->period_start);[m
             if (in_array($bill->utility_type, ['Water', 'Electricity'])) {[m
[31m-                return $periodDate->addMonth()->format('F Y');[m
[32m+[m[32m                return $periodDate->copy()->addMonth()->format('F Y');[m
             }[m
             return $periodDate->format('F Y');[m
         });[m
         [m
[31m-        $utilityRates = Rate::whereIn('utility_type', ['Electricity', 'Water'])->get()->keyBy('utility_type');[m
[32m+[m[32m        // Cache utility rates (rarely changes)[m
[32m+[m[32m        $utilityRates = cache()->remember('utility_rates', 3600, function () {[m
[32m+[m[32m            return Rate::whereIn('utility_type', ['Electricity', 'Water'])[m
[32m+[m[32m                ->select('id', 'utility_type', 'rate', 'monthly_rate')[m
[32m+[m[32m                ->get()[m
[32m+[m[32m                ->keyBy('utility_type');[m
[32m+[m[32m        });[m
[32m+[m[41m        [m
         $stallData = $vendor->stall;[m
[32m+[m[41m        [m
[32m+[m[32m        // Pre-load current month's payment history for instant display[m
[32m+[m[32m        $currentYear = Carbon::now()->year;[m
[32m+[m[32m        $currentMonth = Carbon::now()->month;[m
[32m+[m[32m        $paymentHistoryInitial = $this->getPaymentHistoryData($vendor, $currentYear, $currentMonth, null, 1, 20);[m
 [m
         return view('vendor_portal.vendor', [[m
             'vendor' => $vendor,[m
[36m@@ -137,6 +151,7 @@[m [mpublic function dashboard(?User $vendor = null)[m
             'utilityRates' => $utilityRates,[m
             'stallData' => $stallData,[m
             'billingSettings' => $billingSettings,[m
[32m+[m[32m            'paymentHistoryInitial' => $paymentHistoryInitial,[m
             'isStaffView' => !Auth::user()->isVendor()[m
         ]);[m
     }[m
[36m@@ -154,23 +169,23 @@[m [mpublic function getDashboardData(?User $vendor = null)[m
     $vendor->load('stall.section');[m
 [m
     $outstandingBills = Billing::where('stall_id', $vendor->stall->id)[m
[31m-        ->where(function ($query) {[m
[31m-            $query->where('status', 'unpaid')[m
[31m-                  ->orWhere(function ($subQuery) {[m
[31m-                      $subQuery->where('status', 'paid')[m
[31m-                               ->whereHas('payment', function ($paymentQuery) {[m
[31m-                                   $paymentQuery->whereMonth('payment_date', Carbon::now()->month)[m
[31m-                                                ->whereYear('payment_date', Carbon::now()->year);[m
[31m-                               });[m
[31m-                  });[m
[31m-        })[m
[31m-        ->with('payment')[m
[32m+[m[32m        ->where('status', 'unpaid')[m
[32m+[m[32m        ->with('payment:id,billing_id,amount_paid,payment_date')[m
[32m+[m[32m        ->select('id', 'stall_id', 'utility_type', 'period_start', 'period_end', 'amount', 'due_date', 'disconnection_date', 'status', 'consumption', 'current_reading', 'previous_reading', 'rate')[m
         ->orderBy('due_date', 'desc')[m
         ->get();[m
 [m
[31m-    $billingSettings = BillingSetting::all()->keyBy('utility_type');[m
[32m+[m[32m    // Cache billing settings (rarely changes)[m
[32m+[m[32m    $billingSettings = cache()->remember('billing_settings', 3600, function () {[m
[32m+[m[32m        return BillingSetting::all()->keyBy('utility_type');[m
[32m+[m[32m    });[m
[32m+[m[41m    [m
     $today = Carbon::today();[m
 [m
[32m+[m[32m    // Pre-calculate today values[m
[32m+[m[32m    $todayDay = $today->day;[m
[32m+[m[32m    $currentMonth = $today->format('Y-m');[m
[32m+[m
     foreach ($outstandingBills as $bill) {[m
         $bill->original_amount = (float) $bill->amount;[m
         $originalDueDate = Carbon::parse($bill->due_date);[m
[36m@@ -208,9 +223,8 @@[m [mpublic function getDashboardData(?User $vendor = null)[m
                 }[m
                 $current_total_due += $penaltyAmount;[m
                 $bill->penalty_applied = $penaltyAmount;[m
[31m-            } else if ($today->day <= 15) {[m
[32m+[m[32m            } else if ($todayDay <= 15) {[m
                 $billMonth = Carbon::parse($bill->period_start)->format('Y-m');[m
[31m-                $currentMonth = $today->format('Y-m');[m
 [m
                 if ($billMonth === $currentMonth && $bill->utility_type === 'Rent' && $settings && (float)$settings->discount_rate > 0) {[m
                     $discountAmount = $bill->original_amount * (float)$settings->discount_rate;[m
[36m@@ -229,37 +243,164 @@[m [mpublic function getDashboardData(?User $vendor = null)[m
     ]);[m
     }[m
 [m
[31m-    public function paymentHistoryApi(Request $request)[m
[32m+[m[32m    private function getPaymentHistoryData($vendor, $year = null, $month = null, $search = null, $page = 1, $perPage = 20)[m
     {[m
[31m-        $vendor = Auth::user();[m
[31m-        if (!$vendor->stall) {[m
[31m-            return response()->json(['error' => 'User not assigned to a stall.'], 403);[m
[32m+[m[32m        if (!$vendor || !$vendor->stall) {[m
[32m+[m[32m            return ['data' => [], 'total' => 0, 'has_more' => false];[m
         }[m
[31m-        $year = $request->get('year');[m
[31m-        $month = $request->get('month');[m
[31m-        $search = $request->get('search');[m
 [m
[31m-        $query = Billing::with('payment')[m
[31m-            ->join('payments', 'billing.id', '=', 'payments.billing_id')[m
[31m-            ->where('billing.stall_id', $vendor->stall->id)[m
[31m-            ->where('billing.status', 'paid')[m
[31m-            ->whereDate('payments.payment_date', '<', Carbon::now()->startOfMonth());[m
[31m-[m
[31m-        if ($year) { [m
[31m-            $query->whereYear('payments.payment_date', $year);[m
[32m+[m[32m        // Build cache key for this query[m
[32m+[m[32m        $cacheKey = "payment_history_vendor_{$vendor->stall->id}_y{$year}_m{$month}_s{$search}_p{$page}";[m
[32m+[m[41m        [m
[32m+[m[32m        // Cache results for 5 minutes (short cache for search results)[m
[32m+[m[32m        $cachedResult = cache()->get($cacheKey);[m
[32m+[m[32m        if ($cachedResult && !$search) { // Don't cache search results[m
[32m+[m[32m            return $cachedResult;[m
         }[m
 [m
[31m-        if ($month && $month !== "all") {[m
[31m-            $query->whereMonth('payments.payment_date', $month);[m
[32m+[m[32m        // Optimized query: Start from payments table for better index usage[m
[32m+[m[32m        $baseQuery = DB::table('payments')[m
[32m+[m[32m            ->join('billing', 'payments.billing_id', '=', 'billing.id')[m
[32m+[m[32m            ->where('billing.stall_id', $vendor->stall->id)[m
[32m+[m[32m            ->where('billing.status', 'paid');[m
[32m+[m
[32m+[m[32m        // Use date range instead of whereYear/whereMonth for better index usage[m
[32m+[m[32m        if ($year) {[m
[32m+[m[32m            $startDate = Carbon::create($year, 1, 1)->startOfYear();[m
[32m+[m[32m            $endDate = Carbon::create($year, 12, 31)->endOfYear();[m
[32m+[m[41m            [m
[32m+[m[32m            if ($month && $month !== "all") {[m
[32m+[m[32m                $startDate = Carbon::create($year, $month, 1)->startOfMonth();[m
[32m+[m[32m                $endDate = Carbon::create($year, $month, 1)->endOfMonth();[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
[32m+[m[32m            $baseQuery->whereBetween('payments.payment_date', [[m
[32m+[m[32m                $startDate->toDateString(),[m
[32m+[m[32m                $endDate->toDateString()[m
[32m+[m[32m            ]);[m
[32m+[m[32m        } elseif ($month && $month !== "all") {[m
[32m+[m[32m            // If only month is provided without year, use current year[m
[32m+[m[32m            $year = Carbon::now()->year;[m
[32m+[m[32m            $startDate = Carbon::create($year, $month, 1)->startOfMonth();[m
[32m+[m[32m            $endDate = Carbon::create($year, $month, 1)->endOfMonth();[m
[32m+[m[32m            $baseQuery->whereBetween('payments.payment_date', [[m
[32m+[m[32m                $startDate->toDateString(),[m
[32m+[m[32m                $endDate->toDateString()[m
[32m+[m[32m            ]);[m
         }[m
 [m
         if ($search) {[m
[31m-            $query->where('billing.utility_type', 'like', '%' . $search . '%');[m
[32m+[m[32m            $baseQuery->where('billing.utility_type', 'like', '%' . $search . '%');[m
         }[m
 [m
[31m-        $bills = $query->orderBy('payments.payment_date', 'desc')->select('billing.*')->get();[m
[32m+[m[32m        // Get total count (clone query to avoid affecting main query)[m
[32m+[m[32m        $total = (clone $baseQuery)->count();[m
[32m+[m[41m        [m
[32m+[m[32m        // Get paginated results[m
[32m+[m[32m        $bills = (clone $baseQuery)[m
[32m+[m[32m            ->select([m
[32m+[m[32m                'billing.id',[m
[32m+[m[32m                'billing.stall_id',[m
[32m+[m[32m                'billing.utility_type',[m
[32m+[m[32m                'billing.period_start',[m
[32m+[m[32m                'billing.period_end',[m
[32m+[m[32m                'billing.amount',[m
[32m+[m[32m                'billing.due_date',[m
[32m+[m[32m                'billing.disconnection_date',[m
[32m+[m[32m                'billing.status',[m
[32m+[m[32m                'payments.amount_paid',[m
[32m+[m[32m                'payments.payment_date'[m
[32m+[m[32m            )[m
[32m+[m[32m            ->orderBy('payments.payment_date', 'desc')[m
[32m+[m[32m            ->skip(($page - 1) * $perPage)[m
[32m+[m[32m            ->take($perPage)[m
[32m+[m[32m            ->get();[m
[32m+[m
[32m+[m[32m        // Get billing settings for recalculation[m
[32m+[m[32m        $billingSettings = BillingSetting::all()->keyBy('utility_type');[m
[32m+[m[41m        [m
[32m+[m[32m        // Format response to match expected structure[m
[32m+[m[32m        $formattedBills = $bills->map(function ($bill) use ($billingSettings) {[m
[32m+[m[32m            $originalAmount = (float) $bill->amount;[m
[32m+[m[32m            $paymentDate = Carbon::parse($bill->payment_date);[m
[32m+[m[32m            $dueDate = Carbon::parse($bill->due_date);[m
[32m+[m[32m            $finalAmount = $originalAmount;[m
[32m+[m[32m            $settings = $billingSettings->get($bill->utility_type);[m
[32m+[m[41m            [m
[32m+[m[32m            // Recalculate the correct amount based on payment date[m
[32m+[m[32m            if ($paymentDate->gt($dueDate)) {[m
[32m+[m[32m                // Payment was LATE, calculate penalties[m
[32m+[m[32m                if ($bill->utility_type === 'Rent' && $settings) {[m
[32m+[m[32m                    $interest_months = (int) floor($dueDate->floatDiffInMonths($paymentDate));[m
[32m+[m[32m                    $surcharge = $originalAmount * (float)($settings->surcharge_rate ?? 0);[m
[32m+[m[32m                    $interest = $originalAmount * (float)($settings->monthly_interest_rate ?? 0) * $interest_months;[m
[32m+[m[32m                    $finalAmount = $originalAmount + $surcharge + $interest;[m
[32m+[m[32m                } else if ($settings) {[m
[32m+[m[32m                    $penalty = $originalAmount * (float)($settings->penalty_rate ?? 0);[m
[32m+[m[32m                    $finalAmount = $originalAmount + $penalty;[m
[32m+[m[32m                }[m
[32m+[m[32m            } else if ($paymentDate->day <= 15) {[m
[32m+[m[32m                // Payment was ON TIME (before due date and within discount period), check for discount[m
[32m+[m[32m                $billMonth = Carbon::parse($bill->period_start)->format('Y-m');[m
[32m+[m[32m                $paymentMonth = $paymentDate->format('Y-m');[m
[32m+[m
[32m+[m[32m                if ($billMonth === $paymentMonth && $bill->utility_type === 'Rent' && $settings && (float)$settings->discount_rate > 0) {[m
[32m+[m[32m                    $discountAmount = $originalAmount * (float)$settings->discount_rate;[m
[32m+[m[32m                    $finalAmount = $originalAmount - $discountAmount;[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
[32m+[m[32m            return (object) [[m
[32m+[m[32m                'id' => $bill->id,[m
[32m+[m[32m                'stall_id' => $bill->stall_id,[m
[32m+[m[32m                'utility_type' => $bill->utility_type,[m
[32m+[m[32m                'period_start' => $bill->period_start,[m
[32m+[m[32m                'period_end' => $bill->period_end,[m
[32m+[m[32m                'amount' => $bill->amount,[m
[32m+[m[32m                'due_date' => $bill->due_date,[m
[32m+[m[32m                'disconnection_date' => $bill->disconnection_date,[m
[32m+[m[32m                'status' => $bill->status,[m
[32m+[m[32m                'payment' => (object) [[m
[32m+[m[32m                    'amount_paid' => $finalAmount, // Use recalculated amount[m
[32m+[m[32m                    'payment_date' => $bill->payment_date,[m
[32m+[m[32m                ],[m
[32m+[m[32m            ];[m
[32m+[m[32m        });[m
 [m
[31m-        return response()->json($bills);[m
[32m+[m[32m        $lastPage = (int) ceil($total / $perPage);[m
[32m+[m
[32m+[m[32m        $response = [[m
[32m+[m[32m            'data' => $formattedBills,[m
[32m+[m[32m            'current_page' => (int) $page,[m
[32m+[m[32m            'last_page' => $lastPage,[m
[32m+[m[32m            'per_page' => $perPage,[m
[32m+[m[32m            'total' => $total,[m
[32m+[m[32m            'has_more' => $page < $lastPage,[m
[32m+[m[32m        ];[m
[32m+[m[41m        [m
[32m+[m[32m        // Cache result for 5 minutes (only if no search, as search results change frequently)[m
[32m+[m[32m        if (!$search) {[m
[32m+[m[32m            cache()->put($cacheKey, $response, 300); // 5 minutes[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        return $response;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    public function paymentHistoryApi(Request $request)[m
[32m+[m[32m    {[m
[32m+[m[32m        $vendor = Auth::user();[m
[32m+[m[32m        if (!$vendor->stall) {[m
[32m+[m[32m            return response()->json(['error' => 'User not assigned to a stall.'], 403);[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        $year = $request->get('year');[m
[32m+[m[32m        $month = $request->get('month');[m
[32m+[m[32m        $search = $request->get('search');[m
[32m+[m[32m        $page = $request->get('page', 1);[m
[32m+[m[41m        [m
[32m+[m[32m        $result = $this->getPaymentHistoryData($vendor, $year, $month, $search, $page, 20);[m
[32m+[m
[32m+[m[32m        return response()->json($result);[m
     }[m
 [m
     public function paymentYearsApi()[m
[36m@@ -269,17 +410,26 @@[m [mpublic function paymentYearsApi()[m
             return response()->json(['error' => 'User not assigned to a stall.'], 403);[m
         }[m
 [m
[31m-        $years = Billing::join('payments', 'billing.id', '=', 'payments.billing_id')[m
[32m+[m[32m        // Cache years list (changes infrequently)[m
[32m+[m[32m        $cacheKey = "payment_years_vendor_{$vendor->stall->id}";[m
[32m+[m[32m        $years = cache()->remember($cacheKey, 3600, function () use ($vendor) {[m
[32m+[m[32m            // Optimized: Direct query on payments table[m
[32m+[m[32m            $years = DB::table('payments')[m
[32m+[m[32m                ->join('billing', 'payments.billing_id', '=', 'billing.id')[m
             ->where('billing.stall_id', $vendor->stall->id)[m
[31m-            ->select(DB::raw('EXTRACT(YEAR FROM payments.payment_date) as year'))[m
[31m-            ->distinct()[m
[32m+[m[32m                ->where('billing.status', 'paid')[m
[32m+[m[32m                ->select(DB::raw('DISTINCT YEAR(payments.payment_date) as year'))[m
             ->orderBy('year', 'desc')[m
[31m-            ->pluck('year');[m
[32m+[m[32m                ->pluck('year')[m
[32m+[m[32m                ->toArray();[m
 [m
[31m-        if ($years->isEmpty()) {[m
[31m-            $years->push(now()->year);[m
[32m+[m[32m            if (empty($years)) {[m
[32m+[m[32m                $years = [now()->year];[m
         }[m
 [m
[32m+[m[32m            return $years;[m
[32m+[m[32m        });[m
[32m+[m
         return response()->json($years);[m
     }[m
 [m
[36m@@ -356,4 +506,131 @@[m [mpublic function updatePassword(Request $request)[m
         return redirect()->route('vendor.dashboard')[m
             ->with('success', $message);[m
     }[m
[32m+[m
[32m+[m[32m    public function analytics(?User $vendor = null)[m
[32m+[m[32m    {[m
[32m+[m[32m        if (is_null($vendor) && Auth::user()->isVendor()) {[m
[32m+[m[32m            $vendor = Auth::user();[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        if (!$vendor || !$vendor->stall) {[m
[32m+[m[32m            return response()->json(['error' => 'Vendor or stall not found.'], 404);[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        $stallId = $vendor->stall->id;[m
[32m+[m
[32m+[m[32m        // Get electricity consumption data (last 12 months)[m
[32m+[m[32m        $electricityReadings = UtilityReading::where('stall_id', $stallId)[m
[32m+[m[32m            ->where('utility_type', 'Electricity')[m
[32m+[m[32m            ->orderBy('reading_date', 'desc')[m
[32m+[m[32m            ->limit(12)[m
[32m+[m[32m            ->get()[m
[32m+[m[32m            ->reverse();[m
[32m+[m
[32m+[m[32m        $consumptionData = [];[m
[32m+[m[32m        $consumptionLabels = [];[m
[32m+[m[41m        [m
[32m+[m[32m        foreach ($electricityReadings as $index => $reading) {[m
[32m+[m[32m            if ($index > 0) {[m
[32m+[m[32m                $previousReading = $electricityReadings[$index - 1];[m
[32m+[m[32m                $consumption = $reading->current_reading - $previousReading->current_reading;[m
[32m+[m[32m                $consumptionData[] = max(0, $consumption); // Ensure non-negative[m
[32m+[m[32m                $consumptionLabels[] = Carbon::parse($reading->reading_date)->format('M Y');[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // Get payment tracking data (on-time vs late payments)[m
[32m+[m[32m        // Optimize: Only get billings that are paid or overdue (skip future unpaid bills)[m
[32m+[m[32m        $billings = Billing::where('stall_id', $stallId)[m
[32m+[m[32m            ->where(function ($query) {[m
[32m+[m[32m                $query->where('status', 'paid')[m
[32m+[m[32m                      ->orWhere(function ($q) {[m
[32m+[m[32m                          $q->where('status', 'unpaid')[m
[32m+[m[32m                            ->where('due_date', '<=', Carbon::today());[m
[32m+[m[32m                      });[m
[32m+[m[32m            })[m
[32m+[m[32m            ->with('payment:id,billing_id,payment_date')[m
[32m+[m[32m            ->select('id', 'stall_id', 'utility_type', 'due_date', 'status')[m
[32m+[m[32m            ->orderBy('due_date', 'desc')[m
[32m+[m[32m            ->get();[m
[32m+[m
[32m+[m[32m        $today = Carbon::today();[m
[32m+[m[32m        $onTimeCount = 0;[m
[32m+[m[32m        $lateCount = 0;[m
[32m+[m[32m        $paymentTimeline = [];[m
[32m+[m
[32m+[m[32m        foreach ($billings as $billing) {[m
[32m+[m[32m            $dueDate = Carbon::parse($billing->due_date)->startOfDay();[m
[32m+[m[32m            $isOnTime = false;[m
[32m+[m[32m            $recordDate = null;[m
[32m+[m[41m            [m
[32m+[m[32m            if ($billing->status === 'paid' && $billing->payment) {[m
[32m+[m[32m                // For paid bills: check if payment was made on or before due date[m
[32m+[m[32m                $paymentDate = Carbon::parse($billing->payment->payment_date)->startOfDay();[m
[32m+[m[32m                $isOnTime = $paymentDate->lte($dueDate);[m
[32m+[m[32m                $recordDate = $paymentDate;[m
[32m+[m[32m            } else {[m
[32m+[m[32m                // For unpaid bills: check if due date has passed[m
[32m+[m[32m                if ($today->gt($dueDate)) {[m
[32m+[m[32m                    // Unpaid and past due date = late[m
[32m+[m[32m                    $isOnTime = false;[m
[32m+[m[32m                    $recordDate = $dueDate; // Use due date for timeline grouping[m
[32m+[m[32m                } else {[m
[32m+[m[32m                    // Unpaid but not yet due = not counted (not late, not on-time yet)[m
[32m+[m[32m                    continue; // Skip bills that aren't due yet[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
[32m+[m[32m            if ($isOnTime) {[m
[32m+[m[32m                $onTimeCount++;[m
[32m+[m[32m            } else {[m
[32m+[m[32m                $lateCount++;[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            // Add to timeline for trend analysis[m
[32m+[m[32m            if ($recordDate) {[m
[32m+[m[32m                $paymentTimeline[] = [[m
[32m+[m[32m                    'date' => $recordDate->format('Y-m'),[m
[32m+[m[32m                    'on_time' => $isOnTime ? 1 : 0,[m
[32m+[m[32m                    'late' => $isOnTime ? 0 : 1,[m
[32m+[m[32m                ];[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // Group timeline by month[m
[32m+[m[32m        $timelineGrouped = [];[m
[32m+[m[32m        foreach ($paymentTimeline as $item) {[m
[32m+[m[32m            $month = $item['date'];[m
[32m+[m[32m            if (!isset($timelineGrouped[$month])) {[m
[32m+[m[32m                $timelineGrouped[$month] = ['on_time' => 0, 'late' => 0];[m
[32m+[m[32m            }[m
[32m+[m[32m            $timelineGrouped[$month]['on_time'] += $item['on_time'];[m
[32m+[m[32m            $timelineGrouped[$month]['late'] += $item['late'];[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // Sort by date and get last 12 months[m
[32m+[m[32m        ksort($timelineGrouped);[m
[32m+[m[32m        $timelineGrouped = array_slice($timelineGrouped, -12, 12, true);[m
[32m+[m
[32m+[m[32m        $timelineLabels = array_keys($timelineGrouped);[m
[32m+[m[32m        $timelineOnTime = array_column($timelineGrouped, 'on_time');[m
[32m+[m[32m        $timelineLate = array_column($timelineGrouped, 'late');[m
[32m+[m
[32m+[m[32m        return response()->json([[m
[32m+[m[32m            'electricity' => [[m
[32m+[m[32m                'labels' => $consumptionLabels,[m
[32m+[m[32m                'data' => $consumptionData,[m
[32m+[m[32m            ],[m
[32m+[m[32m            'paymentTracking' => [[m
[32m+[m[32m                'onTime' => $onTimeCount,[m
[32m+[m[32m                'late' => $lateCount,[m
[32m+[m[32m                'total' => $onTimeCount + $lateCount,[m
[32m+[m[32m            ],[m
[32m+[m[32m            'paymentTimeline' => [[m
[32m+[m[32m                'labels' => $timelineLabels,[m
[32m+[m[32m                'onTime' => $timelineOnTime,[m
[32m+[m[32m                'late' => $timelineLate,[m
[32m+[m[32m            ],[m
[32m+[m[32m        ]);[m
[32m+[m[32m    }[m
 }[m
\ No newline at end of file[m
[1mdiff --git a/app/Models/Announcement.php b/app/Models/Announcement.php[m
[1mindex d5051e5..510385e 100644[m
[1m--- a/app/Models/Announcement.php[m
[1m+++ b/app/Models/Announcement.php[m
[36m@@ -9,6 +9,19 @@[m [mclass Announcement extends Model[m
 {[m
     use HasFactory;[m
 [m
[31m-    protected $fillable = ['title', 'content', 'is_active'];[m
[32m+[m[32m    protected $fillable = [[m
[32m+[m[32m        'title',[m[41m [m
[32m+[m[32m        'content',[m[41m [m
[32m+[m[32m        'is_active',[m
[32m+[m[32m        'announcement_type',[m
[32m+[m[32m        'related_section',[m
[32m+[m[32m        'related_utility',[m
[32m+[m[32m        'related_stall_id',[m
[32m+[m[32m        'recipients',[m
[32m+[m[32m    ];[m
[32m+[m
[32m+[m[32m    protected $casts = [[m
[32m+[m[32m        'recipients' => 'array',[m
[32m+[m[32m    ];[m
 }[m
 [m
[1mdiff --git a/app/Models/Schedule.php b/app/Models/Schedule.php[m
[1mindex 55026b5..54e744c 100644[m
[1m--- a/app/Models/Schedule.php[m
[1m+++ b/app/Models/Schedule.php[m
[36m@@ -14,5 +14,11 @@[m [mclass Schedule extends Model[m
         'schedule_type',[m
         'description',[m
         'schedule_date',[m
[32m+[m[32m        'schedule_day',[m
[32m+[m[32m        'sms_days',[m
[32m+[m[32m    ];[m
[32m+[m
[32m+[m[32m    protected $casts = [[m
[32m+[m[32m        'sms_days' => 'array',[m
     ];[m
 }[m
\ No newline at end of file[m
[1mdiff --git a/app/Models/User.php b/app/Models/User.php[m
[1mindex 7f44dfe..3ed10c8 100644[m
[1m--- a/app/Models/User.php[m
[1m+++ b/app/Models/User.php[m
[36m@@ -185,17 +185,36 @@[m [mpublic function getSemaphoreReadyContactNumber(): ?string[m
         // Tinatanggal ang lahat ng non-digit characters[m
         $digits = preg_replace('/\D+/', '', $this->contact_number);[m
         [m
[31m-        // Kung nagsisimula sa '63' at may 12 digits, kino-convert sa '09...' format[m
[32m+[m[32m        // Convert to international format (63...) for Semaphore API[m
[32m+[m[32m        // Semaphore API prefers international format based on response logs[m
[32m+[m[41m        [m
[32m+[m[32m        // If starts with '63' and has 12 digits, return as is (already international)[m
         if (substr($digits, 0, 2) === '63' && strlen($digits) === 12) {[m
[31m-            return '0' . substr($digits, 2);[m
[32m+[m[32m            return $digits;[m
         }[m
         [m
[31m-        // Kung nasa tamang '09' format na at 11 digits, ibalik ito[m
[32m+[m[32m        // If starts with '09' and has 11 digits, convert to international format (63...)[m
         if (substr($digits, 0, 2) === '09' && strlen($digits) === 11) {[m
[31m-            return $digits;[m
[32m+[m[32m            return '63' . substr($digits, 1); // Remove leading 0, add 63[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // If 10 digits (without leading 0), assume it's a local number and add 63[m
[32m+[m[32m        if (strlen($digits) === 10 && substr($digits, 0, 1) !== '0') {[m
[32m+[m[32m            return '63' . $digits;[m
         }[m
 [m
         // Kung hindi makilala ang format, ibalik ang null para hindi mag-send[m
         return null;[m
     }[m
[32m+[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Get the profile picture URL[m
[32m+[m[32m     */[m
[32m+[m[32m    public function getProfilePictureUrlAttribute(): ?string[m
[32m+[m[32m    {[m
[32m+[m[32m        if (!$this->profile_picture) {[m
[32m+[m[32m            return null;[m
[32m+[m[32m        }[m
[32m+[m[32m        return \Illuminate\Support\Facades\Storage::url($this->profile_picture);[m
[32m+[m[32m    }[m
 }[m
[1mdiff --git a/app/Models/UtilityReading.php b/app/Models/UtilityReading.php[m
[1mindex 3b2972e..c46309b 100644[m
[1m--- a/app/Models/UtilityReading.php[m
[1m+++ b/app/Models/UtilityReading.php[m
[36m@@ -29,7 +29,6 @@[m [mclass UtilityReading extends Model[m
         'reading_date',[m
         'current_reading',[m
         'previous_reading',[m
[31m-        'consumption',[m
     ];[m
 [m
     /**[m
[1mdiff --git a/app/Services/AnnouncementService.php b/app/Services/AnnouncementService.php[m
[1mnew file mode 100644[m
[1mindex 0000000..6a2ef5d[m
[1m--- /dev/null[m
[1m+++ b/app/Services/AnnouncementService.php[m
[36m@@ -0,0 +1,202 @@[m
[32m+[m[32m<?php[m
[32m+[m
[32m+[m[32mnamespace App\Services;[m
[32m+[m
[32m+[m[32muse App\Models\Announcement;[m
[32m+[m[32muse Illuminate\Support\Facades\Log;[m
[32m+[m
[32m+[m[32mclass AnnouncementService[m
[32m+[m[32m{[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Generate a draft announcement when utility rates change[m
[32m+[m[32m     */[m
[32m+[m[32m    public function createRateChangeAnnouncement(string $utilityType, float $oldRate, float $newRate, float $oldMonthlyRate = null, float $newMonthlyRate = null): ?Announcement[m
[32m+[m[32m    {[m
[32m+[m[32m        $rateChange = $newRate - $oldRate;[m
[32m+[m[32m        $rateChangePercent = $oldRate > 0 ? (($rateChange / $oldRate) * 100) : 0;[m
[32m+[m[32m        $direction = $rateChange > 0 ? 'increased' : ($rateChange < 0 ? 'decreased' : 'unchanged');[m
[32m+[m[41m        [m
[32m+[m[32m        $title = "{$utilityType} Rate Update";[m
[32m+[m[41m        [m
[32m+[m[32m        $content = "Dear Vendors and Staff,\n\n";[m
[32m+[m[32m        $content .= "This is to inform you that the {$utilityType} rate has been {$direction}.\n\n";[m
[32m+[m[32m        $content .= "Previous Rate: â‚±" . number_format($oldRate, 2) . " per " . ($utilityType === 'Electricity' ? 'kWh' : 'day') . "\n";[m
[32m+[m[32m        $content .= "New Rate: â‚±" . number_format($newRate, 2) . " per " . ($utilityType === 'Electricity' ? 'kWh' : 'day') . "\n";[m
[32m+[m[41m        [m
[32m+[m[32m        if ($oldMonthlyRate !== null && $newMonthlyRate !== null) {[m
[32m+[m[32m            $content .= "\nMonthly Rate:\n";[m
[32m+[m[32m            $content .= "Previous: â‚±" . number_format($oldMonthlyRate, 2) . "\n";[m
[32m+[m[32m            $content .= "New: â‚±" . number_format($newMonthlyRate, 2) . "\n";[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        if ($rateChangePercent != 0) {[m
[32m+[m[32m            $content .= "\nChange: " . ($rateChangePercent > 0 ? '+' : '') . number_format($rateChangePercent, 2) . "%\n";[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        $content .= "\nThis change will be reflected in your next billing statement.\n\n";[m
[32m+[m[32m        $content .= "Thank you for your understanding.\n\n";[m
[32m+[m[32m        $content .= "- Virac Public Market Administration";[m
[32m+[m
[32m+[m[32m        return Announcement::create([[m
[32m+[m[32m            'title' => $title,[m
[32m+[m[32m            'content' => $content,[m
[32m+[m[32m            'announcement_type' => 'rate_change',[m
[32m+[m[32m            'related_utility' => $utilityType,[m
[32m+[m[32m            'related_section' => $utilityType === 'Water' ? 'Wet Section' : null, // Water only for wet section[m
[32m+[m[32m            'is_active' => false, // Draft - needs to be activated manually[m
[32m+[m[32m        ]);[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Generate a draft announcement when billing settings change[m
[32m+[m[32m     */[m
[32m+[m[32m    public function createBillingSettingChangeAnnouncement(string $utilityType, string $settingName, float $oldValue, float $newValue): ?Announcement[m
[32m+[m[32m    {[m
[32m+[m[32m        $settingLabels = [[m
[32m+[m[32m            'discount_rate' => 'Discount Rate',[m
[32m+[m[32m            'surcharge_rate' => 'Surcharge Rate',[m
[32m+[m[32m            'monthly_interest_rate' => 'Monthly Interest Rate',[m
[32m+[m[32m            'penalty_rate' => 'Penalty Rate',[m
[32m+[m[32m        ];[m
[32m+[m
[32m+[m[32m        $label = $settingLabels[$settingName] ?? ucwords(str_replace('_', ' ', $settingName));[m
[32m+[m[32m        $oldPercent = $oldValue * 100;[m
[32m+[m[32m        $newPercent = $newValue * 100;[m
[32m+[m[32m        $change = $newPercent - $oldPercent;[m
[32m+[m[32m        $direction = $change > 0 ? 'increased' : ($change < 0 ? 'decreased' : 'unchanged');[m
[32m+[m
[32m+[m[32m        $title = "{$utilityType} {$label} Update";[m
[32m+[m[41m        [m
[32m+[m[32m        $content = "Dear Vendors and Staff,\n\n";[m
[32m+[m[32m        $content .= "This is to inform you that the {$utilityType} {$label} has been {$direction}.\n\n";[m
[32m+[m[32m        $content .= "Previous {$label}: " . number_format($oldPercent, 2) . "%\n";[m
[32m+[m[32m        $content .= "New {$label}: " . number_format($newPercent, 2) . "%\n";[m
[32m+[m[41m        [m
[32m+[m[32m        if ($change != 0) {[m
[32m+[m[32m            $content .= "\nChange: " . ($change > 0 ? '+' : '') . number_format($change, 2) . " percentage points\n";[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        $content .= "\nThis change will be reflected in your next billing statement.\n\n";[m
[32m+[m[32m        $content .= "Thank you for your understanding.\n\n";[m
[32m+[m[32m        $content .= "- Virac Public Market Administration";[m
[32m+[m
[32m+[m[32m        return Announcement::create([[m
[32m+[m[32m            'title' => $title,[m
[32m+[m[32m            'content' => $content,[m
[32m+[m[32m            'announcement_type' => 'billing_setting_change',[m
[32m+[m[32m            'related_utility' => $utilityType,[m
[32m+[m[32m            'related_section' => $utilityType === 'Water' ? 'Wet Section' : null,[m
[32m+[m[32m            'is_active' => false, // Draft - needs to be activated manually[m
[32m+[m[32m        ]);[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Generate a draft announcement when due date or disconnection date changes[m
[32m+[m[32m     */[m
[32m+[m[32m    public function createDateScheduleChangeAnnouncement(string $scheduleType, string $utilityType, string $oldDay, string $newDay): ?Announcement[m
[32m+[m[32m    {[m
[32m+[m[32m        $isDueDate = str_contains($scheduleType, 'Due Date');[m
[32m+[m[32m        $label = $isDueDate ? 'Due Date' : 'Disconnection Date';[m
[32m+[m[41m        [m
[32m+[m[32m        $title = "{$utilityType} {$label} Update";[m
[32m+[m[41m        [m
[32m+[m[32m        $content = "Dear Vendors and Staff,\n\n";[m
[32m+[m[32m        $content .= "This is to inform you that the {$utilityType} {$label} has been changed.\n\n";[m
[32m+[m[32m        $content .= "Previous {$label}: Day " . $oldDay . " of each month\n";[m
[32m+[m[32m        $content .= "New {$label}: Day " . $newDay . " of each month\n";[m
[32m+[m[41m        [m
[32m+[m[32m        if ($isDueDate) {[m
[32m+[m[32m            $content .= "\nPlease ensure your payments are made on or before the new due date to avoid penalties.\n";[m
[32m+[m[32m        } else {[m
[32m+[m[32m            $content .= "\nPlease ensure your payments are made before the new disconnection date to avoid service interruption.\n";[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        $content .= "\nThis change will take effect in the next billing cycle.\n\n";[m
[32m+[m[32m        $content .= "Thank you for your understanding.\n\n";[m
[32m+[m[32m        $content .= "- Virac Public Market Administration";[m
[32m+[m
[32m+[m[32m        return Announcement::create([[m
[32m+[m[32m            'title' => $title,[m
[32m+[m[32m            'content' => $content,[m
[32m+[m[32m            'announcement_type' => 'date_schedule_change',[m
[32m+[m[32m            'related_utility' => $utilityType,[m
[32m+[m[32m            'related_section' => $utilityType === 'Water' ? 'Wet Section' : null,[m
[32m+[m[32m            'is_active' => false, // Draft - needs to be activated manually[m
[32m+[m[32m        ]);[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Generate a draft announcement when rental rate changes for a specific stall[m
[32m+[m[32m     */[m
[32m+[m[32m    public function createRentalRateChangeAnnouncement(\App\Models\Stall $stall, float $oldDailyRate, float $newDailyRate, float $oldMonthlyRate = null, float $newMonthlyRate = null): ?Announcement[m
[32m+[m[32m    {[m
[32m+[m[32m        $dailyRateChange = $newDailyRate - $oldDailyRate;[m
[32m+[m[32m        $dailyRateChangePercent = $oldDailyRate > 0 ? (($dailyRateChange / $oldDailyRate) * 100) : 0;[m
[32m+[m[32m        $direction = $dailyRateChange > 0 ? 'increased' : ($dailyRateChange < 0 ? 'decreased' : 'unchanged');[m
[32m+[m[41m        [m
[32m+[m[32m        $stallIdentifier = $stall->table_number ?? "Stall #{$stall->id}";[m
[32m+[m[32m        $sectionName = $stall->section ? $stall->section->name : 'Unknown Section';[m
[32m+[m[41m        [m
[32m+[m[32m        $title = "Rental Rate Update - {$stallIdentifier}";[m
[32m+[m[41m        [m
[32m+[m[32m        $content = "Dear Vendor,\n\n";[m
[32m+[m[32m        $content .= "This is to inform you that the rental rate for {$stallIdentifier} ({$sectionName}) has been {$direction}.\n\n";[m
[32m+[m[32m        $content .= "Daily Rate:\n";[m
[32m+[m[32m        $content .= "Previous: â‚±" . number_format($oldDailyRate, 2) . "\n";[m
[32m+[m[32m        $content .= "New: â‚±" . number_format($newDailyRate, 2) . "\n";[m
[32m+[m[41m        [m
[32m+[m[32m        if ($oldMonthlyRate !== null && $newMonthlyRate !== null) {[m
[32m+[m[32m            $content .= "\nMonthly Rate:\n";[m
[32m+[m[32m            $content .= "Previous: â‚±" . number_format($oldMonthlyRate, 2) . "\n";[m
[32m+[m[32m            $content .= "New: â‚±" . number_format($newMonthlyRate, 2) . "\n";[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        if ($dailyRateChangePercent != 0) {[m
[32m+[m[32m            $content .= "\nChange: " . ($dailyRateChangePercent > 0 ? '+' : '') . number_format($dailyRateChangePercent, 2) . "%\n";[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        $content .= "\nThis change will be reflected in your next billing statement.\n\n";[m
[32m+[m[32m        $content .= "Thank you for your understanding.\n\n";[m
[32m+[m[32m        $content .= "- Virac Public Market Administration";[m
[32m+[m
[32m+[m[32m        try {[m
[32m+[m[32m            // Check if the migration has been run by checking if the column exists[m
[32m+[m[32m            $columns = \Illuminate\Support\Facades\Schema::getColumnListing('announcements');[m
[32m+[m[32m            $hasNewColumns = in_array('related_stall_id', $columns);[m
[32m+[m[41m            [m
[32m+[m[32m            $announcementData = [[m
[32m+[m[32m                'title' => $title,[m
[32m+[m[32m                'content' => $content,[m
[32m+[m[32m                'is_active' => false, // Draft - needs to be activated manually[m
[32m+[m[32m            ];[m
[32m+[m[41m            [m
[32m+[m[32m            // Only add new fields if migration has been run[m
[32m+[m[32m            if ($hasNewColumns) {[m
[32m+[m[32m                $announcementData['announcement_type'] = 'rental_rate_change';[m
[32m+[m[32m                $announcementData['related_utility'] = 'Rent';[m
[32m+[m[32m                $announcementData['related_section'] = $stall->section ? $stall->section->name : null;[m
[32m+[m[32m                $announcementData['related_stall_id'] = $stall->id;[m
[32m+[m[32m            } else {[m
[32m+[m[32m                Log::warning('Announcement migration not run - creating announcement without new fields. Please run: php artisan migrate');[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
[32m+[m[32m            $announcement = Announcement::create($announcementData);[m
[32m+[m[41m            [m
[32m+[m[32m            Log::info('Rental rate announcement created', [[m
[32m+[m[32m                'announcement_id' => $announcement->id,[m
[32m+[m[32m                'stall_id' => $stall->id,[m
[32m+[m[32m                'has_new_fields' => $hasNewColumns,[m
[32m+[m[32m            ]);[m
[32m+[m[41m            [m
[32m+[m[32m            return $announcement;[m
[32m+[m[32m        } catch (\Exception $e) {[m
[32m+[m[32m            Log::error('Failed to create rental rate announcement', [[m
[32m+[m[32m                'stall_id' => $stall->id,[m
[32m+[m[32m                'error' => $e->getMessage(),[m
[32m+[m[32m                'trace' => $e->getTraceAsString(),[m
[32m+[m[32m            ]);[m
[32m+[m[32m            throw $e;[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[1mdiff --git a/app/Services/SmsService.php b/app/Services/SmsService.php[m
[1mindex 9af1440..b6d8c04 100644[m
[1m--- a/app/Services/SmsService.php[m
[1m+++ b/app/Services/SmsService.php[m
[36m@@ -21,8 +21,8 @@[m [mpublic function __construct()[m
         $this->senderName = config('services.semaphore.sender_name');[m
 [m
         if (!$this->apiKey) {[m
[31m-            Log::warning('Semaphore API key is not set. SMS features will be disabled.');[m
[31m-            // throw new \Exception("Semaphore API key is missing."); // Disabled to prevent 500 error[m
[32m+[m[32m            Log::error('Semaphore API key is not set.');[m
[32m+[m[32m            throw new \Exception("Semaphore API key is missing.");[m
         }[m
     }[m
 [m
[36m@@ -31,10 +31,6 @@[m [mpublic function send($recipientNumber, $message, $priority = false)[m
         $endpoint = $priority ? '/priority' : '/messages';[m
         $url = $this->baseUrl . $endpoint;[m
 [m
[31m-        if (!$this->apiKey) {[m
[31m-            return ['success' => false, 'message' => 'Semaphore API key is missing.'];[m
[31m-        }[m
[31m-[m
         try {[m
             $payload = [[m
                 'apikey'   => $this->apiKey,[m
[36m@@ -47,13 +43,43 @@[m [mpublic function send($recipientNumber, $message, $priority = false)[m
             }[m
 [m
             $response = Http::asForm()->post($url, $payload);[m
[32m+[m[41m            [m
[32m+[m[32m            // Log the full response for debugging[m
[32m+[m[32m            Log::info("Semaphore API Response", [[m
[32m+[m[32m                'status_code' => $response->status(),[m
[32m+[m[32m                'response_body' => $response->body(),[m
[32m+[m[32m                'response_json' => $response->json(),[m
[32m+[m[32m                'recipient' => $recipientNumber,[m
[32m+[m[32m                'message_length' => strlen($message)[m
[32m+[m[32m            ]);[m
 [m
             if ($response->successful()) {[m
[31m-                Log::info("SMS sent to {$recipientNumber} via Semaphore.", ['response' => $response->json()]);[m
[31m-                return ['success' => true, 'response' => $response->json()];[m
[32m+[m[32m                $responseData = $response->json();[m
[32m+[m[41m                [m
[32m+[m[32m                // Check if Semaphore actually accepted the message[m
[32m+[m[32m                // Semaphore returns array with message_id on success, or error message on failure[m
[32m+[m[32m                if (isset($responseData[0]) && isset($responseData[0]['message_id'])) {[m
[32m+[m[32m                    Log::info("SMS sent to {$recipientNumber} via Semaphore.", [[m
[32m+[m[32m                        'message_id' => $responseData[0]['message_id'],[m
[32m+[m[32m                        'response' => $responseData[m
[32m+[m[32m                    ]);[m
[32m+[m[32m                    return ['success' => true, 'response' => $responseData, 'message_id' => $responseData[0]['message_id']];[m
[32m+[m[32m                } else {[m
[32m+[m[32m                    // Semaphore might return success status but with error in body[m
[32m+[m[32m                    $errorMsg = $responseData[0]['message'] ?? $response->body() ?? 'Unknown error';[m
[32m+[m[32m                    Log::error("Semaphore returned success but message not sent", [[m
[32m+[m[32m                        'recipient' => $recipientNumber,[m
[32m+[m[32m                        'error' => $errorMsg,[m
[32m+[m[32m                        'full_response' => $responseData[m
[32m+[m[32m                    ]);[m
[32m+[m[32m                    return ['success' => false, 'message' => $errorMsg, 'response' => $responseData];[m
[32m+[m[32m                }[m
             } else {[m
[31m-                Log::error("Failed to send SMS to {$recipientNumber} via Semaphore.", ['response' => $response->body()]);[m
[31m-                return ['success' => false, 'response' => $response->body()];[m
[32m+[m[32m                Log::error("Failed to send SMS to {$recipientNumber} via Semaphore.", [[m
[32m+[m[32m                    'status_code' => $response->status(),[m
[32m+[m[32m                    'response' => $response->body()[m
[32m+[m[32m                ]);[m
[32m+[m[32m                return ['success' => false, 'response' => $response->body(), 'status_code' => $response->status()];[m
             }[m
         } catch (\Exception $e) {[m
             Log::error('Semaphore SMS sending failed: ' . $e->getMessage(), ['exception' => $e]);[m
[36m@@ -68,24 +94,51 @@[m [mpublic function sendPriority($recipientNumber, $message)[m
 [m
     public function getCredits()[m
     {[m
[31m-        if (!$this->apiKey) {[m
[31m-            return ['success' => false, 'message' => 'Semaphore API key is missing.'];[m
[32m+[m[32m        // Cache credits for 5 minutes to avoid rate limiting[m
[32m+[m[32m        $cacheKey = 'semaphore_credits';[m
[32m+[m[32m        $cached = \Illuminate\Support\Facades\Cache::get($cacheKey);[m
[32m+[m[41m        [m
[32m+[m[32m        if ($cached !== null) {[m
[32m+[m[32m            return $cached;[m
         }[m
 [m
         $url = $this->baseUrl . '/account?apikey=' . $this->apiKey;[m
 [m
         try {[m
[31m-            $response = Http::get($url);[m
[32m+[m[32m            $response = Http::timeout(10)->get($url);[m
 [m
             if ($response->successful()) {[m
                 $data = $response->json();[m
[31m-                return ['success' => true, 'credit_balance' => $data['credit_balance'] ?? 'N/A'];[m
[32m+[m[32m                $result = ['success' => true, 'credit_balance' => $data['credit_balance'] ?? 'N/A'];[m
[32m+[m[41m                [m
[32m+[m[32m                // Cache successful response for 5 minutes[m
[32m+[m[32m                \Illuminate\Support\Facades\Cache::put($cacheKey, $result, now()->addMinutes(5));[m
[32m+[m[41m                [m
[32m+[m[32m                return $result;[m
             } else {[m
[31m-                Log::error("Failed to fetch Semaphore credits.", ['response' => $response->body()]);[m
[32m+[m[32m                $responseBody = $response->body();[m
[32m+[m[32m                Log::error("Failed to fetch Semaphore credits.", ['response' => $responseBody, 'status' => $response->status()]);[m
[32m+[m[41m                [m
[32m+[m[32m                // If rate limited, return cached value if available, otherwise return error[m
[32m+[m[32m                if (str_contains($responseBody, 'Too Many Attempts') || $response->status() === 429) {[m
[32m+[m[32m                    $oldCache = \Illuminate\Support\Facades\Cache::get($cacheKey . '_fallback');[m
[32m+[m[32m                    if ($oldCache) {[m
[32m+[m[32m                        return $oldCache;[m
[32m+[m[32m                    }[m
[32m+[m[32m                    return ['success' => false, 'message' => 'Rate limit exceeded. Please try again in a few minutes.', 'rate_limited' => true];[m
[32m+[m[32m                }[m
[32m+[m[41m                [m
                 return ['success' => false, 'message' => 'Failed to fetch credits.'];[m
             }[m
         } catch (\Exception $e) {[m
             Log::error('Semaphore credit fetch failed: ' . $e->getMessage(), ['exception' => $e]);[m
[32m+[m[41m            [m
[32m+[m[32m            // Return cached value if available[m
[32m+[m[32m            $oldCache = \Illuminate\Support\Facades\Cache::get($cacheKey . '_fallback');[m
[32m+[m[32m            if ($oldCache) {[m
[32m+[m[32m                return $oldCache;[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
             return ['success' => false, 'message' => $e->getMessage()];[m
         }[m
     }[m
[36m@@ -127,6 +180,11 @@[m [mpublic function sendTemplatedSms(User $user, string $templateName, array $extraD[m
     {[m
         Log::info("SmsService: Starting sendTemplatedSms for user {$user->id} with template '{$templateName}'.");[m
     [m
[32m+[m[32m        // Ensure stall relationship is loaded[m
[32m+[m[32m        if (!$user->relationLoaded('stall')) {[m
[32m+[m[32m            $user->load('stall');[m
[32m+[m[32m        }[m
[32m+[m[41m    [m
         $templates = $this->getFinalTemplates();[m
         $templateData = $templates[$templateName] ?? null;[m
     [m
[36m@@ -154,14 +212,17 @@[m [mpublic function sendTemplatedSms(User $user, string $templateName, array $extraD[m
         $normalizedTemplate = preg_replace_callback([m
             '/{{\s*(.*?)\s*}}/',[m
             function ($matches) {[m
[31m-                return '{{' . $matches[1] . '}}';[m
[32m+[m[32m                return '{{' . trim($matches[1]) . '}}';[m
             },[m
             $messageTemplate[m
         );[m
     [m
         Log::info("SmsService: Normalized template: \"{$normalizedTemplate}\"");[m
         [m
[31m-        $unpaidBills = $user->billings()->where('status', 'unpaid')->get();[m
[32m+[m[32m        $unpaidBills = $user->billings()[m
[32m+[m[32m            ->where('billing.status', 'unpaid')[m
[32m+[m[32m            ->select('billing.id', 'billing.stall_id', 'billing.utility_type', 'billing.period_start', 'billing.period_end', 'billing.amount', 'billing.due_date', 'billing.disconnection_date', 'billing.status', 'billing.consumption', 'billing.current_reading', 'billing.previous_reading', 'billing.rate')[m
[32m+[m[32m            ->get();[m
         $billingSettings = \App\Models\BillingSetting::all()->keyBy('utility_type');[m
         $today = Carbon::today();[m
     [m
[36m@@ -209,7 +270,9 @@[m [mfunction ($matches) {[m
         $itemsForSummary = collect();[m
         switch ($templateName) {[m
             case 'overdue_alert':[m
[31m-                $itemsForSummary = $unpaidBills->where('due_date', '<', $today);[m
[32m+[m[32m                $itemsForSummary = $unpaidBills->where(function($bill) use ($today) {[m
[32m+[m[32m                    return Carbon::parse($bill->due_date)->lt($today);[m
[32m+[m[32m                });[m
                 break;[m
             case 'payment_reminder': // Group this with the default[m
             case 'bill_statement':[m
[36m@@ -218,6 +281,20 @@[m [mfunction ($matches) {[m
                 $itemsForSummary = $unpaidBills;[m
                 break;[m
         }[m
[32m+[m[41m        [m
[32m+[m[32m        Log::info("SmsService: Items for summary", [[m
[32m+[m[32m            'template_name' => $templateName,[m
[32m+[m[32m            'unpaid_bills_count' => $unpaidBills->count(),[m
[32m+[m[32m            'items_for_summary_count' => $itemsForSummary->count(),[m
[32m+[m[32m            'unpaid_bills_types' => $unpaidBills->pluck('utility_type')->toArray()[m
[32m+[m[32m        ]);[m
[32m+[m[41m    [m
[32m+[m[32m        Log::info("SmsService: Bills summary", [[m
[32m+[m[32m            'template_name' => $templateName,[m
[32m+[m[32m            'total_unpaid_bills' => $unpaidBills->count(),[m
[32m+[m[32m            'items_for_summary_count' => $itemsForSummary->count(),[m
[32m+[m[32m            'utility_types' => $itemsForSummary->pluck('utility_type')->toArray()[m
[32m+[m[32m        ]);[m
     [m
         $billDetailsString = '';[m
         if ($itemsForSummary->isNotEmpty()) {[m
[36m@@ -233,32 +310,211 @@[m [mfunction ($matches) {[m
         $totalDue = $itemsForSummary->sum('current_amount_due');[m
         $earliestDueDateBill = $itemsForSummary->sortBy('due_date')->first();[m
         $timestamp = Carbon::now('Asia/Manila')->format('M d, Y h:i A');[m
[32m+[m[41m        [m
[32m+[m[32m        // Get bill month - use current month for billing statements[m
[32m+[m[32m        // This ensures the bill month reflects when the statement is being sent, not when old bills were created[m
[32m+[m[32m        $billMonthFormatted = Carbon::now()->format('F Y');[m
[32m+[m[41m        [m
[32m+[m[32m        // Separate bills by type - use case-insensitive matching[m
[32m+[m[32m        // Get the MOST RECENT unpaid bill for each utility type (sorted by period_start DESC)[m
[32m+[m[32m        // Search in itemsForSummary first, then fallback to all unpaid bills[m
[32m+[m[32m        $rentBill = $itemsForSummary->filter(function ($bill) {[m
[32m+[m[32m            return strtolower(trim($bill->utility_type)) === 'rent';[m
[32m+[m[32m        })->sortByDesc('period_start')->first();[m
[32m+[m[32m        if (!$rentBill) {[m
[32m+[m[32m            $rentBill = $unpaidBills->filter(function ($bill) {[m
[32m+[m[32m                return strtolower(trim($bill->utility_type)) === 'rent';[m
[32m+[m[32m            })->sortByDesc('period_start')->first();[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        $waterBill = $itemsForSummary->filter(function ($bill) {[m
[32m+[m[32m            return strtolower(trim($bill->utility_type)) === 'water';[m
[32m+[m[32m        })->sortByDesc('period_start')->first();[m
[32m+[m[32m        if (!$waterBill) {[m
[32m+[m[32m            $waterBill = $unpaidBills->filter(function ($bill) {[m
[32m+[m[32m                return strtolower(trim($bill->utility_type)) === 'water';[m
[32m+[m[32m            })->sortByDesc('period_start')->first();[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        $electricityBill = $itemsForSummary->filter(function ($bill) {[m
[32m+[m[32m            return strtolower(trim($bill->utility_type)) === 'electricity';[m
[32m+[m[32m        })->sortByDesc('period_start')->first();[m
[32m+[m[32m        if (!$electricityBill) {[m
[32m+[m[32m            $electricityBill = $unpaidBills->filter(function ($bill) {[m
[32m+[m[32m                return strtolower(trim($bill->utility_type)) === 'electricity';[m
[32m+[m[32m            })->sortByDesc('period_start')->first();[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        Log::info("SmsService: Bill details found", [[m
[32m+[m[32m            'rent_bill' => $rentBill ? ['id' => $rentBill->id, 'amount' => $rentBill->amount] : null,[m
[32m+[m[32m            'water_bill' => $waterBill ? ['id' => $waterBill->id, 'amount' => $waterBill->amount] : null,[m
[32m+[m[32m            'electricity_bill' => $electricityBill ? ['id' => $electricityBill->id, 'amount' => $electricityBill->amount] : null,[m
[32m+[m[32m            'bill_month_formatted' => $billMonthFormatted[m
[32m+[m[32m        ]);[m
[32m+[m[41m        [m
[32m+[m[32m        // Format Rent details[m
[32m+[m[32m        $rentDetails = 'N/A';[m
[32m+[m[32m        if ($rentBill) {[m
[32m+[m[32m            $rentOriginal = number_format($rentBill->amount, 2);[m
[32m+[m[32m            $rentDueDate = Carbon::parse($rentBill->due_date)->format('M d, Y');[m
[32m+[m[41m            [m
[32m+[m[32m            // Calculate discount if applicable (if today is <= 15th and bill is for current month)[m
[32m+[m[32m            $rentSettings = $billingSettings->get('Rent');[m
[32m+[m[32m            $rentDiscount = 0;[m
[32m+[m[32m            $todayDay = $today->day;[m
[32m+[m[32m            $rentBillMonth = Carbon::parse($rentBill->period_start)->format('Y-m');[m
[32m+[m[32m            $currentMonth = $today->format('Y-m');[m
[32m+[m[41m            [m
[32m+[m[32m            if ($todayDay <= 15 && $rentBillMonth === $currentMonth && $rentSettings && (float)$rentSettings->discount_rate > 0) {[m
[32m+[m[32m                $rentDiscount = $rentBill->amount * (float)$rentSettings->discount_rate;[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
[32m+[m[32m            $rentDiscounted = $rentBill->amount - $rentDiscount;[m
[32m+[m[41m            [m
[32m+[m[32m            if ($rentDiscount > 0) {[m
[32m+[m[32m                $rentDetails = "Original: P{$rentOriginal}\nDiscounted: P" . number_format($rentDiscounted, 2) . "\nDue: {$rentDueDate}";[m
[32m+[m[32m            } else {[m
[32m+[m[32m                $rentDetails = "Amount: P{$rentOriginal}\nDue: {$rentDueDate}";[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        // Format Water details[m
[32m+[m[32m        $waterDetails = 'N/A';[m
[32m+[m[32m        if ($waterBill) {[m
[32m+[m[32m            $waterAmount = number_format($waterBill->current_amount_due, 2);[m
[32m+[m[32m            $waterDueDate = Carbon::parse($waterBill->due_date)->format('M d, Y');[m
[32m+[m[32m            $waterDetails = "Amount: P{$waterAmount}\nDue: {$waterDueDate}";[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        // Format Electricity details[m
[32m+[m[32m        $electricityDetails = 'N/A';[m
[32m+[m[32m        if ($electricityBill) {[m
[32m+[m[32m            $elecOriginalAmount = (float)$electricityBill->amount;[m
[32m+[m[32m            $elecConsumption = $electricityBill->consumption ?? 0;[m
[32m+[m[32m            $elecRate = $electricityBill->rate ?? 0;[m
[32m+[m[41m            [m
[32m+[m[32m            // If consumption is missing, calculate from readings[m
[32m+[m[32m            if ($elecConsumption == 0 && $electricityBill->current_reading && $electricityBill->previous_reading) {[m
[32m+[m[32m                $elecConsumption = (float)$electricityBill->current_reading - (float)$electricityBill->previous_reading;[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
[32m+[m[32m            // If rate is missing but we have amount and consumption, calculate rate[m
[32m+[m[32m            if ($elecRate == 0 && $elecConsumption > 0 && $elecOriginalAmount > 0) {[m
[32m+[m[32m                $elecRate = $elecOriginalAmount / $elecConsumption;[m
[32m+[m[32m            }[m
[32m+[m[32m            // If consumption is missing but we have amount and rate, calculate consumption[m
[32m+[m[32m            else if ($elecConsumption == 0 && $elecRate > 0 && $elecOriginalAmount > 0) {[m
[32m+[m[32m                $elecConsumption = $elecOriginalAmount / $elecRate;[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
[32m+[m[32m            $elecCalculatedAmount = $elecConsumption * $elecRate;[m
[32m+[m[32m            $elecAmountToPay = number_format($electricityBill->current_amount_due, 2);[m
[32m+[m[32m            $elecDueDate = Carbon::parse($electricityBill->due_date)->format('M d, Y');[m
[32m+[m[32m            $elecDisconnectionDate = $electricityBill->disconnection_date[m[41m [m
[32m+[m[32m                ? Carbon::parse($electricityBill->disconnection_date)->format('M d, Y')[m[41m [m
[32m+[m[32m                : 'N/A';[m
[32m+[m[41m            [m
[32m+[m[32m            // Format calculation: show the formula with actual values[m
[32m+[m[32m            $elecCalculation = "(" . number_format($elecConsumption, 2) . " kWh) x P" . number_format($elecRate, 2) . " = P" . number_format($elecCalculatedAmount > 0 ? $elecCalculatedAmount : $elecOriginalAmount, 2);[m
[32m+[m[32m            $electricityDetails = "Calculation: {$elecCalculation}\nAmount to Pay: P{$elecAmountToPay}\nDue: {$elecDueDate}\nDisconnection: {$elecDisconnectionDate}";[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        // Website URL[m
[32m+[m[32m        $websiteUrl = url('/vendor/home');[m
     [m
[32m+[m[32m        // Ensure all values are strings (not null)[m
         $replacements = [[m
[31m-            '{{vendor_name}}'   => $user->name,[m
[31m-            '{{stall_number}}'  => $user->stall->table_number ?? 'N/A',[m
[32m+[m[32m            '{{vendor_name}}'   => $user->name ?? 'N/A',[m
[32m+[m[32m            '{{stall_number}}'  => ($user->stall->table_number ?? 'N/A'),[m
             '{{total_due}}'     => number_format($totalDue, 2),[m
             '{{due_date}}'      => $earliestDueDateBill ? Carbon::parse($earliestDueDateBill->due_date)->format('M d, Y') : 'N/A',[m
[31m-            '{{bill_details}}'  => $billDetailsString,[m
[31m-            '{{unpaid_items}}'  => $itemsForSummary->pluck('utility_type')->implode(', '),[m
[31m-            '{{overdue_items}}' => $itemsForSummary->pluck('utility_type')->implode(', '),[m
[32m+[m[32m            '{{bill_details}}'  => $billDetailsString ?: 'None',[m
[32m+[m[32m            '{{unpaid_items}}'  => $itemsForSummary->pluck('utility_type')->implode(', ') ?: 'None',[m
[32m+[m[32m            '{{overdue_items}}' => $itemsForSummary->pluck('utility_type')->implode(', ') ?: 'None',[m
             '{{new_total_due}}' => number_format($totalDue, 2),[m
[31m-            '{{upcoming_bill_details}}' => $upcomingDetailsString,[m
[31m-            '{{overdue_bill_details}}'  => $overdueDetailsString,[m
[32m+[m[32m            '{{upcoming_bill_details}}' => $upcomingDetailsString ?: 'None',[m
[32m+[m[32m            '{{overdue_bill_details}}'  => $overdueDetailsString ?: 'None',[m
             '{{timestamp}}'     => $timestamp,[m
[32m+[m[32m            '{{bill_month}}'    => $billMonthFormatted ?: Carbon::now()->format('F Y'),[m
[32m+[m[32m            '{{rent_details}}'  => $rentDetails ?: 'N/A',[m
[32m+[m[32m            '{{water_details}}' => $waterDetails ?: 'N/A',[m
[32m+[m[32m            '{{electricity_details}}' => $electricityDetails ?: 'N/A',[m
[32m+[m[32m            '{{website_url}}'   => $websiteUrl ?: url('/vendor/home'),[m
         ];[m
[32m+[m[41m        [m
[32m+[m[32m        Log::info("SmsService: Replacement values check", [[m
[32m+[m[32m            'bill_month' => $replacements['{{bill_month}}'],[m
[32m+[m[32m            'rent_details_length' => strlen($replacements['{{rent_details}}']),[m
[32m+[m[32m            'water_details_length' => strlen($replacements['{{water_details}}']),[m
[32m+[m[32m            'electricity_details_length' => strlen($replacements['{{electricity_details}}']),[m
[32m+[m[32m            'rent_details_preview' => substr($replacements['{{rent_details}}'], 0, 100),[m
[32m+[m[32m            'water_details_preview' => substr($replacements['{{water_details}}'], 0, 100),[m
[32m+[m[32m            'electricity_details_preview' => substr($replacements['{{electricity_details}}'], 0, 100),[m
[32m+[m[32m        ]);[m
[32m+[m[41m        [m
[32m+[m[32m        Log::info("SmsService: Replacement values", [[m
[32m+[m[32m            'bill_month' => $replacements['{{bill_month}}'],[m
[32m+[m[32m            'rent_details' => substr($replacements['{{rent_details}}'], 0, 50),[m
[32m+[m[32m            'water_details' => substr($replacements['{{water_details}}'], 0, 50),[m
[32m+[m[32m            'electricity_details' => substr($replacements['{{electricity_details}}'], 0, 50),[m
[32m+[m[32m        ]);[m
     [m
         $replacements = array_merge($replacements, $extraData);[m
[32m+[m[41m        [m
[32m+[m[32m        // Debug: Log what placeholders we're trying to replace[m
[32m+[m[32m        Log::info("SmsService: Placeholders to replace", [[m
[32m+[m[32m            'placeholders' => array_keys($replacements),[m
[32m+[m[32m            'normalized_template_sample' => substr($normalizedTemplate, 0, 200)[m
[32m+[m[32m        ]);[m
[32m+[m[41m        [m
         $finalMessage = str_replace(array_keys($replacements), array_values($replacements), $normalizedTemplate);[m
         [m
[32m+[m[32m        // Debug: Check if any placeholders remain unreplaced[m
[32m+[m[32m        $unreplacedPlaceholders = [];[m
[32m+[m[32m        preg_match_all('/{{[^}]+}}/', $finalMessage, $matches);[m
[32m+[m[32m        if (!empty($matches[0])) {[m
[32m+[m[32m            $unreplacedPlaceholders = array_unique($matches[0]);[m
[32m+[m[32m            Log::warning("SmsService: Unreplaced placeholders found", [[m
[32m+[m[32m                'unreplaced' => $unreplacedPlaceholders,[m
[32m+[m[32m                'user_id' => $user->id[m
[32m+[m[32m            ]);[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
         Log::info("SmsService: Final message for user {$user->id}: \"{$finalMessage}\"");[m
     [m
         $recipientNumber = $user->getSemaphoreReadyContactNumber();[m
         if (!$recipientNumber) {[m
[31m-            Log::warning("Skipping SMS for user {$user->id} due to missing contact number.");[m
[31m-            return ['success' => false, 'message' => 'No contact number.'];[m
[32m+[m[32m            Log::warning("Skipping SMS for user {$user->id} ({$user->name}) due to invalid/missing contact number.", [[m
[32m+[m[32m                'contact_number' => $user->contact_number,[m
[32m+[m[32m                'user_id' => $user->id[m
[32m+[m[32m            ]);[m
[32m+[m[32m            return ['success' => false, 'message' => 'No valid contact number. Contact number format: ' . ($user->contact_number ?? 'NULL')];[m
         }[m
[31m-    [m
[31m-        return $this->send($recipientNumber, $finalMessage);[m
[32m+[m
[32m+[m[32m        // Log the final message length and preview[m
[32m+[m[32m        Log::info("SmsService: Sending SMS to user {$user->id}", [[m
[32m+[m[32m            'recipient' => $recipientNumber,[m
[32m+[m[32m            'message_length' => strlen($finalMessage),[m
[32m+[m[32m            'message_preview' => substr($finalMessage, 0, 200),[m
[32m+[m[32m            'full_message' => $finalMessage[m
[32m+[m[32m        ]);[m
[32m+[m
[32m+[m[32m        $result = $this->send($recipientNumber, $finalMessage);[m
[32m+[m[41m        [m
[32m+[m[32m        if (!$result['success']) {[m
[32m+[m[32m            Log::error("SmsService: Failed to send SMS to user {$user->id}", [[m
[32m+[m[32m                'recipient' => $recipientNumber,[m
[32m+[m[32m                'error' => $result['message'] ?? $result['response'] ?? 'Unknown error',[m
[32m+[m[32m                'status_code' => $result['status_code'] ?? null[m
[32m+[m[32m            ]);[m
[32m+[m[32m        } else {[m
[32m+[m[32m            Log::info("SmsService: SMS successfully sent to user {$user->id}", [[m
[32m+[m[32m                'recipient' => $recipientNumber,[m
[32m+[m[32m                'message_id' => $result['message_id'] ?? 'N/A',[m
[32m+[m[32m                'response' => $result['response'] ?? [][m
[32m+[m[32m            ]);[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        return $result;[m
     }[m
 }[m
\ No newline at end of file[m
[1mdiff --git a/database/migrations/2025_01_27_000000_add_announcement_fields_to_announcements_table.php b/database/migrations/2025_01_27_000000_add_announcement_fields_to_announcements_table.php[m
[1mnew file mode 100644[m
[1mindex 0000000..34a7621[m
[1m--- /dev/null[m
[1m+++ b/database/migrations/2025_01_27_000000_add_announcement_fields_to_announcements_table.php[m
[36m@@ -0,0 +1,32 @@[m
[32m+[m[32m<?php[m
[32m+[m
[32m+[m[32muse Illuminate\Database\Migrations\Migration;[m
[32m+[m[32muse Illuminate\Database\Schema\Blueprint;[m
[32m+[m[32muse Illuminate\Support\Facades\Schema;[m
[32m+[m
[32m+[m[32mreturn new class extends Migration[m
[32m+[m[32m{[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Run the migrations.[m
[32m+[m[32m     */[m
[32m+[m[32m    public function up(): void[m
[32m+[m[32m    {[m
[32m+[m[32m        Schema::table('announcements', function (Blueprint $table) {[m
[32m+[m[32m            $table->string('announcement_type')->nullable()->after('content');[m
[32m+[m[32m            $table->string('related_section')->nullable()->after('announcement_type');[m
[32m+[m[32m            $table->string('related_utility')->nullable()->after('related_section');[m
[32m+[m[32m            $table->unsignedBigInteger('related_stall_id')->nullable()->after('related_utility');[m
[32m+[m[32m        });[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Reverse the migrations.[m
[32m+[m[32m     */[m
[32m+[m[32m    public function down(): void[m
[32m+[m[32m    {[m
[32m+[m[32m        Schema::table('announcements', function (Blueprint $table) {[m
[32m+[m[32m            $table->dropColumn(['announcement_type', 'related_section', 'related_utility', 'related_stall_id']);[m
[32m+[m[32m        });[m
[32m+[m[32m    }[m
[32m+[m[32m};[m
[32m+[m
[1mdiff --git a/database/migrations/2025_01_27_100000_add_password_changed_at_to_users_table.php b/database/migrations/2025_01_27_100000_add_password_changed_at_to_users_table.php[m
[1mnew file mode 100644[m
[1mindex 0000000..6fcb931[m
[1m--- /dev/null[m
[1m+++ b/database/migrations/2025_01_27_100000_add_password_changed_at_to_users_table.php[m
[36m@@ -0,0 +1,31 @@[m
[32m+[m[32m<?php[m
[32m+[m
[32m+[m[32muse Illuminate\Database\Migrations\Migration;[m
[32m+[m[32muse Illuminate\Database\Schema\Blueprint;[m
[32m+[m[32muse Illuminate\Support\Facades\Schema;[m
[32m+[m
[32m+[m[32mreturn new class extends Migration[m
[32m+[m[32m{[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Run the migrations.[m
[32m+[m[32m     */[m
[32m+[m[32m    public function up(): void[m
[32m+[m[32m    {[m
[32m+[m[32m        Schema::table('users', function (Blueprint $table) {[m
[32m+[m[32m            if (!Schema::hasColumn('users', 'password_changed_at')) {[m
[32m+[m[32m                $table->timestamp('password_changed_at')->nullable()->after('password');[m
[32m+[m[32m            }[m
[32m+[m[32m        });[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Reverse the migrations.[m
[32m+[m[32m     */[m
[32m+[m[32m    public function down(): void[m
[32m+[m[32m    {[m
[32m+[m[32m        Schema::table('users', function (Blueprint $table) {[m
[32m+[m[32m            $table->dropColumn('password_changed_at');[m
[32m+[m[32m        });[m
[32m+[m[32m    }[m
[32m+[m[32m};[m
[32m+[m
[1mdiff --git a/database/migrations/2025_01_27_110000_add_profile_picture_to_users_table.php b/database/migrations/2025_01_27_110000_add_profile_picture_to_users_table.php[m
[1mnew file mode 100644[m
[1mindex 0000000..69ee7c1[m
[1m--- /dev/null[m
[1m+++ b/database/migrations/2025_01_27_110000_add_profile_picture_to_users_table.php[m
[36m@@ -0,0 +1,29 @@[m
[32m+[m[32m<?php[m
[32m+[m
[32m+[m[32muse Illuminate\Database\Migrations\Migration;[m
[32m+[m[32muse Illuminate\Database\Schema\Blueprint;[m
[32m+[m[32muse Illuminate\Support\Facades\Schema;[m
[32m+[m
[32m+[m[32mreturn new class extends Migration[m
[32m+[m[32m{[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Run the migrations.[m
[32m+[m[32m     */[m
[32m+[m[32m    public function up(): void[m
[32m+[m[32m    {[m
[32m+[m[32m        Schema::table('users', function (Blueprint $table) {[m
[32m+[m[32m            $table->string('profile_picture')->nullable()->after('contact_number');[m
[32m+[m[32m        });[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Reverse the migrations.[m
[32m+[m[32m     */[m
[32m+[m[32m    public function down(): void[m
[32m+[m[32m    {[m
[32m+[m[32m        Schema::table('users', function (Blueprint $table) {[m
[32m+[m[32m            $table->dropColumn('profile_picture');[m
[32m+[m[32m        });[m
[32m+[m[32m    }[m
[32m+[m[32m};[m
[32m+[m
[1mdiff --git a/database/migrations/2025_08_20_072958_create_users_table.php b/database/migrations/2025_08_20_072958_create_users_table.php[m
[1mindex 1067fa5..e2cec95 100644[m
[1m--- a/database/migrations/2025_08_20_072958_create_users_table.php[m
[1m+++ b/database/migrations/2025_08_20_072958_create_users_table.php[m
[36m@@ -10,8 +10,7 @@[m [mpublic function up(): void {[m
             $table->id();[m
             $table->foreignId('role_id')->constrained('roles')->onDelete('cascade');[m
             $table->string('name');[m
[31m-            $table->string('username')->unique(); // ADDED THIS[m
[31m-            $table->string('email')->unique();[m
[32m+[m[32m            $table->string('username')->unique();[m
             $table->string('password');[m
             $table->string('contact_number')->nullable();  [m
             $table->date('application_date')->nullable(); [m
[1mdiff --git a/database/migrations/2025_08_20_073722_create_rates_table.php b/database/migrations/2025_08_20_073722_create_rates_table.php[m
[1mindex 661f451..bec67cb 100644[m
[1m--- a/database/migrations/2025_08_20_073722_create_rates_table.php[m
[1m+++ b/database/migrations/2025_08_20_073722_create_rates_table.php[m
[36m@@ -9,8 +9,6 @@[m [mpublic function up(): void {[m
         Schema::create('rates', function (Blueprint $table) {[m
             $table->id();[m
             $table->enum('utility_type', ['Rent','Electricity','Water']);[m
[31m-            $table->foreignId('section_id')->nullable()->constrained('sections')->nullOnDelete();[m
[31m-            $table->decimal('monthly_rate', 10, 2)->default(0);[m
             $table->decimal('rate', 10, 2);[m
             $table->timestamps();[m
         });[m
[1mdiff --git a/database/migrations/2025_09_13_072903_add_area_to_stalls_table.php b/database/migrations/2025_09_13_072903_add_area_to_stalls_table.php[m
[1mindex af81a7c..438285f 100644[m
[1m--- a/database/migrations/2025_09_13_072903_add_area_to_stalls_table.php[m
[1m+++ b/database/migrations/2025_09_13_072903_add_area_to_stalls_table.php[m
[36m@@ -14,7 +14,9 @@[m [mpublic function up(): void[m
         Schema::table('stalls', function (Blueprint $table) {[m
             // This adds a decimal column named 'area' after the 'table_number' column.[m
             // It's nullable because not all sections will have an area.[m
[31m-            $table->decimal('area', 8, 2)->nullable()->after('table_number');[m
[32m+[m[32m            if (!Schema::hasColumn('stalls', 'area')) {[m
[32m+[m[32m                $table->decimal('area', 8, 2)->nullable()->after('table_number');[m
[32m+[m[32m            }[m
         });[m
     }[m
 [m
[1mdiff --git a/database/migrations/2025_12_05_100000_add_details_to_audit_trails_table.php b/database/migrations/2025_12_05_100000_add_details_to_audit_trails_table.php[m
[1mnew file mode 100644[m
[1mindex 0000000..e662ede[m
[1m--- /dev/null[m
[1m+++ b/database/migrations/2025_12_05_100000_add_details_to_audit_trails_table.php[m
[36m@@ -0,0 +1,31 @@[m
[32m+[m[32m<?php[m
[32m+[m
[32m+[m[32muse Illuminate\Database\Migrations\Migration;[m
[32m+[m[32muse Illuminate\Database\Schema\Blueprint;[m
[32m+[m[32muse Illuminate\Support\Facades\Schema;[m
[32m+[m
[32m+[m[32mreturn new class extends Migration[m
[32m+[m[32m{[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Run the migrations.[m
[32m+[m[32m     */[m
[32m+[m[32m    public function up(): void[m
[32m+[m[32m    {[m
[32m+[m[32m        Schema::table('audit_trails', function (Blueprint $table) {[m
[32m+[m[32m            if (!Schema::hasColumn('audit_trails', 'details')) {[m
[32m+[m[32m                $table->text('details')->nullable()->after('result');[m
[32m+[m[32m            }[m
[32m+[m[32m        });[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Reverse the migrations.[m
[32m+[m[32m     */[m
[32m+[m[32m    public function down(): void[m
[32m+[m[32m    {[m
[32m+[m[32m        Schema::table('audit_trails', function (Blueprint $table) {[m
[32m+[m[32m            $table->dropColumn('details');[m
[32m+[m[32m        });[m
[32m+[m[32m    }[m
[32m+[m[32m};[m
[32m+[m
[1mdiff --git a/database/migrations/2025_12_05_120000_add_index_to_billing_table_for_performance.php b/database/migrations/2025_12_05_120000_add_index_to_billing_table_for_performance.php[m
[1mnew file mode 100644[m
[1mindex 0000000..4842005[m
[1m--- /dev/null[m
[1m+++ b/database/migrations/2025_12_05_120000_add_index_to_billing_table_for_performance.php[m
[36m@@ -0,0 +1,61 @@[m
[32m+[m[32m<?php[m
[32m+[m
[32m+[m[32muse Illuminate\Database\Migrations\Migration;[m
[32m+[m[32muse Illuminate\Database\Schema\Blueprint;[m
[32m+[m[32muse Illuminate\Support\Facades\Schema;[m
[32m+[m
[32m+[m[32mreturn new class extends Migration[m
[32m+[m[32m{[m
[32m+[m[32m    public function up(): void[m
[32m+[m[32m    {[m
[32m+[m[32m        Schema::table('billing', function (Blueprint $table) {[m
[32m+[m[32m            // Add composite index for faster queries on outstanding bills[m
[32m+[m[32m            // This index helps queries like: WHERE stall_id = X AND status = 'unpaid'[m
[32m+[m[32m            if (!$this->indexExists('billing', 'billing_stall_id_status_index')) {[m
[32m+[m[32m                $table->index(['stall_id', 'status'], 'billing_stall_id_status_index');[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
[32m+[m[32m            // Add index on due_date for sorting[m
[32m+[m[32m            if (!$this->indexExists('billing', 'billing_due_date_index')) {[m
[32m+[m[32m                $table->index('due_date', 'billing_due_date_index');[m
[32m+[m[32m            }[m
[32m+[m[32m        });[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    public function down(): void[m
[32m+[m[32m    {[m
[32m+[m[32m        Schema::table('billing', function (Blueprint $table) {[m
[32m+[m[32m            if ($this->indexExists('billing', 'billing_stall_id_status_index')) {[m
[32m+[m[32m                $table->dropIndex('billing_stall_id_status_index');[m
[32m+[m[32m            }[m
[32m+[m[32m            if ($this->indexExists('billing', 'billing_due_date_index')) {[m
[32m+[m[32m                $table->dropIndex('billing_due_date_index');[m
[32m+[m[32m            }[m
[32m+[m[32m        });[m
[32m+[m[32m    }[m
[32m+[m[41m    [m
[32m+[m[32m    private function indexExists($table, $indexName): bool[m
[32m+[m[32m    {[m
[32m+[m[32m        $connection = Schema::getConnection();[m
[32m+[m[32m        $databaseName = $connection->getDatabaseName();[m
[32m+[m[41m        [m
[32m+[m[32m        if ($connection->getDriverName() === 'mysql') {[m
[32m+[m[32m            $result = $connection->select([m
[32m+[m[32m                "SELECT COUNT(*) as count FROM information_schema.statistics[m[41m [m
[32m+[m[32m                 WHERE table_schema = ? AND table_name = ? AND index_name = ?",[m
[32m+[m[32m                [$databaseName, $table, $indexName][m
[32m+[m[32m            );[m
[32m+[m[32m            return $result[0]->count > 0;[m
[32m+[m[32m        } elseif ($connection->getDriverName() === 'pgsql') {[m
[32m+[m[32m            $result = $connection->select([m
[32m+[m[32m                "SELECT COUNT(*) as count FROM pg_indexes[m[41m [m
[32m+[m[32m                 WHERE schemaname = 'public' AND tablename = ? AND indexname = ?",[m
[32m+[m[32m                [$table, $indexName][m
[32m+[m[32m            );[m
[32m+[m[32m            return $result[0]->count > 0;[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        return false;[m
[32m+[m[32m    }[m
[32m+[m[32m};[m
[32m+[m
[1mdiff --git a/database/migrations/2025_12_05_130000_add_indexes_to_payments_table_for_performance.php b/database/migrations/2025_12_05_130000_add_indexes_to_payments_table_for_performance.php[m
[1mnew file mode 100644[m
[1mindex 0000000..6691323[m
[1m--- /dev/null[m
[1m+++ b/database/migrations/2025_12_05_130000_add_indexes_to_payments_table_for_performance.php[m
[36m@@ -0,0 +1,60 @@[m
[32m+[m[32m<?php[m
[32m+[m
[32m+[m[32muse Illuminate\Database\Migrations\Migration;[m
[32m+[m[32muse Illuminate\Database\Schema\Blueprint;[m
[32m+[m[32muse Illuminate\Support\Facades\Schema;[m
[32m+[m
[32m+[m[32mreturn new class extends Migration[m
[32m+[m[32m{[m
[32m+[m[32m    public function up(): void[m
[32m+[m[32m    {[m
[32m+[m[32m        Schema::table('payments', function (Blueprint $table) {[m
[32m+[m[32m            // Add index on payment_date for faster date filtering[m
[32m+[m[32m            if (!$this->indexExists('payments', 'payments_payment_date_index')) {[m
[32m+[m[32m                $table->index('payment_date', 'payments_payment_date_index');[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
[32m+[m[32m            // Add composite index for faster queries filtering by billing_id and payment_date[m
[32m+[m[32m            if (!$this->indexExists('payments', 'payments_billing_id_payment_date_index')) {[m
[32m+[m[32m                $table->index(['billing_id', 'payment_date'], 'payments_billing_id_payment_date_index');[m
[32m+[m[32m            }[m
[32m+[m[32m        });[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    public function down(): void[m
[32m+[m[32m    {[m
[32m+[m[32m        Schema::table('payments', function (Blueprint $table) {[m
[32m+[m[32m            if ($this->indexExists('payments', 'payments_payment_date_index')) {[m
[32m+[m[32m                $table->dropIndex('payments_payment_date_index');[m
[32m+[m[32m            }[m
[32m+[m[32m            if ($this->indexExists('payments', 'payments_billing_id_payment_date_index')) {[m
[32m+[m[32m                $table->dropIndex('payments_billing_id_payment_date_index');[m
[32m+[m[32m            }[m
[32m+[m[32m        });[m
[32m+[m[32m    }[m
[32m+[m[41m    [m
[32m+[m[32m    private function indexExists($table, $indexName): bool[m
[32m+[m[32m    {[m
[32m+[m[32m        $connection = Schema::getConnection();[m
[32m+[m[32m        $databaseName = $connection->getDatabaseName();[m
[32m+[m[41m        [m
[32m+[m[32m        if ($connection->getDriverName() === 'mysql') {[m
[32m+[m[32m            $result = $connection->select([m
[32m+[m[32m                "SELECT COUNT(*) as count FROM information_schema.statistics[m[41m [m
[32m+[m[32m                 WHERE table_schema = ? AND table_name = ? AND index_name = ?",[m
[32m+[m[32m                [$databaseName, $table, $indexName][m
[32m+[m[32m            );[m
[32m+[m[32m            return $result[0]->count > 0;[m
[32m+[m[32m        } elseif ($connection->getDriverName() === 'pgsql') {[m
[32m+[m[32m            $result = $connection->select([m
[32m+[m[32m                "SELECT COUNT(*) as count FROM pg_indexes[m[41m [m
[32m+[m[32m                 WHERE schemaname = 'public' AND tablename = ? AND indexname = ?",[m
[32m+[m[32m                [$table, $indexName][m
[32m+[m[32m            );[m
[32m+[m[32m            return $result[0]->count > 0;[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        return false;[m
[32m+[m[32m    }[m
[32m+[m[32m};[m
[32m+[m
[1mdiff --git a/database/migrations/2025_12_06_100000_add_sms_days_to_schedules_table.php b/database/migrations/2025_12_06_100000_add_sms_days_to_schedules_table.php[m
[1mnew file mode 100644[m
[1mindex 0000000..ff4077b[m
[1m--- /dev/null[m
[1m+++ b/database/migrations/2025_12_06_100000_add_sms_days_to_schedules_table.php[m
[36m@@ -0,0 +1,34 @@[m
[32m+[m[32m<?php[m
[32m+[m
[32m+[m[32muse Illuminate\Database\Migrations\Migration;[m
[32m+[m[32muse Illuminate\Database\Schema\Blueprint;[m
[32m+[m[32muse Illuminate\Support\Facades\Schema;[m
[32m+[m
[32m+[m[32mreturn new class extends Migration[m
[32m+[m[32m{[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Run the migrations.[m
[32m+[m[32m     */[m
[32m+[m[32m    public function up(): void[m
[32m+[m[32m    {[m
[32m+[m[32m        Schema::table('schedules', function (Blueprint $table) {[m
[32m+[m[32m            // Add JSON column to store days array for Payment Reminders and Overdue Alerts[m
[32m+[m[32m            if (!Schema::hasColumn('schedules', 'sms_days')) {[m
[32m+[m[32m                $table->json('sms_days')->nullable()->after('schedule_day');[m
[32m+[m[32m            }[m
[32m+[m[32m        });[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Reverse the migrations.[m
[32m+[m[32m     */[m
[32m+[m[32m    public function down(): void[m
[32m+[m[32m    {[m
[32m+[m[32m        Schema::table('schedules', function (Blueprint $table) {[m
[32m+[m[32m            if (Schema::hasColumn('schedules', 'sms_days')) {[m
[32m+[m[32m                $table->dropColumn('sms_days');[m
[32m+[m[32m            }[m
[32m+[m[32m        });[m
[32m+[m[32m    }[m
[32m+[m[32m};[m
[32m+[m
[1mdiff --git a/database/migrations/2025_12_06_150000_add_recipients_to_announcements_table.php b/database/migrations/2025_12_06_150000_add_recipients_to_announcements_table.php[m
[1mnew file mode 100644[m
[1mindex 0000000..ddb7e5b[m
[1m--- /dev/null[m
[1m+++ b/database/migrations/2025_12_06_150000_add_recipients_to_announcements_table.php[m
[36m@@ -0,0 +1,29 @@[m
[32m+[m[32m<?php[m
[32m+[m
[32m+[m[32muse Illuminate\Database\Migrations\Migration;[m
[32m+[m[32muse Illuminate\Database\Schema\Blueprint;[m
[32m+[m[32muse Illuminate\Support\Facades\Schema;[m
[32m+[m
[32m+[m[32mreturn new class extends Migration[m
[32m+[m[32m{[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Run the migrations.[m
[32m+[m[32m     */[m
[32m+[m[32m    public function up(): void[m
[32m+[m[32m    {[m
[32m+[m[32m        Schema::table('announcements', function (Blueprint $table) {[m
[32m+[m[32m            $table->json('recipients')->nullable()->after('related_stall_id');[m
[32m+[m[32m        });[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Reverse the migrations.[m
[32m+[m[32m     */[m
[32m+[m[32m    public function down(): void[m
[32m+[m[32m    {[m
[32m+[m[32m        Schema::table('announcements', function (Blueprint $table) {[m
[32m+[m[32m            $table->dropColumn('recipients');[m
[32m+[m[32m        });[m
[32m+[m[32m    }[m
[32m+[m[32m};[m
[32m+[m
[1mdiff --git a/database/migrations/2025_12_07_100000_create_dismissed_announcements_table.php b/database/migrations/2025_12_07_100000_create_dismissed_announcements_table.php[m
[1mnew file mode 100644[m
[1mindex 0000000..aa1f188[m
[1m--- /dev/null[m
[1m+++ b/database/migrations/2025_12_07_100000_create_dismissed_announcements_table.php[m
[36m@@ -0,0 +1,36 @@[m
[32m+[m[32m<?php[m
[32m+[m
[32m+[m[32muse Illuminate\Database\Migrations\Migration;[m
[32m+[m[32muse Illuminate\Database\Schema\Blueprint;[m
[32m+[m[32muse Illuminate\Support\Facades\Schema;[m
[32m+[m
[32m+[m[32mreturn new class extends Migration[m
[32m+[m[32m{[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Run the migrations.[m
[32m+[m[32m     */[m
[32m+[m[32m    public function up(): void[m
[32m+[m[32m    {[m
[32m+[m[32m        Schema::create('dismissed_announcements', function (Blueprint $table) {[m
[32m+[m[32m            $table->id();[m
[32m+[m[32m            $table->unsignedBigInteger('user_id');[m
[32m+[m[32m            $table->unsignedBigInteger('announcement_id');[m
[32m+[m[32m            $table->timestamps();[m
[32m+[m
[32m+[m[32m            $table->foreign('user_id')->references('id')->on('users')->onDelete('cascade');[m
[32m+[m[32m            $table->foreign('announcement_id')->references('id')->on('announcements')->onDelete('cascade');[m
[32m+[m[41m            [m
[32m+[m[32m            // Ensure a user can only dismiss an announcement once[m
[32m+[m[32m            $table->unique(['user_id', 'announcement_id']);[m
[32m+[m[32m        });[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    /**[m
[32m+[m[32m     * Reverse the migrations.[m
[32m+[m[32m     */[m
[32m+[m[32m    public function down(): void[m
[32m+[m[32m    {[m
[32m+[m[32m        Schema::dropIfExists('dismissed_announcements');[m
[32m+[m[32m    }[m
[32m+[m[32m};[m
[32m+[m
[1mdiff --git a/database/seeders/DatabaseSeeder.php b/database/seeders/DatabaseSeeder.php[m
[1mindex 4253723..be43f47 100644[m
[1m--- a/database/seeders/DatabaseSeeder.php[m
[1m+++ b/database/seeders/DatabaseSeeder.php[m
[36m@@ -3,9 +3,6 @@[m
 namespace Database\Seeders;[m
 [m
 use Illuminate\Database\Seeder;[m
[31m-use Illuminate\Support\Facades\DB;[m
[31m-use Illuminate\Support\Facades\File;[m
[31m-use Illuminate\Support\Str;[m
 [m
 class DatabaseSeeder extends Seeder[m
 {[m
[36m@@ -14,94 +11,35 @@[m [mclass DatabaseSeeder extends Seeder[m
      */[m
     public function run(): void[m
     {[m
[31m-       DB::disableQueryLog();[m
[31m-        ini_set('memory_limit', '-1');[m
[31m-        set_time_limit(0);[m
[31m-        DB::statement('SET FOREIGN_KEY_CHECKS=0;');[m
[31m-[m
[31m-        // Truncate all tables to ensure a clean slate and avoid duplicate entry errors[m
[31m-        $tables = DB::select('SHOW TABLES');[m
[31m-        [m
[31m-        foreach ($tables as $table) {[m
[31m-            $tableName = "";[m
[31m-            foreach ($table as $key => $value) {[m
[31m-                $tableName = $value;[m
[31m-                break;[m
[31m-            }[m
[31m-[m
[31m-            if ($tableName == 'migrations') {[m
[31m-                continue;[m
[31m-            }[m
[31m-[m
[31m-            try {[m
[31m-                DB::table($tableName)->truncate();[m
[31m-                $this->command->info("Truncated table: $tableName");[m
[31m-            } catch (\Exception $e) {[m
[31m-                // Ignore errors if table doesn't exist or other issues[m
[31m-            }[m
[31m-        }[m
[31m-[m
[31m-        $sqlPath = database_path('seeders/cap102_latest.sql');[m
[31m-[m
[31m-        if (File::exists($sqlPath)) {[m
[31m-            $this->command->info('Importing cap102_latest.sql (Streaming Mode)...');[m
[31m-            [m
[31m-            $handle = fopen($sqlPath, "r");[m
[31m-            if ($handle) {[m
[31m-                $query = ""; [m
[31m-                $count = 0;[m
[31m-                $skipping = false;[m
[31m-[m
[31m-                while (($line = fgets($handle)) !== false) {[m
[31m-                    $trimLine = trim($line);[m
[31m-                    [m
[31m-                    // Skip comments[m
[31m-                    if (empty($trimLine) || str_starts_with($trimLine, '--') || (str_starts_with($trimLine, '/*') && !str_starts_with($trimLine, '/*!'))) {[m
[31m-                        continue;[m
[31m-                    }[m
[31m-[m
[31m-                    // Handle Migrations Table Skipping (Multi-line support)[m
[31m-                    if (!$skipping && (Str::contains($line, 'INSERT INTO `migrations`') || Str::contains($line, 'INSERT INTO migrations'))) {[m
[31m-                        $skipping = true;[m
[31m-                    }[m
[31m-[m
[31m-                    if ($skipping) {[m
[31m-                        if (str_ends_with($trimLine, ';')) {[m
[31m-                            $skipping = false;[m
[31m-                        }[m
[31m-                        continue;[m
[31m-                    }[m
[31m-[m
[31m-                    $query .= $line;[m
[31m-[m
[31m-                    if (str_ends_with($trimLine, ';')) {[m
[31m-                        try {[m
[31m-                            // Extract table name for logging[m
[31m-                            if (preg_match('/INSERT INTO [`"]?(\w+)[`"]?/', $query, $matches)) {[m
[31m-                                $this->command->info("Inserting into table: " . $matches[1]);[m
[31m-                            }[m
[31m-[m
[31m-                            DB::unprepared($query);[m
[31m-                            $count++;[m
[31m-                        } catch (\Exception $e) {[m
[31m-                            // Log ALL errors now, since we are truncating, duplicates shouldn't happen.[m
[31m-                            // If they do, we need to see them to debug the "missing users" issue.[m
[31m-                            $this->command->error("\nError importing query: " . $e->getMessage());[m
[31m-                        }[m
[31m-                        $query = "";[m
[31m-                    }[m
[31m-                }[m
[31m-                fclose($handle);[m
[31m-                $this->command->info("\nData imported successfully!");[m
[31m-            }[m
[31m-        } else {[m
[31m-            $this->command->error('SQL file not found at: ' . $sqlPath);[m
[31m-        }[m
[32m+[m[32m        // Important: Seed in order to respect foreign key constraints[m
         [m
         $this->call([[m
[31m-            AdminUserSeeder::class,[m
[32m+[m[32m            // 1. Foundation tables (no dependencies)[m
[32m+[m[32m            RolesSeeder::class,[m
[32m+[m[32m            SectionsSeeder::class,[m
[32m+[m[32m            RatesSeeder::class,[m
[32m+[m[32m            BillingSettingsSeeder::class,[m
[32m+[m[41m            [m
[32m+[m[32m            // 2. Users (depends on roles)[m
[32m+[m[32m            UsersSeeder::class,[m
[32m+[m[41m            [m
[32m+[m[32m            // 3. Stalls (depends on sections and users)[m
[32m+[m[32m            StallsSeeder::class,[m
[32m+[m[41m            [m
[32m+[m[32m            // 4. Schedules (standalone)[m
[32m+[m[32m            SchedulesSeeder::class,[m
[32m+[m[32m            SmsNotificationSettingsSeeder::class,[m
[32m+[m[41m            [m
[32m+[m[32m            // 5. Billing and Payments (depends on stalls)[m
[32m+[m[32m            BillingSeeder::class,[m
[32m+[m[32m            PaymentsSeeder::class,[m
[32m+[m[41m            [m
[32m+[m[32m            // 6. Large historical data (depends on stalls)[m
[32m+[m[32m            // Note: This seeder contains 2,698 records[m
[32m+[m[32m            UtilityReadingSeeder::class,[m
[32m+[m[41m            [m
[32m+[m[32m            // 7. Audit and history tables (optional - depends on users)[m
[32m+[m[32m            // AuditTrailsSeeder::class,  // Uncomment if needed[m
         ]);[m
[31m-        [m
[31m-        DB::statement('SET FOREIGN_KEY_CHECKS=1;');[m
     }[m
 }[m
\ No newline at end of file[m
[1mdiff --git a/database/seeders/SchedulesSeeder.php b/database/seeders/SchedulesSeeder.php[m
[1mindex db321e1..7df84fa 100644[m
[1m--- a/database/seeders/SchedulesSeeder.php[m
[1m+++ b/database/seeders/SchedulesSeeder.php[m
[36m@@ -17,9 +17,9 @@[m [mpublic function run()[m
             ['id' => 6, 'schedule_type' => 'Due Date - Electricity', 'description' => '13', 'schedule_day' => null, 'schedule_date' => '2025-09-12', 'created_at' => '2025-09-11 22:20:55', 'updated_at' => '2025-10-16 00:47:00'],[m
             ['id' => 7, 'schedule_type' => 'Disconnection - Electricity', 'description' => '19', 'schedule_day' => null, 'schedule_date' => '2025-09-12', 'created_at' => '2025-09-11 22:20:57', 'updated_at' => '2025-10-16 00:47:00'],[m
             ['id' => 8, 'schedule_type' => 'Due Date - Water', 'description' => '13', 'schedule_day' => null, 'schedule_date' => '2025-09-12', 'created_at' => '2025-09-11 22:20:59', 'updated_at' => '2025-10-16 00:47:00'],[m
[31m-            ['id' => 9, 'schedule_type' => 'SMS - Billing Statements', 'description' => '08:00', 'schedule_day' => null, 'schedule_date' => '2025-09-30', 'created_at' => '2025-09-30 05:38:25', 'updated_at' => '2025-10-16 00:54:41'],[m
[31m-            ['id' => 10, 'schedule_type' => 'SMS - Payment Reminders', 'description' => '08:00', 'schedule_day' => null, 'schedule_date' => '2025-09-30', 'created_at' => '2025-09-30 05:38:26', 'updated_at' => '2025-10-10 01:56:47'],[m
[31m-            ['id' => 11, 'schedule_type' => 'SMS - Overdue Alerts', 'description' => '08:00', 'schedule_day' => null, 'schedule_date' => '2025-09-30', 'created_at' => '2025-09-30 05:38:26', 'updated_at' => '2025-10-07 12:42:05'],[m
[32m+[m[32m            ['id' => 9, 'schedule_type' => 'SMS - Billing Statements', 'description' => '08:00', 'schedule_day' => 1, 'sms_days' => null, 'schedule_date' => '2025-09-30', 'created_at' => '2025-09-30 05:38:25', 'updated_at' => '2025-10-16 00:54:41'],[m
[32m+[m[32m            ['id' => 10, 'schedule_type' => 'SMS - Payment Reminders', 'description' => '08:00', 'schedule_day' => null, 'sms_days' => json_encode([7, 5, 3, 1]), 'schedule_date' => '2025-09-30', 'created_at' => '2025-09-30 05:38:26', 'updated_at' => '2025-10-10 01:56:47'],[m
[32m+[m[32m            ['id' => 11, 'schedule_type' => 'SMS - Overdue Alerts', 'description' => '08:00', 'schedule_day' => null, 'sms_days' => json_encode([1, 3, 7, 14, 21, 30]), 'schedule_date' => '2025-09-30', 'created_at' => '2025-09-30 05:38:26', 'updated_at' => '2025-10-07 12:42:05'],[m
         ]);[m
     }[m
 }[m
\ No newline at end of file[m
[1mdiff --git a/database/seeders/SmsNotificationSettings.php b/database/seeders/SmsNotificationSettings.php[m
[1mindex 99fdffa..5e9e4ff 100644[m
[1m--- a/database/seeders/SmsNotificationSettings.php[m
[1m+++ b/database/seeders/SmsNotificationSettings.php[m
[36m@@ -13,7 +13,7 @@[m [mpublic function run()[m
             [[m
                 'id' => 1,[m
                 'name' => 'bill_statement_wet_section',[m
[31m-                'message_template' => 'Bill Statement:\n\nMayad na aga, {{ vendor_name }}. Paisi tabi kan saimong bayadan: {{bill_details}}. \n\nAn kabuuan na babayadan: P{{total_due}}. Salamat!',[m
[32m+[m[32m                'message_template' => 'Virac Public Market - Bill Statement\n\nKumusta, {{ vendor_name }}!\nStall: {{stall_number}}\nBill Month: {{bill_month}}\n\nRENT:\n{{rent_details}}\n\nWATER:\n{{water_details}}\n\nELECTRICITY:\n{{electricity_details}}\n\nTOTAL AMOUNT: P{{total_due}}\n\nPara sa mas malinaw na detalye, bisitahin ang: {{website_url}}\nO pumunta sa Market Operations Office.\n\nSalamat po!',[m
                 'enabled' => 1,[m
                 'created_at' => '2025-08-28 09:33:07',[m
                 'updated_at' => '2025-10-16 00:54:19',[m
[36m@@ -21,7 +21,7 @@[m [mpublic function run()[m
             [[m
                 'id' => 2,[m
                 'name' => 'bill_statement_dry_section',[m
[31m-                'message_template' => 'Bill Statement:\n\nMayad na aga, {{ vendor_name }}. Paisi tabi kan saimong bayadan: {{bill_details}}. \n\nAn kabuuan na babayadan: P{{total_due}}. Salamat!',[m
[32m+[m[32m                'message_template' => 'Virac Public Market - Bill Statement\n\nKumusta, {{ vendor_name }}!\nStall: {{stall_number}}\nBill Month: {{bill_month}}\n\nRENT:\n{{rent_details}}\n\nWATER:\n{{water_details}}\n\nELECTRICITY:\n{{electricity_details}}\n\nTOTAL AMOUNT: P{{total_due}}\n\nPara sa mas malinaw na detalye, bisitahin ang: {{website_url}}\nO pumunta sa Market Operations Office.\n\nSalamat po!',[m
                 'enabled' => 1,[m
                 'created_at' => '2025-08-28 09:33:07',[m
                 'updated_at' => '2025-10-16 00:54:19',[m
[36m@@ -29,7 +29,7 @@[m [mpublic function run()[m
             [[m
                 'id' => 3,[m
                 'name' => 'payment_reminder_template',[m
[31m-                'message_template' => 'Mayad na aga, {{vendor_name}}. Reminder: Ini an saimong mga bayadan na dai pa nababayadan: \n\n{{ upcoming_bill_details }}\n\nSalamat!',[m
[32m+[m[32m                'message_template' => 'Virac Public Market - Payment Reminder\n\nKumusta, {{ vendor_name }}!\nStall: {{stall_number}}\n\nREMINDER: Mayroon po kayong mga bayadan na malapit nang mag-due:\n\n{{ upcoming_bill_details }}\n\nTotal: P{{total_due}}\nEarliest Due: {{due_date}}\n\nPakisettle po bago mag-due date. Salamat!',[m
                 'enabled' => 1,[m
                 'created_at' => '2025-08-28 09:33:07',[m
                 'updated_at' => '2025-10-16 00:54:19',[m
[36m@@ -37,7 +37,7 @@[m [mpublic function run()[m
             [[m
                 'id' => 4,[m
                 'name' => 'overdue_alert_template',[m
[31m-                'message_template' => 'Mayad na aga, {{ vendor_name }}. OVERDUE: An saimong bayadan para sa {{overdue_items}} lampas na sa due date. \n\nAn bagong total: P{{new_total_due}}. Salamat!',[m
[32m+[m[32m                'message_template' => 'Virac Public Market - OVERDUE ALERT\n\nKumusta, {{ vendor_name }}!\nStall: {{stall_number}}\n\nâš ï¸ OVERDUE BILLS:\n{{ overdue_bill_details }}\n\nTOTAL DUE (with penalties): P{{new_total_due}}\n\nAng inyong bayadan para sa {{overdue_items}} ay lampas na sa due date. Pakisettle po agad para maiwasan ang disconnection.\n\nSalamat po!',[m
                 'enabled' => 1,[m
                 'created_at' => '2025-08-28 09:33:07',[m
                 'updated_at' => '2025-10-16 00:54:19',[m
[1mdiff --git a/resources/js/admin-dashboard.js b/resources/js/admin-dashboard.js[m
[1mindex 0ede440..addd032 100644[m
[1m--- a/resources/js/admin-dashboard.js[m
[1m+++ b/resources/js/admin-dashboard.js[m
[36m@@ -385,6 +385,19 @@[m [mclass AdminDashboard {[m
             ? data.map((d) => d.vendor_count)[m
             : [];[m
 [m
[32m+[m[32m        // Define colors for each section for easy distinction[m
[32m+[m[32m        const sectionColors = {[m
[32m+[m[32m            'Wet Section': '#7c3aed',      // Purple[m
[32m+[m[32m            'Dry Section': '#06b6d4',      // Cyan/Teal (changed from purple for better distinction)[m
[32m+[m[32m            'Semi-Wet': '#f59e0b',         // Orange[m
[32m+[m[32m            'Semi-Wet Section': '#f59e0b', // Orange (alternative name)[m
[32m+[m[32m        };[m
[32m+[m
[32m+[m[32m        // Map colors based on section names[m
[32m+[m[32m        const backgroundColor = labels.map((label) => {[m
[32m+[m[32m            return sectionColors[label] || '#6b7280'; // Default gray for unknown sections[m
[32m+[m[32m        });[m
[32m+[m
         this.charts.vendorDistribution = new Chart(ctx, {[m
             type: "doughnut",[m
             data: {[m
[36m@@ -393,13 +406,7 @@[m [mclass AdminDashboard {[m
                     {[m
                         label: "Vendor Count",[m
                         data: values,[m
[31m-                        backgroundColor: [[m
[31m-                            "#4f46e5",[m
[31m-                            "#7c3aed",[m
[31m-                            "#f59e0b",[m
[31m-                            "#10b981",[m
[31m-                            "#3b82f6",[m
[31m-                        ],[m
[32m+[m[32m                        backgroundColor: backgroundColor,[m
                         hoverOffset: 4,[m
                     },[m
                 ],[m
[1mdiff --git a/resources/js/meter.js b/resources/js/meter.js[m
[1mindex df18342..77273f9 100644[m
[1m--- a/resources/js/meter.js[m
[1m+++ b/resources/js/meter.js[m
[36m@@ -34,9 +34,12 @@[m [mdocument.addEventListener("DOMContentLoaded", () => {[m
                 const lowercasedSearch = search ? search.toLowerCase() : "";[m
 [m
                 const filtered = meterReadings.filter((item) => {[m
[32m+[m[32m                    // Case-insensitive section matching with trimmed whitespace[m
[32m+[m[32m                    const itemSection = (item.section || '').trim();[m
[32m+[m[32m                    const currentSection = (currentRentalSection || '').trim();[m
                     const sectionMatch =[m
                         !currentRentalSection ||[m
[31m-                        item.section === currentRentalSection;[m
[32m+[m[32m                        itemSection.toLowerCase() === currentSection.toLowerCase();[m
                     const searchMatch =[m
                         !lowercasedSearch ||[m
                         item.section.toLowerCase().includes(lowercasedSearch) ||[m
[36m@@ -60,9 +63,12 @@[m [mdocument.addEventListener("DOMContentLoaded", () => {[m
                 const lowercasedSearch = search ? search.toLowerCase() : "";[m
 [m
                 const filtered = meterReadings.filter((item) => {[m
[32m+[m[32m                    // Case-insensitive section matching with trimmed whitespace[m
[32m+[m[32m                    const itemSection = (item.section || '').trim();[m
[32m+[m[32m                    const currentSection = (currentRentalSection || '').trim();[m
                     const sectionMatch =[m
                         !currentRentalSection ||[m
[31m-                        item.section === currentRentalSection;[m
[32m+[m[32m                        itemSection.toLowerCase() === currentSection.toLowerCase();[m
                     const searchMatch =[m
                         !lowercasedSearch ||[m
                         item.section.toLowerCase().includes(lowercasedSearch) ||[m
[36m@@ -928,7 +934,7 @@[m [mdocument.addEventListener("DOMContentLoaded", () => {[m
 [m
                 // Generate Header HTML[m
                 const headerHtml = `[m
[31m-[m
[32m+[m[32m            <thead>[m
                 <tr class="table-header">[m
                     ${headers[m
                         .map([m
[36m@@ -1350,7 +1356,15 @@[m [mdocument.addEventListener("DOMContentLoaded", () => {[m
             setInterval(this.methods.ForStatusUpdates, 5000);[m
             setInterval(this.methods.ForScheduleUpdate, 5000);[m
             //In-App and SMS Notification//[m
[31m-            setInterval(this.methods.fetchNotifications, 7000);[m
[32m+[m[32m            // Poll for notifications every 2 seconds for faster updates[m
[32m+[m[32m            setInterval(this.methods.fetchNotifications, 2000);[m
[32m+[m[41m            [m
[32m+[m[32m            // Also fetch immediately when page becomes visible (user switches tabs/windows)[m
[32m+[m[32m            document.addEventListener('visibilitychange', () => {[m
[32m+[m[32m                if (!document.hidden) {[m
[32m+[m[32m                    this.methods.fetchNotifications();[m
[32m+[m[32m                }[m
[32m+[m[32m            });[m
 [m
             const hash = window.location.hash.substring(1);[m
             if (hash && document.getElementById(hash)) {[m
[36m@@ -1638,6 +1652,185 @@[m [mdocument.addEventListener("DOMContentLoaded", () => {[m
                 ?.addEventListener("click", () =>[m
                     this.methods.closeModal("requestEditModal")[m
                 );[m
[32m+[m
[32m+[m[32m            // Password change form[m
[32m+[m[32m            const passwordForm = document.getElementById("changePasswordForm");[m
[32m+[m[32m            if (passwordForm) {[m
[32m+[m[32m                passwordForm.addEventListener("submit", async (e) => {[m
[32m+[m[32m                    e.preventDefault();[m
[32m+[m[41m                    [m
[32m+[m[32m                    const btn = document.getElementById("changePasswordBtn");[m
[32m+[m[32m                    const originalText = btn.innerHTML;[m
[32m+[m[32m                    btn.disabled = true;[m
[32m+[m[32m                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Changing...</span>';[m
[32m+[m
[32m+[m[32m                    const formData = new FormData(passwordForm);[m
[32m+[m[32m                    const data = {[m
[32m+[m[32m                        current_password: formData.get("current_password"),[m
[32m+[m[32m                        password: formData.get("password"),[m
[32m+[m[32m                        password_confirmation: formData.get("password_confirmation"),[m
[32m+[m[32m                    };[m
[32m+[m
[32m+[m[32m                    try {[m
[32m+[m[32m                        const response = await fetch("/api/user-settings/change-password", {[m
[32m+[m[32m                            method: "POST",[m
[32m+[m[32m                            headers: {[m
[32m+[m[32m                                "Content-Type": "application/json",[m
[32m+[m[32m                                Accept: "application/json",[m
[32m+[m[32m                                "X-CSRF-TOKEN": document[m
[32m+[m[32m                                    .querySelector('meta[name="csrf-token"]')[m
[32m+[m[32m                                    .getAttribute("content"),[m
[32m+[m[32m                            },[m
[32m+[m[32m                            credentials: "include",[m
[32m+[m[32m                            body: JSON.stringify(data),[m
[32m+[m[32m                        });[m
[32m+[m
[32m+[m[32m                        const result = await response.json();[m
[32m+[m
[32m+[m[32m                        if (response.ok) {[m
[32m+[m[32m                            this.methods.showNotification(result.message || "Password changed successfully!", "success");[m
[32m+[m[32m                            passwordForm.reset();[m
[32m+[m[32m                        } else {[m
[32m+[m[32m                            const errorMsg = result.message || result.errors?.current_password?.[0] || result.errors?.password?.[0] || "Failed to change password";[m
[32m+[m[32m                            this.methods.showNotification(errorMsg, "error");[m
[32m+[m[32m                        }[m
[32m+[m[32m                    } catch (error) {[m
[32m+[m[32m                        console.error("Password change error:", error);[m
[32m+[m[32m                        this.methods.showNotification("An error occurred. Please try again.", "error");[m
[32m+[m[32m                    } finally {[m
[32m+[m[32m                        btn.disabled = false;[m
[32m+[m[32m                        btn.innerHTML = originalText;[m
[32m+[m[32m                    }[m
[32m+[m[32m                });[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            // Profile picture upload[m
[32m+[m[32m            const profilePictureInput = document.getElementById("profilePictureInput");[m
[32m+[m[32m            const removeProfilePictureBtn = document.getElementById("removeProfilePictureBtn");[m
[32m+[m[41m            [m
[32m+[m[32m            if (profilePictureInput) {[m
[32m+[m[32m                profilePictureInput.addEventListener("change", async (e) => {[m
[32m+[m[32m                    const file = e.target.files[0];[m
[32m+[m[32m                    if (!file) return;[m
[32m+[m
[32m+[m[32m                    if (file.size > 2 * 1024 * 1024) {[m
[32m+[m[32m                        this.methods.showNotification("Image must be smaller than 2MB", "error");[m
[32m+[m[32m                        return;[m
[32m+[m[32m                    }[m
[32m+[m
[32m+[m[32m                    if (!file.type.match(/^image\/(jpeg|jpg|png|gif)$/)) {[m
[32m+[m[32m                        this.methods.showNotification("Please select a valid image file (JPEG, PNG, or GIF)", "error");[m
[32m+[m[32m                        return;[m
[32m+[m[32m                    }[m
[32m+[m
[32m+[m[32m                    const formData = new FormData();[m
[32m+[m[32m                    formData.append("profile_picture", file);[m
[32m+[m
[32m+[m[32m                    const container = document.getElementById("profilePictureContainer");[m
[32m+[m[32m                    const placeholder = document.getElementById("profilePicturePlaceholder");[m
[32m+[m[32m                    const img = document.getElementById("profilePictureImg");[m
[32m+[m
[32m+[m[32m                    // Show preview[m
[32m+[m[32m                    const reader = new FileReader();[m
[32m+[m[32m                    reader.onload = (e) => {[m
[32m+[m[32m                        if (img) {[m
[32m+[m[32m                            img.src = e.target.result;[m
[32m+[m[32m                            img.classList.remove("hidden");[m
[32m+[m[32m                            if (placeholder) placeholder.classList.add("hidden");[m
[32m+[m[32m                        } else {[m
[32m+[m[32m                            const newImg = document.createElement("img");[m
[32m+[m[32m                            newImg.id = "profilePictureImg";[m
[32m+[m[32m                            newImg.src = e.target.result;[m
[32m+[m[32m                            newImg.alt = "Profile Picture";[m
[32m+[m[32m                            newImg.className = "w-full h-full object-cover";[m
[32m+[m[32m                            container.innerHTML = "";[m
[32m+[m[32m                            container.appendChild(newImg);[m
[32m+[m[32m                        }[m
[32m+[m[32m                        if (removeProfilePictureBtn) removeProfilePictureBtn.classList.remove("hidden");[m
[32m+[m[32m                    };[m
[32m+[m[32m                    reader.readAsDataURL(file);[m
[32m+[m
[32m+[m[32m                    try {[m
[32m+[m[32m                        const response = await fetch("/api/user-settings/upload-profile-picture", {[m
[32m+[m[32m                            method: "POST",[m
[32m+[m[32m                            headers: {[m
[32m+[m[32m                                "X-CSRF-TOKEN": document[m
[32m+[m[32m                                    .querySelector('meta[name="csrf-token"]')[m
[32m+[m[32m                                    .getAttribute("content"),[m
[32m+[m[32m                            },[m
[32m+[m[32m                            credentials: "include",[m
[32m+[m[32m                            body: formData,[m
[32m+[m[32m                        });[m
[32m+[m
[32m+[m[32m                        const result = await response.json();[m
[32m+[m
[32m+[m[32m                        if (response.ok) {[m
[32m+[m[32m                            this.methods.showNotification(result.message || "Profile picture uploaded successfully!", "success");[m
[32m+[m[32m                            if (img && result.profile_picture_url) {[m
[32m+[m[32m                                img.src = result.profile_picture_url;[m
[32m+[m[32m                            }[m
[32m+[m[32m                            // Update sidebar profile picture[m
[32m+[m[32m                            const sidebarImg = document.getElementById('sidebarProfilePicture');[m
[32m+[m[32m                            const sidebarIcon = document.getElementById('sidebarProfileIcon');[m
[32m+[m[32m                            if (sidebarImg && result.profile_picture_url) {[m
[32m+[m[32m                                sidebarImg.src = result.profile_picture_url;[m
[32m+[m[32m                                sidebarImg.classList.remove('hidden');[m
[32m+[m[32m                                if (sidebarIcon) sidebarIcon.classList.add('hidden');[m
[32m+[m[32m                            }[m
[32m+[m[32m                        } else {[m
[32m+[m[32m                            this.methods.showNotification(result.message || "Failed to upload profile picture", "error");[m
[32m+[m[32m                            if (img) img.classList.add("hidden");[m
[32m+[m[32m                            if (placeholder) placeholder.classList.remove("hidden");[m
[32m+[m[32m                        }[m
[32m+[m[32m                    } catch (error) {[m
[32m+[m[32m                        console.error("Profile picture upload error:", error);[m
[32m+[m[32m                        this.methods.showNotification("An error occurred. Please try again.", "error");[m
[32m+[m[32m                        if (img) img.classList.add("hidden");[m
[32m+[m[32m                        if (placeholder) placeholder.classList.remove("hidden");[m
[32m+[m[32m                    } finally {[m
[32m+[m[32m                        profilePictureInput.value = "";[m
[32m+[m[32m                    }[m
[32m+[m[32m                });[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            if (removeProfilePictureBtn) {[m
[32m+[m[32m                removeProfilePictureBtn.addEventListener("click", async () => {[m
[32m+[m[32m                    if (!confirm("Are you sure you want to remove your profile picture?")) return;[m
[32m+[m
[32m+[m[32m                    try {[m
[32m+[m[32m                        const response = await fetch("/api/user-settings/remove-profile-picture", {[m
[32m+[m[32m                            method: "DELETE",[m
[32m+[m[32m                            headers: {[m
[32m+[m[32m                                "X-CSRF-TOKEN": document[m
[32m+[m[32m                                    .querySelector('meta[name="csrf-token"]')[m
[32m+[m[32m                                    .getAttribute("content"),[m
[32m+[m[32m                            },[m
[32m+[m[32m                            credentials: "include",[m
[32m+[m[32m                        });[m
[32m+[m
[32m+[m[32m                        const result = await response.json();[m
[32m+[m
[32m+[m[32m                        if (response.ok) {[m
[32m+[m[32m                            this.methods.showNotification(result.message || "Profile picture removed successfully!", "success");[m
[32m+[m[32m                            const img = document.getElementById("profilePictureImg");[m
[32m+[m[32m                            const placeholder = document.getElementById("profilePicturePlaceholder");[m
[32m+[m[32m                            if (img) img.classList.add("hidden");[m
[32m+[m[32m                            if (placeholder) placeholder.classList.remove("hidden");[m
[32m+[m[32m                            removeProfilePictureBtn.classList.add("hidden");[m
[32m+[m[32m                            // Update sidebar[m
[32m+[m[32m                            const sidebarImg = document.querySelector('#sidebarProfileImage img');[m
[32m+[m[32m                            const sidebarIcon = document.getElementById('sidebarProfileIcon');[m
[32m+[m[32m                            if (sidebarImg) sidebarImg.classList.add('hidden');[m
[32m+[m[32m                            if (sidebarIcon) sidebarIcon.classList.remove('hidden');[m
[32m+[m[32m                        } else {[m
[32m+[m[32m                            this.methods.showNotification(result.message || "Failed to remove profile picture", "error");[m
[32m+[m[32m                        }[m
[32m+[m[32m                    } catch (error) {[m
[32m+[m[32m                        console.error("Remove profile picture error:", error);[m
[32m+[m[32m                        this.methods.showNotification("An error occurred. Please try again.", "error");[m
[32m+[m[32m                    }[m
[32m+[m[32m                });[m
[32m+[m[32m            }[m
         },[m
     };[m
 [m
[1mdiff --git a/resources/js/staff.js b/resources/js/staff.js[m
[1mindex c536a3a..dca09e1 100644[m
[1m--- a/resources/js/staff.js[m
[1m+++ b/resources/js/staff.js[m
[36m@@ -15,7 +15,7 @@[m [mconst MarketApp = {[m
             search: "",[m
         },[m
         sort: {[m
[31m-            key: "vendorName",[m
[32m+[m[32m            key: "stallNumber",[m
             direction: "asc",[m
         },[m
         currentVendorId: null,[m
[36m@@ -24,18 +24,23 @@[m [mconst MarketApp = {[m
         isLoading: true,[m
         vendorDashboardData: null,[m
         isLoadingModal: false,[m
[31m-        dataLoaded: {[m
[31m-            homeSection: false,[m
[31m-            vendorManagementSection: false,[m
[31m-            stallAssignmentSection: false,[m
[31m-            dashboardSection: false,[m
[31m-            reportsSection: false,[m
[31m-        },[m
[32m+[m[32m        allNotifications: [],[m
[32m+[m[32m            dataLoaded: {[m
[32m+[m[32m                homeSection: false,[m
[32m+[m[32m                vendorManagementSection: false,[m
[32m+[m[32m                stallAssignmentSection: false,[m
[32m+[m[32m                dashboardSection: false,[m
[32m+[m[32m                reportsSection: false,[m
[32m+[m[32m                profileSection: false,[m
[32m+[m[32m                notificationsSection: false,[m
[32m+[m[32m            },[m
         isOutstandingModalOpen: false,[m
         modalBills: [],[m
         unassignedVendors: [],[m
         availableStalls: [],[m
         charts: {},[m
[32m+[m[32m        notifications: [],[m
[32m+[m[32m        unreadCount: 0,[m
     },[m
 [m
     dashboardInstance: null,[m
[36m@@ -63,7 +68,16 @@[m [mconst MarketApp = {[m
                 if (!response.ok)[m
                     throw new Error(`HTTP error! Status: ${response.status}`);[m
                 const result = await response.json();[m
[31m-                return result.data || result; // Handle paginated or array response[m
[32m+[m[32m                // Handle paginated response - Laravel pagination returns { data: [...], current_page: ..., etc }[m
[32m+[m[32m                if (result.data && Array.isArray(result.data)) {[m
[32m+[m[32m                    return result.data;[m
[32m+[m[32m                }[m
[32m+[m[32m                // Handle array response[m
[32m+[m[32m                if (Array.isArray(result)) {[m
[32m+[m[32m                    return result;[m
[32m+[m[32m                }[m
[32m+[m[32m                // Fallback[m
[32m+[m[32m                return [];[m
             } catch (error) {[m
                 console.error("Failed to fetch vendors:", error);[m
                 return [];[m
[36m@@ -190,31 +204,6 @@[m [mconst MarketApp = {[m
                 return { success: false, message: error.message };[m
             }[m
         },[m
[31m-        async uploadProfilePicture(vendorId, file) {[m
[31m-            try {[m
[31m-                const formData = new FormData();[m
[31m-                formData.append("vendor_id", vendorId);[m
[31m-                formData.append("profile_picture", file);[m
[31m-[m
[31m-                const response = await fetch("/api/staff/upload-profile-picture", {[m
[31m-                    method: "POST",[m
[31m-                    headers: {[m
[31m-                        "X-CSRF-TOKEN": document[m
[31m-                            .querySelector('meta[name="csrf-token"]')[m
[31m-                            .getAttribute("content"),[m
[31m-                    },[m
[31m-                    body: formData,[m
[31m-                    credentials: "include",[m
[31m-                });[m
[31m-                const result = await response.json();[m
[31m-                if (!response.ok)[m
[31m-                    throw new Error(result.message || "Upload failed");[m
[31m-                return { success: true, ...result };[m
[31m-            } catch (error) {[m
[31m-                console.error("Profile picture upload error:", error);[m
[31m-                return { success: false, message: error.message };[m
[31m-            }[m
[31m-        },[m
     },[m
 [m
     elements: {},[m
[36m@@ -240,11 +229,23 @@[m [mconst MarketApp = {[m
             const { key, direction } = state.sort;[m
             if (key) {[m
                 filtered.sort((a, b) => {[m
[31m-                    const valA = a[key] ? a[key].toString().toLowerCase() : "";[m
[31m-                    const valB = b[key] ? b[key].toString().toLowerCase() : "";[m
[31m-                    if (valA < valB) return direction === "asc" ? -1 : 1;[m
[31m-                    if (valA > valB) return direction === "asc" ? 1 : -1;[m
[31m-                    return 0;[m
[32m+[m[32m                    let valA = a[key] ? a[key].toString() : "";[m
[32m+[m[32m                    let valB = b[key] ? b[key].toString() : "";[m
[32m+[m[41m                    [m
[32m+[m[32m                    // Use natural sort for stall numbers (handles alphanumeric like "MS-06", "L1")[m
[32m+[m[32m                    if (key === "stallNumber") {[m
[32m+[m[32m                        valA = valA.toUpperCase();[m
[32m+[m[32m                        valB = valB.toUpperCase();[m
[32m+[m[32m                        const comparison = valA.localeCompare(valB, undefined, { numeric: true, sensitivity: 'base' });[m
[32m+[m[32m                        return direction === "asc" ? comparison : -comparison;[m
[32m+[m[32m                    } else {[m
[32m+[m[32m                        // Regular string comparison for other fields[m
[32m+[m[32m                        valA = valA.toLowerCase();[m
[32m+[m[32m                        valB = valB.toLowerCase();[m
[32m+[m[32m                        if (valA < valB) return direction === "asc" ? -1 : 1;[m
[32m+[m[32m                        if (valA > valB) return direction === "asc" ? 1 : -1;[m
[32m+[m[32m                        return 0;[m
[32m+[m[32m                    }[m
                 });[m
             }[m
             return filtered;[m
[36m@@ -324,6 +325,10 @@[m [mconst MarketApp = {[m
             }[m
 [m
             MarketApp.render.updateDashboardView();[m
[32m+[m[32m            // Update notifications when section changes[m
[32m+[m[32m            MarketApp.methods.renderNotificationDropdown();[m
[32m+[m[32m            // Fetch fresh notifications when section changes[m
[32m+[m[32m            MarketApp.methods.fetchNotifications();[m
             // Call the new initializer method every time the section changes[m
             MarketApp.methods.initializeSection(MarketApp.state.activeSection);[m
         },[m
[36m@@ -359,6 +364,10 @@[m [mconst MarketApp = {[m
                         MarketApp.methods.setupStallAssignmentEventListeners();[m
                         await MarketApp.methods.loadStallAssignmentData();[m
                         break;[m
[32m+[m[32m                    case "notificationsSection":[m
[32m+[m[32m                        await MarketApp.methods.loadAllNotifications();[m
[32m+[m[32m                        MarketApp.methods.setupNotificationsEventListeners();[m
[32m+[m[32m                        break;[m
                 }[m
                 // Mark MarketApp section as loaded so we don't run setup again[m
                 MarketApp.state.dataLoaded[sectionId] = true;[m
[36m@@ -526,6 +535,399 @@[m [mconst MarketApp = {[m
             }[m
         },[m
 [m
[32m+[m[32m        // Announcements are now shown as notifications in the bell dropdown[m
[32m+[m[32m        // No need to display announcement banners[m
[32m+[m
[32m+[m[32m        async fetchNotifications() {[m
[32m+[m[32m            try {[m
[32m+[m[32m                const response = await fetch("/notifications/fetch");[m
[32m+[m[32m                if (!response.ok) return;[m
[32m+[m
[32m+[m[32m                const data = await response.json();[m
[32m+[m[32m                MarketApp.state.notifications = data.notifications || [];[m
[32m+[m[32m                MarketApp.state.unreadCount = data.unread_count || 0;[m
[32m+[m[32m                MarketApp.methods.renderNotificationDropdown();[m
[32m+[m[32m            } catch (error) {[m
[32m+[m[32m                console.error("Error fetching notifications:", error);[m
[32m+[m[32m            }[m
[32m+[m[32m        },[m
[32m+[m
[32m+[m[32m        renderNotificationDropdown() {[m
[32m+[m[32m            // Find notification elements in the active section[m
[32m+[m[32m            const activeSection = document.querySelector(".dashboard-section.active");[m
[32m+[m[32m            if (!activeSection) return;[m
[32m+[m
[32m+[m[32m            const notificationList = activeSection.querySelector(".notificationList");[m
[32m+[m[32m            const notificationDot = activeSection.querySelector(".notificationDot");[m
[32m+[m
[32m+[m[32m            if (!notificationList || !notificationDot) return;[m
[32m+[m
[32m+[m[32m            // Show/hide notification dot[m
[32m+[m[32m            notificationDot.classList.toggle("hidden", MarketApp.state.unreadCount === 0);[m
[32m+[m
[32m+[m[32m            if (MarketApp.state.notifications.length === 0) {[m
[32m+[m[32m                notificationList.innerHTML = `<p class="text-center text-gray-500 p-4">You have no new notifications.</p>`;[m
[32m+[m[32m                return;[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            notificationList.innerHTML = MarketApp.state.notifications[m
[32m+[m[32m                .map((notification) => {[m
[32m+[m[32m                    // Try to parse message as JSON, fallback to plain text[m
[32m+[m[32m                    let notificationText = notification.title || "Notification";[m
[32m+[m[32m                    try {[m
[32m+[m[32m                        if (notification.message) {[m
[32m+[m[32m                            const data = JSON.parse(notification.message);[m
[32m+[m[32m                            notificationText = data.text || data.message || notification.title || notificationText;[m
[32m+[m[32m                        }[m
[32m+[m[32m                    } catch (e) {[m
[32m+[m[32m                        // If not JSON, use message as plain text[m
[32m+[m[32m                        notificationText = notification.message || notification.title || notificationText;[m
[32m+[m[32m                    }[m
[32m+[m[41m                    [m
[32m+[m[32m                    const isUnread = notification.read_at === null;[m
[32m+[m[32m                    const timeAgo = MarketApp.methods.formatTimeAgo(notification.created_at);[m
[32m+[m
[32m+[m[32m                    return `[m
[32m+[m[32m                        <div class="block p-3 transition-colors hover:bg-gray-100 ${isUnread ? "bg-blue-50" : ""}">[m
[32m+[m[32m                            <div class="flex items-start">[m
[32m+[m[32m                                ${isUnread ? '<div class="w-2 h-2 bg-blue-500 rounded-full mt-1.5 mr-3 flex-shrink-0"></div>' : '<div class="w-2 h-2 mr-3"></div>'}[m
[32m+[m[32m                                <div class="flex-grow">[m
[32m+[m[32m                                    <p class="text-sm text-gray-800">${MarketApp.methods.escapeHtml(notificationText)}</p>[m
[32m+[m[32m                                    <p class="text-xs text-blue-600 font-semibold mt-1">${timeAgo}</p>[m
[32m+[m[32m                                </div>[m
[32m+[m[32m                            </div>[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                    `;[m
[32m+[m[32m                })[m
[32m+[m[32m                .join("");[m
[32m+[m[32m        },[m
[32m+[m
[32m+[m[32m        escapeHtml(text) {[m
[32m+[m[32m            const div = document.createElement('div');[m
[32m+[m[32m            div.textContent = text;[m
[32m+[m[32m            return div.innerHTML;[m
[32m+[m[32m        },[m
[32m+[m
[32m+[m[32m        formatTimeAgo(dateString) {[m
[32m+[m[32m            const date = new Date(dateString);[m
[32m+[m[32m            const seconds = Math.floor((new Date() - date) / 1000);[m
[32m+[m
[32m+[m[32m            let interval = seconds / 31536000;[m
[32m+[m[32m            if (interval >= 1) {[m
[32m+[m[32m                const value = Math.floor(interval);[m
[32m+[m[32m                return value === 1 ? `${value} year ago` : `${value} years ago`;[m
[32m+[m[32m            }[m
[32m+[m[32m            interval = seconds / 2592000;[m
[32m+[m[32m            if (interval >= 1) {[m
[32m+[m[32m                const value = Math.floor(interval);[m
[32m+[m[32m                return value === 1 ? `${value} month ago` : `${value} months ago`;[m
[32m+[m[32m            }[m
[32m+[m[32m            interval = seconds / 86400;[m
[32m+[m[32m            if (interval >= 1) {[m
[32m+[m[32m                const value = Math.floor(interval);[m
[32m+[m[32m                return value === 1 ? `${value} day ago` : `${value} days ago`;[m
[32m+[m[32m            }[m
[32m+[m[32m            interval = seconds / 3600;[m
[32m+[m[32m            if (interval >= 1) {[m
[32m+[m[32m                const value = Math.floor(interval);[m
[32m+[m[32m                return value === 1 ? `${value} hour ago` : `${value} hours ago`;[m
[32m+[m[32m            }[m
[32m+[m[32m            interval = seconds / 60;[m
[32m+[m[32m            if (interval >= 1) {[m
[32m+[m[32m                const value = Math.floor(interval);[m
[32m+[m[32m                return value === 1 ? `${value} minute ago` : `${value} minutes ago`;[m
[32m+[m[32m            }[m
[32m+[m[32m            return "Just now";[m
[32m+[m[32m        },[m
[32m+[m
[32m+[m[32m        async markNotificationsAsRead() {[m
[32m+[m[32m            if (MarketApp.state.unreadCount === 0) return;[m
[32m+[m
[32m+[m[32m            // Optimistic update[m
[32m+[m[32m            const now = new Date().toISOString();[m
[32m+[m[32m            MarketApp.state.notifications = MarketApp.state.notifications.map((notification) => {[m
[32m+[m[32m                if (notification.read_at === null) {[m
[32m+[m[32m                    return { ...notification, read_at: now };[m
[32m+[m[32m                }[m
[32m+[m[32m                return notification;[m
[32m+[m[32m            });[m
[32m+[m[32m            MarketApp.state.unreadCount = 0;[m
[32m+[m[32m            MarketApp.methods.renderNotificationDropdown();[m
[32m+[m
[32m+[m[32m            try {[m
[32m+[m[32m                await fetch("/notifications/mark-as-read", {[m
[32m+[m[32m                    method: "POST",[m
[32m+[m[32m                    headers: {[m
[32m+[m[32m                        "Content-Type": "application/json",[m
[32m+[m[32m                        "X-CSRF-TOKEN": document.querySelector('meta[name="csrf-token"]')?.getAttribute("content"),[m
[32m+[m[32m                    },[m
[32m+[m[32m                });[m
[32m+[m[32m            } catch (error) {[m
[32m+[m[32m                console.error("Failed to mark notifications as read:", error);[m
[32m+[m[32m            }[m
[32m+[m[32m        },[m
[32m+[m
[32m+[m[32m        async loadAllNotifications() {[m
[32m+[m[32m            const loader = document.getElementById("notificationsLoader");[m
[32m+[m[32m            const list = document.getElementById("notificationsList");[m
[32m+[m[32m            const noMessage = document.getElementById("noNotificationsMessage");[m
[32m+[m
[32m+[m[32m            if (loader) loader.classList.remove("hidden");[m
[32m+[m[32m            if (list) list.classList.add("hidden");[m
[32m+[m[32m            if (noMessage) noMessage.classList.add("hidden");[m
[32m+[m
[32m+[m[32m            try {[m
[32m+[m[32m                // Fetch both notifications and announcements in parallel with timeout[m
[32m+[m[32m                const controller = new AbortController();[m
[32m+[m[32m                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout[m
[32m+[m
[32m+[m[32m                const [notificationsResponse, announcementsResponse] = await Promise.all([[m
[32m+[m[32m                    fetch("/notifications/fetch-all", {[m
[32m+[m[32m                        signal: controller.signal,[m
[32m+[m[32m                        credentials: "include",[m
[32m+[m[32m                    }),[m
[32m+[m[32m                    fetch("/api/announcements/all-for-user", {[m
[32m+[m[32m                        headers: {[m
[32m+[m[32m                            "Accept": "application/json",[m
[32m+[m[32m                            "X-CSRF-TOKEN": document.querySelector('meta[name="csrf-token"]')?.getAttribute("content") || "",[m
[32m+[m[32m                        },[m
[32m+[m[32m                        credentials: "include",[m
[32m+[m[32m                        signal: controller.signal,[m
[32m+[m[32m                    }).catch(() => ({ ok: false, json: async () => [] })) // Gracefully handle announcements failure[m
[32m+[m[32m                ]);[m
[32m+[m
[32m+[m[32m                clearTimeout(timeoutId);[m
[32m+[m
[32m+[m[32m                if (!notificationsResponse.ok) throw new Error("Failed to fetch notifications");[m
[32m+[m
[32m+[m[32m                const notificationsData = await notificationsResponse.json();[m
[32m+[m[32m                const announcements = announcementsResponse.ok ? await announcementsResponse.json() : [];[m
[32m+[m
[32m+[m[32m                // Combine notifications and announcements[m
[32m+[m[32m                const allItems = [];[m
[32m+[m[41m                [m
[32m+[m[32m                // Add regular notifications[m
[32m+[m[32m                (notificationsData.notifications || []).forEach(notif => {[m
[32m+[m[32m                    allItems.push({[m
[32m+[m[32m                        ...notif,[m
[32m+[m[32m                        type: 'notification',[m
[32m+[m[32m                    });[m
[32m+[m[32m                });[m
[32m+[m
[32m+[m[32m                // Add announcements (convert to notification-like format)[m
[32m+[m[32m                if (Array.isArray(announcements)) {[m
[32m+[m[32m                    announcements.forEach(announcement => {[m
[32m+[m[32m                        allItems.push({[m
[32m+[m[32m                            id: `announcement_${announcement.id}`,[m
[32m+[m[32m                            title: announcement.title,[m
[32m+[m[32m                            message: announcement.content,[m
[32m+[m[32m                            created_at: announcement.created_at,[m
[32m+[m[32m                            read_at: announcement.is_dismissed ? announcement.created_at : null, // Treat dismissed as read[m
[32m+[m[32m                            sender_name: null,[m
[32m+[m[32m                            type: 'announcement',[m
[32m+[m[32m                            announcement_id: announcement.id,[m
[32m+[m[32m                            is_dismissed: announcement.is_dismissed,[m
[32m+[m[32m                        });[m
[32m+[m[32m                    });[m
[32m+[m[32m                }[m
[32m+[m
[32m+[m[32m                // Sort by created_at descending (newest first)[m
[32m+[m[32m                allItems.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));[m
[32m+[m
[32m+[m[32m                MarketApp.state.allNotifications = allItems;[m
[32m+[m[32m                MarketApp.state.unreadCount = notificationsData.unread_count || 0;[m
[32m+[m
[32m+[m[32m                MarketApp.methods.renderNotificationsList();[m
[32m+[m[32m            } catch (error) {[m
[32m+[m[32m                console.error("Error loading notifications:", error);[m
[32m+[m[32m                if (error.name === 'AbortError') {[m
[32m+[m[32m                    MarketApp.methods.showToast("Request timed out. Please try again.", "error");[m
[32m+[m[32m                } else {[m
[32m+[m[32m                    MarketApp.methods.showToast("Failed to load notifications", "error");[m
[32m+[m[32m                }[m
[32m+[m[32m                // Show empty state on error[m
[32m+[m[32m                if (noMessage) {[m
[32m+[m[32m                    noMessage.classList.remove("hidden");[m
[32m+[m[32m                    noMessage.innerHTML = `[m
[32m+[m[32m                        <i class="fas fa-exclamation-triangle text-4xl mb-4 text-yellow-400"></i>[m
[32m+[m[32m                        <p class="text-lg">Failed to load notifications.</p>[m
[32m+[m[32m                        <button onclick="location.reload()" class="mt-4 bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg">[m
[32m+[m[32m                            Retry[m
[32m+[m[32m                        </button>[m
[32m+[m[32m                    `;[m
[32m+[m[32m                }[m
[32m+[m[32m            } finally {[m
[32m+[m[32m                if (loader) loader.classList.add("hidden");[m
[32m+[m[32m            }[m
[32m+[m[32m        },[m
[32m+[m
[32m+[m[32m        renderNotificationsList() {[m
[32m+[m[32m            const list = document.getElementById("notificationsList");[m
[32m+[m[32m            const noMessage = document.getElementById("noNotificationsMessage");[m
[32m+[m[32m            const unreadBadge = document.getElementById("unreadCountBadge");[m
[32m+[m[32m            const unreadText = document.getElementById("unreadCountText");[m
[32m+[m
[32m+[m[32m            if (!list || !noMessage) return;[m
[32m+[m
[32m+[m[32m            const notifications = MarketApp.state.allNotifications || [];[m
[32m+[m
[32m+[m[32m            if (notifications.length === 0) {[m
[32m+[m[32m                list.classList.add("hidden");[m
[32m+[m[32m                noMessage.classList.remove("hidden");[m
[32m+[m[32m                if (unreadBadge) unreadBadge.classList.add("hidden");[m
[32m+[m[32m                return;[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            list.classList.remove("hidden");[m
[32m+[m[32m            noMessage.classList.add("hidden");[m
[32m+[m
[32m+[m[32m            // Update unread badge[m
[32m+[m[32m            if (unreadBadge && MarketApp.state.unreadCount > 0) {[m
[32m+[m[32m                unreadBadge.classList.remove("hidden");[m
[32m+[m[32m                if (unreadText) unreadText.textContent = MarketApp.state.unreadCount;[m
[32m+[m[32m            } else if (unreadBadge) {[m
[32m+[m[32m                unreadBadge.classList.add("hidden");[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            list.innerHTML = notifications.map((notification) => {[m
[32m+[m[32m                const isUnread = !notification.read_at;[m
[32m+[m[32m                const isAnnouncement = notification.type === 'announcement';[m
[32m+[m[32m                const isDismissed = notification.is_dismissed;[m
[32m+[m[32m                const timeAgo = MarketApp.methods.formatTimeAgo(notification.created_at);[m
[32m+[m[32m                const formattedDate = new Date(notification.created_at).toLocaleString('en-US', {[m
[32m+[m[32m                    year: 'numeric',[m
[32m+[m[32m                    month: 'short',[m
[32m+[m[32m                    day: 'numeric',[m
[32m+[m[32m                    hour: '2-digit',[m
[32m+[m[32m                    minute: '2-digit'[m
[32m+[m[32m                });[m
[32m+[m
[32m+[m[32m                // Parse message if it's JSON[m
[32m+[m[32m                let messageText = notification.message || notification.title || "Notification";[m
[32m+[m[32m                try {[m
[32m+[m[32m                    const parsed = JSON.parse(notification.message);[m
[32m+[m[32m                    messageText = parsed.text || parsed.message || notification.title || messageText;[m
[32m+[m[32m                } catch (e) {[m
[32m+[m[32m                    // Not JSON, use as is[m
[32m+[m[32m                }[m
[32m+[m
[32m+[m[32m                // Determine background color[m
[32m+[m[32m                let bgColor = 'bg-white';[m
[32m+[m[32m                if (isUnread && !isDismissed) {[m
[32m+[m[32m                    bgColor = 'bg-blue-50 border-blue-200';[m
[32m+[m[32m                } else if (isDismissed) {[m
[32m+[m[32m                    bgColor = 'bg-gray-50 border-gray-300';[m
[32m+[m[32m                }[m
[32m+[m
[32m+[m[32m                return `[m
[32m+[m[32m                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow ${bgColor}">[m
[32m+[m[32m                        <div class="flex items-start justify-between">[m
[32m+[m[32m                            <div class="flex-1">[m
[32m+[m[32m                                <div class="flex items-start gap-3">[m
[32m+[m[32m                                    ${isUnread && !isDismissed ? '<div class="w-2 h-2 bg-blue-500 rounded-full mt-2 flex-shrink-0"></div>' : ''}[m
[32m+[m[32m                                    ${isDismissed ? '<div class="w-2 h-2 bg-gray-400 rounded-full mt-2 flex-shrink-0"></div>' : ''}[m
[32m+[m[32m                                    ${!isUnread && !isDismissed ? '<div class="w-2 h-2 mr-3"></div>' : ''}[m
[32m+[m[32m                                    <div class="flex-1">[m
[32m+[m[32m                                        <div class="flex items-center gap-2 mb-1">[m
[32m+[m[32m                                            ${isAnnouncement ? '<span class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-indigo-100 text-indigo-800"><i class="fas fa-bullhorn mr-1"></i>Announcement</span>' : ''}[m
[32m+[m[32m                                            ${isDismissed ? '<span class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-gray-200 text-gray-600"><i class="fas fa-check-circle mr-1"></i>Dismissed</span>' : ''}[m
[32m+[m[32m                                        </div>[m
[32m+[m[32m                                        <h3 class="font-semibold text-gray-800 mb-1">${MarketApp.methods.escapeHtml(notification.title || 'Notification')}</h3>[m
[32m+[m[32m                                        <p class="text-sm text-gray-600 mb-2">${MarketApp.methods.escapeHtml(messageText)}</p>[m
[32m+[m[32m                                        <div class="flex items-center gap-4 text-xs text-gray-500">[m
[32m+[m[32m                                            <span><i class="fas fa-clock mr-1"></i>${timeAgo}</span>[m
[32m+[m[32m                                            <span><i class="fas fa-calendar mr-1"></i>${formattedDate}</span>[m
[32m+[m[32m                                            ${notification.sender_name ? `<span><i class="fas fa-user mr-1"></i>From: ${MarketApp.methods.escapeHtml(notification.sender_name)}</span>` : ''}[m
[32m+[m[32m                                        </div>[m
[32m+[m[32m                                    </div>[m
[32m+[m[32m                                </div>[m
[32m+[m[32m                            </div>[m
[32m+[m[32m                            ${isUnread && !isAnnouncement ? `[m
[32m+[m[32m                                <button class="mark-notification-read-btn ml-4 text-indigo-600 hover:text-indigo-800 transition-colors"[m[41m [m
[32m+[m[32m                                        data-id="${notification.id}"[m[41m [m
[32m+[m[32m                                        title="Mark as read">[m
[32m+[m[32m                                    <i class="fas fa-check-circle"></i>[m
[32m+[m[32m                                </button>[m
[32m+[m[32m                            ` : ''}[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                `;[m
[32m+[m[32m            }).join("");[m
[32m+[m
[32m+[m[32m            // Attach event listeners to mark as read buttons[m
[32m+[m[32m            list.querySelectorAll(".mark-notification-read-btn").forEach(btn => {[m
[32m+[m[32m                btn.addEventListener("click", async (e) => {[m
[32m+[m[32m                    const notificationId = e.currentTarget.dataset.id;[m
[32m+[m[32m                    await MarketApp.methods.markSingleNotificationAsRead(notificationId);[m
[32m+[m[32m                });[m
[32m+[m[32m            });[m
[32m+[m[32m        },[m
[32m+[m
[32m+[m[32m        async markSingleNotificationAsRead(notificationId) {[m
[32m+[m[32m            try {[m
[32m+[m[32m                const response = await fetch(`/notifications/${notificationId}/mark-as-read`, {[m
[32m+[m[32m                    method: "POST",[m
[32m+[m[32m                    headers: {[m
[32m+[m[32m                        "Content-Type": "application/json",[m
[32m+[m[32m                        "X-CSRF-TOKEN": document.querySelector('meta[name="csrf-token"]')?.getAttribute("content"),[m
[32m+[m[32m                    },[m
[32m+[m[32m                });[m
[32m+[m
[32m+[m[32m                if (response.ok) {[m
[32m+[m[32m                    // Update local state[m
[32m+[m[32m                    MarketApp.state.allNotifications = MarketApp.state.allNotifications.map(n => {[m
[32m+[m[32m                        if (n.id == notificationId) {[m
[32m+[m[32m                            return { ...n, read_at: new Date().toISOString() };[m
[32m+[m[32m                        }[m
[32m+[m[32m                        return n;[m
[32m+[m[32m                    });[m
[32m+[m[32m                    MarketApp.state.unreadCount = Math.max(0, MarketApp.state.unreadCount - 1);[m
[32m+[m[32m                    MarketApp.methods.renderNotificationsList();[m
[32m+[m[32m                }[m
[32m+[m[32m            } catch (error) {[m
[32m+[m[32m                console.error("Failed to mark notification as read:", error);[m
[32m+[m[32m            }[m
[32m+[m[32m        },[m
[32m+[m
[32m+[m[32m        setupNotificationsEventListeners() {[m
[32m+[m[32m            const markAllBtn = document.getElementById("markAllAsReadBtn");[m
[32m+[m[32m            if (markAllBtn && !markAllBtn.dataset.listenerAttached) {[m
[32m+[m[32m                markAllBtn.dataset.listenerAttached = "true";[m
[32m+[m[32m                markAllBtn.addEventListener("click", async () => {[m
[32m+[m[32m                    if (MarketApp.state.unreadCount === 0) {[m
[32m+[m[32m                        MarketApp.methods.showToast("All notifications are already read", "info");[m
[32m+[m[32m                        return;[m
[32m+[m[32m                    }[m
[32m+[m
[32m+[m[32m                    try {[m
[32m+[m[32m                        const response = await fetch("/notifications/mark-as-read", {[m
[32m+[m[32m                            method: "POST",[m
[32m+[m[32m                            headers: {[m
[32m+[m[32m                                "Content-Type": "application/json",[m
[32m+[m[32m                                "X-CSRF-TOKEN": document.querySelector('meta[name="csrf-token"]')?.getAttribute("content"),[m
[32m+[m[32m                            },[m
[32m+[m[32m                        });[m
[32m+[m
[32m+[m[32m                        if (response.ok) {[m
[32m+[m[32m                            // Update all notifications to read[m
[32m+[m[32m                            MarketApp.state.allNotifications = MarketApp.state.allNotifications.map(n => ({[m
[32m+[m[32m                                ...n,[m
[32m+[m[32m                                read_at: n.read_at || new Date().toISOString()[m
[32m+[m[32m                            }));[m
[32m+[m[32m                            MarketApp.state.unreadCount = 0;[m
[32m+[m[32m                            MarketApp.methods.renderNotificationsList();[m
[32m+[m[32m                            MarketApp.methods.showToast("All notifications marked as read", "success");[m
[32m+[m[32m                        }[m
[32m+[m[32m                    } catch (error) {[m
[32m+[m[32m                        console.error("Failed to mark all as read:", error);[m
[32m+[m[32m                        MarketApp.methods.showToast("Failed to mark all as read", "error");[m
[32m+[m[32m                    }[m
[32m+[m[32m                });[m
[32m+[m[32m            }[m
[32m+[m[32m        },[m
[32m+[m
[32m+[m[32m        // Announcement banner removed - announcements now appear as notifications in the bell dropdown[m
[32m+[m
         showToast(message, type = "success") {[m
             const toastContainer = document.getElementById("toastContainer");[m
             if (!toastContainer) {[m
[36m@@ -553,6 +955,254 @@[m [mconst MarketApp = {[m
             }, 5000);[m
         },[m
 [m
[32m+[m[32m        setupPasswordChangeForm() {[m
[32m+[m[32m            const form = document.getElementById("changePasswordForm");[m
[32m+[m[32m            if (!form) return;[m
[32m+[m
[32m+[m[32m            form.addEventListener("submit", async (e) => {[m
[32m+[m[32m                e.preventDefault();[m
[32m+[m[41m                [m
[32m+[m[32m                const btn = document.getElementById("changePasswordBtn");[m
[32m+[m[32m                const originalText = btn.innerHTML;[m
[32m+[m[32m                btn.disabled = true;[m
[32m+[m[32m                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Changing...</span>';[m
[32m+[m
[32m+[m[32m                const formData = new FormData(form);[m
[32m+[m[32m                const data = {[m
[32m+[m[32m                    current_password: formData.get("current_password"),[m
[32m+[m[32m                    password: formData.get("password"),[m
[32m+[m[32m                    password_confirmation: formData.get("password_confirmation"),[m
[32m+[m[32m                };[m
[32m+[m
[32m+[m[32m                try {[m
[32m+[m[32m                    const response = await fetch("/api/user-settings/change-password", {[m
[32m+[m[32m                        method: "POST",[m
[32m+[m[32m                        headers: {[m
[32m+[m[32m                            "Content-Type": "application/json",[m
[32m+[m[32m                            Accept: "application/json",[m
[32m+[m[32m                            "X-CSRF-TOKEN": document[m
[32m+[m[32m                                .querySelector('meta[name="csrf-token"]')[m
[32m+[m[32m                                .getAttribute("content"),[m
[32m+[m[32m                        },[m
[32m+[m[32m                        credentials: "include",[m
[32m+[m[32m                        body: JSON.stringify(data),[m
[32m+[m[32m                    });[m
[32m+[m
[32m+[m[32m                    const result = await response.json();[m
[32m+[m
[32m+[m[32m                    if (response.ok) {[m
[32m+[m[32m                        MarketApp.methods.showToast(result.message || "Password changed successfully!", "success");[m
[32m+[m[32m                        form.reset();[m
[32m+[m[32m                    } else {[m
[32m+[m[32m                        const errorMsg = result.message || result.errors?.current_password?.[0] || result.errors?.password?.[0] || "Failed to change password";[m
[32m+[m[32m                        MarketApp.methods.showToast(errorMsg, "error");[m
[32m+[m[32m                    }[m
[32m+[m[32m                } catch (error) {[m
[32m+[m[32m                    console.error("Password change error:", error);[m
[32m+[m[32m                    MarketApp.methods.showToast("An error occurred. Please try again.", "error");[m
[32m+[m[32m                } finally {[m
[32m+[m[32m                    btn.disabled = false;[m
[32m+[m[32m                    btn.innerHTML = originalText;[m
[32m+[m[32m                }[m
[32m+[m[32m            });[m
[32m+[m[32m        },[m
[32m+[m
[32m+[m[32m        setupProfilePictureUpload() {[m
[32m+[m[32m            const input = document.getElementById("profilePictureInput");[m
[32m+[m[32m            const removeBtn = document.getElementById("removeProfilePictureBtn");[m
[32m+[m[32m            if (!input) return;[m
[32m+[m
[32m+[m[32m            input.addEventListener("change", async (e) => {[m
[32m+[m[32m                const file = e.target.files[0];[m
[32m+[m[32m                if (!file) return;[m
[32m+[m
[32m+[m[32m                // Validate file size (2MB max)[m
[32m+[m[32m                if (file.size > 2 * 1024 * 1024) {[m
[32m+[m[32m                    MarketApp.methods.showToast("Image must be smaller than 2MB", "error");[m
[32m+[m[32m                    return;[m
[32m+[m[32m                }[m
[32m+[m
[32m+[m[32m                // Validate file type[m
[32m+[m[32m                if (!file.type.match(/^image\/(jpeg|jpg|png|gif)$/)) {[m
[32m+[m[32m                    MarketApp.methods.showToast("Please select a valid image file (JPEG, PNG, or GIF)", "error");[m
[32m+[m[32m                    return;[m
[32m+[m[32m                }[m
[32m+[m
[32m+[m[32m                const formData = new FormData();[m
[32m+[m[32m                formData.append("profile_picture", file);[m
[32m+[m
[32m+[m[32m                const container = document.getElementById("profilePictureContainer");[m
[32m+[m[32m                const placeholder = document.getElementById("profilePicturePlaceholder");[m
[32m+[m[32m                const img = document.getElementById("profilePictureImg");[m
[32m+[m
[32m+[m[32m                // Show preview[m
[32m+[m[32m                const reader = new FileReader();[m
[32m+[m[32m                reader.onload = (e) => {[m
[32m+[m[32m                    if (img) {[m
[32m+[m[32m                        img.src = e.target.result;[m
[32m+[m[32m                        img.classList.remove("hidden");[m
[32m+[m[32m                        if (placeholder) placeholder.classList.add("hidden");[m
[32m+[m[32m                    } else {[m
[32m+[m[32m                        const newImg = document.createElement("img");[m
[32m+[m[32m                        newImg.id = "profilePictureImg";[m
[32m+[m[32m                        newImg.src = e.target.result;[m
[32m+[m[32m                        newImg.alt = "Profile Picture";[m
[32m+[m[32m                        newImg.className = "w-full h-full object-cover";[m
[32m+[m[32m                        container.innerHTML = "";[m
[32m+[m[32m                        container.appendChild(newImg);[m
[32m+[m[32m                    }[m
[32m+[m[32m                    if (removeBtn) removeBtn.classList.remove("hidden");[m
[32m+[m[32m                };[m
[32m+[m[32m                reader.readAsDataURL(file);[m
[32m+[m
[32m+[m[32m                try {[m
[32m+[m[32m                    const response = await fetch("/api/user-settings/upload-profile-picture", {[m
[32m+[m[32m                        method: "POST",[m
[32m+[m[32m                        headers: {[m
[32m+[m[32m                            "X-CSRF-TOKEN": document[m
[32m+[m[32m                                .querySelector('meta[name="csrf-token"]')[m
[32m+[m[32m                                .getAttribute("content"),[m
[32m+[m[32m                        },[m
[32m+[m[32m                        credentials: "include",[m
[32m+[m[32m                        body: formData,[m
[32m+[m[32m                    });[m
[32m+[m
[32m+[m[32m                    const result = await response.json();[m
[32m+[m
[32m+[m[32m                    if (response.ok) {[m
[32m+[m[32m                        MarketApp.methods.showToast(result.message || "Profile picture uploaded successfully!", "success");[m
[32m+[m[32m                        // Update image source to the server URL[m
[32m+[m[32m                        if (result.profile_picture_url) {[m
[32m+[m[32m                            console.log('Profile picture URL received:', result.profile_picture_url);[m
[32m+[m[32m                            // Get or create the image element[m
[32m+[m[32m                            let profileImg = document.getElementById("profilePictureImg");[m
[32m+[m[32m                            const container = document.getElementById("profilePictureContainer");[m
[32m+[m[32m                            const placeholder = document.getElementById("profilePicturePlaceholder");[m
[32m+[m[41m                            [m
[32m+[m[32m                            console.log('Profile image element exists:', !!profileImg);[m
[32m+[m[32m                            console.log('Container exists:', !!container);[m
[32m+[m[32m                            console.log('Placeholder exists:', !!placeholder);[m
[32m+[m[41m                            [m
[32m+[m[32m                            if (!profileImg) {[m
[32m+[m[32m                                // Create image element if it doesn't exist (when placeholder was showing)[m
[32m+[m[32m                                profileImg = document.createElement("img");[m
[32m+[m[32m                                profileImg.id = "profilePictureImg";[m
[32m+[m[32m                                profileImg.alt = "Profile Picture";[m
[32m+[m[32m                                profileImg.className = "w-full h-full object-cover";[m
[32m+[m[32m                                if (container) {[m
[32m+[m[32m                                    // Remove placeholder if it exists[m
[32m+[m[32m                                    if (placeholder && placeholder.parentNode === container) {[m
[32m+[m[32m                                        container.removeChild(placeholder);[m
[32m+[m[32m                                    }[m
[32m+[m[32m                                    container.appendChild(profileImg);[m
[32m+[m[32m                                }[m
[32m+[m[32m                            }[m
[32m+[m[41m                            [m
[32m+[m[32m                            // Update image source with cache busting to force reload[m
[32m+[m[32m                            const imageUrl = result.profile_picture_url + (result.profile_picture_url.includes('?') ? '&' : '?') + 't=' + Date.now();[m
[32m+[m[41m                            [m
[32m+[m[32m                            // Set up error handler before changing src[m
[32m+[m[32m                            profileImg.onerror = function() {[m
[32m+[m[32m                                console.error('Failed to load profile picture:', imageUrl);[m
[32m+[m[32m                                console.error('Original URL:', result.profile_picture_url);[m
[32m+[m[32m                                // Try without cache busting[m
[32m+[m[32m                                profileImg.src = result.profile_picture_url;[m
[32m+[m[41m                                [m
[32m+[m[32m                                // If still fails, show helpful message[m
[32m+[m[32m                                profileImg.onerror = function() {[m
[32m+[m[32m                                    console.error('Profile picture failed to load. Storage link may be missing.');[m
[32m+[m[32m                                    MarketApp.methods.showToast([m
[32m+[m[32m                                        'Image uploaded but cannot display. Please ensure storage link is created (run: php artisan storage:link)',[m
[32m+[m[32m                                        'error'[m
[32m+[m[32m                                    );[m
[32m+[m[32m                                };[m
[32m+[m[32m                            };[m
[32m+[m[41m                            [m
[32m+[m[32m                            // Update the image source[m
[32m+[m[32m                            profileImg.src = imageUrl;[m
[32m+[m[32m                            profileImg.classList.remove("hidden");[m
[32m+[m[41m                            [m
[32m+[m[32m                            // Hide placeholder if it still exists[m
[32m+[m[32m                            if (placeholder && placeholder.parentNode) {[m
[32m+[m[32m                                placeholder.classList.add("hidden");[m
[32m+[m[32m                            }[m
[32m+[m[41m                            [m
[32m+[m[32m                            // Show remove button[m
[32m+[m[32m                            if (removeBtn) removeBtn.classList.remove("hidden");[m
[32m+[m[32m                        }[m
[32m+[m[32m                        // Update sidebar profile picture[m
[32m+[m[32m                        const sidebarImg = document.getElementById('sidebarProfilePicture');[m
[32m+[m[32m                        const sidebarIcon = document.getElementById('sidebarProfileIcon');[m
[32m+[m[32m                        if (sidebarImg && result.profile_picture_url) {[m
[32m+[m[32m                            const sidebarImageUrl = result.profile_picture_url + (result.profile_picture_url.includes('?') ? '&' : '?') + 't=' + Date.now();[m
[32m+[m[32m                            sidebarImg.src = sidebarImageUrl;[m
[32m+[m[32m                            sidebarImg.classList.remove('hidden');[m
[32m+[m[32m                            if (sidebarIcon) sidebarIcon.classList.add('hidden');[m
[32m+[m[41m                            [m
[32m+[m[32m                            // Handle sidebar image load error[m
[32m+[m[32m                            sidebarImg.onerror = function() {[m
[32m+[m[32m                                console.error('Failed to load sidebar profile picture');[m
[32m+[m[32m                                sidebarImg.src = result.profile_picture_url; // Try without cache busting[m
[32m+[m[32m                            };[m
[32m+[m[32m                        }[m
[32m+[m[32m                    } else {[m
[32m+[m[32m                        MarketApp.methods.showToast(result.message || "Failed to upload profile picture", "error");[m
[32m+[m[32m                        // Revert preview on error[m
[32m+[m[32m                        if (img) img.classList.add("hidden");[m
[32m+[m[32m                        if (placeholder) placeholder.classList.remove("hidden");[m
[32m+[m[32m                    }[m
[32m+[m[32m                } catch (error) {[m
[32m+[m[32m                    console.error("Profile picture upload error:", error);[m
[32m+[m[32m                    MarketApp.methods.showToast("An error occurred. Please try again.", "error");[m
[32m+[m[32m                    // Revert preview on error[m
[32m+[m[32m                    if (img) img.classList.add("hidden");[m
[32m+[m[32m                    if (placeholder) placeholder.classList.remove("hidden");[m
[32m+[m[32m                } finally {[m
[32m+[m[32m                    // Reset input[m
[32m+[m[32m                    input.value = "";[m
[32m+[m[32m                }[m
[32m+[m[32m            });[m
[32m+[m
[32m+[m[32m            if (removeBtn) {[m
[32m+[m[32m                removeBtn.addEventListener("click", async () => {[m
[32m+[m[32m                    if (!confirm("Are you sure you want to remove your profile picture?")) return;[m
[32m+[m
[32m+[m[32m                    try {[m
[32m+[m[32m                        const response = await fetch("/api/user-settings/remove-profile-picture", {[m
[32m+[m[32m                            method: "DELETE",[m
[32m+[m[32m                            headers: {[m
[32m+[m[32m                                "X-CSRF-TOKEN": document[m
[32m+[m[32m                                    .querySelector('meta[name="csrf-token"]')[m
[32m+[m[32m                                    .getAttribute("content"),[m
[32m+[m[32m                            },[m
[32m+[m[32m                            credentials: "include",[m
[32m+[m[32m                        });[m
[32m+[m
[32m+[m[32m                        const result = await response.json();[m
[32m+[m
[32m+[m[32m                        if (response.ok) {[m
[32m+[m[32m                            MarketApp.methods.showToast(result.message || "Profile picture removed successfully!", "success");[m
[32m+[m[32m                            const img = document.getElementById("profilePictureImg");[m
[32m+[m[32m                            const placeholder = document.getElementById("profilePicturePlaceholder");[m
[32m+[m[32m                            if (img) img.classList.add("hidden");[m
[32m+[m[32m                            if (placeholder) placeholder.classList.remove("hidden");[m
[32m+[m[32m                            removeBtn.classList.add("hidden");[m
[32m+[m[32m                            // Update sidebar[m
[32m+[m[32m                            const sidebarImg = document.getElementById('sidebarProfilePicture');[m
[32m+[m[32m                            const sidebarIcon = document.getElementById('sidebarProfileIcon');[m
[32m+[m[32m                            if (sidebarImg) sidebarImg.classList.add('hidden');[m
[32m+[m[32m                            if (sidebarIcon) sidebarIcon.classList.remove('hidden');[m
[32m+[m[32m                        } else {[m
[32m+[m[32m                            MarketApp.methods.showToast(result.message || "Failed to remove profile picture", "error");[m
[32m+[m[32m                        }[m
[32m+[m[32m                    } catch (error) {[m
[32m+[m[32m                        console.error("Remove profile picture error:", error);[m
[32m+[m[32m                        MarketApp.methods.showToast("An error occurred. Please try again.", "error");[m
[32m+[m[32m                    }[m
[32m+[m[32m                });[m
[32m+[m[32m            }[m
[32m+[m[32m        },[m
[32m+[m
         toggleModal: function (modalId, show) {[m
             const modal = document.getElementById(modalId);[m
             const content = document.getElementById(`${modalId}Content`);[m
[36m@@ -662,7 +1312,7 @@[m [mconst MarketApp = {[m
             const query = new URLSearchParams({ year, month, search });[m
             const url = `/api/staff/vendors/${vendor.id}/payment-history-filtered?${query}`;[m
 [m
[31m-            tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-indigo-500"></i></td></tr>`;[m
[32m+[m[32m            tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-indigo-500"></i></td></tr>`;[m
             noResultsEl.classList.add("hidden");[m
 [m
             try {[m
[36m@@ -671,9 +1321,12 @@[m [mconst MarketApp = {[m
                     throw new Error("Failed to fetch payment history");[m
                 }[m
 [m
[31m-                const payments = await response.json();[m
[32m+[m[32m                const responseData = await response.json();[m
[32m+[m[41m                [m
[32m+[m[32m                // Handle paginated response[m
[32m+[m[32m                const payments = responseData.data || responseData;[m
 [m
[31m-                if (payments.length === 0) {[m
[32m+[m[32m                if (!payments || payments.length === 0) {[m
                     tableBody.innerHTML = "";[m
                     noResultsEl.classList.remove("hidden");[m
                     return;[m
[36m@@ -712,18 +1365,12 @@[m [mconst MarketApp = {[m
                                 bill.period_start,[m
                                 bill.period_end[m
                             )}</td>[m
[31m-                        <td data-label="Amount Due" class="px-4 py-2 text-center">â‚±${parseFloat([m
[32m+[m[32m                        <td data-label="Bill Amount" class="px-4 py-2 text-center">â‚±${parseFloat([m
                                 bill.payment.amount_paid[m
                             ).toFixed(2)}</td>[m
                         <td data-label="Due Date" class="px-4 py-2 text-center">${formatShortDate([m
                                 bill.due_date[m
                             )}</td>[m
[31m-                        <td data-label="Amount After Due" class="px-4 py-2 text-center">â‚±${parseFloat([m
[31m-                                bill.amount_after_due[m
[31m-                            ).toFixed(2)}</td>[m
[31m-                        <td data-label="Disconnection Date" class="px-4 py-2 text-center">${formatShortDate([m
[31m-                                bill.disconnection_date[m
[31m-                            )}</td>[m
                         <td data-label="Payment Status" class="px-4 py-2 text-center">[m
                             <span class="whitespace-nowrap px-4 py-1.5 text-xs font-semibold text-white bg-gray-800 rounded-full">[m
                                 Paid on ${formatStatusDate([m
[36m@@ -737,7 +1384,7 @@[m [mconst MarketApp = {[m
                     .join("");[m
             } catch (error) {[m
                 console.error("Failed to fetch payment history:", error);[m
[31m-                tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-8 text-red-500">Error loading data.</td></tr>`;[m
[32m+[m[32m                tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-red-500">Error loading data.</td></tr>`;[m
                 MarketApp.methods.showToast([m
                     "Failed to load payment history.",[m
                     "error"[m
[36m@@ -1207,27 +1854,64 @@[m [mconst MarketApp = {[m
                                 const daysInMonth = new Date([m
                                     bill.period_end[m
                                 ).getDate();[m
[31m-                                const waterRate = 5.0;[m
[31m-                                const calculatedAmount =[m
[31m-                                    waterRate * daysInMonth;[m
[32m+[m[32m                                // Get rate from database, or calculate backwards from stored amount[m
[32m+[m[32m                                let waterRate = window.UTILITY_RATES?.Water?.rate || 0;[m
[32m+[m[32m                                if (waterRate === 0 && originalAmount > 0 && daysInMonth > 0) {[m
[32m+[m[32m                                    // Calculate rate backwards from stored amount[m
[32m+[m[32m                                    waterRate = originalAmount / daysInMonth;[m
[32m+[m[32m                                }[m
[32m+[m[32m                                const calculatedAmount = waterRate * daysInMonth;[m
                                 baseAmountForCalc = calculatedAmount;[m
[32m+[m[32m                                // Always display as formula: rate x days = amount[m
                                 detailsHtml = `${formatCurrency([m
                                     waterRate[m
                                 )} x ${daysInMonth} days = <strong>${formatCurrency([m
                                     calculatedAmount[m
                                 )}</strong>`;[m
[31m-                            } else if ([m
[31m-                                bill.utility_type === "Electricity" &&[m
[31m-                                bill.consumption[m
[31m-                            ) {[m
[31m-                                const consumption =[m
[31m-                                    parseFloat(bill.consumption) || 0;[m
[32m+[m[32m                            } else if (bill.utility_type === "Electricity") {[m
[32m+[m[32m                                // Priority 1: Use bill.consumption if available (most accurate)[m
[32m+[m[32m                                // Priority 2: Calculate from current_reading - previous_reading[m
[32m+[m[32m                                // Priority 3: Only calculate backwards if both are missing[m
[32m+[m[32m                                let consumption = null;[m
[32m+[m[32m                                if (bill.consumption !== null && bill.consumption !== undefined && !isNaN(parseFloat(bill.consumption))) {[m
[32m+[m[32m                                    consumption = parseFloat(bill.consumption);[m
[32m+[m[32m                                } else if (bill.current_reading !== null && bill.previous_reading !== null) {[m
[32m+[m[32m                                    consumption = (parseFloat(bill.current_reading) || 0) - (parseFloat(bill.previous_reading) || 0);[m
[32m+[m[32m                                } else {[m
[32m+[m[32m                                    consumption = 0;[m
[32m+[m[32m                                }[m
[32m+[m[41m                                [m
[32m+[m[32m                                // Get rate: Priority 1: bill.rate, Priority 2: database rate[m
[32m+[m[32m                                let electricityRate = bill.rate || window.UTILITY_RATES?.Electricity?.rate || 0;[m
[32m+[m[41m                                [m
[32m+[m[32m                                // Only calculate backwards if we're missing actual data[m
[32m+[m[32m                                if (consumption === 0 && originalAmount > 0) {[m
[32m+[m[32m                                    // If we have a rate, calculate consumption from amount[m
[32m+[m[32m                                    if (electricityRate > 0) {[m
[32m+[m[32m                                        consumption = originalAmount / electricityRate;[m
[32m+[m[32m                                    } else {[m
[32m+[m[32m                                        // If no rate, try to get it from database[m
[32m+[m[32m                                        electricityRate = window.UTILITY_RATES?.Electricity?.rate || 0;[m
[32m+[m[32m                                        if (electricityRate > 0) {[m
[32m+[m[32m                                            consumption = originalAmount / electricityRate;[m
[32m+[m[32m                                        }[m
[32m+[m[32m                                    }[m
[32m+[m[32m                                } else if (electricityRate === 0 && originalAmount > 0 && consumption > 0) {[m
[32m+[m[32m                                    // If we have consumption but no rate, calculate rate from amount[m
[32m+[m[32m                                    electricityRate = originalAmount / consumption;[m
[32m+[m[32m                                }[m
[32m+[m[41m                                [m
[32m+[m[32m                                // Calculate amount from consumption Ã— rate[m
[32m+[m[32m                                const calculatedAmount = consumption * electricityRate;[m
[32m+[m[32m                                baseAmountForCalc = calculatedAmount > 0 ? calculatedAmount : originalAmount;[m
[32m+[m[41m                                [m
[32m+[m[32m                                // Always display as formula: (consumption kWh) x rate = amount[m
                                 detailsHtml = `(${consumption.toFixed([m
                                     2[m
                                 )} kWh) x ${formatCurrency([m
[31m-                                    bill.rate || 0[m
[32m+[m[32m                                    electricityRate[m
                                 )} = <strong>${formatCurrency([m
[31m-                                    originalAmount[m
[32m+[m[32m                                    calculatedAmount > 0 ? calculatedAmount : originalAmount[m
                                 )}</strong>`;[m
                             }[m
 [m
[36m@@ -1478,7 +2162,12 @@[m [mconst MarketApp = {[m
             }[m
 [m
             dailyCollectionsTableBody.innerHTML = "";[m
[31m-            const collections = MarketApp.state.dailyCollections;[m
[32m+[m[32m            // Sort collections alphabetically by stall/table number[m
[32m+[m[32m            const collections = [...MarketApp.state.dailyCollections].sort((a, b) => {[m
[32m+[m[32m                const stallA = (a.stallNumber || '').toString().toUpperCase();[m
[32m+[m[32m                const stallB = (b.stallNumber || '').toString().toUpperCase();[m
[32m+[m[32m                return stallA.localeCompare(stallB, undefined, { numeric: true, sensitivity: 'base' });[m
[32m+[m[32m            });[m
             const selected = MarketApp.state.selectedCollections;[m
 [m
             if (collections.length > 0) {[m
[36m@@ -1547,19 +2236,25 @@[m [mconst MarketApp = {[m
                 return;[m
             }[m
 [m
[31m-            // Load profile picture if available[m
[31m-            const profilePicturePreview = document.getElementById("profilePicturePreview");[m
[31m-            const profilePictureIcon = document.getElementById("profilePictureIcon");[m
[31m-[m
[31m-            if (profilePicturePreview && profilePictureIcon) {[m
[31m-                if (vendor.profile_picture_url) {[m
[31m-                    profilePicturePreview.src = vendor.profile_picture_url;[m
[31m-                    profilePicturePreview.classList.remove("hidden");[m
[31m-                    profilePictureIcon.classList.add("hidden");[m
[31m-                } else {[m
[31m-                    profilePicturePreview.src = "";[m
[31m-                    profilePicturePreview.classList.add("hidden");[m
[31m-                    profilePictureIcon.classList.remove("hidden");[m
[32m+[m[32m            // Update profile picture[m
[32m+[m[32m            const profilePicturePreview = document.getElementById('profilePicturePreview');[m
[32m+[m[32m            const profilePictureIcon = document.getElementById('profilePictureIcon');[m
[32m+[m[41m            [m
[32m+[m[32m            if (vendor.profile_picture) {[m
[32m+[m[32m                if (profilePicturePreview) {[m
[32m+[m[32m                    profilePicturePreview.src = vendor.profile_picture;[m
[32m+[m[32m                    profilePicturePreview.classList.remove('hidden');[m
[32m+[m[32m                }[m
[32m+[m[32m                if (profilePictureIcon) {[m
[32m+[m[32m                    profilePictureIcon.classList.add('hidden');[m
[32m+[m[32m                }[m
[32m+[m[32m            } else {[m
[32m+[m[32m                if (profilePicturePreview) {[m
[32m+[m[32m                    profilePicturePreview.classList.add('hidden');[m
[32m+[m[32m                    profilePicturePreview.src = '';[m
[32m+[m[32m                }[m
[32m+[m[32m                if (profilePictureIcon) {[m
[32m+[m[32m                    profilePictureIcon.classList.remove('hidden');[m
                 }[m
             }[m
 [m
[36m@@ -1588,6 +2283,106 @@[m [mconst MarketApp = {[m
                         span.textContent = "N/A";[m
                     }[m
                 });[m
[32m+[m
[32m+[m[32m            // Setup vendor profile picture upload handler[m
[32m+[m[32m            this.setupVendorProfilePictureUpload(vendor.id);[m
[32m+[m[32m        },[m
[32m+[m
[32m+[m[32m        setupVendorProfilePictureUpload(vendorId) {[m
[32m+[m[32m            const input = document.getElementById("profilePictureInput");[m
[32m+[m[32m            if (!input) return;[m
[32m+[m
[32m+[m[32m            // Remove existing listeners by cloning the element[m
[32m+[m[32m            const newInput = input.cloneNode(true);[m
[32m+[m[32m            input.parentNode.replaceChild(newInput, input);[m
[32m+[m
[32m+[m[32m            newInput.addEventListener("change", async (e) => {[m
[32m+[m[32m                const file = e.target.files[0];[m
[32m+[m[32m                if (!file) return;[m
[32m+[m
[32m+[m[32m                // Validate file size (2MB max)[m
[32m+[m[32m                if (file.size > 2 * 1024 * 1024) {[m
[32m+[m[32m                    MarketApp.methods.showToast("Image must be smaller than 2MB", "error");[m
[32m+[m[32m                    return;[m
[32m+[m[32m                }[m
[32m+[m
[32m+[m[32m                // Validate file type[m
[32m+[m[32m                if (!file.type.match(/^image\/(jpeg|jpg|png|gif)$/)) {[m
[32m+[m[32m                    MarketApp.methods.showToast("Please select a valid image file (JPEG, PNG, or GIF)", "error");[m
[32m+[m[32m                    return;[m
[32m+[m[32m                }[m
[32m+[m
[32m+[m[32m                const formData = new FormData();[m
[32m+[m[32m                formData.append("profile_picture", file);[m
[32m+[m
[32m+[m[32m                const profilePicturePreview = document.getElementById('profilePicturePreview');[m
[32m+[m[32m                const profilePictureIcon = document.getElementById('profilePictureIcon');[m
[32m+[m
[32m+[m[32m                // Show preview[m
[32m+[m[32m                const reader = new FileReader();[m
[32m+[m[32m                reader.onload = (e) => {[m
[32m+[m[32m                    if (profilePicturePreview) {[m
[32m+[m[32m                        profilePicturePreview.src = e.target.result;[m
[32m+[m[32m                        profilePicturePreview.classList.remove('hidden');[m
[32m+[m[32m                    }[m
[32m+[m[32m                    if (profilePictureIcon) {[m
[32m+[m[32m                        profilePictureIcon.classList.add('hidden');[m
[32m+[m[32m                    }[m
[32m+[m[32m                };[m
[32m+[m[32m                reader.readAsDataURL(file);[m
[32m+[m
[32m+[m[32m                try {[m
[32m+[m[32m                    const response = await fetch(`/api/staff/vendors/${vendorId}/upload-profile-picture`, {[m
[32m+[m[32m                        method: "POST",[m
[32m+[m[32m                        headers: {[m
[32m+[m[32m                            "X-CSRF-TOKEN": document[m
[32m+[m[32m                                .querySelector('meta[name="csrf-token"]')[m
[32m+[m[32m                                .getAttribute("content"),[m
[32m+[m[32m                        },[m
[32m+[m[32m                        credentials: "include",[m
[32m+[m[32m                        body: formData,[m
[32m+[m[32m                    });[m
[32m+[m
[32m+[m[32m                    const result = await response.json();[m
[32m+[m
[32m+[m[32m                    if (response.ok) {[m
[32m+[m[32m                        MarketApp.methods.showToast(result.message || "Vendor profile picture uploaded successfully!", "success");[m
[32m+[m[32m                        // Update image source to the server URL[m
[32m+[m[32m                        if (profilePicturePreview && result.profile_picture_url) {[m
[32m+[m[32m                            const imageUrl = result.profile_picture_url + (result.profile_picture_url.includes('?') ? '&' : '?') + 't=' + Date.now();[m
[32m+[m[32m                            profilePicturePreview.src = imageUrl;[m
[32m+[m[32m                            profilePicturePreview.classList.remove('hidden');[m
[32m+[m[32m                            if (profilePictureIcon) profilePictureIcon.classList.add('hidden');[m
[32m+[m[32m                        }[m
[32m+[m[32m                        // Update vendor data in state[m
[32m+[m[32m                        const vendor = MarketApp.getters.currentVendor(MarketApp.state);[m
[32m+[m[32m                        if (vendor) {[m
[32m+[m[32m                            vendor.profile_picture = result.profile_picture_url;[m
[32m+[m[32m                        }[m
[32m+[m[32m                    } else {[m
[32m+[m[32m                        MarketApp.methods.showToast(result.message || "Failed to upload vendor profile picture", "error");[m
[32m+[m[32m                        // Revert preview on error[m
[32m+[m[32m                        if (profilePicturePreview) {[m
[32m+[m[32m                            profilePicturePreview.classList.add('hidden');[m
[32m+[m[32m                            profilePicturePreview.src = '';[m
[32m+[m[32m                        }[m
[32m+[m[32m                        if (profilePictureIcon) profilePictureIcon.classList.remove('hidden');[m
[32m+[m[32m                    }[m
[32m+[m[32m                } catch (error) {[m
[32m+[m[32m                    console.error("Vendor profile picture upload error:", error);[m
[32m+[m[32m                    const errorMessage = error.message || "An error occurred. Please try again.";[m
[32m+[m[32m                    MarketApp.methods.showToast(errorMessage, "error");[m
[32m+[m[32m                    // Revert preview on error[m
[32m+[m[32m                    if (profilePicturePreview) {[m
[32m+[m[32m                        profilePicturePreview.classList.add('hidden');[m
[32m+[m[32m                        profilePicturePreview.src = '';[m
[32m+[m[32m                    }[m
[32m+[m[32m                    if (profilePictureIcon) profilePictureIcon.classList.remove('hidden');[m
[32m+[m[32m                } finally {[m
[32m+[m[32m                    // Reset input[m
[32m+[m[32m                    newInput.value = "";[m
[32m+[m[32m                }[m
[32m+[m[32m            });[m
         },[m
 [m
         populateSectionDropdown(sections) {[m
[36m@@ -1997,6 +2792,14 @@[m [mconst MarketApp = {[m
             ),[m
             stallSectionFilter: document.getElementById("stallSectionFilter"),[m
             assignStallBtn: document.getElementById("assignStallBtn"),[m
[32m+[m
[32m+[m[32m            //--Notifications--//[m
[32m+[m[32m            notificationsLoader: document.getElementById("notificationsLoader"),[m
[32m+[m[32m            notificationsList: document.getElementById("notificationsList"),[m
[32m+[m[32m            noNotificationsMessage: document.getElementById("noNotificationsMessage"),[m
[32m+[m[32m            markAllAsReadBtn: document.getElementById("markAllAsReadBtn"),[m
[32m+[m[32m            unreadCountBadge: document.getElementById("unreadCountBadge"),[m
[32m+[m[32m            unreadCountText: document.getElementById("unreadCountText"),[m
         };[m
     },[m
 [m
[36m@@ -2030,6 +2833,36 @@[m [mconst MarketApp = {[m
                 );[m
             }[m
         });[m
[32m+[m
[32m+[m[32m        // Notification bell click handler[m
[32m+[m[32m        document.addEventListener("click", (e) => {[m
[32m+[m[32m            const bellButton = e.target.closest(".notificationBell button");[m
[32m+[m[32m            if (bellButton) {[m
[32m+[m[32m                e.stopPropagation();[m
[32m+[m[32m                // Find the dropdown in the active section[m
[32m+[m[32m                const activeSection = document.querySelector(".dashboard-section.active");[m
[32m+[m[32m                if (activeSection) {[m
[32m+[m[32m                    const dropdown = activeSection.querySelector(".notificationDropdown");[m
[32m+[m[32m                    if (dropdown) {[m
[32m+[m[32m                        const isHidden = dropdown.classList.toggle("hidden");[m
[32m+[m[32m                        if (!isHidden && MarketApp.state.unreadCount > 0) {[m
[32m+[m[32m                            methods.markNotificationsAsRead();[m
[32m+[m[32m                        }[m
[32m+[m[32m                    }[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            // Close dropdown when clicking outside[m
[32m+[m[32m            const activeSection = document.querySelector(".dashboard-section.active");[m
[32m+[m[32m            if (activeSection) {[m
[32m+[m[32m                const dropdown = activeSection.querySelector(".notificationDropdown");[m
[32m+[m[32m                const bell = activeSection.querySelector(".notificationBell");[m
[32m+[m[32m                if (dropdown && !dropdown.classList.contains("hidden") && bell && !bell.contains(e.target)) {[m
[32m+[m[32m                    dropdown.classList.add("hidden");[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m[32m        });[m
[32m+[m
         elements.bulkPrintBtn?.addEventListener([m
             "click",[m
             methods.printBulkReceipts[m
[36m@@ -2093,62 +2926,6 @@[m [mconst MarketApp = {[m
             if (e.target === elements.editModal) methods.closeEditModal();[m
         });[m
 [m
[31m-        // Profile Picture Upload Handler[m
[31m-        const profilePictureInput = document.getElementById("profilePictureInput");[m
[31m-        profilePictureInput?.addEventListener("change", async (e) => {[m
[31m-            const file = e.target.files[0];[m
[31m-            if (!file) return;[m
[31m-[m
[31m-            const vendor = MarketApp.getters.currentVendor(MarketApp.state);[m
[31m-            if (!vendor) return;[m
[31m-[m
[31m-            // Show loading state on the image container[m
[31m-            const preview = document.getElementById("profilePicturePreview");[m
[31m-            const icon = document.getElementById("profilePictureIcon");[m
[31m-            const container = preview?.parentElement;[m
[31m-[m
[31m-            if (container) {[m
[31m-                container.innerHTML = `<div class="flex items-center justify-center w-full h-full">[m
[31m-                    <i class="fas fa-spinner fa-spin text-4xl text-indigo-500"></i>[m
[31m-                </div>`;[m
[31m-            }[m
[31m-[m
[31m-            const result = await MarketApp.database.uploadProfilePicture(vendor.id, file);[m
[31m-[m
[31m-            if (result.success) {[m
[31m-                // Update the preview with the new image[m
[31m-                if (container) {[m
[31m-                    container.innerHTML = `[m
[31m-                        <img id="profilePicturePreview" src="${result.profile_picture_url}" alt="Vendor's Profile Picture" class="w-full h-full object-cover">[m
[31m-                    `;[m
[31m-                }[m
[31m-                // Update the vendor data in state[m
[31m-                const vendorIndex = MarketApp.state.allVendors.findIndex(v => v.id === vendor.id);[m
[31m-                if (vendorIndex !== -1) {[m
[31m-                    MarketApp.state.allVendors[vendorIndex].profile_picture_url = result.profile_picture_url;[m
[31m-                }[m
[31m-                MarketApp.methods.showToast("Profile picture updated!", "success");[m
[31m-            } else {[m
[31m-                // Restore the original state[m
[31m-                if (container) {[m
[31m-                    if (vendor.profile_picture_url) {[m
[31m-                        container.innerHTML = `[m
[31m-                            <img id="profilePicturePreview" src="${vendor.profile_picture_url}" alt="Vendor's Profile Picture" class="w-full h-full object-cover">[m
[31m-                        `;[m
[31m-                    } else {[m
[31m-                        container.innerHTML = `[m
[31m-                            <img id="profilePicturePreview" src="" alt="Vendor's Profile Picture" class="w-full h-full object-cover hidden">[m
[31m-                            <i id="profilePictureIcon" class="fas fa-user text-6xl text-gray-400"></i>[m
[31m-                        `;[m
[31m-                    }[m
[31m-                }[m
[31m-                MarketApp.methods.showToast(`Failed: ${result.message}`, "error");[m
[31m-            }[m
[31m-[m
[31m-            // Clear the input so the same file can be selected again[m
[31m-            e.target.value = "";[m
[31m-        });[m
[31m-[m
         MarketApp.elements.outstandingBalanceLink?.addEventListener([m
             "click",[m
             (e) => {[m
[36m@@ -2250,16 +3027,51 @@[m [mconst MarketApp = {[m
         MarketApp.render.renderDailyCollectionsTable();[m
 [m
         try {[m
[32m+[m[32m            // Use initial state from server if available, otherwise fetch from API[m
[32m+[m[32m            const initialState = window.STAFF_PORTAL_STATE || {};[m
[32m+[m[32m            const initialVendors = initialState.vendors || [];[m
[32m+[m[32m            const initialSections = initialState.sections || [];[m
[32m+[m
             const [collections, vendors, sections] = await Promise.all([[m
                 MarketApp.database.fetchDailyCollections(),[m
[31m-                MarketApp.database.fetchVendors(),[m
[31m-                MarketApp.database.fetchSections(),[m
[32m+[m[32m                initialVendors.length > 0[m[41m [m
[32m+[m[32m                    ? Promise.resolve(initialVendors)[m[41m [m
[32m+[m[32m                    : MarketApp.database.fetchVendors(),[m
[32m+[m[32m                initialSections.length > 0[m[41m [m
[32m+[m[32m                    ? Promise.resolve(initialSections)[m[41m [m
[32m+[m[32m                    : MarketApp.database.fetchSections(),[m
             ]);[m
 [m
             MarketApp.state.dailyCollections = collections;[m
[31m-            MarketApp.state.allVendors = vendors;[m
[32m+[m[32m            MarketApp.state.allVendors = Array.isArray(vendors) ? vendors : (vendors.data || []);[m
             MarketApp.state.allMarketSections = sections;[m
             MarketApp.methods.setSectionFromHash();[m
[32m+[m[41m            [m
[32m+[m[32m            // Load announcements[m
[32m+[m[32m            // Announcements are now shown as notifications in the bell dropdown[m
[32m+[m[41m            [m
[32m+[m[32m            // Load notifications[m
[32m+[m[32m            await MarketApp.methods.fetchNotifications();[m
[32m+[m[41m            [m
[32m+[m[32m            // Setup announcement close button[m
[32m+[m[32m            // Announcement banner removed[m
[32m+[m[41m            [m
[32m+[m[32m            // Poll for notifications every 7 seconds[m
[32m+[m[32m            // Poll for notifications every 2 seconds for faster updates[m
[32m+[m[32m            setInterval(() => MarketApp.methods.fetchNotifications(), 2000);[m
[32m+[m[41m            [m
[32m+[m[32m            // Also fetch immediately when page becomes visible (user switches tabs/windows)[m
[32m+[m[32m            document.addEventListener('visibilitychange', () => {[m
[32m+[m[32m                if (!document.hidden) {[m
[32m+[m[32m                    MarketApp.methods.fetchNotifications();[m
[32m+[m[32m                }[m
[32m+[m[32m            });[m
[32m+[m[41m            [m
[32m+[m[32m            // Setup password change form[m
[32m+[m[32m            MarketApp.methods.setupPasswordChangeForm();[m
[32m+[m[41m            [m
[32m+[m[32m            // Setup profile picture upload[m
[32m+[m[32m            MarketApp.methods.setupProfilePictureUpload();[m
         } catch (error) {[m
             console.error("Failed to initialize the application:", error);[m
             MarketApp.methods.showToast([m
[1mdiff --git a/resources/js/superadmin.js b/resources/js/superadmin.js[m
[1mindex 925a27b..b256aa5 100644[m
[1m--- a/resources/js/superadmin.js[m
[1m+++ b/resources/js/superadmin.js[m
[36m@@ -15,10 +15,15 @@[m [mclass SuperAdminDashboard {[m
         this.userPollingInterval = null; // Property to hold the interval ID[m
         this.rentalRates = [];[m
         this.allRentalRates = window.INITIAL_STATE?.rentalRates?.data || [];[m
[31m-        this.utilityRates =[m
[31m-            window.INITIAL_STATE?.utilityRates?.data ||[m
[31m-            window.INITIAL_STATE?.utilityRates ||[m
[31m-            [];[m
[32m+[m[32m        // Ensure utilityRates is always an array[m
[32m+[m[32m        // The API returns an array directly, but check both .data and direct access[m
[32m+[m[32m        const utilityRatesData = window.INITIAL_STATE?.utilityRates?.data || window.INITIAL_STATE?.utilityRates;[m
[32m+[m[32m        this.utilityRates = Array.isArray(utilityRatesData)[m[41m [m
[32m+[m[32m            ? utilityRatesData[m[41m [m
[32m+[m[32m            : [];[m
[32m+[m[41m        [m
[32m+[m[32m        // Debug: Log initial utility rates[m
[32m+[m[32m        console.log('Initial Utility Rates:', this.utilityRates);[m
         this.utilityRateHistory =[m
             window.INITIAL_STATE?.utilityRateHistory?.data || [];[m
         this.currentSchedule = {[m
[36m@@ -67,9 +72,12 @@[m [mclass SuperAdminDashboard {[m
         this.userPollingInterval = null;[m
         this.rentalRates = []; // This gets populated by filterAndRenderRates[m
         this.rentalRatesPagination = {};[m
[31m-        this.utilityRateHistoryPage = 2; // Start at page 2 for infinite scroll[m
[32m+[m[32m        // Initialize pagination state for utility rate history[m
[32m+[m[32m        const utilityRateHistoryData = window.INITIAL_STATE?.utilityRateHistory?.data || window.INITIAL_STATE?.utilityRateHistory || [];[m
[32m+[m[32m        this.utilityRateHistoryPage = Array.isArray(utilityRateHistoryData) && utilityRateHistoryData.length > 0 ? 2 : 1; // Start at page 2 if we have initial data, otherwise page 1[m
         this.utilityRateHistoryHasMore =[m
[31m-            !!window.INITIAL_STATE?.utilityRateHistory?.next_page_url;[m
[32m+[m[32m            !!window.INITIAL_STATE?.utilityRateHistory?.next_page_url ||[m[41m [m
[32m+[m[32m            !!window.INITIAL_STATE?.utilityRateHistory?.has_more;[m
         this.isFetchingUtilityHistory = false;[m
         this.scheduleHistoryPage = 2;[m
         this.scheduleHistoryHasMore =[m
[36m@@ -82,6 +90,7 @@[m [mclass SuperAdminDashboard {[m
         this.billingDateHistoryHasMore =[m
             !!window.INITIAL_STATE?.billingDatesHistory?.next_page_url;[m
         this.isFetchingBillingHistory = false;[m
[32m+[m[32m        this.originalBillingDates = null; // Store original values when entering edit mode[m
         this.activeNotificationEditor = null;[m
         //properties for SMS Schedule history infinite scroll[m
         this.smsScheduleHistoryPage = 2;[m
[36m@@ -111,6 +120,11 @@[m [mclass SuperAdminDashboard {[m
         this.billingSettingsHistoryHasMore =[m
             !!window.INITIAL_STATE?.billingSettingsHistory?.next_page_url;[m
         this.isFetchingBillingSettingsHistory = false;[m
[32m+[m[32m        // Rental Rate History properties[m
[32m+[m[32m        this.rentalRateHistory = window.INITIAL_STATE?.rentalRateHistory?.data || [];[m
[32m+[m[32m        this.rentalRateHistoryPage = 1;[m
[32m+[m[32m        this.rentalRateHistoryHasMore = true;[m
[32m+[m[32m        this.isFetchingRentalRateHistory = false;[m
         this.dataLoaded = {[m
             marketStallRentalRatesSection: false,[m
             electricityWaterRatesSection: false,[m
[36m@@ -122,6 +136,7 @@[m [mclass SuperAdminDashboard {[m
             systemUserManagementSection: false,[m
             auditTrailsSection: false,[m
             discountsSurchargesPenaltySection: false,[m
[32m+[m[32m            profileSection: false,[m
         };[m
         this.listenersInitialized = {[m
             rentalRates: false,[m
[36m@@ -162,6 +177,9 @@[m [mclass SuperAdminDashboard {[m
             rentalRatesPagination: document.getElementById([m
                 "rentalRatesPagination"[m
             ),[m
[32m+[m[32m            rentalRateHistoryTableBody: document.getElementById("rentalRateHistoryTableBody"),[m
[32m+[m[32m            rentalRateHistoryLoader: document.getElementById("rentalRateHistoryLoader"),[m
[32m+[m[32m            rentalRateHistoryContainer: document.getElementById("rentalRateHistoryContainer"),[m
             sectionNavBtns: document.querySelectorAll(".section-nav-btn"),[m
 [m
             rentalRatesSearchInput: document.getElementById([m
[36m@@ -420,7 +438,12 @@[m [mclass SuperAdminDashboard {[m
             announcementContent: document.getElementById("announcementContent"),[m
             announcementIsActive: document.getElementById("announcementIsActive"),[m
             saveAnnouncementBtn: document.getElementById("saveAnnouncementBtn"),[m
[31m-            announcementsList: document.getElementById("announcementsList"),[m
[32m+[m[32m            sentAnnouncementsList: document.getElementById("sentAnnouncementsList"),[m
[32m+[m[32m            draftAnnouncementsList: document.getElementById("draftAnnouncementsList"),[m
[32m+[m
[32m+[m[32m            // Settings Elements[m
[32m+[m[32m            changePasswordForm: document.getElementById("changePasswordForm"),[m
[32m+[m[32m            changePasswordBtn: document.getElementById("changePasswordBtn"),[m
         };[m
     }[m
 [m
[36m@@ -519,14 +542,58 @@[m [mclass SuperAdminDashboard {[m
         );[m
 [m
         this.filterAndRenderRates();[m
[32m+[m[41m        [m
[32m+[m[32m        // Always render all data on page load (even if empty)[m
[32m+[m[32m        // They will show "No data found" or "Loading..." if empty, or display data if available[m
[32m+[m[41m        [m
[32m+[m[32m        // Utility Rates[m
         this.renderUtilityRatesTable();[m
         this.renderUtilityRateHistoryTable();[m
[32m+[m[41m        [m
[32m+[m[32m        // If utility rates are empty, fetch them[m
[32m+[m[32m        if (!this.utilityRates || this.utilityRates.length === 0) {[m
[32m+[m[32m            this.fetchUtilityRates();[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        // If utility rate history is empty, fetch it[m
[32m+[m[32m        if (!this.utilityRateHistory || this.utilityRateHistory.length === 0) {[m
[32m+[m[32m            this.utilityRateHistory = [];[m
[32m+[m[32m            this.utilityRateHistoryPage = 1;[m
[32m+[m[32m            this.utilityRateHistoryHasMore = true;[m
[32m+[m[32m            this.fetchUtilityRateHistory();[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        // Meter Reading Schedule[m
         this.renderMeterReadingSchedule();[m
         this.renderScheduleHistoryTable();[m
[32m+[m[41m        [m
[32m+[m[32m        // Billing Date Schedules[m
         this.renderBillingDateSchedules();[m
         this.renderBillingDateHistory();[m
[32m+[m[41m        [m
[32m+[m[32m        // If billing date schedules are empty, fetch them[m
[32m+[m[32m        if (!this.billingDateSchedules || this.billingDateSchedules.length === 0) {[m
[32m+[m[32m            this.fetchBillingDateSchedules();[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        // Billing Settings (Discounts, Surcharges, Penalty)[m
         this.renderBillingSettingsTables();[m
         this.renderBillingSettingsHistory();[m
[32m+[m[41m        [m
[32m+[m[32m        // If billing settings are empty, fetch them[m
[32m+[m[32m        if (!this.billingSettings || Object.keys(this.billingSettings).length === 0) {[m
[32m+[m[32m            this.fetchBillingSettings();[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        // Rental Rate History[m
[32m+[m[32m        this.renderRentalRateHistory();[m
[32m+[m[41m        [m
[32m+[m[32m        if (!this.rentalRateHistory || this.rentalRateHistory.length === 0) {[m
[32m+[m[32m            this.rentalRateHistory = [];[m
[32m+[m[32m            this.rentalRateHistoryPage = 1;[m
[32m+[m[32m            this.rentalRateHistoryHasMore = true;[m
[32m+[m[32m            this.fetchRentalRateHistory();[m
[32m+[m[32m        }[m
         this.renderNotificationTemplates();[m
         this.renderSmsSchedulesTable(); // New render call[m
         this.renderSmsScheduleHistory(); // New render call[m
[36m@@ -537,7 +604,15 @@[m [mclass SuperAdminDashboard {[m
         if (this.unreadNotificationCount > 0) {[m
             this.elements.notificationDot.classList.remove("hidden");[m
         }[m
[31m-        setInterval(this.fetchUnreadNotifications.bind(this), 7000);[m
[32m+[m[32m        // Poll for notifications every 2 seconds for faster updates[m
[32m+[m[32m        setInterval(this.fetchUnreadNotifications.bind(this), 2000);[m
[32m+[m[41m        [m
[32m+[m[32m        // Also fetch immediately when page becomes visible (user switches tabs/windows)[m
[32m+[m[32m        document.addEventListener('visibilitychange', () => {[m
[32m+[m[32m            if (!document.hidden) {[m
[32m+[m[32m                this.fetchUnreadNotifications();[m
[32m+[m[32m            }[m
[32m+[m[32m        });[m
 [m
         await this.fetchRoles();[m
 [m
[36m@@ -784,11 +859,18 @@[m [mclass SuperAdminDashboard {[m
             if (data.success) {[m
                 this.elements.semaphoreCreditBalance.textContent = data.credit_balance;[m
             } else {[m
[31m-                this.elements.semaphoreCreditBalance.textContent = "Error";[m
[32m+[m[32m                if (data.rate_limited) {[m
[32m+[m[32m                    this.elements.semaphoreCreditBalance.textContent = "Rate Limited";[m
[32m+[m[32m                    this.elements.semaphoreCreditBalance.title = "Too many requests. Please wait a few minutes before refreshing.";[m
[32m+[m[32m                } else {[m
[32m+[m[32m                    this.elements.semaphoreCreditBalance.textContent = "Error";[m
[32m+[m[32m                    this.elements.semaphoreCreditBalance.title = data.message || "Failed to fetch credits";[m
[32m+[m[32m                }[m
             }[m
         } catch (error) {[m
             console.error("Error fetching Semaphore credits:", error);[m
             this.elements.semaphoreCreditBalance.textContent = "Error";[m
[32m+[m[32m            this.elements.semaphoreCreditBalance.title = "Network error. Please try again later.";[m
         }[m
     }[m
 [m
[36m@@ -831,6 +913,7 @@[m [mclass SuperAdminDashboard {[m
                 break;[m
             case "announcementSection":[m
                 await this.fetchAnnouncements();[m
[32m+[m[32m                await this.loadAnnouncementRecipients();[m
                 break;[m
             // The 'notificationSection' still needs to fetch SMS settings dynamically[m
         }[m
[36m@@ -928,10 +1011,15 @@[m [mclass SuperAdminDashboard {[m
             const response = await fetch("/api/utility-rates");[m
             if (!response.ok) throw new Error("Network response was not ok");[m
 [m
[31m-            // This new code correctly handles a wrapped API response[m
[32m+[m[32m            // The API returns an array directly[m
             const responseData = await response.json();[m
[31m-            this.utilityRates = responseData.data || responseData;[m
[32m+[m[41m            [m
[32m+[m[32m            // Ensure utilityRates is always an array[m
[32m+[m[32m            this.utilityRates = Array.isArray(responseData)[m[41m [m
[32m+[m[32m                ? responseData[m[41m [m
[32m+[m[32m                : [];[m
 [m
[32m+[m[32m            console.log('Utility Rates loaded:', this.utilityRates);[m
             this.renderUtilityRatesTable();[m
         } catch (error) {[m
             console.error("Failed to fetch utility rates:", error);[m
[36m@@ -956,12 +1044,24 @@[m [mclass SuperAdminDashboard {[m
             if (!response.ok) throw new Error("Network response was not ok");[m
             const data = await response.json();[m
 [m
[31m-            this.utilityRateHistory.push(...data.data);[m
[31m-            this.utilityRateHistoryHasMore = data.next_page_url !== null;[m
[31m-            this.utilityRateHistoryPage++;[m
[32m+[m[32m            // Handle both paginated and non-paginated responses[m
[32m+[m[32m            const historyData = data.data || data;[m
[32m+[m[32m            const hasMore = data.has_more !== undefined ? data.has_more : (data.next_page_url !== null);[m
[32m+[m[41m            [m
[32m+[m[32m            if (historyData && Array.isArray(historyData) && historyData.length > 0) {[m
[32m+[m[32m                this.utilityRateHistory.push(...historyData);[m
[32m+[m[32m                this.utilityRateHistoryHasMore = hasMore;[m
[32m+[m[32m                this.utilityRateHistoryPage++;[m
[32m+[m[32m            } else {[m
[32m+[m[32m                // No more data[m
[32m+[m[32m                this.utilityRateHistoryHasMore = false;[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
             this.renderUtilityRateHistoryTable();[m
         } catch (error) {[m
[31m-            // ... error handling[m
[32m+[m[32m            console.error("Failed to fetch utility rate history:", error);[m
[32m+[m[32m            this.showToast("Failed to load utility rate history.", "error");[m
[32m+[m[32m            this.renderUtilityRateHistoryTable(); // Still render to show empty state[m
         } finally {[m
             this.isFetchingUtilityHistory = false;[m
             if (this.elements.utilityRateHistoryLoader)[m
[36m@@ -1110,7 +1210,7 @@[m [mclass SuperAdminDashboard {[m
                 if (this.activeNotificationEditor) {[m
                     this.insertPlaceholder([m
                         this.activeNotificationEditor,[m
[31m-                        button.textContent[m
[32m+[m[32m                        button.textContent.trim()[m
                     );[m
                 } else {[m
                     this.showToast("Please select a text area first.", "info");[m
[36m@@ -1118,6 +1218,35 @@[m [mclass SuperAdminDashboard {[m
             });[m
         });[m
 [m
[32m+[m[32m        // Add search functionality for placeholders[m
[32m+[m[32m        const placeholderSearch = document.getElementById("placeholderSearch");[m
[32m+[m[32m        if (placeholderSearch) {[m
[32m+[m[32m            placeholderSearch.addEventListener("input", (e) => {[m
[32m+[m[32m                const searchTerm = e.target.value.toLowerCase();[m
[32m+[m[32m                const categories = document.querySelectorAll(".placeholder-category");[m
[32m+[m[41m                [m
[32m+[m[32m                categories.forEach((category) => {[m
[32m+[m[32m                    const buttons = category.querySelectorAll(".placeholder-btn");[m
[32m+[m[32m                    const hasMatch = Array.from(buttons).some((btn) =>[m
[32m+[m[32m                        btn.textContent.toLowerCase().includes(searchTerm) ||[m
[32m+[m[32m                        btn.getAttribute("title")?.toLowerCase().includes(searchTerm)[m
[32m+[m[32m                    );[m
[32m+[m[41m                    [m
[32m+[m[32m                    if (hasMatch || !searchTerm) {[m
[32m+[m[32m                        category.style.display = "block";[m
[32m+[m[32m                        buttons.forEach((btn) => {[m
[32m+[m[32m                            const matches =[m[41m [m
[32m+[m[32m                                btn.textContent.toLowerCase().includes(searchTerm) ||[m
[32m+[m[32m                                btn.getAttribute("title")?.toLowerCase().includes(searchTerm);[m
[32m+[m[32m                            btn.style.display = matches || !searchTerm ? "inline-block" : "none";[m
[32m+[m[32m                        });[m
[32m+[m[32m                    } else {[m
[32m+[m[32m                        category.style.display = "none";[m
[32m+[m[32m                    }[m
[32m+[m[32m                });[m
[32m+[m[32m            });[m
[32m+[m[32m        }[m
[32m+[m
         // --- New SMS Schedule Listeners ---[m
         this.elements.editSmsSchedulesBtn.addEventListener("click", () =>[m
             this.toggleSmsSchedulesEditMode(true)[m
[36m@@ -1177,6 +1306,11 @@[m [mclass SuperAdminDashboard {[m
             overdue_items: "Rent, Electricity",[m
             new_total_due: "3850.00",[m
             timestamp: timestamp, // Add the timestamp here[m
[32m+[m[32m            bill_month: "September 2025",[m
[32m+[m[32m            rent_details: "Original: P1,250.00\nDiscounted: P1,200.00\nDue: September 15, 2025",[m
[32m+[m[32m            water_details: "Amount: P550.00\nDue: September 15, 2025",[m
[32m+[m[32m            electricity_details: "Calculation: (20.67 kWh) x P30.00 = P620.00\nAmount to Pay: P620.00\nDue: September 15, 2025\nDisconnection: September 25, 2025",[m
[32m+[m[32m            website_url: window.location.origin + "/vendor/home",[m
         };[m
 [m
         for (const [key, value] of Object.entries(data)) {[m
[36m@@ -1196,7 +1330,10 @@[m [mclass SuperAdminDashboard {[m
 [m
     insertPlaceholder(editorElement, placeholder) {[m
         editorElement.focus();[m
[31m-        document.execCommand("insertText", false, placeholder);[m
[32m+[m[32m        // Remove @ symbol if present (for display purposes) and ensure proper format[m
[32m+[m[32m        const cleanPlaceholder = placeholder.replace(/^@/, '').trim();[m
[32m+[m[32m        const formattedPlaceholder = `{{${cleanPlaceholder}}}`;[m
[32m+[m[32m        document.execCommand("insertText", false, formattedPlaceholder);[m
         this.updateCharacterCount(editorElement);[m
         this.updateLivePreview(editorElement);[m
     }[m
[36m@@ -1273,10 +1410,31 @@[m [mclass SuperAdminDashboard {[m
         const { smsScheduleTableBody } = this.elements;[m
         if (!smsScheduleTableBody) return;[m
 [m
[31m-        const scheduleTypes = [[m
[31m-            "SMS - Billing Statements",[m
[31m-            "SMS - Payment Reminders",[m
[31m-            "SMS - Overdue Alerts",[m
[32m+[m[32m        const scheduleConfigs = [[m
[32m+[m[32m            {[m
[32m+[m[32m                type: "SMS - Billing Statements",[m
[32m+[m[32m                label: "Billing Statements",[m
[32m+[m[32m                dayType: "month", // Day of month (1-31)[m
[32m+[m[32m                defaultDay: 1,[m
[32m+[m[32m                defaultDays: null,[m
[32m+[m[32m                helpText: "Day of month when billing statements are sent (1-31)"[m
[32m+[m[32m            },[m
[32m+[m[32m            {[m
[32m+[m[32m                type: "SMS - Payment Reminders",[m
[32m+[m[32m                label: "Payment Reminders",[m
[32m+[m[32m                dayType: "before", // Days before due date[m
[32m+[m[32m                defaultDay: null,[m
[32m+[m[32m                defaultDays: [7, 5, 3, 1],[m
[32m+[m[32m                helpText: "Days before due date to send reminders (e.g., 7 = 7 days before)"[m
[32m+[m[32m            },[m
[32m+[m[32m            {[m
[32m+[m[32m                type: "SMS - Overdue Alerts",[m
[32m+[m[32m                label: "Overdue Alerts",[m
[32m+[m[32m                dayType: "after", // Days after due date (overdue)[m
[32m+[m[32m                defaultDay: null,[m
[32m+[m[32m                defaultDays: [1, 3, 7, 14, 21, 30],[m
[32m+[m[32m                helpText: "Days after due date to send alerts (e.g., 1 = 1 day overdue)"[m
[32m+[m[32m            }[m
         ];[m
 [m
         const formatTime12hr = (timeString) => {[m
[36m@@ -1288,22 +1446,87 @@[m [mclass SuperAdminDashboard {[m
             return `${String(h12).padStart(2, "0")}:${minutes} ${suffix}`;[m
         };[m
 [m
[31m-        smsScheduleTableBody.innerHTML = scheduleTypes[m
[31m-            .map((type) => {[m
[32m+[m[32m        smsScheduleTableBody.innerHTML = scheduleConfigs[m
[32m+[m[32m            .map((config) => {[m
                 const schedule = this.smsSchedules.find([m
[31m-                    (s) => s.schedule_type === type[m
[32m+[m[32m                    (s) => s.schedule_type === config.type[m
                 );[m
[31m-                const currentTime = schedule ? schedule.description : "00:00";[m
[32m+[m[32m                const currentTime = schedule ? schedule.description : "08:00";[m
[32m+[m[32m                const currentDay = schedule ? (schedule.schedule_day ?? config.defaultDay) : config.defaultDay;[m
[32m+[m[32m                const currentDays = schedule && schedule.sms_days[m[41m [m
[32m+[m[32m                    ? (Array.isArray(schedule.sms_days) ? schedule.sms_days : [])[m
[32m+[m[32m                    : (config.defaultDays || []);[m
[32m+[m
[32m+[m[32m                let daysDisplay = "";[m
[32m+[m[32m                if (isEditing) {[m
[32m+[m[32m                    if (config.dayType === "month") {[m
[32m+[m[32m                        // Billing Statements: Single day of month selector[m
[32m+[m[32m                        daysDisplay = `[m
[32m+[m[32m                            <select class="sms-schedule-day-input w-full border border-gray-300 rounded-lg px-3 py-2" data-type="${config.type}">[m
[32m+[m[32m                                ${Array.from({ length: 31 }, (_, i) => i + 1).map(day =>[m[41m [m
[32m+[m[32m                                    `<option value="${day}" ${currentDay === day ? "selected" : ""}>${day}${day === 1 ? "st" : day === 2 ? "nd" : day === 3 ? "rd" : "th"}</option>`[m
[32m+[m[32m                                ).join("")}[m
[32m+[m[32m                            </select>[m
[32m+[m[32m                            <p class="text-xs text-gray-500 mt-1">${config.helpText}</p>[m
[32m+[m[32m                        `;[m
[32m+[m[32m                    } else {[m
[32m+[m[32m                        // Payment Reminders and Overdue Alerts: Multiple days with add/remove[m
[32m+[m[32m                        const daysList = currentDays.length > 0 ? currentDays : [];[m
[32m+[m[32m                        const sortedDays = [...daysList].sort((a, b) => a - b);[m
[32m+[m[41m                        [m
[32m+[m[32m                        daysDisplay = `[m
[32m+[m[32m                            <div class="sms-days-container" data-type="${config.type}">[m
[32m+[m[32m                                <div class="flex flex-wrap gap-2 mb-2">[m
[32m+[m[32m                                    ${sortedDays.map((day, index) => `[m
[32m+[m[32m                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800">[m
[32m+[m[32m                                            ${day} ${config.dayType === "before" ? "days before" : "days overdue"}[m
[32m+[m[32m                                            <button type="button" class="ml-2 text-indigo-600 hover:text-indigo-800 remove-day-btn" data-type="${config.type}" data-day="${day}" data-index="${index}">[m
[32m+[m[32m                                                <i class="fas fa-times"></i>[m
[32m+[m[32m                                            </button>[m
[32m+[m[32m                                        </span>[m
[32m+[m[32m                                    `).join("")}[m
[32m+[m[32m                                </div>[m
[32m+[m[32m                                <div class="flex gap-2">[m
[32m+[m[32m                                    <input type="number"[m[41m [m
[32m+[m[32m                                           class="add-day-input w-24 border border-gray-300 rounded-lg px-2 py-1 text-sm"[m[41m [m
[32m+[m[32m                                           data-type="${config.type}"[m
[32m+[m[32m                                           placeholder="Add day"[m
[32m+[m[32m                                           min="0"[m
[32m+[m[32m                                           max="365">[m
[32m+[m[32m                                    <button type="button"[m[41m [m
[32m+[m[32m                                            class="add-day-btn bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 rounded-lg text-sm transition-smooth"[m
[32m+[m[32m                                            data-type="${config.type}">[m
[32m+[m[32m                                        <i class="fas fa-plus text-xs"></i> Add[m
[32m+[m[32m                                    </button>[m
[32m+[m[32m                                </div>[m
[32m+[m[32m                                <p class="text-xs text-gray-500 mt-1">${config.helpText}</p>[m
[32m+[m[32m                            </div>[m
[32m+[m[32m                        `;[m
[32m+[m[32m                    }[m
[32m+[m[32m                } else {[m
[32m+[m[32m                    // Display mode[m
[32m+[m[32m                    if (config.dayType === "month") {[m
[32m+[m[32m                        const daySuffix = currentDay === 1 ? "st" : currentDay === 2 ? "nd" : currentDay === 3 ? "rd" : "th";[m
[32m+[m[32m                        daysDisplay = `<span>${currentDay || config.defaultDay}${daySuffix} of month</span>`;[m
[32m+[m[32m                    } else {[m
[32m+[m[32m                        if (currentDays.length > 0) {[m
[32m+[m[32m                            const sortedDays = [...currentDays].sort((a, b) => a - b);[m
[32m+[m[32m                            daysDisplay = `<span>${sortedDays.join(", ")} ${config.dayType === "before" ? "days before" : "days overdue"}</span>`;[m
[32m+[m[32m                        } else {[m
[32m+[m[32m                            daysDisplay = `<span class="text-gray-400">Not Set</span>`;[m
[32m+[m[32m                        }[m
[32m+[m[32m                    }[m
[32m+[m[32m                }[m
 [m
                 return `[m
                 <tr class="hover:bg-gray-50 transition-colors">[m
[31m-                    <td data-label="Notification Type" class="border border-gray-200 px-4 py-3 text-gray-700 font-medium">${type.replace([m
[31m-                    "SMS - ",[m
[31m-                    ""[m
[31m-                )}</td>[m
[32m+[m[32m                    <td data-label="Notification Type" class="border border-gray-200 px-4 py-3 text-gray-700 font-medium">${config.label}</td>[m
[32m+[m[32m                    <td data-label="Scheduled Days" class="border border-gray-200 px-4 py-3 text-gray-700">[m
[32m+[m[32m                        ${daysDisplay}[m
[32m+[m[32m                    </td>[m
                     <td data-label="Scheduled Time" class="border border-gray-200 px-4 py-3 text-gray-700">[m
                         ${isEditing[m
[31m-                        ? `<input type="time" class="sms-schedule-input w-full border border-gray-300 rounded-lg px-3 py-2" data-type="${type}" value="${currentTime}">`[m
[32m+[m[32m                        ? `<input type="time" class="sms-schedule-time-input w-full border border-gray-300 rounded-lg px-3 py-2" data-type="${config.type}" value="${currentTime}">`[m
                         : `<span>${formatTime12hr(currentTime)}</span>`[m
                     }[m
                     </td>[m
[36m@@ -1311,6 +1534,78 @@[m [mclass SuperAdminDashboard {[m
             `;[m
             })[m
             .join("");[m
[32m+[m
[32m+[m[32m        // Add event listeners for add/remove day buttons[m
[32m+[m[32m        if (isEditing) {[m
[32m+[m[32m            this.setupSmsDaysEventListeners();[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    setupSmsDaysEventListeners() {[m
[32m+[m[32m        const { smsScheduleTableBody } = this.elements;[m
[32m+[m[32m        if (!smsScheduleTableBody) return;[m
[32m+[m
[32m+[m[32m        // Remove day button[m
[32m+[m[32m        smsScheduleTableBody.querySelectorAll(".remove-day-btn").forEach(btn => {[m
[32m+[m[32m            btn.addEventListener("click", (e) => {[m
[32m+[m[32m                const type = e.target.closest(".remove-day-btn").dataset.type;[m
[32m+[m[32m                const dayToRemove = parseInt(e.target.closest(".remove-day-btn").dataset.day);[m
[32m+[m[41m                [m
[32m+[m[32m                const schedule = this.smsSchedules.find(s => s.schedule_type === type);[m
[32m+[m[32m                if (schedule && schedule.sms_days) {[m
[32m+[m[32m                    schedule.sms_days = schedule.sms_days.filter(d => d !== dayToRemove);[m
[32m+[m[32m                    this.renderSmsSchedulesTable(true);[m
[32m+[m[32m                }[m
[32m+[m[32m            });[m
[32m+[m[32m        });[m
[32m+[m
[32m+[m[32m        // Add day button[m
[32m+[m[32m        smsScheduleTableBody.querySelectorAll(".add-day-btn").forEach(btn => {[m
[32m+[m[32m            btn.addEventListener("click", (e) => {[m
[32m+[m[32m                const type = e.target.closest(".add-day-btn").dataset.type;[m
[32m+[m[32m                const container = smsScheduleTableBody.querySelector(`.sms-days-container[data-type="${type}"]`);[m
[32m+[m[32m                const input = container.querySelector(".add-day-input");[m
[32m+[m[32m                const dayValue = parseInt(input.value);[m
[32m+[m
[32m+[m[32m                if (isNaN(dayValue) || dayValue < 0 || dayValue > 365) {[m
[32m+[m[32m                    this.showToast("Please enter a valid day (0-365)", "error");[m
[32m+[m[32m                    return;[m
[32m+[m[32m                }[m
[32m+[m
[32m+[m[32m                const schedule = this.smsSchedules.find(s => s.schedule_type === type);[m
[32m+[m[32m                if (!schedule) {[m
[32m+[m[32m                    this.smsSchedules.push({[m
[32m+[m[32m                        schedule_type: type,[m
[32m+[m[32m                        description: "08:00",[m
[32m+[m[32m                        sms_days: [dayValue][m
[32m+[m[32m                    });[m
[32m+[m[32m                } else {[m
[32m+[m[32m                    if (!schedule.sms_days) {[m
[32m+[m[32m                        schedule.sms_days = [];[m
[32m+[m[32m                    }[m
[32m+[m[32m                    if (!schedule.sms_days.includes(dayValue)) {[m
[32m+[m[32m                        schedule.sms_days.push(dayValue);[m
[32m+[m[32m                    } else {[m
[32m+[m[32m                        this.showToast("This day is already added", "error");[m
[32m+[m[32m                        return;[m
[32m+[m[32m                    }[m
[32m+[m[32m                }[m
[32m+[m
[32m+[m[32m                input.value = "";[m
[32m+[m[32m                this.renderSmsSchedulesTable(true);[m
[32m+[m[32m            });[m
[32m+[m[32m        });[m
[32m+[m
[32m+[m[32m        // Enter key on add day input[m
[32m+[m[32m        smsScheduleTableBody.querySelectorAll(".add-day-input").forEach(input => {[m
[32m+[m[32m            input.addEventListener("keypress", (e) => {[m
[32m+[m[32m                if (e.key === "Enter") {[m
[32m+[m[32m                    e.preventDefault();[m
[32m+[m[32m                    const btn = input.parentElement.querySelector(".add-day-btn");[m
[32m+[m[32m                    btn.click();[m
[32m+[m[32m                }[m
[32m+[m[32m            });[m
[32m+[m[32m        });[m
     }[m
 [m
     renderSmsScheduleHistory() {[m
[36m@@ -1321,18 +1616,18 @@[m [mclass SuperAdminDashboard {[m
             return;[m
         }[m
 [m
[31m-        const formatTime12hr = (timeString) => {[m
[31m-            if ([m
[31m-                !timeString ||[m
[31m-                !timeString.includes(":") ||[m
[31m-                timeString === "Not Set"[m
[31m-            )[m
[31m-                return "Not Set";[m
[31m-            const [hours, minutes] = timeString.split(":");[m
[31m-            const h = parseInt(hours, 10);[m
[31m-            const suffix = h >= 12 ? "PM" : "AM";[m
[31m-            const h12 = h % 12 || 12;[m
[31m-            return `${String(h12).padStart(2, "0")}:${minutes} ${suffix}`;[m
[32m+[m[32m        const formatValue = (value) => {[m
[32m+[m[32m            if (!value || value === "Not Set") return "Not Set";[m
[32m+[m[32m            // Check if it's a time format (contains :)[m
[32m+[m[32m            if (value.includes(":")) {[m
[32m+[m[32m                const [hours, minutes] = value.split(":");[m
[32m+[m[32m                const h = parseInt(hours, 10);[m
[32m+[m[32m                const suffix = h >= 12 ? "PM" : "AM";[m
[32m+[m[32m                const h12 = h % 12 || 12;[m
[32m+[m[32m                return `${String(h12).padStart(2, "0")}:${minutes} ${suffix}`;[m
[32m+[m[32m            }[m
[32m+[m[32m            // Otherwise, it's a day or days value[m
[32m+[m[32m            return value;[m
         };[m
 [m
         smsScheduleHistoryTableBody.innerHTML = this.smsScheduleHistory[m
[36m@@ -1355,10 +1650,10 @@[m [mclass SuperAdminDashboard {[m
                     "SMS - ",[m
                     ""[m
                 )}</td>[m
[31m-                    <td data-label="Old Time" class="border border-gray-200 px-4 py-3 text-gray-700">${formatTime12hr([m
[32m+[m[32m                    <td data-label="Old Value" class="border border-gray-200 px-4 py-3 text-gray-700">${formatValue([m
                     log.old_value[m
                 )}</td>[m
[31m-                    <td data-label="New Time" class="border border-gray-200 px-4 py-3 text-gray-700">${formatTime12hr([m
[32m+[m[32m                    <td data-label="New Value" class="border border-gray-200 px-4 py-3 text-gray-700">${formatValue([m
                     log.new_value[m
                 )}</td>[m
                 </tr>[m
[36m@@ -1381,15 +1676,45 @@[m [mclass SuperAdminDashboard {[m
 [m
     async saveSmsSchedules() {[m
         const updatedSchedulesPayload = [];[m
[32m+[m[32m        const scheduleTypes = new Set();[m
[32m+[m
[32m+[m[32m        // Collect all schedule types[m
         this.elements.smsScheduleTableBody[m
[31m-            .querySelectorAll(".sms-schedule-input")[m
[31m-            .forEach((input) => {[m
[31m-                updatedSchedulesPayload.push({[m
[31m-                    type: input.dataset.type,[m
[31m-                    time: input.value,[m
[31m-                });[m
[32m+[m[32m            .querySelectorAll(".sms-schedule-time-input, .sms-schedule-day-input, .sms-days-container")[m
[32m+[m[32m            .forEach((element) => {[m
[32m+[m[32m                const type = element.dataset.type;[m
[32m+[m[32m                if (type) scheduleTypes.add(type);[m
             });[m
 [m
[32m+[m[32m        // Build payload with time, day, and days[m
[32m+[m[32m        scheduleTypes.forEach((type) => {[m
[32m+[m[32m            const timeInput = this.elements.smsScheduleTableBody.querySelector([m
[32m+[m[32m                `.sms-schedule-time-input[data-type="${type}"]`[m
[32m+[m[32m            );[m
[32m+[m[32m            const dayInput = this.elements.smsScheduleTableBody.querySelector([m
[32m+[m[32m                `.sms-schedule-day-input[data-type="${type}"]`[m
[32m+[m[32m            );[m
[32m+[m[32m            const schedule = this.smsSchedules.find(s => s.schedule_type === type);[m
[32m+[m
[32m+[m[32m            if (timeInput) {[m
[32m+[m[32m                const payload = {[m
[32m+[m[32m                    type: type,[m
[32m+[m[32m                    time: timeInput.value,[m
[32m+[m[32m                };[m
[32m+[m
[32m+[m[32m                // Billing Statements uses day (schedule_day)[m
[32m+[m[32m                if (type === "SMS - Billing Statements" && dayInput) {[m
[32m+[m[32m                    payload.day = parseInt(dayInput.value);[m
[32m+[m[32m                }[m
[32m+[m[32m                // Payment Reminders and Overdue Alerts use days array (sms_days)[m
[32m+[m[32m                else if (schedule && schedule.sms_days) {[m
[32m+[m[32m                    payload.days = schedule.sms_days;[m
[32m+[m[32m                }[m
[32m+[m
[32m+[m[32m                updatedSchedulesPayload.push(payload);[m
[32m+[m[32m            }[m
[32m+[m[32m        });[m
[32m+[m
         // Optimistic UI update[m
         const oldSchedules = JSON.parse(JSON.stringify(this.smsSchedules));[m
         updatedSchedulesPayload.forEach((updated) => {[m
[36m@@ -1398,11 +1723,24 @@[m [mclass SuperAdminDashboard {[m
             );[m
             if (schedule) {[m
                 schedule.description = updated.time;[m
[32m+[m[32m                if (updated.day !== undefined) {[m
[32m+[m[32m                    schedule.schedule_day = updated.day;[m
[32m+[m[32m                }[m
[32m+[m[32m                if (updated.days !== undefined) {[m
[32m+[m[32m                    schedule.sms_days = updated.days;[m
[32m+[m[32m                }[m
             } else {[m
[31m-                this.smsSchedules.push({[m
[32m+[m[32m                const newSchedule = {[m
                     schedule_type: updated.type,[m
                     description: updated.time,[m
[31m-                });[m
[32m+[m[32m                };[m
[32m+[m[32m                if (updated.day !== undefined) {[m
[32m+[m[32m                    newSchedule.schedule_day = updated.day;[m
[32m+[m[32m                }[m
[32m+[m[32m                if (updated.days !== undefined) {[m
[32m+[m[32m                    newSchedule.sms_days = updated.days;[m
[32m+[m[32m                }[m
[32m+[m[32m                this.smsSchedules.push(newSchedule);[m
             }[m
         });[m
         this.toggleSmsSchedulesEditMode(false);[m
[36m@@ -2263,41 +2601,64 @@[m [mclass SuperAdminDashboard {[m
 [m
     renderUtilityRatesTable(isEditing = false) {[m
         if (!this.elements.utilityRatesTableBody) return;[m
[32m+[m[41m        [m
[32m+[m[32m        // Ensure utilityRates is an array[m
[32m+[m[32m        if (!Array.isArray(this.utilityRates)) {[m
[32m+[m[32m            console.warn('utilityRates is not an array:', this.utilityRates);[m
[32m+[m[32m            this.utilityRates = [];[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        // Debug: Log the utility rates data structure[m
[32m+[m[32m        console.log('Utility Rates Data:', this.utilityRates);[m
[32m+[m[32m        if (this.utilityRates.length > 0) {[m
[32m+[m[32m            console.log('First rate structure:', this.utilityRates[0]);[m
[32m+[m[32m            console.log('First rate utility property:', this.utilityRates[0]?.utility);[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // Ensure we have data, if not, fetch it[m
[32m+[m[32m        if (!this.utilityRates || this.utilityRates.length === 0) {[m
[32m+[m[32m            this.elements.utilityRatesTableBody.innerHTML = `[m
[32m+[m[32m                <tr><td colspan="2" class="text-center py-4 text-gray-500">Loading utility rates...</td></tr>[m
[32m+[m[32m            `;[m
[32m+[m[32m            this.fetchUtilityRates();[m
[32m+[m[32m            return;[m
[32m+[m[32m        }[m
 [m
         if (isEditing) {[m
             // Edit mode with styling that matches the view mode[m
             this.elements.utilityRatesTableBody.innerHTML = this.utilityRates[m
                 .map([m
[31m-                    (rate) => `[m
[31m-                <tr class="bg-gradient-to-r from-gray-50 to-gray-100" data-id="util-${rate.id[m
[31m-                        }">[m
[31m-                    <td data-label="Utility" class="border border-gray-200 px-4 py-3 text-gray-700">${rate.utility[m
[31m-                        }</td>[m
[32m+[m[32m                    (rate) => {[m
[32m+[m[32m                        const rateValue = parseFloat(rate.rate) || 0;[m
[32m+[m[32m                        return `[m
[32m+[m[32m                <tr class="bg-gradient-to-r from-gray-50 to-gray-100" data-id="util-${rate.id || ''}">[m
[32m+[m[32m                    <td data-label="Utility" class="border border-gray-200 px-4 py-3 text-gray-700">${rate.utility || 'N/A'}</td>[m
                     [m
                     <td data-label="Rate" class="border border-gray-200 px-4 py-3 text-gray-700"> [m
                         [m
                         <input type="number" [m
                                class="edit-utility-rate no-spinner w-full h-full bg-transparent text-left text-gray-700 focus:outline-none focus:bg-gray-100 rounded-lg px-4 py-1 transition" [m
[31m-                               value="${parseFloat(rate.rate)}" [m
[32m+[m[32m                               value="${rateValue}"[m[41m [m
                                min="0" [m
                                step="0.01">[m
                     </td>[m
[31m-                </tr>`[m
[32m+[m[32m                </tr>`;[m
[32m+[m[32m                    }[m
                 )[m
                 .join("");[m
         } else {[m
             // View mode (remains the same)[m
             this.elements.utilityRatesTableBody.innerHTML = this.utilityRates[m
                 .map([m
[31m-                    (rate) => `[m
[31m-                <tr class="hover:bg-gray-50 transition-colors" data-id="util-${rate.id[m
[31m-                        }">[m
[31m-                    <td data-label="Utility" class="border border-gray-200 px-4 py-3 text-gray-700 font-medium">${rate.utility[m
[31m-                        }</td>[m
[31m-                    <td data-label="Rate" class="border border-gray-200 px-4 py-3 text-gray-700">â‚±${rate.rate.toFixed([m
[31m-                            2[m
[31m-                        )} / ${rate.unit}</td>[m
[31m-                </tr>`[m
[32m+[m[32m                    (rate) => {[m
[32m+[m[32m                        const rateValue = parseFloat(rate.rate) || 0;[m
[32m+[m[32m                        const unit = rate.unit || (rate.utility === 'Electricity' ? 'kWh' : 'day');[m
[32m+[m[32m                        return `[m
[32m+[m[32m                <tr class="hover:bg-gray-50 transition-colors" data-id="util-${rate.id || ''}">[m
[32m+[m[32m                    <td data-label="Utility" class="border border-gray-200 px-4 py-3 text-gray-700 font-medium">${rate.utility || 'N/A'}</td>[m
[32m+[m[32m                    <td data-label="Rate" class="border border-gray-200 px-4 py-3 text-gray-700">â‚±${rateValue.toFixed(2)} / ${unit}</td>[m
[32m+[m[32m                </tr>`;[m
[32m+[m[32m                    }[m
                 )[m
                 .join("");[m
         }[m
[36m@@ -2566,25 +2927,112 @@[m [mclass SuperAdminDashboard {[m
     renderBillingDateSchedules(isEditing = false) {[m
         const tableBody = this.elements.billingDatesTableBody;[m
         if (!tableBody) return;[m
[32m+[m[41m        [m
[32m+[m[32m        // If no schedules data, show loading message and fetch[m
[32m+[m[32m        if (!this.billingDateSchedules || this.billingDateSchedules.length === 0) {[m
[32m+[m[32m            tableBody.innerHTML = `[m
[32m+[m[32m                <tr><td colspan="6" class="text-center py-4 text-gray-500">Loading billing schedules...</td></tr>[m
[32m+[m[32m            `;[m
[32m+[m[32m            if (!isEditing) { // Only fetch if not already in edit mode[m
[32m+[m[32m                this.fetchBillingDateSchedules();[m
[32m+[m[32m            }[m
[32m+[m[32m            return;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // Debug: Log the schedules data when entering edit mode[m
[32m+[m[32m        if (isEditing) {[m
[32m+[m[32m            console.log("=== EDIT MODE ACTIVATED ===");[m
[32m+[m[32m            console.log("Billing Date Schedules Data:", this.billingDateSchedules);[m
[32m+[m[32m            console.log("Number of schedules:", this.billingDateSchedules?.length || 0);[m
[32m+[m[32m            if (this.billingDateSchedules && this.billingDateSchedules.length > 0) {[m
[32m+[m[32m                console.log("Sample schedule structure:", this.billingDateSchedules[0]);[m
[32m+[m[32m                console.log("All schedule types:", this.billingDateSchedules.map(s => s.schedule_type));[m
[32m+[m[32m            } else {[m
[32m+[m[32m                console.error("âš ï¸ No billing date schedules found! Data might not be loaded.");[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
 [m
[31m-        const findSchedule = (type) =>[m
[31m-            this.billingDateSchedules.find((s) => s.schedule_type === type);[m
[32m+[m[32m        const findSchedule = (type) => {[m
[32m+[m[32m            if (!this.billingDateSchedules || !Array.isArray(this.billingDateSchedules)) {[m
[32m+[m[32m                console.error(`Cannot find schedule - billingDateSchedules is not an array:`, this.billingDateSchedules);[m
[32m+[m[32m                return null;[m
[32m+[m[32m            }[m
[32m+[m[32m            const found = this.billingDateSchedules.find((s) => {[m
[32m+[m[32m                // Check both possible field names[m
[32m+[m[32m                const scheduleType = s.schedule_type || s.scheduleType;[m
[32m+[m[32m                return scheduleType === type;[m
[32m+[m[32m            });[m
[32m+[m[32m            if (isEditing && !found) {[m
[32m+[m[32m                console.warn(`âš ï¸ Schedule not found for type: "${type}"`);[m
[32m+[m[32m            }[m
[32m+[m[32m            return found;[m
[32m+[m[32m        };[m
 [m
[31m-        const createDayDropdown = (schedule, scheduleType, isEnabled) => {[m
[31m-            let options = '<option value="Not Set">Not Set</option>';[m
[32m+[m[32m        const createDayDropdown = (schedule, scheduleType, isEnabled, currentValue = null, isEditing = false) => {[m
[32m+[m[32m            // Determine the value to use - prioritize currentValue (already processed), then schedule.description[m
[32m+[m[32m            let scheduleValue = "Not Set";[m
[32m+[m[41m            [m
[32m+[m[32m            // Use currentValue if it's valid (this is the processed value from view mode)[m
[32m+[m[32m            if (currentValue && currentValue !== "Not Set" && currentValue !== null && currentValue !== undefined && currentValue !== "") {[m
[32m+[m[32m                scheduleValue = String(currentValue);[m
[32m+[m[32m            }[m[41m [m
[32m+[m[32m            // Fallback to schedule.description if currentValue is not available[m
[32m+[m[32m            else if (schedule && schedule.description !== null && schedule.description !== undefined && schedule.description !== "") {[m
[32m+[m[32m                let desc = String(schedule.description).trim();[m
[32m+[m[32m                // Convert numeric descriptions to just the number[m
[32m+[m[32m                const numValue = parseInt(desc);[m
[32m+[m[32m                if (!isNaN(numValue) && desc !== "N/A" && desc !== "End of the month") {[m
[32m+[m[32m                    scheduleValue = String(numValue);[m
[32m+[m[32m                } else {[m
[32m+[m[32m                    scheduleValue = desc; // Keep special values as-is[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
[32m+[m[32m            // Debug logging[m
[32m+[m[32m            if (isEditing) {[m
[32m+[m[32m                console.log(`  â†’ Dropdown ${scheduleType}:`, {[m
[32m+[m[32m                    currentValue,[m
[32m+[m[32m                    scheduleDesc: schedule?.description,[m
[32m+[m[32m                    finalValue: scheduleValue,[m
[32m+[m[32m                    willSet: scheduleValue !== "Not Set"[m
[32m+[m[32m                });[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
[32m+[m[32m            // Determine if this is for Rent based on scheduleType[m
[32m+[m[32m            const isRent = scheduleType.includes('Rent');[m
[32m+[m[41m            [m
[32m+[m[32m            // Build options HTML with selected attribute already in place (like billing settings does)[m
[32m+[m[32m            let optionsHTML = "";[m
[32m+[m[41m            [m
[32m+[m[32m            // "Not Set" option[m
[32m+[m[32m            const notSetSelected = scheduleValue === "Not Set" ? " selected" : "";[m
[32m+[m[32m            optionsHTML += `<option value="Not Set"${notSetSelected}>Not Set</option>`;[m
[32m+[m[41m            [m
[32m+[m[32m            // Add special options for Rent[m
[32m+[m[32m            if (isRent && scheduleType.includes('Due Date')) {[m
[32m+[m[32m                const endOfMonthSelected = scheduleValue === "End of the month" ? " selected" : "";[m
[32m+[m[32m                optionsHTML += `<option value="End of the month"${endOfMonthSelected}>End of the month</option>`;[m
[32m+[m[32m            }[m
[32m+[m[32m            if (isRent && scheduleType.includes('Disconnection')) {[m
[32m+[m[32m                const naSelected = scheduleValue === "N/A" ? " selected" : "";[m
[32m+[m[32m                optionsHTML += `<option value="N/A"${naSelected}>N/A</option>`;[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
[32m+[m[32m            // Add day options (1-31) with selected attribute[m
             for (let i = 1; i <= 31; i++) {[m
[31m-                options += `<option value="${i}">${i}</option>`;[m
[32m+[m[32m                const daySelected = scheduleValue === String(i) ? " selected" : "";[m
[32m+[m[32m                optionsHTML += `<option value="${i}"${daySelected}>${i}</option>`;[m
             }[m
[31m-            const select = document.createElement("select");[m
[31m-            select.innerHTML = options;[m
[31m-            // Use the schedule's description if it exists, otherwise default to "Not Set"[m
[31m-            select.value = schedule ? schedule.description : "Not Set";[m
[31m-            select.disabled = !isEnabled;[m
[31m-            select.dataset.id = schedule ? schedule.id : "";[m
[31m-            select.dataset.type = scheduleType; // Always use the explicitly passed scheduleType[m
[31m-            select.className =[m
[31m-                "billing-date-select w-full border border-gray-300 rounded-lg px-3 py-2 bg-white";[m
[31m-            return select.outerHTML;[m
[32m+[m[41m            [m
[32m+[m[32m            // Return the complete select HTML (like billing settings does)[m
[32m+[m[32m            return `[m
[32m+[m[32m                <select ${!isEnabled ? 'disabled' : ''}[m[41m [m
[32m+[m[32m                        data-id="${schedule ? schedule.id : ''}"[m[41m [m
[32m+[m[32m                        data-type="${scheduleType}"[m
[32m+[m[32m                        class="billing-date-select w-full border border-gray-300 rounded-lg px-3 py-2 bg-white">[m
[32m+[m[32m                    ${optionsHTML}[m
[32m+[m[32m                </select>[m
[32m+[m[32m            `;[m
         };[m
 [m
         const formatDay = (day) => {[m
[36m@@ -2593,10 +3041,23 @@[m [mclass SuperAdminDashboard {[m
             }[m
             const dayNum = parseInt(day);[m
             if (isNaN(dayNum)) return `<strong>${day}</strong>`;[m
[31m-            const suffix =[m
[31m-                ["th", "st", "nd", "rd"][[m
[31m-                ((((dayNum + 90) % 100) - 10) % 10) - 1[m
[31m-                ] || "th";[m
[32m+[m[41m            [m
[32m+[m[32m            // Correct ordinal suffix logic[m
[32m+[m[32m            let suffix = "th";[m
[32m+[m[32m            const lastDigit = dayNum % 10;[m
[32m+[m[32m            const lastTwoDigits = dayNum % 100;[m
[32m+[m[41m            [m
[32m+[m[32m            // Special cases: 11th, 12th, 13th (not 11st, 12nd, 13rd)[m
[32m+[m[32m            if (lastTwoDigits >= 11 && lastTwoDigits <= 13) {[m
[32m+[m[32m                suffix = "th";[m
[32m+[m[32m            } else if (lastDigit === 1) {[m
[32m+[m[32m                suffix = "st";[m
[32m+[m[32m            } else if (lastDigit === 2) {[m
[32m+[m[32m                suffix = "nd";[m
[32m+[m[32m            } else if (lastDigit === 3) {[m
[32m+[m[32m                suffix = "rd";[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
             return `<strong>${dayNum}${suffix} day of the month</strong>`;[m
         };[m
 [m
[36m@@ -2613,17 +3074,64 @@[m [mclass SuperAdminDashboard {[m
             let dueDateCell = "";[m
             let discoDateCell = "";[m
 [m
[31m-            if (util === "Rent") {[m
[31m-                dueDateCell = formatDay("End of the month");[m
[31m-                discoDateCell = formatDay("N/A");[m
[31m-            } else {[m
[31m-                dueDateCell = isEditing[m
[31m-                    ? createDayDropdown(dueDateSchedule, dueDateType, true)[m
[31m-                    : formatDay(dueDateSchedule?.description);[m
[31m-                discoDateCell = isEditing[m
[31m-                    ? createDayDropdown(discoDateSchedule, discoDateType, true)[m
[31m-                    : formatDay(discoDateSchedule?.description);[m
[32m+[m[32m            // Get description value, handling both string and number formats[m
[32m+[m[32m            // Use ONLY what's actually saved in the database - no defaults[m
[32m+[m[32m            // Check both possible field names (description or Description)[m
[32m+[m[32m            const dueDateDesc = dueDateSchedule?.description ?? dueDateSchedule?.Description ?? null;[m
[32m+[m[32m            const discoDateDesc = discoDateSchedule?.description ?? discoDateSchedule?.Description ?? null;[m
[32m+[m[41m            [m
[32m+[m[32m            // Debug logging for each utility[m
[32m+[m[32m            if (isEditing) {[m
[32m+[m[32m                console.log(`\n--- ${util} ---`);[m
[32m+[m[32m                console.log(`Due Date Schedule:`, dueDateSchedule);[m
[32m+[m[32m                console.log(`Due Date Description:`, dueDateDesc, `Type:`, typeof dueDateDesc);[m
[32m+[m[32m                console.log(`Disconnection Schedule:`, discoDateSchedule);[m
[32m+[m[32m                console.log(`Disconnection Description:`, discoDateDesc, `Type:`, typeof discoDateDesc);[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
[32m+[m[32m            // Convert to string, preserving the actual saved value[m
[32m+[m[32m            // Handle null, undefined, and empty string as "Not Set"[m
[32m+[m[32m            let dueDateValue = "Not Set";[m
[32m+[m[32m            if (dueDateDesc !== null && dueDateDesc !== undefined && dueDateDesc !== "") {[m
[32m+[m[32m                // Convert to string and trim whitespace[m
[32m+[m[32m                dueDateValue = String(dueDateDesc).trim();[m
[32m+[m[32m                // If it's a numeric value, convert to just the number string (e.g., "14" not "14.0")[m
[32m+[m[32m                const numValue = parseInt(dueDateValue);[m
[32m+[m[32m                if (!isNaN(numValue) && dueDateValue !== "N/A" && dueDateValue !== "End of the month") {[m
[32m+[m[32m                    dueDateValue = String(numValue);[m
[32m+[m[32m                }[m
[32m+[m[32m                // Keep special values as-is[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
[32m+[m[32m            let discoDateValue = "Not Set";[m
[32m+[m[32m            if (discoDateDesc !== null && discoDateDesc !== undefined && discoDateDesc !== "") {[m
[32m+[m[32m                // Convert to string and trim whitespace[m
[32m+[m[32m                discoDateValue = String(discoDateDesc).trim();[m
[32m+[m[32m                // If it's a numeric value, convert to just the number string[m
[32m+[m[32m                const numValue = parseInt(discoDateValue);[m
[32m+[m[32m                if (!isNaN(numValue) && discoDateValue !== "N/A" && discoDateValue !== "End of the month") {[m
[32m+[m[32m                    discoDateValue = String(numValue);[m
[32m+[m[32m                }[m
[32m+[m[32m                // Keep special values as-is[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
[32m+[m[32m            if (isEditing) {[m
[32m+[m[32m                console.log(`\nâœ… ${util} - Final Values:`, {[m
[32m+[m[32m                    dueDate: { raw: dueDateDesc, processed: dueDateValue },[m
[32m+[m[32m                    disconnection: { raw: discoDateDesc, processed: discoDateValue },[m
[32m+[m[32m                    dueDateSchedule: dueDateSchedule,[m
[32m+[m[32m                    discoDateSchedule: discoDateSchedule[m
[32m+[m[32m                });[m
             }[m
[32m+[m[41m            [m
[32m+[m[32m            // Render cells - editable dropdowns when editing, formatted text when viewing[m
[32m+[m[32m            // Pass the current saved value to ensure it's preserved in the dropdown[m
[32m+[m[32m            dueDateCell = isEditing[m
[32m+[m[32m                ? createDayDropdown(dueDateSchedule, dueDateType, true, dueDateValue, isEditing)[m
[32m+[m[32m                : formatDay(dueDateValue);[m
[32m+[m[32m            discoDateCell = isEditing[m
[32m+[m[32m                ? createDayDropdown(discoDateSchedule, discoDateType, true, discoDateValue, isEditing)[m
[32m+[m[32m                : formatDay(discoDateValue);[m
 [m
             tableHTML += `[m
                 <tr class="hover:bg-gray-50 transition-colors">[m
[36m@@ -2651,10 +3159,23 @@[m [mclass SuperAdminDashboard {[m
             if (day === "Not Set" || !day) return "Not Set";[m
             const dayNum = parseInt(day);[m
             if (isNaN(dayNum)) return day; // Should not happen but good practice[m
[31m-            const suffix =[m
[31m-                ["th", "st", "nd", "rd"][[m
[31m-                ((((dayNum + 90) % 100) - 10) % 10) - 1[m
[31m-                ] || "th";[m
[32m+[m[41m            [m
[32m+[m[32m            // Correct ordinal suffix logic[m
[32m+[m[32m            let suffix = "th";[m
[32m+[m[32m            const lastDigit = dayNum % 10;[m
[32m+[m[32m            const lastTwoDigits = dayNum % 100;[m
[32m+[m[41m            [m
[32m+[m[32m            // Special cases: 11th, 12th, 13th (not 11st, 12nd, 13rd)[m
[32m+[m[32m            if (lastTwoDigits >= 11 && lastTwoDigits <= 13) {[m
[32m+[m[32m                suffix = "th";[m
[32m+[m[32m            } else if (lastDigit === 1) {[m
[32m+[m[32m                suffix = "st";[m
[32m+[m[32m            } else if (lastDigit === 2) {[m
[32m+[m[32m                suffix = "nd";[m
[32m+[m[32m            } else if (lastDigit === 3) {[m
[32m+[m[32m                suffix = "rd";[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
             return `${dayNum}${suffix} day`;[m
         };[m
 [m
[36m@@ -2702,6 +3223,26 @@[m [mclass SuperAdminDashboard {[m
     }[m
 [m
     toggleBillingDatesEditMode(isEditing) {[m
[32m+[m[32m        if (isEditing) {[m
[32m+[m[32m            // Ensure data is loaded before entering edit mode[m
[32m+[m[32m            if (!this.billingDateSchedules || this.billingDateSchedules.length === 0) {[m
[32m+[m[32m                this.showToast("Loading schedules...", "info");[m
[32m+[m[32m                this.fetchBillingDateSchedules().then(() => {[m
[32m+[m[32m                    // Store original values when entering edit mode[m
[32m+[m[32m                    this.originalBillingDates = JSON.parse([m
[32m+[m[32m                        JSON.stringify(this.billingDateSchedules)[m
[32m+[m[32m                    );[m
[32m+[m[32m                    this.elements.billingDatesDefaultButtons.classList.add("hidden");[m
[32m+[m[32m                    this.elements.billingDatesEditButtons.classList.remove("hidden");[m
[32m+[m[32m                    this.renderBillingDateSchedules(true);[m
[32m+[m[32m                });[m
[32m+[m[32m                return;[m
[32m+[m[32m            }[m
[32m+[m[32m            // Store original values when entering edit mode[m
[32m+[m[32m            this.originalBillingDates = JSON.parse([m
[32m+[m[32m                JSON.stringify(this.billingDateSchedules)[m
[32m+[m[32m            );[m
[32m+[m[32m        }[m
         this.elements.billingDatesDefaultButtons.classList.toggle([m
             "hidden",[m
             isEditing[m
[36m@@ -2718,15 +3259,37 @@[m [mclass SuperAdminDashboard {[m
         const selects = this.elements.billingDatesTableBody.querySelectorAll([m
             ".billing-date-select:not([disabled])"[m
         );[m
[32m+[m[41m        [m
[32m+[m[32m        // Only include schedules that have actually changed[m
         selects.forEach((select) => {[m
[31m-            updatedSchedulesPayload.push({[m
[31m-                type: select.dataset.type,[m
[31m-                day: select.value,[m
[31m-            });[m
[32m+[m[32m            const scheduleType = select.dataset.type;[m
[32m+[m[32m            const newDay = select.value;[m
[32m+[m[41m            [m
[32m+[m[32m            // Find original value[m
[32m+[m[32m            const originalSchedule = this.originalBillingDates?.find([m
[32m+[m[32m                (s) => s.schedule_type === scheduleType[m
[32m+[m[32m            );[m
[32m+[m[32m            const oldValue = originalSchedule ? originalSchedule.description : "Not Set";[m
[32m+[m[41m            [m
[32m+[m[32m            // Only add to payload if value has changed[m
[32m+[m[32m            // Convert oldValue to string for proper comparison[m
[32m+[m[32m            const oldValueStr = oldValue !== null && oldValue !== undefined ? String(oldValue) : "Not Set";[m
[32m+[m[41m            [m
[32m+[m[32m            if (oldValueStr !== newDay && !(oldValueStr === null && newDay === "Not Set")) {[m
[32m+[m[32m                // Ensure we have valid data[m
[32m+[m[32m                if (scheduleType && newDay !== null && newDay !== undefined) {[m
[32m+[m[32m                    updatedSchedulesPayload.push({[m
[32m+[m[32m                        type: scheduleType,[m
[32m+[m[32m                        day: String(newDay),[m
[32m+[m[32m                    });[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
         });[m
 [m
[32m+[m[32m        // If nothing changed, just exit edit mode[m
         if (updatedSchedulesPayload.length === 0) {[m
             this.toggleBillingDatesEditMode(false);[m
[32m+[m[32m            this.showToast("No changes to save.", "info");[m
             return;[m
         }[m
 [m
[36m@@ -2736,7 +3299,7 @@[m [mclass SuperAdminDashboard {[m
         const oldHistory = JSON.parse(JSON.stringify(this.billingDateHistory));[m
         const newHistoryLogs = [];[m
 [m
[31m-        //  Immediately update local state and create temporary history logs[m
[32m+[m[32m        // Immediately update local state and create temporary history logs[m
         updatedSchedulesPayload.forEach((updated) => {[m
             const oldSchedule = oldSchedules.find([m
                 (s) => s.schedule_type === updated.type[m
[36m@@ -2765,14 +3328,14 @@[m [mclass SuperAdminDashboard {[m
             }[m
         });[m
 [m
[31m-        //  Immediately update the UI[m
[31m-        this.toggleBillingDatesEditMode(false); // Re-renders the main table[m
[32m+[m[32m        // Immediately update the UI[m
[32m+[m[32m        this.toggleBillingDatesEditMode(false);[m
         if (newHistoryLogs.length > 0) {[m
             this.billingDateHistory.unshift(...newHistoryLogs);[m
[31m-            this.renderBillingDateHistory(); // Re-renders the history table[m
[32m+[m[32m            this.renderBillingDateHistory();[m
         }[m
 [m
[31m-        // . Save to the server in the background[m
[32m+[m[32m        // Save to the server in the background[m
         try {[m
             const response = await fetch("/api/schedules/billing-dates", {[m
                 method: "PUT",[m
[36m@@ -2793,14 +3356,14 @@[m [mclass SuperAdminDashboard {[m
                 );[m
             }[m
 [m
[31m-            //  On success, show confirmation and silently refresh history[m
[32m+[m[32m            // On success, show confirmation and silently refresh history[m
             this.showToast("Schedules updated successfully!", "success");[m
             this.billingDateHistory = [];[m
             this.billingDateHistoryPage = 1;[m
             this.billingDateHistoryHasMore = true;[m
             await this.fetchBillingDateHistory();[m
         } catch (error) {[m
[31m-            //  On failure, roll back all UI changes[m
[32m+[m[32m            // On failure, roll back all UI changes[m
             this.showToast(error.message, "error");[m
             this.billingDateSchedules = oldSchedules;[m
             this.billingDateHistory = oldHistory;[m
[36m@@ -2809,6 +3372,8 @@[m [mclass SuperAdminDashboard {[m
         }[m
     }[m
 [m
[32m+[m[32m    // Old bulk save method removed - using saveIndividualSchedule instead[m
[32m+[m
     renderMeterReadingSchedule() {[m
         if (!this.currentSchedule) return;[m
         const day = this.currentSchedule.day;[m
[36m@@ -3244,6 +3809,12 @@[m [mclass SuperAdminDashboard {[m
             }[m
 [m
             this.showToast("Rates updated successfully!", "success");[m
[32m+[m[41m            [m
[32m+[m[32m            // Refresh rental rate history after successful update[m
[32m+[m[32m            this.rentalRateHistory = [];[m
[32m+[m[32m            this.rentalRateHistoryPage = 1;[m
[32m+[m[32m            this.rentalRateHistoryHasMore = true;[m
[32m+[m[32m            await this.fetchRentalRateHistory();[m
         } catch (error) {[m
             this.showToast(error.message, "error");[m
             this.allRentalRates = oldAllRentalRates;[m
[36m@@ -3445,6 +4016,119 @@[m [mclass SuperAdminDashboard {[m
         this.filterAndRenderRates(1);[m
     }[m
 [m
[32m+[m[32m    async fetchRentalRateHistory() {[m
[32m+[m[32m        console.log("fetchRentalRateHistory called", {[m
[32m+[m[32m            isFetching: this.isFetchingRentalRateHistory,[m
[32m+[m[32m            hasMore: this.rentalRateHistoryHasMore,[m
[32m+[m[32m            page: this.rentalRateHistoryPage[m
[32m+[m[32m        });[m
[32m+[m[41m        [m
[32m+[m[32m        if (this.isFetchingRentalRateHistory || !this.rentalRateHistoryHasMore) {[m
[32m+[m[32m            console.log("Skipping fetch - already fetching or no more data");[m
[32m+[m[32m            return;[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        this.isFetchingRentalRateHistory = true;[m
[32m+[m[32m        if (this.elements.rentalRateHistoryLoader)[m
[32m+[m[32m            this.elements.rentalRateHistoryLoader.style.display = "block";[m
[32m+[m
[32m+[m[32m        try {[m
[32m+[m[32m            console.log("Fetching rental rate history from API...");[m
[32m+[m[32m            const response = await fetch([m
[32m+[m[32m                `/api/rental-rates/history?page=${this.rentalRateHistoryPage}`[m
[32m+[m[32m            );[m
[32m+[m[32m            console.log("API Response status:", response.status, response.statusText);[m
[32m+[m[41m            [m
[32m+[m[32m            if (!response.ok) {[m
[32m+[m[32m                const errorData = await response.json().catch(() => ({}));[m
[32m+[m[32m                console.error("API Error:", errorData);[m
[32m+[m[32m                throw new Error(errorData.message || "Network response was not ok");[m
[32m+[m[32m            }[m
[32m+[m[32m            const data = await response.json();[m
[32m+[m[41m            [m
[32m+[m[32m            console.log("Rental Rate History API Response:", data);[m
[32m+[m[32m            console.log("History Data:", data.data);[m
[32m+[m[32m            console.log("Total Records:", data.total);[m
[32m+[m[32m            console.log("Has More:", data.has_more);[m
[32m+[m[32m            console.log("Current Page:", data.current_page);[m
[32m+[m[41m            [m
[32m+[m[32m            // Additional debugging[m
[32m+[m[32m            if (!data.data || data.data.length === 0) {[m
[32m+[m[32m                console.warn("âš ï¸ No history data in response. Response structure:", Object.keys(data));[m
[32m+[m[32m                if (data.total === 0) {[m
[32m+[m[32m                    console.warn("âš ï¸ Total is 0 - No audit trail records found for Rental Rates module");[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            // Handle both paginated and non-paginated responses[m
[32m+[m[32m            const historyData = data.data || data;[m
[32m+[m[32m            const hasMore = data.has_more !== undefined ? data.has_more : (data.next_page_url !== null);[m
[32m+[m[41m            [m
[32m+[m[32m            if (historyData && Array.isArray(historyData) && historyData.length > 0) {[m
[32m+[m[32m                this.rentalRateHistory.push(...historyData);[m
[32m+[m[32m                this.rentalRateHistoryHasMore = hasMore;[m
[32m+[m[32m                this.rentalRateHistoryPage++;[m
[32m+[m[32m                this.renderRentalRateHistory();[m
[32m+[m[32m            } else {[m
[32m+[m[32m                console.warn("No history data received from API");[m
[32m+[m[32m                this.renderRentalRateHistory(); // Still render to show "No history logs found"[m
[32m+[m[32m            }[m
[32m+[m[32m        } catch (error) {[m
[32m+[m[32m            console.error("Failed to fetch rental rate history:", error);[m
[32m+[m[32m            this.showToast("Failed to load rental rate history.", "error");[m
[32m+[m[32m            // Still render to show empty state[m
[32m+[m[32m            this.renderRentalRateHistory();[m
[32m+[m[32m        } finally {[m
[32m+[m[32m            this.isFetchingRentalRateHistory = false;[m
[32m+[m[32m            if (this.elements.rentalRateHistoryLoader)[m
[32m+[m[32m                this.elements.rentalRateHistoryLoader.style.display = "none";[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    renderRentalRateHistory() {[m
[32m+[m[32m        const tableBody = this.elements.rentalRateHistoryTableBody;[m
[32m+[m[32m        if (!tableBody) return;[m
[32m+[m
[32m+[m[32m        if (this.rentalRateHistory.length === 0) {[m
[32m+[m[32m            tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-gray-500">No history logs found.</td></tr>`;[m
[32m+[m[32m            return;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        tableBody.innerHTML = this.rentalRateHistory[m
[32m+[m[32m            .map((log) => {[m
[32m+[m[32m                const formattedDate = new Date(log.changed_at).toLocaleString([m
[32m+[m[32m                    "en-US",[m
[32m+[m[32m                    {[m
[32m+[m[32m                        year: "numeric",[m
[32m+[m[32m                        month: "long",[m
[32m+[m[32m                        day: "numeric",[m
[32m+[m[32m                        hour: "2-digit",[m
[32m+[m[32m                        minute: "2-digit",[m
[32m+[m[32m                        hour12: true,[m
[32m+[m[32m                    }[m
[32m+[m[32m                );[m
[32m+[m
[32m+[m[32m                const formatRate = (rate) => {[m
[32m+[m[32m                    if (rate === null || rate === undefined) return "N/A";[m
[32m+[m[32m                    return `â‚±${parseFloat(rate).toFixed(2)}`;[m
[32m+[m[32m                };[m
[32m+[m
[32m+[m[32m                return `[m
[32m+[m[32m                <tr class="hover:bg-gray-50 transition-colors">[m
[32m+[m[32m                    <td data-label="Date & Time" class="border border-gray-200 px-4 py-3 text-gray-700">${formattedDate}</td>[m
[32m+[m[32m                    <td data-label="Action" class="border border-gray-200 px-4 py-3 text-gray-700">${log.action || "N/A"}</td>[m
[32m+[m[32m                    <td data-label="Table Number" class="border border-gray-200 px-4 py-3 text-gray-700">${log.table_number || "N/A"}</td>[m
[32m+[m[32m                    <td data-label="Section" class="border border-gray-200 px-4 py-3 text-gray-700">${log.section || "N/A"}</td>[m
[32m+[m[32m                    <td data-label="Old Daily Rate" class="border border-gray-200 px-4 py-3 text-gray-700">${formatRate(log.old_daily_rate)}</td>[m
[32m+[m[32m                    <td data-label="New Daily Rate" class="border border-gray-200 px-4 py-3 text-gray-700">${formatRate(log.new_daily_rate)}</td>[m
[32m+[m[32m                    <td data-label="Old Monthly Rate" class="border border-gray-200 px-4 py-3 text-gray-700">${formatRate(log.old_monthly_rate)}</td>[m
[32m+[m[32m                    <td data-label="New Monthly Rate" class="border border-gray-200 px-4 py-3 text-gray-700">${formatRate(log.new_monthly_rate)}</td>[m
[32m+[m[32m                </tr>[m
[32m+[m[32m            `;[m
[32m+[m[32m            })[m
[32m+[m[32m            .join("");[m
[32m+[m[32m    }[m
[32m+[m
     async addNewInlineRow() {[m
         if (this.isRentalRatesEditing) {[m
             this.showToast([m
[36m@@ -3699,6 +4383,185 @@[m [mclass SuperAdminDashboard {[m
                 this.handleSectionNavigation(btn)[m
             )[m
         );[m
[32m+[m
[32m+[m[32m        // Password change form[m
[32m+[m[32m        if (this.elements.changePasswordForm) {[m
[32m+[m[32m            this.elements.changePasswordForm.addEventListener("submit", async (e) => {[m
[32m+[m[32m                e.preventDefault();[m
[32m+[m[41m                [m
[32m+[m[32m                const btn = this.elements.changePasswordBtn;[m
[32m+[m[32m                const originalText = btn.innerHTML;[m
[32m+[m[32m                btn.disabled = true;[m
[32m+[m[32m                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Changing...</span>';[m
[32m+[m
[32m+[m[32m                const formData = new FormData(this.elements.changePasswordForm);[m
[32m+[m[32m                const data = {[m
[32m+[m[32m                    current_password: formData.get("current_password"),[m
[32m+[m[32m                    password: formData.get("password"),[m
[32m+[m[32m                    password_confirmation: formData.get("password_confirmation"),[m
[32m+[m[32m                };[m
[32m+[m
[32m+[m[32m                try {[m
[32m+[m[32m                    const response = await fetch("/api/user-settings/change-password", {[m
[32m+[m[32m                        method: "POST",[m
[32m+[m[32m                        headers: {[m
[32m+[m[32m                            "Content-Type": "application/json",[m
[32m+[m[32m                            Accept: "application/json",[m
[32m+[m[32m                            "X-CSRF-TOKEN": document[m
[32m+[m[32m                                .querySelector('meta[name="csrf-token"]')[m
[32m+[m[32m                                .getAttribute("content"),[m
[32m+[m[32m                        },[m
[32m+[m[32m                        credentials: "include",[m
[32m+[m[32m                        body: JSON.stringify(data),[m
[32m+[m[32m                    });[m
[32m+[m
[32m+[m[32m                    const result = await response.json();[m
[32m+[m
[32m+[m[32m                    if (response.ok) {[m
[32m+[m[32m                        this.showToast(result.message || "Password changed successfully!", "success");[m
[32m+[m[32m                        this.elements.changePasswordForm.reset();[m
[32m+[m[32m                    } else {[m
[32m+[m[32m                        const errorMsg = result.message || result.errors?.current_password?.[0] || result.errors?.password?.[0] || "Failed to change password";[m
[32m+[m[32m                        this.showToast(errorMsg, "error");[m
[32m+[m[32m                    }[m
[32m+[m[32m                } catch (error) {[m
[32m+[m[32m                    console.error("Password change error:", error);[m
[32m+[m[32m                    this.showToast("An error occurred. Please try again.", "error");[m
[32m+[m[32m                } finally {[m
[32m+[m[32m                    btn.disabled = false;[m
[32m+[m[32m                    btn.innerHTML = originalText;[m
[32m+[m[32m                }[m
[32m+[m[32m            });[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // Profile picture upload[m
[32m+[m[32m        const profilePictureInput = document.getElementById("profilePictureInput");[m
[32m+[m[32m        const removeProfilePictureBtn = document.getElementById("removeProfilePictureBtn");[m
[32m+[m[41m        [m
[32m+[m[32m        if (profilePictureInput) {[m
[32m+[m[32m            profilePictureInput.addEventListener("change", async (e) => {[m
[32m+[m[32m                const file = e.target.files[0];[m
[32m+[m[32m                if (!file) return;[m
[32m+[m
[32m+[m[32m                if (file.size > 2 * 1024 * 1024) {[m
[32m+[m[32m                    this.showToast("Image must be smaller than 2MB", "error");[m
[32m+[m[32m                    return;[m
[32m+[m[32m                }[m
[32m+[m
[32m+[m[32m                if (!file.type.match(/^image\/(jpeg|jpg|png|gif)$/)) {[m
[32m+[m[32m                    this.showToast("Please select a valid image file (JPEG, PNG, or GIF)", "error");[m
[32m+[m[32m                    return;[m
[32m+[m[32m                }[m
[32m+[m
[32m+[m[32m                const formData = new FormData();[m
[32m+[m[32m                formData.append("profile_picture", file);[m
[32m+[m
[32m+[m[32m                const container = document.getElementById("profilePictureContainer");[m
[32m+[m[32m                const placeholder = document.getElementById("profilePicturePlaceholder");[m
[32m+[m[32m                const img = document.getElementById("profilePictureImg");[m
[32m+[m
[32m+[m[32m                // Show preview[m
[32m+[m[32m                const reader = new FileReader();[m
[32m+[m[32m                reader.onload = (e) => {[m
[32m+[m[32m                    if (img) {[m
[32m+[m[32m                        img.src = e.target.result;[m
[32m+[m[32m                        img.classList.remove("hidden");[m
[32m+[m[32m                        if (placeholder) placeholder.classList.add("hidden");[m
[32m+[m[32m                    } else {[m
[32m+[m[32m                        const newImg = document.createElement("img");[m
[32m+[m[32m                        newImg.id = "profilePictureImg";[m
[32m+[m[32m                        newImg.src = e.target.result;[m
[32m+[m[32m                        newImg.alt = "Profile Picture";[m
[32m+[m[32m                        newImg.className = "w-full h-full object-cover";[m
[32m+[m[32m                        container.innerHTML = "";[m
[32m+[m[32m                        container.appendChild(newImg);[m
[32m+[m[32m                    }[m
[32m+[m[32m                    if (removeProfilePictureBtn) removeProfilePictureBtn.classList.remove("hidden");[m
[32m+[m[32m                };[m
[32m+[m[32m                reader.readAsDataURL(file);[m
[32m+[m
[32m+[m[32m                try {[m
[32m+[m[32m                    const response = await fetch("/api/user-settings/upload-profile-picture", {[m
[32m+[m[32m                        method: "POST",[m
[32m+[m[32m                        headers: {[m
[32m+[m[32m                            "X-CSRF-TOKEN": document[m
[32m+[m[32m                                .querySelector('meta[name="csrf-token"]')[m
[32m+[m[32m                                .getAttribute("content"),[m
[32m+[m[32m                        },[m
[32m+[m[32m                        credentials: "include",[m
[32m+[m[32m                        body: formData,[m
[32m+[m[32m                    });[m
[32m+[m
[32m+[m[32m                    const result = await response.json();[m
[32m+[m
[32m+[m[32m                    if (response.ok) {[m
[32m+[m[32m                        this.showToast(result.message || "Profile picture uploaded successfully!", "success");[m
[32m+[m[32m                        if (img && result.profile_picture_url) {[m
[32m+[m[32m                            img.src = result.profile_picture_url;[m
[32m+[m[32m                        }[m
[32m+[m[32m                        // Update sidebar profile picture[m
[32m+[m[32m                        const sidebarImg = document.querySelector('#sidebarProfileImage img');[m
[32m+[m[32m                        const sidebarIcon = document.getElementById('sidebarProfileIcon');[m
[32m+[m[32m                        if (sidebarImg && result.profile_picture_url) {[m
[32m+[m[32m                            sidebarImg.src = result.profile_picture_url;[m
[32m+[m[32m                            sidebarImg.classList.remove('hidden');[m
[32m+[m[32m                            if (sidebarIcon) sidebarIcon.classList.add('hidden');[m
[32m+[m[32m                        }[m
[32m+[m[32m                    } else {[m
[32m+[m[32m                        this.showToast(result.message || "Failed to upload profile picture", "error");[m
[32m+[m[32m                        if (img) img.classList.add("hidden");[m
[32m+[m[32m                        if (placeholder) placeholder.classList.remove("hidden");[m
[32m+[m[32m                    }[m
[32m+[m[32m                } catch (error) {[m
[32m+[m[32m                    console.error("Profile picture upload error:", error);[m
[32m+[m[32m                    this.showToast("An error occurred. Please try again.", "error");[m
[32m+[m[32m                    if (img) img.classList.add("hidden");[m
[32m+[m[32m                    if (placeholder) placeholder.classList.remove("hidden");[m
[32m+[m[32m                } finally {[m
[32m+[m[32m                    profilePictureInput.value = "";[m
[32m+[m[32m                }[m
[32m+[m[32m            });[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        if (removeProfilePictureBtn) {[m
[32m+[m[32m            removeProfilePictureBtn.addEventListener("click", async () => {[m
[32m+[m[32m                if (!confirm("Are you sure you want to remove your profile picture?")) return;[m
[32m+[m
[32m+[m[32m                try {[m
[32m+[m[32m                    const response = await fetch("/api/user-settings/remove-profile-picture", {[m
[32m+[m[32m                        method: "DELETE",[m
[32m+[m[32m                        headers: {[m
[32m+[m[32m                            "X-CSRF-TOKEN": document[m
[32m+[m[32m                                .querySelector('meta[name="csrf-token"]')[m
[32m+[m[32m                                .getAttribute("content"),[m
[32m+[m[32m                        },[m
[32m+[m[32m                        credentials: "include",[m
[32m+[m[32m                    });[m
[32m+[m
[32m+[m[32m                    const result = await response.json();[m
[32m+[m
[32m+[m[32m                    if (response.ok) {[m
[32m+[m[32m                        this.showToast(result.message || "Profile picture removed successfully!", "success");[m
[32m+[m[32m                        const img = document.getElementById("profilePictureImg");[m
[32m+[m[32m                        const placeholder = document.getElementById("profilePicturePlaceholder");[m
[32m+[m[32m                        if (img) img.classList.add("hidden");[m
[32m+[m[32m                        if (placeholder) placeholder.classList.remove("hidden");[m
[32m+[m[32m                        removeProfilePictureBtn.classList.add("hidden");[m
[32m+[m[32m                        // Update sidebar[m
[32m+[m[32m                        const sidebarImg = document.querySelector('#sidebarProfileImage img');[m
[32m+[m[32m                        const sidebarIcon = document.getElementById('sidebarProfileIcon');[m
[32m+[m[32m                        if (sidebarImg) sidebarImg.classList.add('hidden');[m
[32m+[m[32m                        if (sidebarIcon) sidebarIcon.classList.remove('hidden');[m
[32m+[m[32m                    } else {[m
[32m+[m[32m                        this.showToast(result.message || "Failed to remove profile picture", "error");[m
[32m+[m[32m                    }[m
[32m+[m[32m                } catch (error) {[m
[32m+[m[32m                    console.error("Remove profile picture error:", error);[m
[32m+[m[32m                    this.showToast("An error occurred. Please try again.", "error");[m
[32m+[m[32m                }[m
[32m+[m[32m            });[m
[32m+[m[32m        }[m
[32m+[m
         //In-app and SMS Notification//[m
         const mainContent = document.querySelector(".main-content");[m
         if (mainContent) {[m
[36m@@ -3880,6 +4743,20 @@[m [mclass SuperAdminDashboard {[m
         const { rentSettingsTableBody, utilitySettingsTableBody } =[m
             this.elements;[m
         if (!rentSettingsTableBody || !utilitySettingsTableBody) return;[m
[32m+[m[41m        [m
[32m+[m[32m        // If no billing settings data, show loading message and fetch[m
[32m+[m[32m        if (!this.billingSettings || Object.keys(this.billingSettings).length === 0) {[m
[32m+[m[32m            rentSettingsTableBody.innerHTML = `[m
[32m+[m[32m                <tr><td colspan="4" class="text-center py-4 text-gray-500">Loading billing settings...</td></tr>[m
[32m+[m[32m            `;[m
[32m+[m[32m            utilitySettingsTableBody.innerHTML = `[m
[32m+[m[32m                <tr><td colspan="4" class="text-center py-4 text-gray-500">Loading billing settings...</td></tr>[m
[32m+[m[32m            `;[m
[32m+[m[32m            if (!isEditing) { // Only fetch if not already in edit mode[m
[32m+[m[32m                this.fetchBillingSettings();[m
[32m+[m[32m            }[m
[32m+[m[32m            return;[m
[32m+[m[32m        }[m
 [m
         const formatDisplay = (value) =>[m
             parseFloat(value) > 0[m
[36m@@ -4099,57 +4976,190 @@[m [mclass SuperAdminDashboard {[m
                 e.preventDefault();[m
                 this.saveAnnouncement();[m
             });[m
[32m+[m
[32m+[m[32m            // Handle recipient checkbox interactions[m
[32m+[m[32m            const allSectionsCheckbox = document.getElementById('recipientAllSections');[m
[32m+[m[32m            if (allSectionsCheckbox) {[m
[32m+[m[32m                allSectionsCheckbox.addEventListener('change', (e) => {[m
[32m+[m[32m                    const wetSection = document.getElementById('recipientWetSection');[m
[32m+[m[32m                    const drySection = document.getElementById('recipientDrySection');[m
[32m+[m[32m                    const semiWetSection = document.getElementById('recipientSemiWetSection');[m
[32m+[m[41m                    [m
[32m+[m[32m                    if (e.target.checked) {[m
[32m+[m[32m                        // Uncheck and disable specific sections when "All Sections" is checked[m
[32m+[m[32m                        if (wetSection) {[m
[32m+[m[32m                            wetSection.checked = false;[m
[32m+[m[32m                            wetSection.disabled = true;[m
[32m+[m[32m                        }[m
[32m+[m[32m                        if (drySection) {[m
[32m+[m[32m                            drySection.checked = false;[m
[32m+[m[32m                            drySection.disabled = true;[m
[32m+[m[32m                        }[m
[32m+[m[32m                        if (semiWetSection) {[m
[32m+[m[32m                            semiWetSection.checked = false;[m
[32m+[m[32m                            semiWetSection.disabled = true;[m
[32m+[m[32m                        }[m
[32m+[m[32m                    } else {[m
[32m+[m[32m                        // Enable specific sections when "All Sections" is unchecked[m
[32m+[m[32m                        if (wetSection) wetSection.disabled = false;[m
[32m+[m[32m                        if (drySection) drySection.disabled = false;[m
[32m+[m[32m                        if (semiWetSection) semiWetSection.disabled = false;[m
[32m+[m[32m                    }[m
[32m+[m[32m                });[m
[32m+[m
[32m+[m[32m                // Handle specific section checkboxes - uncheck "All Sections" when a specific section is selected[m
[32m+[m[32m                const specificSections = ['recipientWetSection', 'recipientDrySection', 'recipientSemiWetSection'];[m
[32m+[m[32m                specificSections.forEach(id => {[m
[32m+[m[32m                    const checkbox = document.getElementById(id);[m
[32m+[m[32m                    if (checkbox) {[m
[32m+[m[32m                        checkbox.addEventListener('change', (e) => {[m
[32m+[m[32m                            if (e.target.checked && allSectionsCheckbox.checked) {[m
[32m+[m[32m                                allSectionsCheckbox.checked = false;[m
[32m+[m[32m                                // Enable all specific sections[m
[32m+[m[32m                                specificSections.forEach(sid => {[m
[32m+[m[32m                                    const cb = document.getElementById(sid);[m
[32m+[m[32m                                    if (cb) cb.disabled = false;[m
[32m+[m[32m                                });[m
[32m+[m[32m                            }[m
[32m+[m[32m                        });[m
[32m+[m[32m                    }[m
[32m+[m[32m                });[m
[32m+[m[32m            }[m
         }[m
 [m
[31m-        if (this.elements.announcementsList) {[m
[31m-            this.elements.announcementsList.addEventListener("click", (e) => {[m
[32m+[m[32m        // Event listeners for sent announcements[m
[32m+[m[32m        if (this.elements.sentAnnouncementsList) {[m
[32m+[m[32m            this.elements.sentAnnouncementsList.addEventListener("click", (e) => {[m
[32m+[m[32m                const deleteBtn = e.target.closest(".delete-announcement-btn");[m
[32m+[m[32m                if (deleteBtn) {[m
[32m+[m[32m                    const id = deleteBtn.dataset.id;[m
[32m+[m[32m                    this.confirmDeleteAnnouncement(id);[m
[32m+[m[32m                }[m
[32m+[m[32m            });[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        // Event listeners for draft announcements[m
[32m+[m[32m        if (this.elements.draftAnnouncementsList) {[m
[32m+[m[32m            this.elements.draftAnnouncementsList.addEventListener("click", (e) => {[m
                 const deleteBtn = e.target.closest(".delete-announcement-btn");[m
                 if (deleteBtn) {[m
                     const id = deleteBtn.dataset.id;[m
                     this.confirmDeleteAnnouncement(id);[m
                 }[m
[32m+[m[41m                [m
[32m+[m[32m                const activateBtn = e.target.closest(".activate-announcement-btn");[m
[32m+[m[32m                if (activateBtn) {[m
[32m+[m[32m                    const id = activateBtn.dataset.id;[m
[32m+[m[32m                    this.activateAnnouncement(id);[m
[32m+[m[32m                }[m
             });[m
         }[m
     }[m
 [m
     async fetchAnnouncements() {[m
[31m-        if (!this.elements.announcementsList) return;[m
[32m+[m[32m        if (!this.elements.sentAnnouncementsList || !this.elements.draftAnnouncementsList) return;[m
 [m
         try {[m
             const response = await fetch("/api/admin/announcements");[m
             if (!response.ok) throw new Error("Failed to fetch announcements");[m
 [m
             const announcements = await response.json();[m
[31m-            this.renderAnnouncements(announcements);[m
[32m+[m[41m            [m
[32m+[m[32m            // Separate sent and draft announcements[m
[32m+[m[32m            const sentAnnouncements = announcements.filter(a => a.is_active);[m
[32m+[m[32m            const draftAnnouncements = announcements.filter(a => !a.is_active);[m
[32m+[m[41m            [m
[32m+[m[32m            this.renderSentAnnouncements(sentAnnouncements);[m
[32m+[m[32m            this.renderDraftAnnouncements(draftAnnouncements);[m
             this.dataLoaded.announcementSection = true;[m
         } catch (error) {[m
             console.error("Error fetching announcements:", error);[m
[31m-            this.elements.announcementsList.innerHTML = `[m
[32m+[m[32m            const errorHtml = `[m
                 <div class="text-center text-red-500 py-4">[m
                     <i class="fas fa-exclamation-circle mb-2"></i>[m
                     <p>Failed to load announcements.</p>[m
                 </div>`;[m
[32m+[m[32m            if (this.elements.sentAnnouncementsList) {[m
[32m+[m[32m                this.elements.sentAnnouncementsList.innerHTML = errorHtml;[m
[32m+[m[32m            }[m
[32m+[m[32m            if (this.elements.draftAnnouncementsList) {[m
[32m+[m[32m                this.elements.draftAnnouncementsList.innerHTML = errorHtml;[m
[32m+[m[32m            }[m
         }[m
     }[m
 [m
[31m-    renderAnnouncements(announcements) {[m
[31m-        if (!this.elements.announcementsList) return;[m
[32m+[m[32m    async loadAnnouncementRecipients() {[m
[32m+[m[32m        // Sections are now hardcoded in the form, no need to load dynamically[m
[32m+[m[32m        // This function is kept for potential future use[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    renderSentAnnouncements(announcements) {[m
[32m+[m[32m        if (!this.elements.sentAnnouncementsList) return;[m
 [m
         if (announcements.length === 0) {[m
[31m-            this.elements.announcementsList.innerHTML = `[m
[32m+[m[32m            this.elements.sentAnnouncementsList.innerHTML = `[m
                 <div class="text-center text-gray-500 py-8">[m
                     <i class="fas fa-bullhorn text-2xl mb-2 opacity-50"></i>[m
[31m-                    <p>No active announcements.</p>[m
[32m+[m[32m                    <p>No sent announcements.</p>[m
[32m+[m[32m                </div>`;[m
[32m+[m[32m            return;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        this.elements.sentAnnouncementsList.innerHTML = announcements.map(announcement => {[m
[32m+[m[32m            const date = new Date(announcement.created_at);[m
[32m+[m[32m            const dateStr = date.toLocaleDateString();[m
[32m+[m[32m            const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });[m
[32m+[m[41m            [m
[32m+[m[32m            return `[m
[32m+[m[32m            <div class="bg-gray-50 rounded-xl p-4 border border-gray-100 hover:shadow-md transition-shadow">[m
[32m+[m[32m                <div class="flex justify-between items-start mb-2">[m
[32m+[m[32m                    <h4 class="font-bold text-gray-800">${announcement.title}</h4>[m
[32m+[m[32m                    <div class="flex items-center gap-2">[m
[32m+[m[32m                        <span class="text-xs text-gray-500">${dateStr} ${timeStr}</span>[m
[32m+[m[32m                        <button data-id="${announcement.id}"[m[41m [m
[32m+[m[32m                            class="delete-announcement-btn text-red-500 hover:text-red-700 p-1 rounded transition-colors" title="Delete">[m
[32m+[m[32m                            <i class="fas fa-trash-alt"></i>[m
[32m+[m[32m                        </button>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                </div>[m
[32m+[m[32m                <p class="text-gray-600 text-sm whitespace-pre-wrap">${announcement.content}</p>[m
[32m+[m[32m                <div class="mt-2 flex items-center gap-2">[m
[32m+[m[32m                    <span class="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">[m
[32m+[m[32m                        Sent[m
[32m+[m[32m                    </span>[m
[32m+[m[32m                </div>[m
[32m+[m[32m            </div>[m
[32m+[m[32m        `;[m
[32m+[m[32m        }).join('');[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    renderDraftAnnouncements(announcements) {[m
[32m+[m[32m        if (!this.elements.draftAnnouncementsList) return;[m
[32m+[m
[32m+[m[32m        if (announcements.length === 0) {[m
[32m+[m[32m            this.elements.draftAnnouncementsList.innerHTML = `[m
[32m+[m[32m                <div class="text-center text-gray-500 py-8">[m
[32m+[m[32m                    <i class="fas fa-file-alt text-2xl mb-2 opacity-50"></i>[m
[32m+[m[32m                    <p>No draft announcements.</p>[m
                 </div>`;[m
             return;[m
         }[m
 [m
[31m-        this.elements.announcementsList.innerHTML = announcements.map(announcement => `[m
[32m+[m[32m        this.elements.draftAnnouncementsList.innerHTML = announcements.map(announcement => {[m
[32m+[m[32m            const date = new Date(announcement.created_at);[m
[32m+[m[32m            const dateStr = date.toLocaleDateString();[m
[32m+[m[32m            const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });[m
[32m+[m[41m            [m
[32m+[m[32m            return `[m
             <div class="bg-gray-50 rounded-xl p-4 border border-gray-100 hover:shadow-md transition-shadow">[m
                 <div class="flex justify-between items-start mb-2">[m
                     <h4 class="font-bold text-gray-800">${announcement.title}</h4>[m
                     <div class="flex items-center gap-2">[m
[31m-                        <span class="text-xs text-gray-500">${new Date(announcement.created_at).toLocaleDateString()}</span>[m
[32m+[m[32m                        <span class="text-xs text-gray-500">${dateStr} ${timeStr}</span>[m
[32m+[m[32m                        <button data-id="${announcement.id}"[m[41m [m
[32m+[m[32m                            class="activate-announcement-btn bg-market-primary text-white px-3 py-1 rounded text-xs font-medium hover:bg-market-secondary transition-colors" title="Send">[m
[32m+[m[32m                            <i class="fas fa-paper-plane mr-1"></i> Send[m
[32m+[m[32m                        </button>[m
                         <button data-id="${announcement.id}" [m
                             class="delete-announcement-btn text-red-500 hover:text-red-700 p-1 rounded transition-colors" title="Delete">[m
                             <i class="fas fa-trash-alt"></i>[m
[36m@@ -4158,12 +5168,13 @@[m [mclass SuperAdminDashboard {[m
                 </div>[m
                 <p class="text-gray-600 text-sm whitespace-pre-wrap">${announcement.content}</p>[m
                 <div class="mt-2 flex items-center gap-2">[m
[31m-                    <span class="px-2 py-1 rounded-full text-xs font-medium ${announcement.is_active ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}">[m
[31m-                        ${announcement.is_active ? 'Active' : 'Draft'}[m
[32m+[m[32m                    <span class="px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700">[m
[32m+[m[32m                        Draft[m
                     </span>[m
                 </div>[m
             </div>[m
[31m-        `).join('');[m
[32m+[m[32m        `;[m
[32m+[m[32m        }).join('');[m
     }[m
 [m
     async saveAnnouncement() {[m
[36m@@ -4177,6 +5188,30 @@[m [mclass SuperAdminDashboard {[m
             return;[m
         }[m
 [m
[32m+[m[32m        // Collect recipient data[m
[32m+[m[32m        const recipients = {[m
[32m+[m[32m            staff: document.getElementById('recipientStaff')?.checked || false,[m
[32m+[m[32m            all_sections: document.getElementById('recipientAllSections')?.checked || false,[m
[32m+[m[32m            sections: [][m
[32m+[m[32m        };[m
[32m+[m
[32m+[m[32m        // Get selected specific sections[m
[32m+[m[32m        if (document.getElementById('recipientWetSection')?.checked) {[m
[32m+[m[32m            recipients.sections.push('Wet Section');[m
[32m+[m[32m        }[m
[32m+[m[32m        if (document.getElementById('recipientDrySection')?.checked) {[m
[32m+[m[32m            recipients.sections.push('Dry Section');[m
[32m+[m[32m        }[m
[32m+[m[32m        if (document.getElementById('recipientSemiWetSection')?.checked) {[m
[32m+[m[32m            recipients.sections.push('Semi-Wet');[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // Validate that at least one recipient is selected[m
[32m+[m[32m        if (!recipients.staff && !recipients.all_sections && recipients.sections.length === 0) {[m
[32m+[m[32m            this.showToast("Please select at least one recipient.", "error");[m
[32m+[m[32m            return;[m
[32m+[m[32m        }[m
[32m+[m
         try {[m
             const originalBtnText = btn.innerHTML;[m
             btn.disabled = true;[m
[36m@@ -4191,7 +5226,8 @@[m [mclass SuperAdminDashboard {[m
                 body: JSON.stringify({[m
                     title,[m
                     content,[m
[31m-                    is_active: isActive[m
[32m+[m[32m                    is_active: isActive,[m
[32m+[m[32m                    recipients: recipients[m
                 }),[m
             });[m
 [m
[36m@@ -4199,6 +5235,12 @@[m [mclass SuperAdminDashboard {[m
 [m
             this.showToast("Announcement posted successfully!", "success");[m
             this.elements.createAnnouncementForm.reset();[m
[32m+[m[32m            // Reset recipient checkboxes[m
[32m+[m[32m            document.getElementById('recipientStaff').checked = true;[m
[32m+[m[32m            document.getElementById('recipientAllSections').checked = true;[m
[32m+[m[32m            document.getElementById('recipientWetSection').checked = false;[m
[32m+[m[32m            document.getElementById('recipientDrySection').checked = false;[m
[32m+[m[32m            document.getElementById('recipientSemiWetSection').checked = false;[m
             this.fetchAnnouncements(); // Refresh list[m
 [m
         } catch (error) {[m
[36m@@ -4252,6 +5294,29 @@[m [mclass SuperAdminDashboard {[m
             this.showToast("Failed to delete announcement", "error");[m
         }[m
     }[m
[32m+[m
[32m+[m[32m    async activateAnnouncement(id) {[m
[32m+[m[32m        try {[m
[32m+[m[32m            const response = await fetch(`/api/admin/announcements/${id}`, {[m
[32m+[m[32m                method: "PUT",[m
[32m+[m[32m                headers: {[m
[32m+[m[32m                    "Content-Type": "application/json",[m
[32m+[m[32m                    "X-CSRF-TOKEN": document.querySelector('meta[name="csrf-token"]').getAttribute("content"),[m
[32m+[m[32m                },[m
[32m+[m[32m                body: JSON.stringify({[m
[32m+[m[32m                    is_active: true,[m
[32m+[m[32m                }),[m
[32m+[m[32m            });[m
[32m+[m
[32m+[m[32m            if (!response.ok) throw new Error("Failed to activate announcement");[m
[32m+[m
[32m+[m[32m            this.showToast("Announcement sent successfully!", "success");[m
[32m+[m[32m            this.fetchAnnouncements();[m
[32m+[m[32m        } catch (error) {[m
[32m+[m[32m            console.error("Error sending announcement:", error);[m
[32m+[m[32m            this.showToast("Failed to send announcement", "error");[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
 }[m
 [m
 document.addEventListener("DOMContentLoaded", () => {[m
[1mdiff --git a/resources/js/vendor.js b/resources/js/vendor.js[m
[1mindex e98d9ae..699556e 100644[m
[1m--- a/resources/js/vendor.js[m
[1m+++ b/resources/js/vendor.js[m
[36m@@ -1,5 +1,9 @@[m
 // In: js/vendor.js[m
 [m
[32m+[m[32mimport Chart from "chart.js/auto";[m
[32m+[m
[32m+[m[32mwindow.Chart = Chart;[m
[32m+[m
 class Dashboard {[m
     constructor(initialData) {[m
         this.helpers = {[m
[36m@@ -53,6 +57,12 @@[m [mclass Dashboard {[m
             this.fetchAndRenderPayments.bind(this),[m
             300[m
         );[m
[32m+[m[32m        this.charts = {};[m
[32m+[m[32m        this.notifications = {[m
[32m+[m[32m            list: [],[m
[32m+[m[32m            unreadCount: 0,[m
[32m+[m[32m            allNotifications: [],[m
[32m+[m[32m        };[m
     }[m
 [m
     cacheDOMElements() {[m
[36m@@ -82,6 +92,20 @@[m [mclass Dashboard {[m
                 "billBreakdownDetails"[m
             ),[m
             homeContent: document.getElementById("homeContent"),[m
[32m+[m[32m            analyticsContent: document.getElementById("analyticsContent"),[m
[32m+[m[32m            electricityChart: document.getElementById("electricityConsumptionChart"),[m
[32m+[m[32m            paymentStatusChart: document.getElementById("paymentStatusChart"),[m
[32m+[m[32m            paymentTimelineChart: document.getElementById("paymentTimelineChart"),[m
[32m+[m[32m            changePasswordForm: document.getElementById("changePasswordForm"),[m
[32m+[m[32m            changePasswordBtn: document.getElementById("changePasswordBtn"),[m
[32m+[m[32m            profileSectionImg: document.getElementById("profileSectionImg"),[m
[32m+[m[32m            profileSectionIcon: document.getElementById("profileSectionIcon"),[m
[32m+[m[32m            notificationsLoader: document.getElementById("notificationsLoader"),[m
[32m+[m[32m            notificationsList: document.getElementById("notificationsList"),[m
[32m+[m[32m            noNotificationsMessage: document.getElementById("noNotificationsMessage"),[m
[32m+[m[32m            markAllAsReadBtn: document.getElementById("markAllAsReadBtn"),[m
[32m+[m[32m            unreadCountBadge: document.getElementById("unreadCountBadge"),[m
[32m+[m[32m            unreadCountText: document.getElementById("unreadCountText"),[m
         };[m
     }[m
 [m
[36m@@ -90,13 +114,22 @@[m [mclass Dashboard {[m
             typeof isStaffView !== "undefined" && isStaffView[m
                 ? "all"[m
                 : new Date().getMonth() + 1;[m
[32m+[m[32m        // Pre-load payment history from server if available[m
[32m+[m[32m        const initialPaymentHistory = typeof paymentHistoryInitialData !== 'undefined'[m[41m [m
[32m+[m[32m            ? paymentHistoryInitialData[m[41m [m
[32m+[m[32m            : { data: [], total: 0, has_more: false };[m
[32m+[m[41m        [m
         const state = {[m
             searchTerm: "",[m
             selectedYear: new Date().getFullYear(),[m
             selectedMonth: defaultMonth,[m
             isOutstandingModalOpen: false,[m
             activeSection: "homeSection",[m
[31m-            paymentHistory: [],[m
[32m+[m[32m            paymentHistory: [], // Will be set after formatPaymentHistory is available[m
[32m+[m[32m            paymentHistoryPage: initialPaymentHistory.current_page || 1,[m
[32m+[m[32m            paymentHistoryHasMore: initialPaymentHistory.has_more || false,[m
[32m+[m[32m            paymentHistoryTotal: initialPaymentHistory.total || 0,[m
[32m+[m[32m            paymentHistoryInitialData: initialPaymentHistory, // Store raw data for later formatting[m
             modalBills: [],[m
             isLoading: false,[m
         };[m
[36m@@ -112,6 +145,19 @@[m [mclass Dashboard {[m
                 }[m
                 if (property === "activeSection") {[m
                     this.renderActiveSection();[m
[32m+[m[32m                    // Update notifications when section changes[m
[32m+[m[32m                    this.renderNotificationDropdown();[m
[32m+[m[32m                    // Fetch fresh notifications when section changes[m
[32m+[m[32m                    this.fetchNotifications();[m
[32m+[m[32m                    // Load analytics when section is shown[m
[32m+[m[32m                    if (target.activeSection === "analyticsSection") {[m
[32m+[m[32m                        this.loadAnalytics();[m
[32m+[m[32m                    }[m
[32m+[m[32m                    // Load all notifications when notifications section is shown[m
[32m+[m[32m                    if (target.activeSection === "notificationsSection") {[m
[32m+[m[32m                        this.loadAllNotifications();[m
[32m+[m[32m                        this.setupNotificationsEventListeners();[m
[32m+[m[32m                    }[m
                 }[m
                 if (property === "paymentHistory") {[m
                     this.renderPaymentHistory();[m
[36m@@ -133,11 +179,36 @@[m [mclass Dashboard {[m
         if (this.elements.yearDropdown) {[m
             await this.populateYearFilter();[m
             this.setDefaultFilters();[m
[31m-            await this.fetchAndRenderPayments();[m
[32m+[m[41m            [m
[32m+[m[32m            // If we have pre-loaded payment history data, format and render it immediately[m
[32m+[m[32m            if (this.state.paymentHistoryInitialData && this.state.paymentHistoryInitialData.data && this.state.paymentHistoryInitialData.data.length > 0) {[m
[32m+[m[32m                this.state.paymentHistory = this.formatPaymentHistory(this.state.paymentHistoryInitialData.data);[m
[32m+[m[32m                this.state.paymentHistoryPage = this.state.paymentHistoryInitialData.current_page || 1;[m
[32m+[m[32m                this.state.paymentHistoryHasMore = this.state.paymentHistoryInitialData.has_more || false;[m
[32m+[m[32m                this.state.paymentHistoryTotal = this.state.paymentHistoryInitialData.total || 0;[m
[32m+[m[32m                this.renderPaymentHistory();[m
[32m+[m[32m            } else {[m
[32m+[m[32m                // Otherwise fetch it[m
[32m+[m[32m                await this.fetchAndRenderPayments(1);[m
[32m+[m[32m            }[m
         }[m
[32m+[m[32m        // Announcements are now shown as notifications in the bell dropdown[m
[32m+[m[32m        await this.fetchNotifications();[m
[32m+[m[32m        // Announcement banner removed - announcements now appear as notifications in the bell dropdown[m
         setInterval(this.checkForUpdates.bind(this), 5000);[m
[32m+[m[32m        // Poll for notifications every 2 seconds for faster updates[m
[32m+[m[32m        setInterval(this.fetchNotifications.bind(this), 2000);[m
[32m+[m[41m        [m
[32m+[m[32m        // Also fetch immediately when page becomes visible (user switches tabs/windows)[m
[32m+[m[32m        document.addEventListener('visibilitychange', () => {[m
[32m+[m[32m            if (!document.hidden) {[m
[32m+[m[32m                this.fetchNotifications();[m
[32m+[m[32m            }[m
[32m+[m[32m        });[m
     }[m
 [m
[32m+[m[32m    // Announcement banner removed - announcements now appear as notifications in the bell dropdown[m
[32m+[m
     async checkForUpdates() {[m
         try {[m
             const url =[m
[36m@@ -202,8 +273,6 @@[m [mclass Dashboard {[m
                 <td data-label="Period Covered" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">${item.period}</td>[m
                 <td data-label="Bill Amount" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">${item.amount}</td>[m
                 <td data-label="Due Date" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">${item.dueDate}</td>[m
[31m-                <td data-label="Amount After Due" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">${item.amountAfterDue}</td>[m
[31m-                <td data-label="Disconnection Date" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">${item.disconnectionDate}</td>[m
                 <td data-label="Payment Status" class="px-6 py-4 whitespace-nowrap text-center text-sm">[m
                     <span class="status-badge status-paid">${item.statusText}</span>[m
                 </td>[m
[36m@@ -213,14 +282,59 @@[m [mclass Dashboard {[m
             .join("");[m
 [m
         paymentTableBody.innerHTML = rowsHtml;[m
[32m+[m[41m        [m
[32m+[m[32m        // Add pagination controls if there are more pages[m
[32m+[m[32m        this.renderPaymentHistoryPagination();[m
[32m+[m[32m    }[m
[32m+[m[41m    [m
[32m+[m[32m    renderPaymentHistoryPagination() {[m
[32m+[m[32m        // Remove existing pagination if any[m
[32m+[m[32m        const existingPagination = document.getElementById('paymentHistoryPagination');[m
[32m+[m[32m        if (existingPagination) {[m
[32m+[m[32m            existingPagination.remove();[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        if (!this.state.paymentHistoryHasMore && this.state.paymentHistoryTotal <= 20) {[m
[32m+[m[32m            return; // No pagination needed[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        const tableContainer = this.elements.singleTableContainer;[m
[32m+[m[32m        if (!tableContainer) return;[m
[32m+[m[41m        [m
[32m+[m[32m        const paginationHtml = `[m
[32m+[m[32m            <div id="paymentHistoryPagination" class="mt-4 flex items-center justify-between">[m
[32m+[m[32m                <div class="text-sm text-gray-700">[m
[32m+[m[32m                    Showing ${this.state.paymentHistory.length} of ${this.state.paymentHistoryTotal} records[m
[32m+[m[32m                </div>[m
[32m+[m[32m                ${this.state.paymentHistoryHasMore ? `[m
[32m+[m[32m                    <button[m[41m [m
[32m+[m[32m                        id="loadMorePaymentsBtn"[m[41m [m
[32m+[m[32m                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"[m
[32m+[m[32m                    >[m
[32m+[m[32m                        <i class="fas fa-arrow-down mr-2"></i>Load More[m
[32m+[m[32m                    </button>[m
[32m+[m[32m                ` : ''}[m
[32m+[m[32m            </div>[m
[32m+[m[32m        `;[m
[32m+[m[41m        [m
[32m+[m[32m        tableContainer.insertAdjacentHTML('beforeend', paginationHtml);[m
[32m+[m[41m        [m
[32m+[m[32m        // Add event listener for load more button[m
[32m+[m[32m        const loadMoreBtn = document.getElementById('loadMorePaymentsBtn');[m
[32m+[m[32m        if (loadMoreBtn) {[m
[32m+[m[32m            loadMoreBtn.addEventListener('click', () => {[m
[32m+[m[32m                this.fetchAndRenderPayments(this.state.paymentHistoryPage + 1);[m
[32m+[m[32m            });[m
[32m+[m[32m        }[m
     }[m
 [m
[31m-    async fetchAndRenderPayments() {[m
[32m+[m[32m    async fetchAndRenderPayments(page = 1) {[m
         const { selectedYear, selectedMonth, searchTerm } = this.state;[m
         const query = new URLSearchParams({[m
             year: selectedYear,[m
             month: selectedMonth,[m
             search: searchTerm,[m
[32m+[m[32m            page: page,[m
         });[m
         let url =[m
             typeof isStaffView !== "undefined" && isStaffView[m
[36m@@ -228,14 +342,48 @@[m [mclass Dashboard {[m
                 : `/api/vendor/payments?${query}`;[m
 [m
         try {[m
[32m+[m[32m            // Show loading state[m
[32m+[m[32m            const tableBody = this.elements.paymentTableBody;[m
[32m+[m[32m            if (tableBody && page === 1) {[m
[32m+[m[32m                tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-indigo-500"></i> Loading...</td></tr>`;[m
[32m+[m[32m            }[m
[32m+[m
             const response = await fetch(url);[m
             if (!response.ok)[m
                 throw new Error(`HTTP error! Status: ${response.status}`);[m
             const data = await response.json();[m
[31m-            this.state.paymentHistory = this.formatPaymentHistory(data);[m
[32m+[m[41m            [m
[32m+[m[32m            // Handle paginated response[m
[32m+[m[32m            if (data.data) {[m
[32m+[m[32m                const formattedData = this.formatPaymentHistory(data.data);[m
[32m+[m[32m                if (page === 1) {[m
[32m+[m[32m                    // First page - replace data[m
[32m+[m[32m                    this.state.paymentHistory = formattedData;[m
[32m+[m[32m                } else {[m
[32m+[m[32m                    // Subsequent pages - append data[m
[32m+[m[32m                    this.state.paymentHistory = [...this.state.paymentHistory, ...formattedData];[m
[32m+[m[32m                }[m
[32m+[m[32m                this.state.paymentHistoryPage = data.current_page || 1;[m
[32m+[m[32m                this.state.paymentHistoryHasMore = data.has_more || false;[m
[32m+[m[32m                this.state.paymentHistoryTotal = data.total || 0;[m
[32m+[m[32m            } else {[m
[32m+[m[32m                // Fallback for non-paginated responses[m
[32m+[m[32m                this.state.paymentHistory = this.formatPaymentHistory(data);[m
[32m+[m[32m                this.state.paymentHistoryPage = 1;[m
[32m+[m[32m                this.state.paymentHistoryHasMore = false;[m
[32m+[m[32m                this.state.paymentHistoryTotal = data.length || 0;[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
[32m+[m[32m            this.renderPaymentHistory();[m
         } catch (error) {[m
             console.error("Failed to fetch payment history:", error);[m
[31m-            this.state.paymentHistory = [];[m
[32m+[m[32m            if (page === 1) {[m
[32m+[m[32m                this.state.paymentHistory = [];[m
[32m+[m[32m            }[m
[32m+[m[32m            const tableBody = this.elements.paymentTableBody;[m
[32m+[m[32m            if (tableBody && page === 1) {[m
[32m+[m[32m                tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-8 text-red-500">Failed to load payment history. Please try again.</td></tr>`;[m
[32m+[m[32m            }[m
         }[m
     }[m
 [m
[36m@@ -330,154 +478,198 @@[m [mclass Dashboard {[m
         this.elements.monthDropdown.value = this.state.selectedMonth;[m
     }[m
 [m
[31m- renderOutstandingModal() {[m
[31m-    // Safety check: ensure elements are initialized[m
[31m-    if (!this.elements || !this.elements.outstandingDetailsModal) {[m
[31m-        console.warn("Modal elements not yet initialized");[m
[31m-        return;[m
[31m-    }[m
[31m-    [m
[31m-    const modal = this.elements.outstandingDetailsModal;[m
[31m-    if (!modal) return;[m
[31m-[m
[31m-    if (this.state.isOutstandingModalOpen) {[m
[31m-        const detailsBody = this.elements.outstandingBreakdownDetails;[m
[31m-        const billsToDisplay = this.state.modalBills || [];[m
[31m-[m
[31m-        if (billsToDisplay.length > 0) {[m
[31m-            // Initialize totals[m
[31m-            let totalOriginal = 0;[m
[31m-            let totalDiscount = 0;[m
[31m-            let totalSurcharge = 0;[m
[31m-            let totalAmount = 0;[m
[31m-[m
[31m-            detailsBody.innerHTML = billsToDisplay[m
[31m-                .map((bill) => {[m
[31m-                    const originalAmount = parseFloat(bill.original_amount);[m
[31m-                    const penaltyApplied = parseFloat(bill.penalty_applied || 0);[m
[31m-                    const discountApplied = parseFloat(bill.discount_applied || 0);[m
[31m-[m
[31m-                    let baseAmountForCalc = originalAmount;[m
[31m-                    let detailsHtml = `<strong>${this.helpers.formatCurrency(originalAmount)}</strong>`;[m
[31m-[m
[31m-                    // Calculate Original Payment with formula[m
[31m-                    if (bill.utility_type === "Rent" && stallData) {[m
[31m-                        const dailyRate = parseFloat(stallData.daily_rate || 0);[m
[31m-                        const area = parseFloat(stallData.area || 0);[m
[31m-                        [m
[31m-                        // Check if vendor is in Dry Section (has area)[m
[31m-                        if (area > 0) {[m
[31m-                            // Dry Section: (area Ã— rate_per_sqm) Ã— 30[m
[31m-                            const calculatedAmount = (area * dailyRate) * 30;[m
[31m-                            baseAmountForCalc = calculatedAmount;[m
[31m-                            detailsHtml = `(${area.toFixed(2)} mÂ² x ${this.helpers.formatCurrency(dailyRate)}) x 30 days = <strong>${this.helpers.formatCurrency(calculatedAmount)}</strong>`;[m
[31m-                        } else {[m
[31m-                            // Regular Section: daily_rate Ã— 30[m
[31m-                            const calculatedAmount = dailyRate * 30;[m
[32m+[m[32m    renderOutstandingModal() {[m
[32m+[m[32m        // Safety check: ensure elements are initialized[m
[32m+[m[32m        if (!this.elements || !this.elements.outstandingDetailsModal) {[m
[32m+[m[32m            console.warn("Modal elements not yet initialized");[m
[32m+[m[32m            return;[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        const modal = this.elements.outstandingDetailsModal;[m
[32m+[m[32m        if (!modal) return;[m
[32m+[m
[32m+[m[32m        if (this.state.isOutstandingModalOpen) {[m
[32m+[m[32m            const detailsBody = this.elements.outstandingBreakdownDetails;[m
[32m+[m[32m            const billsToDisplay = this.state.modalBills || [];[m
[32m+[m
[32m+[m[32m            if (billsToDisplay.length > 0) {[m
[32m+[m[32m                // Initialize totals[m
[32m+[m[32m                let totalOriginal = 0;[m
[32m+[m[32m                let totalDiscount = 0;[m
[32m+[m[32m                let totalSurcharge = 0;[m
[32m+[m[32m                let totalAmount = 0;[m
[32m+[m
[32m+[m[32m                detailsBody.innerHTML = billsToDisplay[m
[32m+[m[32m                    .map((bill) => {[m
[32m+[m[32m                        const originalAmount = parseFloat(bill.original_amount);[m
[32m+[m[32m                        const penaltyApplied = parseFloat(bill.penalty_applied || 0);[m
[32m+[m[32m                        const discountApplied = parseFloat(bill.discount_applied || 0);[m
[32m+[m
[32m+[m[32m                        let baseAmountForCalc = originalAmount;[m
[32m+[m[32m                        let detailsHtml = `<strong>${this.helpers.formatCurrency(originalAmount)}</strong>`;[m
[32m+[m
[32m+[m[32m                        // Calculate Original Payment with formula[m
[32m+[m[32m                        if (bill.utility_type === "Rent" && stallData) {[m
[32m+[m[32m                            const dailyRate = parseFloat(stallData.daily_rate || 0);[m
[32m+[m[32m                            const area = parseFloat(stallData.area || 0);[m
[32m+[m[41m                            [m
[32m+[m[32m                            // Check if vendor is in Dry Section (has area)[m
[32m+[m[32m                            if (area > 0) {[m
[32m+[m[32m                                // Dry Section: (area Ã— rate_per_sqm) Ã— 30[m
[32m+[m[32m                                const calculatedAmount = (area * dailyRate) * 30;[m
[32m+[m[32m                                baseAmountForCalc = calculatedAmount;[m
[32m+[m[32m                                detailsHtml = `(${area.toFixed(2)} mÂ² x ${this.helpers.formatCurrency(dailyRate)}) x 30 days = <strong>${this.helpers.formatCurrency(calculatedAmount)}</strong>`;[m
[32m+[m[32m                            } else {[m
[32m+[m[32m                                // Regular Section: daily_rate Ã— 30[m
[32m+[m[32m                                const calculatedAmount = dailyRate * 30;[m
[32m+[m[32m                                baseAmountForCalc = calculatedAmount;[m
[32m+[m[32m                                detailsHtml = `${this.helpers.formatCurrency(dailyRate)} x 30 days = <strong>${this.helpers.formatCurrency(calculatedAmount)}</strong>`;[m
[32m+[m[32m                            }[m
[32m+[m[32m                        } else if (bill.utility_type === "Water") {[m
[32m+[m[32m                            const daysInMonth = new Date(bill.period_end).getDate();[m
[32m+[m[32m                            // Get rate from database, or calculate backwards from stored amount[m
[32m+[m[32m                            let waterRate = utilityRatesData?.Water?.rate || 0;[m
[32m+[m[32m                            if (waterRate === 0 && originalAmount > 0 && daysInMonth > 0) {[m
[32m+[m[32m                                // Calculate rate backwards from stored amount[m
[32m+[m[32m                                waterRate = originalAmount / daysInMonth;[m
[32m+[m[32m                            }[m
[32m+[m[32m                            const calculatedAmount = waterRate * daysInMonth;[m
                             baseAmountForCalc = calculatedAmount;[m
[31m-                            detailsHtml = `${this.helpers.formatCurrency(dailyRate)} x 30 days = <strong>${this.helpers.formatCurrency(calculatedAmount)}</strong>`;[m
[32m+[m[32m                            // Always display as formula: rate x days = amount[m
[32m+[m[32m                            detailsHtml = `${this.helpers.formatCurrency(waterRate)} x ${daysInMonth} days = <strong>${this.helpers.formatCurrency(calculatedAmount)}</strong>`;[m
[32m+[m[32m                        } else if (bill.utility_type === "Electricity") {[m
[32m+[m[32m                            // Priority 1: Use bill.consumption if available (most accurate)[m
[32m+[m[32m                            // Priority 2: Calculate from current_reading - previous_reading[m
[32m+[m[32m                            // Priority 3: Only calculate backwards if both are missing[m
[32m+[m[32m                            let consumption = null;[m
[32m+[m[32m                            if (bill.consumption !== null && bill.consumption !== undefined && !isNaN(parseFloat(bill.consumption))) {[m
[32m+[m[32m                                consumption = parseFloat(bill.consumption);[m
[32m+[m[32m                            } else if (bill.current_reading !== null && bill.previous_reading !== null) {[m
[32m+[m[32m                                consumption = (parseFloat(bill.current_reading) || 0) - (parseFloat(bill.previous_reading) || 0);[m
[32m+[m[32m                            } else {[m
[32m+[m[32m                                consumption = 0;[m
[32m+[m[32m                            }[m
[32m+[m[41m                            [m
[32m+[m[32m                            // Get rate: Priority 1: bill.rate, Priority 2: database rate[m
[32m+[m[32m                            let electricityRate = bill.rate || utilityRatesData?.Electricity?.rate || 0;[m
[32m+[m[41m                            [m
[32m+[m[32m                            // Only calculate backwards if we're missing actual data[m
[32m+[m[32m                            if (consumption === 0 && originalAmount > 0) {[m
[32m+[m[32m                                // If we have a rate, calculate consumption from amount[m
[32m+[m[32m                                if (electricityRate > 0) {[m
[32m+[m[32m                                    consumption = originalAmount / electricityRate;[m
[32m+[m[32m                                } else {[m
[32m+[m[32m                                    // If no rate, try to get it from database[m
[32m+[m[32m                                    electricityRate = utilityRatesData?.Electricity?.rate || 0;[m
[32m+[m[32m                                    if (electricityRate > 0) {[m
[32m+[m[32m                                        consumption = originalAmount / electricityRate;[m
[32m+[m[32m                                    }[m
[32m+[m[32m                                }[m
[32m+[m[32m                            } else if (electricityRate === 0 && originalAmount > 0 && consumption > 0) {[m
[32m+[m[32m                                // If we have consumption but no rate, calculate rate from amount[m
[32m+[m[32m                                electricityRate = originalAmount / consumption;[m
[32m+[m[32m                            }[m
[32m+[m[41m                            [m
[32m+[m[32m                            // Calculate amount from consumption Ã— rate[m
[32m+[m[32m                            const calculatedAmount = consumption * electricityRate;[m
[32m+[m[32m                            baseAmountForCalc = calculatedAmount > 0 ? calculatedAmount : originalAmount;[m
[32m+[m[41m                            [m
[32m+[m[32m                            // Always display as formula: (consumption kWh) x rate = amount[m
[32m+[m[32m                            detailsHtml = `(${consumption.toFixed(2)} kWh) x ${this.helpers.formatCurrency(electricityRate)} = <strong>${this.helpers.formatCurrency(calculatedAmount > 0 ? calculatedAmount : originalAmount)}</strong>`;[m
                         }[m
[31m-                    } else if (bill.utility_type === "Water" && utilityRatesData.Water) {[m
[31m-                        const daysInMonth = new Date(bill.period_end).getDate();[m
[31m-                        const calculatedAmount = (utilityRatesData.Water.rate || 0) * daysInMonth;[m
[31m-                        baseAmountForCalc = calculatedAmount;[m
[31m-                        detailsHtml = `${this.helpers.formatCurrency(utilityRatesData.Water.rate || 0)} x ${daysInMonth} days = <strong>${this.helpers.formatCurrency(calculatedAmount)}</strong>`;[m
[31m-                    } else if (bill.utility_type === "Electricity") {[m
[31m-                        const consumption = (bill.current_reading || 0) - (bill.previous_reading || 0);[m
[31m-                        detailsHtml = `(${consumption.toFixed(2)} kWh) x ${this.helpers.formatCurrency(bill.rate || 0)} = <strong>${this.helpers.formatCurrency(originalAmount)}</strong>`;[m
[31m-                    }[m
 [m
[31m-                    // ===== Discount Column with Formula =====[m
[31m-                    let discountHtml = '-';[m
[31m-                    if (discountApplied > 0 && billingSettingsData) {[m
[31m-                        const settings = billingSettingsData[bill.utility_type];[m
[31m-                        if (settings && settings.discount_rate) {[m
[31m-                            const discountRate = parseFloat(settings.discount_rate);[m
[31m-                            discountHtml = `<strong class="text-green-600">${this.helpers.formatCurrency(baseAmountForCalc)} x ${(discountRate * 100).toFixed(0)}% = -${this.helpers.formatCurrency(discountApplied)}</strong>`;[m
[31m-                        } else {[m
[31m-                            discountHtml = `<strong class="text-green-600">-${this.helpers.formatCurrency(discountApplied)}</strong>`;[m
[32m+[m[32m                        // ===== Discount Column with Formula =====[m
[32m+[m[32m                        let discountHtml = '-';[m
[32m+[m[32m                        if (discountApplied > 0 && billingSettingsData) {[m
[32m+[m[32m                            const settings = billingSettingsData[bill.utility_type];[m
[32m+[m[32m                            if (settings && settings.discount_rate) {[m
[32m+[m[32m                                const discountRate = parseFloat(settings.discount_rate);[m
[32m+[m[32m                                discountHtml = `<strong class="text-green-600">${this.helpers.formatCurrency(baseAmountForCalc)} x ${(discountRate * 100).toFixed(0)}% = -${this.helpers.formatCurrency(discountApplied)}</strong>`;[m
[32m+[m[32m                            } else {[m
[32m+[m[32m                                discountHtml = `<strong class="text-green-600">-${this.helpers.formatCurrency(discountApplied)}</strong>`;[m
[32m+[m[32m                            }[m
                         }[m
[31m-                    }[m
 [m
[31m-                    // ===== Surcharge/Penalty Column with Formula =====[m
[31m-                    let penaltyHtml = '-';[m
[31m-                    if (penaltyApplied > 0 && billingSettingsData) {[m
[31m-                        const settings = billingSettingsData[bill.utility_type];[m
[31m-                        if (settings && bill.utility_type === 'Rent') {[m
[31m-                            // For Rent: Show surcharge + interest breakdown[m
[31m-                            const surchargeRate = parseFloat(settings.surcharge_rate || 0);[m
[31m-                            const interestRate = parseFloat(settings.monthly_interest_rate || 0);[m
[31m-                            const interestMonths = parseInt(bill.interest_months || 0);[m
[31m-                            [m
[31m-                            const surchargeAmount = baseAmountForCalc * surchargeRate;[m
[31m-                            const interestAmount = baseAmountForCalc * interestRate * interestMonths;[m
[31m-                            [m
[31m-                            penaltyHtml = `<strong class="text-red-600">Surcharge (${(surchargeRate * 100).toFixed(0)}%): + ${this.helpers.formatCurrency(surchargeAmount)}<br>`;[m
[31m-                            penaltyHtml += `Interest (${(interestRate * 100).toFixed(0)}% x ${interestMonths} mo): + ${this.helpers.formatCurrency(interestAmount)}<br>`;[m
[31m-                            penaltyHtml += `--- Total Penalty: + ${this.helpers.formatCurrency(penaltyApplied)}</strong>`;[m
[31m-                        } else if (settings && settings.penalty_rate) {[m
[31m-                            // For Utilities with penalty rate configured[m
[31m-                            const penaltyRate = parseFloat(settings.penalty_rate);[m
[31m-                            penaltyHtml = `<strong class="text-red-600">Penalty (${(penaltyRate * 100).toFixed(0)}%): + ${this.helpers.formatCurrency(penaltyApplied)}</strong>`;[m
[31m-                        } else {[m
[31m-                            // Fallback: just show the amount[m
[31m-                            penaltyHtml = `<strong class="text-red-600">+ ${this.helpers.formatCurrency(penaltyApplied)}</strong>`;[m
[32m+[m[32m                        // ===== Surcharge/Penalty Column with Formula =====[m
[32m+[m[32m                        let penaltyHtml = '-';[m
[32m+[m[32m                        if (penaltyApplied > 0 && billingSettingsData) {[m
[32m+[m[32m                            const settings = billingSettingsData[bill.utility_type];[m
[32m+[m[32m                            if (settings && bill.utility_type === 'Rent') {[m
[32m+[m[32m                                // For Rent: Show surcharge + interest breakdown[m
[32m+[m[32m                                const surchargeRate = parseFloat(settings.surcharge_rate || 0);[m
[32m+[m[32m                                const interestRate = parseFloat(settings.monthly_interest_rate || 0);[m
[32m+[m[32m                                const interestMonths = parseInt(bill.interest_months || 0);[m
[32m+[m[41m                                [m
[32m+[m[32m                                const surchargeAmount = baseAmountForCalc * surchargeRate;[m
[32m+[m[32m                                const interestAmount = baseAmountForCalc * interestRate * interestMonths;[m
[32m+[m[41m                                [m
[32m+[m[32m                                penaltyHtml = `<strong class="text-red-600">Surcharge (${(surchargeRate * 100).toFixed(0)}%): + ${this.helpers.formatCurrency(surchargeAmount)}<br>`;[m
[32m+[m[32m                                penaltyHtml += `Interest (${(interestRate * 100).toFixed(0)}% x ${interestMonths} mo): + ${this.helpers.formatCurrency(interestAmount)}<br>`;[m
[32m+[m[32m                                penaltyHtml += `--- Total Penalty: + ${this.helpers.formatCurrency(penaltyApplied)}</strong>`;[m
[32m+[m[32m                            } else if (settings && settings.penalty_rate) {[m
[32m+[m[32m                                // For Utilities with penalty rate configured[m
[32m+[m[32m                                const penaltyRate = parseFloat(settings.penalty_rate);[m
[32m+[m[32m                                penaltyHtml = `<strong class="text-red-600">Penalty (${(penaltyRate * 100).toFixed(0)}%): + ${this.helpers.formatCurrency(penaltyApplied)}</strong>`;[m
[32m+[m[32m                            } else {[m
[32m+[m[32m                                // Fallback: just show the amount[m
[32m+[m[32m                                penaltyHtml = `<strong class="text-red-600">+ ${this.helpers.formatCurrency(penaltyApplied)}</strong>`;[m
[32m+[m[32m                            }[m
                         }[m
[31m-                    }[m
 [m
[31m-                    const finalTotal = parseFloat(bill.display_amount_due || 0);[m
[31m-                    [m
[31m-                    // Add to totals[m
[31m-                    totalOriginal += baseAmountForCalc;[m
[31m-                    totalDiscount += discountApplied;[m
[31m-                    totalSurcharge += penaltyApplied;[m
[31m-                    totalAmount += finalTotal;[m
[31m-                    [m
[31m-                    const categoryText = bill.utility_type === 'Rent'[m
[31m-                        ? `Rent<br><span class="text-sm font-normal text-gray-500">(Standard Payment)</span>`[m
[31m-                        : bill.utility_type;[m
[31m-[m
[31m-                    return `[m
[31m-                        <tr class="text-lg border-b border-gray-200">[m
[31m-                            <td class="px-4 py-3 align-top font-bold">${categoryText}</td>[m
[31m-                            <td class="px-4 py-3 align-top">${detailsHtml}</td>[m
[31m-                            <td class="px-4 py-3 align-top">${discountHtml}</td>[m
[31m-                            <td class="px-4 py-3 align-top">${penaltyHtml}</td>[m
[31m-                            <td class="px-4 py-3 align-top font-bold text-market-primary">${this.helpers.formatCurrency(finalTotal)}</td>[m
[31m-                        </tr>[m
[31m-                    `;[m
[31m-                })[m
[31m-                .join("");[m
[31m-[m
[31m-            // Update footer totals[m
[31m-            const totalOriginalEl = document.getElementById('totalOriginalPayment');[m
[31m-            const totalDiscountEl = document.getElementById('totalDiscount');[m
[31m-            const totalSurchargeEl = document.getElementById('totalSurcharge');[m
[31m-            const totalAmountDueEl = document.getElementById('totalAmountDue');[m
[31m-[m
[31m-            if (totalOriginalEl) totalOriginalEl.textContent = this.helpers.formatCurrency(totalOriginal);[m
[31m-            if (totalDiscountEl) totalDiscountEl.textContent = totalDiscount > 0 ? `-${this.helpers.formatCurrency(totalDiscount)}` : this.helpers.formatCurrency(0);[m
[31m-            if (totalSurchargeEl) totalSurchargeEl.textContent = this.helpers.formatCurrency(totalSurcharge);[m
[31m-            if (totalAmountDueEl) totalAmountDueEl.textContent = this.helpers.formatCurrency(totalAmount);[m
[32m+[m[32m                        const finalTotal = parseFloat(bill.display_amount_due || 0);[m
[32m+[m[41m                        [m
[32m+[m[32m                        // Add to totals[m
[32m+[m[32m                        totalOriginal += baseAmountForCalc;[m
[32m+[m[32m                        totalDiscount += discountApplied;[m
[32m+[m[32m                        totalSurcharge += penaltyApplied;[m
[32m+[m[32m                        totalAmount += finalTotal;[m
[32m+[m[41m                        [m
[32m+[m[32m                        const categoryText = bill.utility_type === 'Rent'[m
[32m+[m[32m                            ? `Rent<br><span class="text-sm font-normal text-gray-500">(Standard Payment)</span>`[m
[32m+[m[32m                            : bill.utility_type;[m
[32m+[m
[32m+[m[32m                        return `[m
[32m+[m[32m                            <tr class="text-lg border-b border-gray-200">[m
[32m+[m[32m                                <td class="px-4 py-3 align-top font-bold">${categoryText}</td>[m
[32m+[m[32m                                <td class="px-4 py-3 align-top">${detailsHtml}</td>[m
[32m+[m[32m                                <td class="px-4 py-3 align-top">${discountHtml}</td>[m
[32m+[m[32m                                <td class="px-4 py-3 align-top">${penaltyHtml}</td>[m
[32m+[m[32m                                <td class="px-4 py-3 align-top font-bold text-market-primary">${this.helpers.formatCurrency(finalTotal)}</td>[m
[32m+[m[32m                            </tr>[m
[32m+[m[32m                        `;[m
[32m+[m[32m                    })[m
[32m+[m[32m                    .join("");[m
[32m+[m
[32m+[m[32m                // Update footer totals[m
[32m+[m[32m                const totalOriginalEl = document.getElementById('totalOriginalPayment');[m
[32m+[m[32m                const totalDiscountEl = document.getElementById('totalDiscount');[m
[32m+[m[32m                const totalSurchargeEl = document.getElementById('totalSurcharge');[m
[32m+[m[32m                const totalAmountDueEl = document.getElementById('totalAmountDue');[m
[32m+[m
[32m+[m[32m                if (totalOriginalEl) totalOriginalEl.textContent = this.helpers.formatCurrency(totalOriginal);[m
[32m+[m[32m                if (totalDiscountEl) totalDiscountEl.textContent = totalDiscount > 0 ? `-${this.helpers.formatCurrency(totalDiscount)}` : this.helpers.formatCurrency(0);[m
[32m+[m[32m                if (totalSurchargeEl) totalSurchargeEl.textContent = this.helpers.formatCurrency(totalSurcharge);[m
[32m+[m[32m                if (totalAmountDueEl) totalAmountDueEl.textContent = this.helpers.formatCurrency(totalAmount);[m
[32m+[m[32m            } else {[m
[32m+[m[32m                detailsBody.innerHTML = `<tr><td colspan="5" class="text-center py-4">No bills for this month.</td></tr>`;[m
[32m+[m[41m                [m
[32m+[m[32m                // Reset footer totals[m
[32m+[m[32m                const totalOriginalEl = document.getElementById('totalOriginalPayment');[m
[32m+[m[32m                const totalDiscountEl = document.getElementById('totalDiscount');[m
[32m+[m[32m                const totalSurchargeEl = document.getElementById('totalSurcharge');[m
[32m+[m[32m                const totalAmountDueEl = document.getElementById('totalAmountDue');[m
[32m+[m
[32m+[m[32m                if (totalOriginalEl) totalOriginalEl.textContent = this.helpers.formatCurrency(0);[m
[32m+[m[32m                if (totalDiscountEl) totalDiscountEl.textContent = this.helpers.formatCurrency(0);[m
[32m+[m[32m                if (totalSurchargeEl) totalSurchargeEl.textContent = this.helpers.formatCurrency(0);[m
[32m+[m[32m                if (totalAmountDueEl) totalAmountDueEl.textContent = this.helpers.formatCurrency(0);[m
[32m+[m[32m            }[m
[32m+[m[32m            modal.classList.remove("hidden");[m
         } else {[m
[31m-            detailsBody.innerHTML = `<tr><td colspan="5" class="text-center py-4">No bills for this month.</td></tr>`;[m
[31m-            [m
[31m-            // Reset footer totals[m
[31m-            const totalOriginalEl = document.getElementById('totalOriginalPayment');[m
[31m-            const totalDiscountEl = document.getElementById('totalDiscount');[m
[31m-            const totalSurchargeEl = document.getElementById('totalSurcharge');[m
[31m-            const totalAmountDueEl = document.getElementById('totalAmountDue');[m
[31m-[m
[31m-            if (totalOriginalEl) totalOriginalEl.textContent = this.helpers.formatCurrency(0);[m
[31m-            if (totalDiscountEl) totalDiscountEl.textContent = this.helpers.formatCurrency(0);[m
[31m-            if (totalSurchargeEl) totalSurchargeEl.textContent = this.helpers.formatCurrency(0);[m
[31m-            if (totalAmountDueEl) totalAmountDueEl.textContent = this.helpers.formatCurrency(0);[m
[32m+[m[32m            modal.classList.add("hidden");[m
         }[m
[31m-        modal.classList.remove("hidden");[m
[31m-    } else {[m
[31m-        modal.classList.add("hidden");[m
     }[m
[31m-}[m
[32m+[m
     setupEventListeners() {[m
         this.elements.navLinks.forEach((link) => {[m
             link.addEventListener("click", (e) => {[m
[36m@@ -517,18 +709,100 @@[m [mclass Dashboard {[m
 [m
         this.elements.yearDropdown?.addEventListener("change", (e) => {[m
             this.state.selectedYear = e.target.value;[m
[31m-            this.fetchAndRenderPayments();[m
[32m+[m[32m            this.state.paymentHistoryPage = 1; // Reset to first page[m
[32m+[m[32m            this.fetchAndRenderPayments(1);[m
         });[m
 [m
         this.elements.monthDropdown?.addEventListener("change", (e) => {[m
             this.state.selectedMonth = e.target.value;[m
[31m-            this.fetchAndRenderPayments();[m
[32m+[m[32m            this.state.paymentHistoryPage = 1; // Reset to first page[m
[32m+[m[32m            this.fetchAndRenderPayments(1);[m
         });[m
 [m
         this.elements.searchInput?.addEventListener("input", (e) => {[m
             this.state.searchTerm = e.target.value;[m
[32m+[m[32m            this.state.paymentHistoryPage = 1; // Reset to first page[m
             this.debouncedSearch();[m
         });[m
[32m+[m
[32m+[m[32m        // Notification bell click handler[m
[32m+[m[32m        document.addEventListener("click", (e) => {[m
[32m+[m[32m            const bellButton = e.target.closest(".notificationBell button");[m
[32m+[m[32m            if (bellButton) {[m
[32m+[m[32m                e.stopPropagation();[m
[32m+[m[32m                // Find the dropdown in the active section[m
[32m+[m[32m                const activeSection = document.querySelector(".dashboard-section.active");[m
[32m+[m[32m                if (activeSection) {[m
[32m+[m[32m                    const dropdown = activeSection.querySelector(".notificationDropdown");[m
[32m+[m[32m                    if (dropdown) {[m
[32m+[m[32m                        const isHidden = dropdown.classList.toggle("hidden");[m
[32m+[m[32m                        if (!isHidden && this.notifications.unreadCount > 0) {[m
[32m+[m[32m                            this.markNotificationsAsRead();[m
[32m+[m[32m                        }[m
[32m+[m[32m                    }[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            // Close dropdown when clicking outside[m
[32m+[m[32m            const activeSection = document.querySelector(".dashboard-section.active");[m
[32m+[m[32m            if (activeSection) {[m
[32m+[m[32m                const dropdown = activeSection.querySelector(".notificationDropdown");[m
[32m+[m[32m                const bell = activeSection.querySelector(".notificationBell");[m
[32m+[m[32m                if (dropdown && !dropdown.classList.contains("hidden") && bell && !bell.contains(e.target)) {[m
[32m+[m[32m                    dropdown.classList.add("hidden");[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m[32m        });[m
[32m+[m
[32m+[m
[32m+[m[32m        // Change password form handler[m
[32m+[m[32m        if (this.elements.changePasswordForm) {[m
[32m+[m[32m            this.elements.changePasswordForm.addEventListener("submit", async (e) => {[m
[32m+[m[32m                e.preventDefault();[m
[32m+[m[32m                const btn = this.elements.changePasswordBtn;[m
[32m+[m[32m                const originalText = btn.innerHTML;[m
[32m+[m[32m                btn.disabled = true;[m
[32m+[m[32m                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Changing...';[m
[32m+[m
[32m+[m[32m                const formData = new FormData(this.elements.changePasswordForm);[m
[32m+[m[32m                const data = {[m
[32m+[m[32m                    current_password: formData.get("current_password"),[m
[32m+[m[32m                    password: formData.get("password"),[m
[32m+[m[32m                    password_confirmation: formData.get("password_confirmation"),[m
[32m+[m[32m                };[m
[32m+[m
[32m+[m[32m                try {[m
[32m+[m[32m                    const response = await fetch("/api/user-settings/change-password", {[m
[32m+[m[32m                        method: "POST",[m
[32m+[m[32m                        headers: {[m
[32m+[m[32m                            "Content-Type": "application/json",[m
[32m+[m[32m                            Accept: "application/json",[m
[32m+[m[32m                            "X-CSRF-TOKEN": document[m
[32m+[m[32m                                .querySelector('meta[name="csrf-token"]')[m
[32m+[m[32m                                .getAttribute("content"),[m
[32m+[m[32m                        },[m
[32m+[m[32m                        credentials: "include",[m
[32m+[m[32m                        body: JSON.stringify(data),[m
[32m+[m[32m                    });[m
[32m+[m
[32m+[m[32m                    const result = await response.json();[m
[32m+[m
[32m+[m[32m                    if (response.ok) {[m
[32m+[m[32m                        this.helpers.showToast(result.message || "Password changed successfully!", "success");[m
[32m+[m[32m                        this.elements.changePasswordForm.reset();[m
[32m+[m[32m                    } else {[m
[32m+[m[32m                        const errorMsg = result.message || result.errors?.current_password?.[0] || result.errors?.password?.[0] || "Failed to change password";[m
[32m+[m[32m                        this.helpers.showToast(errorMsg, "error");[m
[32m+[m[32m                    }[m
[32m+[m[32m                } catch (error) {[m
[32m+[m[32m                    console.error("Password change error:", error);[m
[32m+[m[32m                    this.helpers.showToast("An error occurred. Please try again.", "error");[m
[32m+[m[32m                } finally {[m
[32m+[m[32m                    btn.disabled = false;[m
[32m+[m[32m                    btn.innerHTML = originalText;[m
[32m+[m[32m                }[m
[32m+[m[32m            });[m
[32m+[m[32m        }[m
     }[m
 [m
     showOutstandingDetailsForMonth(month) {[m
[36m@@ -606,6 +880,614 @@[m [mclass Dashboard {[m
     setInitialSection() {[m
         const hash = window.location.hash.substring(1) || "homeSection";[m
         this.state.activeSection = hash;[m
[32m+[m[32m        // Load analytics if analytics section is active[m
[32m+[m[32m        if (hash === "analyticsSection") {[m
[32m+[m[32m            this.loadAnalytics();[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    async loadAnalytics() {[m
[32m+[m[32m        try {[m
[32m+[m[32m            const url = typeof isStaffView !== "undefined" && isStaffView[m
[32m+[m[32m                ? `/api/staff/vendor/${vendorData.id}/analytics`[m
[32m+[m[32m                : `/api/vendor/analytics`;[m
[32m+[m
[32m+[m[32m            const response = await fetch(url);[m
[32m+[m[32m            if (!response.ok) throw new Error("Failed to fetch analytics data");[m
[32m+[m[41m            [m
[32m+[m[32m            const data = await response.json();[m
[32m+[m[32m            this.renderElectricityChart(data.electricity);[m
[32m+[m[32m            this.renderPaymentStatusChart(data.paymentTracking);[m
[32m+[m[32m            this.renderPaymentTimelineChart(data.paymentTimeline);[m
[32m+[m[32m        } catch (error) {[m
[32m+[m[32m            console.error("Failed to load analytics:", error);[m
[32m+[m[32m            this.helpers.showToast("Failed to load analytics data", "error");[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    renderElectricityChart(data) {[m
[32m+[m[32m        const ctx = this.elements.electricityChart?.getContext("2d");[m
[32m+[m[32m        if (!ctx) return;[m
[32m+[m
[32m+[m[32m        // Destroy existing chart if it exists[m
[32m+[m[32m        if (this.charts.electricity) {[m
[32m+[m[32m            this.charts.electricity.destroy();[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        this.charts.electricity = new Chart(ctx, {[m
[32m+[m[32m            type: "line",[m
[32m+[m[32m            data: {[m
[32m+[m[32m                labels: data.labels || [],[m
[32m+[m[32m                datasets: [{[m
[32m+[m[32m                    label: "Electricity Consumption (kWh)",[m
[32m+[m[32m                    data: data.data || [],[m
[32m+[m[32m                    borderColor: "rgb(255, 165, 0)",[m
[32m+[m[32m                    backgroundColor: "rgba(255, 165, 0, 0.1)",[m
[32m+[m[32m                    borderWidth: 3,[m
[32m+[m[32m                    fill: true,[m
[32m+[m[32m                    tension: 0.4,[m
[32m+[m[32m                    pointRadius: 5,[m
[32m+[m[32m                    pointHoverRadius: 7,[m
[32m+[m[32m                    pointBackgroundColor: "rgb(255, 165, 0)",[m
[32m+[m[32m                    pointBorderColor: "#fff",[m
[32m+[m[32m                    pointBorderWidth: 2,[m
[32m+[m[32m                }],[m
[32m+[m[32m            },[m
[32m+[m[32m            options: {[m
[32m+[m[32m                responsive: true,[m
[32m+[m[32m                maintainAspectRatio: false,[m
[32m+[m[32m                plugins: {[m
[32m+[m[32m                    legend: {[m
[32m+[m[32m                        display: true,[m
[32m+[m[32m                        position: "top",[m
[32m+[m[32m                    },[m
[32m+[m[32m                    tooltip: {[m
[32m+[m[32m                        mode: "index",[m
[32m+[m[32m                        intersect: false,[m
[32m+[m[32m                        callbacks: {[m
[32m+[m[32m                            label: (context) => {[m
[32m+[m[32m                                return `${context.dataset.label}: ${context.parsed.y.toFixed(2)} kWh`;[m
[32m+[m[32m                            },[m
[32m+[m[32m                        },[m
[32m+[m[32m                    },[m
[32m+[m[32m                },[m
[32m+[m[32m                scales: {[m
[32m+[m[32m                    y: {[m
[32m+[m[32m                        beginAtZero: true,[m
[32m+[m[32m                        title: {[m
[32m+[m[32m                            display: true,[m
[32m+[m[32m                            text: "Consumption (kWh)",[m
[32m+[m[32m                        },[m
[32m+[m[32m                    },[m
[32m+[m[32m                    x: {[m
[32m+[m[32m                        title: {[m
[32m+[m[32m                            display: true,[m
[32m+[m[32m                            text: "Month",[m
[32m+[m[32m                        },[m
[32m+[m[32m                    },[m
[32m+[m[32m                },[m
[32m+[m[32m            },[m
[32m+[m[32m        });[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    renderPaymentStatusChart(data) {[m
[32m+[m[32m        const ctx = this.elements.paymentStatusChart?.getContext("2d");[m
[32m+[m[32m        if (!ctx) return;[m
[32m+[m
[32m+[m[32m        // Update stats[m
[32m+[m[32m        const onTimeEl = document.getElementById("onTimeCount");[m
[32m+[m[32m        const lateEl = document.getElementById("lateCount");[m
[32m+[m[32m        if (onTimeEl) onTimeEl.textContent = data.onTime || 0;[m
[32m+[m[32m        if (lateEl) lateEl.textContent = data.late || 0;[m
[32m+[m
[32m+[m[32m        // Destroy existing chart if it exists[m
[32m+[m[32m        if (this.charts.paymentStatus) {[m
[32m+[m[32m            this.charts.paymentStatus.destroy();[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        this.charts.paymentStatus = new Chart(ctx, {[m
[32m+[m[32m            type: "doughnut",[m
[32m+[m[32m            data: {[m
[32m+[m[32m                labels: ["On Time", "Late"],[m
[32m+[m[32m                datasets: [{[m
[32m+[m[32m                    data: [data.onTime || 0, data.late || 0],[m
[32m+[m[32m                    backgroundColor: [[m
[32m+[m[32m                        "rgba(34, 197, 94, 0.8)",[m
[32m+[m[32m                        "rgba(239, 68, 68, 0.8)",[m
[32m+[m[32m                    ],[m
[32m+[m[32m                    borderColor: [[m
[32m+[m[32m                        "rgb(34, 197, 94)",[m
[32m+[m[32m                        "rgb(239, 68, 68)",[m
[32m+[m[32m                    ],[m
[32m+[m[32m                    borderWidth: 2,[m
[32m+[m[32m                }],[m
[32m+[m[32m            },[m
[32m+[m[32m            options: {[m
[32m+[m[32m                responsive: true,[m
[32m+[m[32m                maintainAspectRatio: false,[m
[32m+[m[32m                plugins: {[m
[32m+[m[32m                    legend: {[m
[32m+[m[32m                        display: true,[m
[32m+[m[32m                        position: "bottom",[m
[32m+[m[32m                    },[m
[32m+[m[32m                    tooltip: {[m
[32m+[m[32m                        callbacks: {[m
[32m+[m[32m                            label: (context) => {[m
[32m+[m[32m                                const label = context.label || "";[m
[32m+[m[32m                                const value = context.parsed || 0;[m
[32m+[m[32m                                const total = data.total || 1;[m
[32m+[m[32m                                const percentage = ((value / total) * 100).toFixed(1);[m
[32m+[m[32m                                return `${label}: ${value} (${percentage}%)`;[m
[32m+[m[32m                            },[m
[32m+[m[32m                        },[m
[32m+[m[32m                    },[m
[32m+[m[32m                },[m
[32m+[m[32m            },[m
[32m+[m[32m        });[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    renderPaymentTimelineChart(data) {[m
[32m+[m[32m        const ctx = this.elements.paymentTimelineChart?.getContext("2d");[m
[32m+[m[32m        if (!ctx) return;[m
[32m+[m
[32m+[m[32m        // Destroy existing chart if it exists[m
[32m+[m[32m        if (this.charts.paymentTimeline) {[m
[32m+[m[32m            this.charts.paymentTimeline.destroy();[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // Format labels to be more readable[m
[32m+[m[32m        const formattedLabels = (data.labels || []).map(label => {[m
[32m+[m[32m            const [year, month] = label.split("-");[m
[32m+[m[32m            const date = new Date(year, month - 1);[m
[32m+[m[32m            return date.toLocaleDateString("en-US", { month: "short", year: "numeric" });[m
[32m+[m[32m        });[m
[32m+[m
[32m+[m[32m        this.charts.paymentTimeline = new Chart(ctx, {[m
[32m+[m[32m            type: "bar",[m
[32m+[m[32m            data: {[m
[32m+[m[32m                labels: formattedLabels,[m
[32m+[m[32m                datasets: [[m
[32m+[m[32m                    {[m
[32m+[m[32m                        label: "On Time",[m
[32m+[m[32m                        data: data.onTime || [],[m
[32m+[m[32m                        backgroundColor: "rgba(34, 197, 94, 0.8)",[m
[32m+[m[32m                        borderColor: "rgb(34, 197, 94)",[m
[32m+[m[32m                        borderWidth: 1,[m
[32m+[m[32m                    },[m
[32m+[m[32m                    {[m
[32m+[m[32m                        label: "Late",[m
[32m+[m[32m                        data: data.late || [],[m
[32m+[m[32m                        backgroundColor: "rgba(239, 68, 68, 0.8)",[m
[32m+[m[32m                        borderColor: "rgb(239, 68, 68)",[m
[32m+[m[32m                        borderWidth: 1,[m
[32m+[m[32m                    },[m
[32m+[m[32m                ],[m
[32m+[m[32m            },[m
[32m+[m[32m            options: {[m
[32m+[m[32m                responsive: true,[m
[32m+[m[32m                maintainAspectRatio: false,[m
[32m+[m[32m                plugins: {[m
[32m+[m[32m                    legend: {[m
[32m+[m[32m                        display: true,[m
[32m+[m[32m                        position: "top",[m
[32m+[m[32m                    },[m
[32m+[m[32m                    tooltip: {[m
[32m+[m[32m                        mode: "index",[m
[32m+[m[32m                        intersect: false,[m
[32m+[m[32m                    },[m
[32m+[m[32m                },[m
[32m+[m[32m                scales: {[m
[32m+[m[32m                    x: {[m
[32m+[m[32m                        stacked: true,[m
[32m+[m[32m                        title: {[m
[32m+[m[32m                            display: true,[m
[32m+[m[32m                            text: "Month",[m
[32m+[m[32m                        },[m
[32m+[m[32m                    },[m
[32m+[m[32m                    y: {[m
[32m+[m[32m                        stacked: true,[m
[32m+[m[32m                        beginAtZero: true,[m
[32m+[m[32m                        ticks: {[m
[32m+[m[32m                            stepSize: 1,[m
[32m+[m[32m                        },[m
[32m+[m[32m                        title: {[m
[32m+[m[32m                            display: true,[m
[32m+[m[32m                            text: "Number of Payments",[m
[32m+[m[32m                        },[m
[32m+[m[32m                    },[m
[32m+[m[32m                },[m
[32m+[m[32m            },[m
[32m+[m[32m        });[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    // Announcement banner removed - announcements now appear as notifications in the bell dropdown[m
[32m+[m
[32m+[m[32m    async fetchNotifications() {[m
[32m+[m[32m        try {[m
[32m+[m[32m            const response = await fetch("/notifications/fetch");[m
[32m+[m[32m            if (!response.ok) return;[m
[32m+[m
[32m+[m[32m            const data = await response.json();[m
[32m+[m[32m            this.notifications.list = data.notifications || [];[m
[32m+[m[32m            this.notifications.unreadCount = data.unread_count || 0;[m
[32m+[m[32m            this.renderNotificationDropdown();[m
[32m+[m[32m        } catch (error) {[m
[32m+[m[32m            console.error("Error fetching notifications:", error);[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    renderNotificationDropdown() {[m
[32m+[m[32m        // Find notification elements in the active section[m
[32m+[m[32m        const activeSection = document.querySelector(".dashboard-section.active");[m
[32m+[m[32m        if (!activeSection) return;[m
[32m+[m
[32m+[m[32m        const notificationList = activeSection.querySelector(".notificationList");[m
[32m+[m[32m        const notificationDot = activeSection.querySelector(".notificationDot");[m
[32m+[m
[32m+[m[32m        if (!notificationList || !notificationDot) return;[m
[32m+[m
[32m+[m[32m        // Show/hide notification dot[m
[32m+[m[32m        notificationDot.classList.toggle("hidden", this.notifications.unreadCount === 0);[m
[32m+[m
[32m+[m[32m        if (this.notifications.list.length === 0) {[m
[32m+[m[32m            notificationList.innerHTML = `<p class="text-center text-gray-500 p-4">You have no new notifications.</p>`;[m
[32m+[m[32m            return;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        notificationList.innerHTML = this.notifications.list[m
[32m+[m[32m            .map((notification) => {[m
[32m+[m[32m                // Try to parse message as JSON, fallback to plain text[m
[32m+[m[32m                let notificationText = notification.title || "Notification";[m
[32m+[m[32m                try {[m
[32m+[m[32m                    if (notification.message) {[m
[32m+[m[32m                        const data = JSON.parse(notification.message);[m
[32m+[m[32m                        notificationText = data.text || data.message || notification.title || notificationText;[m
[32m+[m[32m                    }[m
[32m+[m[32m                } catch (e) {[m
[32m+[m[32m                    // If not JSON, use message as plain text[m
[32m+[m[32m                    notificationText = notification.message || notification.title || notificationText;[m
[32m+[m[32m                }[m
[32m+[m[41m                [m
[32m+[m[32m                const isUnread = notification.read_at === null;[m
[32m+[m[32m                const timeAgo = this.formatTimeAgo(notification.created_at);[m
[32m+[m
[32m+[m[32m                return `[m
[32m+[m[32m                    <div class="block p-3 transition-colors hover:bg-gray-100 ${isUnread ? "bg-blue-50" : ""}">[m
[32m+[m[32m                        <div class="flex items-start">[m
[32m+[m[32m                            ${isUnread ? '<div class="w-2 h-2 bg-blue-500 rounded-full mt-1.5 mr-3 flex-shrink-0"></div>' : '<div class="w-2 h-2 mr-3"></div>'}[m
[32m+[m[32m                            <div class="flex-grow">[m
[32m+[m[32m                                <p class="text-sm text-gray-800">${this.escapeHtml(notificationText)}</p>[m
[32m+[m[32m                                <p class="text-xs text-blue-600 font-semibold mt-1">${timeAgo}</p>[m
[32m+[m[32m                            </div>[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                `;[m
[32m+[m[32m            })[m
[32m+[m[32m            .join("");[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    escapeHtml(text) {[m
[32m+[m[32m        const div = document.createElement('div');[m
[32m+[m[32m        div.textContent = text;[m
[32m+[m[32m        return div.innerHTML;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    formatTimeAgo(dateString) {[m
[32m+[m[32m        const date = new Date(dateString);[m
[32m+[m[32m        const seconds = Math.floor((new Date() - date) / 1000);[m
[32m+[m
[32m+[m[32m        let interval = seconds / 31536000;[m
[32m+[m[32m        if (interval >= 1) {[m
[32m+[m[32m            const value = Math.floor(interval);[m
[32m+[m[32m            return value === 1 ? `${value} year ago` : `${value} years ago`;[m
[32m+[m[32m        }[m
[32m+[m[32m        interval = seconds / 2592000;[m
[32m+[m[32m        if (interval >= 1) {[m
[32m+[m[32m            const value = Math.floor(interval);[m
[32m+[m[32m            return value === 1 ? `${value} month ago` : `${value} months ago`;[m
[32m+[m[32m        }[m
[32m+[m[32m        interval = seconds / 86400;[m
[32m+[m[32m        if (interval >= 1) {[m
[32m+[m[32m            const value = Math.floor(interval);[m
[32m+[m[32m            return value === 1 ? `${value} day ago` : `${value} days ago`;[m
[32m+[m[32m        }[m
[32m+[m[32m        interval = seconds / 3600;[m
[32m+[m[32m        if (interval >= 1) {[m
[32m+[m[32m            const value = Math.floor(interval);[m
[32m+[m[32m            return value === 1 ? `${value} hour ago` : `${value} hours ago`;[m
[32m+[m[32m        }[m
[32m+[m[32m        interval = seconds / 60;[m
[32m+[m[32m        if (interval >= 1) {[m
[32m+[m[32m            const value = Math.floor(interval);[m
[32m+[m[32m            return value === 1 ? `${value} minute ago` : `${value} minutes ago`;[m
[32m+[m[32m        }[m
[32m+[m[32m        return "Just now";[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    async loadAllNotifications() {[m
[32m+[m[32m        const loader = document.getElementById("notificationsLoader");[m
[32m+[m[32m        const list = document.getElementById("notificationsList");[m
[32m+[m[32m        const noMessage = document.getElementById("noNotificationsMessage");[m
[32m+[m
[32m+[m[32m        if (loader) loader.classList.remove("hidden");[m
[32m+[m[32m        if (list) list.classList.add("hidden");[m
[32m+[m[32m        if (noMessage) noMessage.classList.add("hidden");[m
[32m+[m
[32m+[m[32m        try {[m
[32m+[m[32m            // Fetch both notifications and announcements in parallel with timeout[m
[32m+[m[32m            const controller = new AbortController();[m
[32m+[m[32m            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout[m
[32m+[m
[32m+[m[32m            const [notificationsResponse, announcementsResponse] = await Promise.all([[m
[32m+[m[32m                fetch("/notifications/fetch-all", {[m
[32m+[m[32m                    signal: controller.signal,[m
[32m+[m[32m                    credentials: "include",[m
[32m+[m[32m                }),[m
[32m+[m[32m                fetch("/api/announcements/all-for-user", {[m
[32m+[m[32m                    headers: {[m
[32m+[m[32m                        "Accept": "application/json",[m
[32m+[m[32m                        "X-CSRF-TOKEN": document.querySelector('meta[name="csrf-token"]')?.getAttribute("content") || "",[m
[32m+[m[32m                    },[m
[32m+[m[32m                    credentials: "include",[m
[32m+[m[32m                    signal: controller.signal,[m
[32m+[m[32m                }).catch(() => ({ ok: false, json: async () => [] })) // Gracefully handle announcements failure[m
[32m+[m[32m            ]);[m
[32m+[m
[32m+[m[32m            clearTimeout(timeoutId);[m
[32m+[m
[32m+[m[32m            if (!notificationsResponse.ok) throw new Error("Failed to fetch notifications");[m
[32m+[m
[32m+[m[32m            const notificationsData = await notificationsResponse.json();[m
[32m+[m[32m            const announcements = announcementsResponse.ok ? await announcementsResponse.json() : [];[m
[32m+[m
[32m+[m[32m            // Combine notifications and announcements[m
[32m+[m[32m            const allItems = [];[m
[32m+[m[41m            [m
[32m+[m[32m            // Add regular notifications[m
[32m+[m[32m            (notificationsData.notifications || []).forEach(notif => {[m
[32m+[m[32m                allItems.push({[m
[32m+[m[32m                    ...notif,[m
[32m+[m[32m                    type: 'notification',[m
[32m+[m[32m                });[m
[32m+[m[32m            });[m
[32m+[m
[32m+[m[32m            // Add announcements (convert to notification-like format)[m
[32m+[m[32m            if (Array.isArray(announcements)) {[m
[32m+[m[32m                announcements.forEach(announcement => {[m
[32m+[m[32m                    allItems.push({[m
[32m+[m[32m                        id: `announcement_${announcement.id}`,[m
[32m+[m[32m                        title: announcement.title,[m
[32m+[m[32m                        message: announcement.content,[m
[32m+[m[32m                        created_at: announcement.created_at,[m
[32m+[m[32m                        read_at: announcement.is_dismissed ? announcement.created_at : null, // Treat dismissed as read[m
[32m+[m[32m                        sender_name: null,[m
[32m+[m[32m                        type: 'announcement',[m
[32m+[m[32m                        announcement_id: announcement.id,[m
[32m+[m[32m                        is_dismissed: announcement.is_dismissed,[m
[32m+[m[32m                    });[m
[32m+[m[32m                });[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            // Sort by created_at descending (newest first)[m
[32m+[m[32m            allItems.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));[m
[32m+[m
[32m+[m[32m            this.notifications.allNotifications = allItems;[m
[32m+[m[32m            this.notifications.unreadCount = notificationsData.unread_count || 0;[m
[32m+[m
[32m+[m[32m            this.renderNotificationsList();[m
[32m+[m[32m        } catch (error) {[m
[32m+[m[32m            console.error("Error loading notifications:", error);[m
[32m+[m[32m            if (error.name === 'AbortError') {[m
[32m+[m[32m                this.helpers.showToast("Request timed out. Please try again.", "error");[m
[32m+[m[32m            } else {[m
[32m+[m[32m                this.helpers.showToast("Failed to load notifications", "error");[m
[32m+[m[32m            }[m
[32m+[m[32m            // Show empty state on error[m
[32m+[m[32m            if (noMessage) {[m
[32m+[m[32m                noMessage.classList.remove("hidden");[m
[32m+[m[32m                noMessage.innerHTML = `[m
[32m+[m[32m                    <i class="fas fa-exclamation-triangle text-4xl mb-4 text-yellow-400"></i>[m
[32m+[m[32m                    <p class="text-lg">Failed to load notifications.</p>[m
[32m+[m[32m                    <button onclick="location.reload()" class="mt-4 bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg">[m
[32m+[m[32m                        Retry[m
[32m+[m[32m                    </button>[m
[32m+[m[32m                `;[m
[32m+[m[32m            }[m
[32m+[m[32m        } finally {[m
[32m+[m[32m            if (loader) loader.classList.add("hidden");[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    renderNotificationsList() {[m
[32m+[m[32m        const list = document.getElementById("notificationsList");[m
[32m+[m[32m        const noMessage = document.getElementById("noNotificationsMessage");[m
[32m+[m[32m        const unreadBadge = document.getElementById("unreadCountBadge");[m
[32m+[m[32m        const unreadText = document.getElementById("unreadCountText");[m
[32m+[m
[32m+[m[32m        if (!list || !noMessage) return;[m
[32m+[m
[32m+[m[32m        const notifications = this.notifications.allNotifications || [];[m
[32m+[m
[32m+[m[32m        if (notifications.length === 0) {[m
[32m+[m[32m            list.classList.add("hidden");[m
[32m+[m[32m            noMessage.classList.remove("hidden");[m
[32m+[m[32m            if (unreadBadge) unreadBadge.classList.add("hidden");[m
[32m+[m[32m            return;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        list.classList.remove("hidden");[m
[32m+[m[32m        noMessage.classList.add("hidden");[m
[32m+[m
[32m+[m[32m        // Update unread badge[m
[32m+[m[32m        if (unreadBadge && this.notifications.unreadCount > 0) {[m
[32m+[m[32m            unreadBadge.classList.remove("hidden");[m
[32m+[m[32m            if (unreadText) unreadText.textContent = this.notifications.unreadCount;[m
[32m+[m[32m        } else if (unreadBadge) {[m
[32m+[m[32m            unreadBadge.classList.add("hidden");[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        list.innerHTML = notifications.map((notification) => {[m
[32m+[m[32m            const isUnread = !notification.read_at;[m
[32m+[m[32m            const isAnnouncement = notification.type === 'announcement';[m
[32m+[m[32m            const isDismissed = notification.is_dismissed;[m
[32m+[m[32m            const timeAgo = this.formatTimeAgo(notification.created_at);[m
[32m+[m[32m            const formattedDate = new Date(notification.created_at).toLocaleString('en-US', {[m
[32m+[m[32m                year: 'numeric',[m
[32m+[m[32m                month: 'short',[m
[32m+[m[32m                day: 'numeric',[m
[32m+[m[32m                hour: '2-digit',[m
[32m+[m[32m                minute: '2-digit'[m
[32m+[m[32m            });[m
[32m+[m
[32m+[m[32m            // Parse message if it's JSON[m
[32m+[m[32m            let messageText = notification.message || notification.title || "Notification";[m
[32m+[m[32m            try {[m
[32m+[m[32m                const parsed = JSON.parse(notification.message);[m
[32m+[m[32m                messageText = parsed.text || parsed.message || notification.title || messageText;[m
[32m+[m[32m            } catch (e) {[m
[32m+[m[32m                // Not JSON, use as is[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            // Determine background color[m
[32m+[m[32m            let bgColor = 'bg-white';[m
[32m+[m[32m            if (isUnread && !isDismissed) {[m
[32m+[m[32m                bgColor = 'bg-blue-50 border-blue-200';[m
[32m+[m[32m            } else if (isDismissed) {[m
[32m+[m[32m                bgColor = 'bg-gray-50 border-gray-300';[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            return `[m
[32m+[m[32m                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow ${bgColor}">[m
[32m+[m[32m                    <div class="flex items-start justify-between">[m
[32m+[m[32m                        <div class="flex-1">[m
[32m+[m[32m                            <div class="flex items-start gap-3">[m
[32m+[m[32m                                ${isUnread && !isDismissed ? '<div class="w-2 h-2 bg-blue-500 rounded-full mt-2 flex-shrink-0"></div>' : ''}[m
[32m+[m[32m                                ${isDismissed ? '<div class="w-2 h-2 bg-gray-400 rounded-full mt-2 flex-shrink-0"></div>' : ''}[m
[32m+[m[32m                                ${!isUnread && !isDismissed ? '<div class="w-2 h-2 mr-3"></div>' : ''}[m
[32m+[m[32m                                <div class="flex-1">[m
[32m+[m[32m                                    <div class="flex items-center gap-2 mb-1">[m
[32m+[m[32m                                        ${isAnnouncement ? '<span class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-indigo-100 text-indigo-800"><i class="fas fa-bullhorn mr-1"></i>Announcement</span>' : ''}[m
[32m+[m[32m                                        ${isDismissed ? '<span class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-gray-200 text-gray-600"><i class="fas fa-check-circle mr-1"></i>Dismissed</span>' : ''}[m
[32m+[m[32m                                    </div>[m
[32m+[m[32m                                    <h3 class="font-semibold text-gray-800 mb-1">${this.escapeHtml(notification.title || 'Notification')}</h3>[m
[32m+[m[32m                                    <p class="text-sm text-gray-600 mb-2">${this.escapeHtml(messageText)}</p>[m
[32m+[m[32m                                    <div class="flex items-center gap-4 text-xs text-gray-500">[m
[32m+[m[32m                                        <span><i class="fas fa-clock mr-1"></i>${timeAgo}</span>[m
[32m+[m[32m                                        <span><i class="fas fa-calendar mr-1"></i>${formattedDate}</span>[m
[32m+[m[32m                                        ${notification.sender_name ? `<span><i class="fas fa-user mr-1"></i>From: ${this.escapeHtml(notification.sender_name)}</span>` : ''}[m
[32m+[m[32m                                    </div>[m
[32m+[m[32m                                </div>[m
[32m+[m[32m                            </div>[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                        ${isUnread && !isAnnouncement ? `[m
[32m+[m[32m                            <button class="mark-notification-read-btn ml-4 text-indigo-600 hover:text-indigo-800 transition-colors"[m[41m [m
[32m+[m[32m                                    data-id="${notification.id}"[m[41m [m
[32m+[m[32m                                    title="Mark as read">[m
[32m+[m[32m                                <i class="fas fa-check-circle"></i>[m
[32m+[m[32m                            </button>[m
[32m+[m[32m                        ` : ''}[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                </div>[m
[32m+[m[32m            `;[m
[32m+[m[32m        }).join("");[m
[32m+[m
[32m+[m[32m        // Attach event listeners to mark as read buttons[m
[32m+[m[32m        list.querySelectorAll(".mark-notification-read-btn").forEach(btn => {[m
[32m+[m[32m            btn.addEventListener("click", async (e) => {[m
[32m+[m[32m                const notificationId = e.currentTarget.dataset.id;[m
[32m+[m[32m                await this.markSingleNotificationAsRead(notificationId);[m
[32m+[m[32m            });[m
[32m+[m[32m        });[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    async markSingleNotificationAsRead(notificationId) {[m
[32m+[m[32m        try {[m
[32m+[m[32m            const response = await fetch(`/notifications/${notificationId}/mark-as-read`, {[m
[32m+[m[32m                method: "POST",[m
[32m+[m[32m                headers: {[m
[32m+[m[32m                    "Content-Type": "application/json",[m
[32m+[m[32m                    "X-CSRF-TOKEN": document.querySelector('meta[name="csrf-token"]')?.getAttribute("content"),[m
[32m+[m[32m                },[m
[32m+[m[32m            });[m
[32m+[m
[32m+[m[32m            if (response.ok) {[m
[32m+[m[32m                // Update local state[m
[32m+[m[32m                this.notifications.allNotifications = this.notifications.allNotifications.map(n => {[m
[32m+[m[32m                    if (n.id == notificationId) {[m
[32m+[m[32m                        return { ...n, read_at: new Date().toISOString() };[m
[32m+[m[32m                    }[m
[32m+[m[32m                    return n;[m
[32m+[m[32m                });[m
[32m+[m[32m                this.notifications.unreadCount = Math.max(0, this.notifications.unreadCount - 1);[m
[32m+[m[32m                this.renderNotificationsList();[m
[32m+[m[32m            }[m
[32m+[m[32m        } catch (error) {[m
[32m+[m[32m            console.error("Failed to mark notification as read:", error);[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    setupNotificationsEventListeners() {[m
[32m+[m[32m        const markAllBtn = document.getElementById("markAllAsReadBtn");[m
[32m+[m[32m        if (markAllBtn && !markAllBtn.dataset.listenerAttached) {[m
[32m+[m[32m            markAllBtn.dataset.listenerAttached = "true";[m
[32m+[m[32m            markAllBtn.addEventListener("click", async () => {[m
[32m+[m[32m                if (this.notifications.unreadCount === 0) {[m
[32m+[m[32m                    this.helpers.showToast("All notifications are already read", "info");[m
[32m+[m[32m                    return;[m
[32m+[m[32m                }[m
[32m+[m
[32m+[m[32m                try {[m
[32m+[m[32m                    const response = await fetch("/notifications/mark-as-read", {[m
[32m+[m[32m                        method: "POST",[m
[32m+[m[32m                        headers: {[m
[32m+[m[32m                            "Content-Type": "application/json",[m
[32m+[m[32m                            "X-CSRF-TOKEN": document.querySelector('meta[name="csrf-token"]')?.getAttribute("content"),[m
[32m+[m[32m                        },[m
[32m+[m[32m                    });[m
[32m+[m
[32m+[m[32m                    if (response.ok) {[m
[32m+[m[32m                        // Update all notifications to read[m
[32m+[m[32m                        this.notifications.allNotifications = this.notifications.allNotifications.map(n => ({[m
[32m+[m[32m                            ...n,[m
[32m+[m[32m                            read_at: n.read_at || new Date().toISOString()[m
[32m+[m[32m                        }));[m
[32m+[m[32m                        this.notifications.unreadCount = 0;[m
[32m+[m[32m                        this.renderNotificationsList();[m
[32m+[m[32m                        this.helpers.showToast("All notifications marked as read", "success");[m
[32m+[m[32m                    }[m
[32m+[m[32m                } catch (error) {[m
[32m+[m[32m                    console.error("Failed to mark all as read:", error);[m
[32m+[m[32m                    this.helpers.showToast("Failed to mark all as read", "error");[m
[32m+[m[32m                }[m
[32m+[m[32m            });[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    async markNotificationsAsRead() {[m
[32m+[m[32m        if (this.notifications.unreadCount === 0) return;[m
[32m+[m
[32m+[m[32m        // Optimistic update[m
[32m+[m[32m        const now = new Date().toISOString();[m
[32m+[m[32m        this.notifications.list = this.notifications.list.map((notification) => {[m
[32m+[m[32m            if (notification.read_at === null) {[m
[32m+[m[32m                return { ...notification, read_at: now };[m
[32m+[m[32m            }[m
[32m+[m[32m            return notification;[m
[32m+[m[32m        });[m
[32m+[m[32m        this.notifications.unreadCount = 0;[m
[32m+[m[32m        this.renderNotificationDropdown();[m
[32m+[m
[32m+[m[32m        try {[m
[32m+[m[32m            await fetch("/notifications/mark-as-read", {[m
[32m+[m[32m                method: "POST",[m
[32m+[m[32m                headers: {[m
[32m+[m[32m                    "Content-Type": "application/json",[m
[32m+[m[32m                    "X-CSRF-TOKEN": document.querySelector('meta[name="csrf-token"]')?.getAttribute("content"),[m
[32m+[m[32m                },[m
[32m+[m[32m            });[m
[32m+[m[32m        } catch (error) {[m
[32m+[m[32m            console.error("Failed to mark notifications as read:", error);[m
[32m+[m[32m        }[m
     }[m
 }[m
 [m
[1mdiff --git a/resources/views/auth/login.blade.php b/resources/views/auth/login.blade.php[m
[1mindex 0c68152..ff6444d 100644[m
[1m--- a/resources/views/auth/login.blade.php[m
[1m+++ b/resources/views/auth/login.blade.php[m
[36m@@ -9,103 +9,140 @@[m
     @vite('resources/css/all.min.css')[m
     @vite('resources/css/roboto.css')[m
     @vite('resources/js/app.js')[m
[32m+[m[32m    <style>[m
[32m+[m[32m        .corner-border {[m
[32m+[m[32m            position: relative;[m
[32m+[m[32m        }[m
[32m+[m[32m        .corner-border-top {[m
[32m+[m[32m            position: absolute;[m
[32m+[m[32m            top: 0;[m
[32m+[m[32m            right: 0;[m
[32m+[m[32m            left: 0;[m
[32m+[m[32m            height: 3px;[m
[32m+[m[32m            background: #eab308;[m
[32m+[m[32m            border-radius: 0 12px 0 0;[m
[32m+[m[32m            z-index: 10;[m
[32m+[m[32m        }[m
[32m+[m[32m        @media (min-width: 1024px) {[m
[32m+[m[32m            .corner-border-top {[m
[32m+[m[32m                left: 60%;[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m[32m        .corner-border-right {[m
[32m+[m[32m            position: absolute;[m
[32m+[m[32m            top: 0;[m
[32m+[m[32m            bottom: 0;[m
[32m+[m[32m            right: 0;[m
[32m+[m[32m            width: 3px;[m
[32m+[m[32m            background: #eab308;[m
[32m+[m[32m            z-index: 10;[m
[32m+[m[32m        }[m
[32m+[m[32m        .corner-border-bottom {[m
[32m+[m[32m            position: absolute;[m
[32m+[m[32m            bottom: 0;[m
[32m+[m[32m            right: 0;[m
[32m+[m[32m            left: 0;[m
[32m+[m[32m            height: 3px;[m
[32m+[m[32m            background: #eab308;[m
[32m+[m[32m            border-radius: 0 0 12px 0;[m
[32m+[m[32m            z-index: 10;[m
[32m+[m[32m        }[m
[32m+[m[32m        @media (min-width: 1024px) {[m
[32m+[m[32m            .corner-border-bottom {[m
[32m+[m[32m                left: 60%;[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m[32m    </style>[m
 </head>[m
 [m
[31m-<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex flex-col justify-center">[m
[31m-    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 w-full">[m
[31m-        <div class="flex justify-center">[m
[31m-            <div class="bg-white rounded-xl shadow-2xl overflow-hidden flex flex-col md:flex-row w-full max-w-5xl">[m
[31m-                <div class="md:w-1/2 relative h-64 md:h-auto overflow-hidden">[m
[31m-                    <img src="{{ asset('images/login.png') }}" alt="Virac Public Market Logo" alt="Virac Public Market"[m
[31m-                        class="object-cover w-full h-full object-top" />[m
[31m-                    <div[m
[31m-                        class="absolute inset-0 bg-gradient-to-t from-blue-900/70 to-transparent flex flex-col justify-end p-8 text-white">[m
[31m-                        <h2 class="text-2xl font-bold mb-2">Virac Public Market</h2>[m
[31m-                        <p class="text-sm opacity-90">Rent and Utility Management System</p>[m
[31m-                    </div>[m
[32m+[m[32m<body class="h-screen bg-blue-50 overflow-hidden">[m
[32m+[m[32m    <div class="h-screen flex w-full px-4 pt-4 pb-6 lg:px-6 lg:pt-6 lg:pb-8">[m
[32m+[m[32m        <div class="bg-white shadow-soft overflow-hidden flex flex-col lg:flex-row w-full h-full rounded-2xl corner-border relative">[m
[32m+[m[32m            <div class="corner-border-top"></div>[m
[32m+[m[32m            <div class="corner-border-right"></div>[m
[32m+[m[32m            <div class="corner-border-bottom"></div>[m
[32m+[m[32m            <!-- Left Section: Market Image -->[m
[32m+[m[32m            <div class="lg:w-3/5 relative h-full overflow-hidden">[m
[32m+[m[32m                <img src="{{ asset('images/vpm.png') }}" alt="Virac Public Market"[m[41m [m
[32m+[m[32m                    class="object-cover w-full h-full" style="object-position: center 30%;" />[m
[32m+[m[32m                <div class="absolute inset-0 bg-black/20 flex flex-col justify-end p-6 lg:p-8">[m
[32m+[m[32m                    <h2 class="text-xl lg:text-2xl font-bold text-white mb-1">Virac Public Market</h2>[m
[32m+[m[32m                    <p class="text-xs lg:text-sm text-white/90">Rent and Utility Management System</p>[m
                 </div>[m
[32m+[m[32m            </div>[m
 [m
[31m-                <div class="md:w-1/2 p-8 md:p-12 flex flex-col justify-center">[m
[31m-                    <div class="mb-8">[m
[31m-                        <h1 class="text-3xl font-bold text-gray-800 mb-2">Welcome Back</h1>[m
[31m-                        <p class="text-gray-600">Please sign in to access your dashboard</p>[m
[31m-                    </div>[m
[31m-[m
[31m-                    @if ($errors->any())[m
[31m-                        <div class="mb-4 bg-red-50 border-l-4 border-red-500 p-4 rounded-md">[m
[31m-                            <div class="flex">[m
[31m-                                <div class="flex-shrink-0">[m
[31m-                                    <i class="fas fa-exclamation-circle text-red-500"></i>[m
[31m-                                </div>[m
[31m-                                <div class="ml-3">[m
[31m-                                    <h3 class="text-sm font-medium text-red-800">[m
[31m-                                        Login Failed[m
[31m-                                    </h3>[m
[31m-                                    <div class="mt-2 text-sm text-red-700">[m
[31m-                                        <ul class="list-disc pl-5 space-y-1">[m
[31m-                                            @foreach ($errors->all() as $error)[m
[31m-                                                <li>{{ $error }}</li>[m
[31m-                                            @endforeach[m
[31m-                                        </ul>[m
[31m-                                    </div>[m
[31m-                                </div>[m
[31m-                            </div>[m
[32m+[m[32m            <!-- Right Section: Login Form -->[m
[32m+[m[32m            <div class="lg:w-2/5 px-6 pt-6 pb-6 lg:px-8 lg:pt-8 lg:pb-8 xl:px-10 xl:pt-10 flex flex-col justify-center max-w-md mx-auto lg:max-w-none h-full overflow-y-auto relative">[m
[32m+[m[32m                <!-- Logo at upper right -->[m
[32m+[m[32m                <div class="absolute top-5 right-5 lg:top-6 lg:right-6 xl:top-8 xl:right-8">[m
[32m+[m[32m                    <img src="{{ asset('images/logo.png') }}" alt="Logo" class="h-12 lg:h-16 w-auto">[m
[32m+[m[32m                </div>[m
[32m+[m[41m                [m
[32m+[m[32m                <div class="mb-6">[m
[32m+[m[32m                    <div class="flex items-center gap-2 mb-2">[m
[32m+[m[32m                        <div class="w-1 h-8 bg-yellow-500 rounded-full"></div>[m
[32m+[m[32m                        <div>[m
[32m+[m[32m                            <h1 class="text-xl lg:text-2xl font-bold text-gray-800 mb-1">Welcome Back</h1>[m
[32m+[m[32m                            <p class="text-gray-600 text-xs lg:text-sm">Please sign in to access your dashboard</p>[m
                         </div>[m
[31m-                    @endif[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                </div>[m
 [m
[31m-                    <form method="POST" action="{{ route('login') }}" class="space-y-6" id="loginForm">[m
[31m-                        @csrf <div>[m
[31m-                            <label for="username" class="block text-sm font-medium text-gray-700 mb-1">[m
[32m+[m[32m                    <form method="POST" action="{{ route('login') }}" class="space-y-5" id="loginForm">[m
[32m+[m[32m                        @csrf[m
[32m+[m[41m                        [m
[32m+[m[32m                        <div>[m
[32m+[m[32m                            <label for="username" class="block text-xs lg:text-sm font-medium text-gray-700 mb-1">[m
                                 Username[m
                             </label>[m
                             <div class="relative">[m
                                 <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">[m
[31m-                                    <i class="fas fa-user text-gray-400"></i>[m
[32m+[m[32m                                    <i class="fas fa-user text-gray-400 text-sm"></i>[m
                                 </div>[m
                                 <input id="username" name="username" type="text" autocomplete="username" required[m
                                     value="{{ old('username') }}"[m
[31m-                                    class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"[m
[32m+[m[32m                                    class="block w-full pl-10 pr-3 py-2.5 border-2 border-gray-300 rounded-xl text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 transition-all"[m
                                     placeholder="Enter your username">[m
                             </div>[m
                         </div>[m
 [m
                         <div>[m
[31m-                            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">[m
[32m+[m[32m                            <label for="password" class="block text-xs lg:text-sm font-medium text-gray-700 mb-1">[m
                                 Password[m
                             </label>[m
                             <div class="relative">[m
                                 <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">[m
[31m-                                    <i class="fas fa-lock text-gray-400"></i>[m
[32m+[m[32m                                    <i class="fas fa-lock text-gray-400 text-sm"></i>[m
                                 </div>[m
                                 <input id="password" name="password" type="password" autocomplete="current-password"[m
                                     required[m
[31m-                                    class="block w-full pl-10 pr-10 py-3 border border-gray-300 rounded-lg text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"[m
[32m+[m[32m                                    class="block w-full pl-10 pr-10 py-2.5 border-2 border-gray-300 rounded-xl text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 transition-all"[m
                                     placeholder="Enter your password">[m
[31m-                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center">[m
[31m-                                    <i class="fas fa-eye text-gray-400 cursor-pointer" id="togglePassword"></i>[m
[31m-                                </div>[m
[32m+[m[32m                                <button type="button" id="togglePassword" class="absolute inset-y-0 right-0 pr-3 flex items-center">[m
[32m+[m[32m                                    <i class="fas fa-eye text-gray-400 cursor-pointer hover:text-gray-600 text-sm" id="eyeIcon"></i>[m
[32m+[m[32m                                </button>[m
                             </div>[m
                         </div>[m
 [m
                         <div class="flex items-center justify-between">[m
                             <div class="flex items-center">[m
                                 <input id="remember" name="remember" type="checkbox"[m
[31m-                                    class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">[m
[32m+[m[32m                                    class="h-4 w-4 text-yellow-500 focus:ring-yellow-400 border-gray-300 rounded">[m
                                 <label for="remember" class="ml-2 block text-sm text-gray-700">[m
[31m-                                    Remember me[m
[32m+[m[32m                                    Keep me logged in[m
                                 </label>[m
                             </div>[m
                             <div class="text-sm">[m
                                 <a href="{{ route('password.request') }}"[m
[31m-                                    class="font-medium text-blue-600 hover:text-blue-500">[m
[31m-                                    Forgot your password?[m
[32m+[m[32m                                    class="font-medium text-market-secondary hover:text-yellow-500 transition-colors">[m
[32m+[m[32m                                    Forget password?[m
                                 </a>[m
                             </div>[m
                         </div>[m
 [m
                         <div>[m
                             <button type="submit" id="loginButton"[m
[31m-                                class="rounded-button whitespace-nowrap w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 cursor-pointer">[m
[32m+[m[32m                                class="w-full flex justify-center items-center py-2.5 px-4 border border-transparent text-sm font-medium rounded-xl text-white bg-market-primary hover:bg-market-secondary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-400 cursor-pointer transition-all duration-300 shadow-lg hover:shadow-xl">[m
                                 <span id="buttonText">Sign in</span>[m
                                 <span id="spinner" class="hidden ml-2">[m
                                     <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg"[m
[36m@@ -119,9 +156,16 @@[m [mclass="rounded-button whitespace-nowrap w-full flex justify-center py-3 px-4 bor[m
                                 </span>[m
                             </button>[m
                         </div>[m
[32m+[m
[32m+[m[32m                        @if ($errors->has('username'))[m
[32m+[m[32m                            <div class="text-sm text-red-600 mt-2 flex items-center gap-2">[m
[32m+[m[32m                                <i class="fas fa-exclamation-circle"></i>[m
[32m+[m[32m                                <span>{{ $errors->first('username') }}</span>[m
[32m+[m[32m                            </div>[m
[32m+[m[32m                        @endif[m
                     </form>[m
 [m
[31m-                    <p class="mt-8 text-center text-xs text-gray-500">[m
[32m+[m[32m                    <p class="mt-6 text-center text-xs text-gray-500">[m
                         &copy; 2025 Virac Public Market Management System. All rights reserved.[m
                     </p>[m
                 </div>[m
[36m@@ -130,6 +174,23 @@[m [mclass="rounded-button whitespace-nowrap w-full flex justify-center py-3 px-4 bor[m
     </div>[m
 [m
     <script>[m
[32m+[m[32m        // Password toggle functionality[m
[32m+[m[32m        document.getElementById('togglePassword').addEventListener('click', function() {[m
[32m+[m[32m            const passwordInput = document.getElementById('password');[m
[32m+[m[32m            const eyeIcon = document.getElementById('eyeIcon');[m
[32m+[m[41m            [m
[32m+[m[32m            if (passwordInput.type === 'password') {[m
[32m+[m[32m                passwordInput.type = 'text';[m
[32m+[m[32m                eyeIcon.classList.remove('fa-eye');[m
[32m+[m[32m                eyeIcon.classList.add('fa-eye-slash');[m
[32m+[m[32m            } else {[m
[32m+[m[32m                passwordInput.type = 'password';[m
[32m+[m[32m                eyeIcon.classList.remove('fa-eye-slash');[m
[32m+[m[32m                eyeIcon.classList.add('fa-eye');[m
[32m+[m[32m            }[m
[32m+[m[32m        });[m
[32m+[m
[32m+[m[32m        // Form submission handler[m
         document.getElementById('loginForm').addEventListener('submit', function(e) {[m
             const button = document.getElementById('loginButton');[m
             const buttonText = document.getElementById('buttonText');[m
[1mdiff --git a/resources/views/layouts/app.blade.php b/resources/views/layouts/app.blade.php[m
[1mindex f6ad950..2dda972 100644[m
[1m--- a/resources/views/layouts/app.blade.php[m
[1m+++ b/resources/views/layouts/app.blade.php[m
[36m@@ -1,3 +1,6 @@[m
[32m+[m[32m@php[m
[32m+[m[32m    use Illuminate\Support\Facades\Storage;[m
[32m+[m[32m@endphp[m
 <!DOCTYPE html>[m
 <html lang="en">[m
 [m
[36m@@ -107,23 +110,15 @@[m [mclass="text-base font-semibold bg-gradient-to-r from-sky-500 to-indigo-600 bg-cl[m
                         <div class="flex-shrink-0">[m
                             <div id="sidebarProfileImage"[m
                                 class="w-20 h-20 rounded-xl bg-gray-200 flex items-center justify-center shadow-inner overflow-hidden">[m
[31m-                                @php[m
[31m-                                    $sidebarProfileUrl = null;[m
[31m-                                    if (Auth::user()->role && Auth::user()->role->name == 'Vendor' && Auth::user()->profile_picture) {[m
[31m-                                        if (str_starts_with(Auth::user()->profile_picture, 'data:')) {[m
[31m-                                            $sidebarProfileUrl = Auth::user()->profile_picture;[m
[31m-                                        } else {[m
[31m-                                            $sidebarProfileUrl = Storage::disk('b2')->temporaryUrl([m
[31m-                                                Auth::user()->profile_picture,[m
[31m-                                                now()->addDays(7)[m
[31m-                                            );[m
[31m-                                        }[m
[31m-                                    }[m
[31m-                                @endphp[m
[31m-                                @if($sidebarProfileUrl)[m
[31m-                                    <img src="{{ $sidebarProfileUrl }}" alt="Profile" class="w-full h-full object-cover">[m
[32m+[m[32m                                @if(Auth::user()->profile_picture)[m
[32m+[m[32m                                    <img src="{{ Storage::url(Auth::user()->profile_picture) }}"[m[41m [m
[32m+[m[32m                                         alt="Profile"[m[41m [m
[32m+[m[32m                                         class="w-full h-full object-cover"[m
[32m+[m[32m                                         id="sidebarProfilePicture">[m
[32m+[m[32m                                    <i id="sidebarProfileIcon" class="fas fa-user text-4xl text-gray-400 hidden"></i>[m
                                 @else[m
[31m-                                    <i id="sidebarProfileIcon" class="fas fa-user text-4xl text-gray-400"></i>[m
[32m+[m[32m                                    <img id="sidebarProfilePicture" src="" alt="Profile" class="w-full h-full object-cover hidden">[m
[32m+[m[32m                                <i id="sidebarProfileIcon" class="fas fa-user text-4xl text-gray-400"></i>[m
                                 @endif[m
                             </div>[m
                         </div>[m
[1mdiff --git a/resources/views/meter_portal/meter.blade.php b/resources/views/meter_portal/meter.blade.php[m
[1mindex c0b79b7..4296fcd 100644[m
[1m--- a/resources/views/meter_portal/meter.blade.php[m
[1m+++ b/resources/views/meter_portal/meter.blade.php[m
[36m@@ -1,5 +1,9 @@[m
 @extends('layouts.app') {{-- Extends the newly created master layout --}}[m
 [m
[32m+[m[32m@php[m
[32m+[m[32m    use Illuminate\Support\Facades\Storage;[m
[32m+[m[32m@endphp[m
[32m+[m
 @section('title', 'Virac Public Market - Meter Reader Clerk Dashboard') {{-- Sets the specific page title --}}[m
 [m
 @vite('resources/js/meter.js')[m
[36m@@ -28,8 +32,8 @@[m
     <div class="flex-grow">[m
         <a href="#homeSection" data-section="homeSection"[m
             class="nav-link active text-black font-medium rounded-xl p-3 mb-2 hover:bg-gradient-to-r hover:from-[#9466ff] hover:to-[#4f46e5] cursor-pointer flex items-center space-x-3">[m
[31m-            <i class="fas fa-home"></i>[m
[31m-            <span>Home</span>[m
[32m+[m[32m            <i class="fas fa-tasks"></i>[m
[32m+[m[32m            <span>Pending Tasks</span>[m
         </a>[m
         <a href="#electricitySection" data-section="electricitySection"[m
             class="nav-link text-black font-medium rounded-xl p-3 mb-2 hover:bg-gradient-to-r hover:from-[#9466ff] hover:to-[#4f46e5] cursor-pointer flex items-center space-x-3">[m
[36m@@ -47,6 +51,11 @@[m [mclass="nav-link text-black font-medium rounded-xl p-3 mb-2 hover:bg-gradient-to-[m
             <i class="fas fa-archive"></i>[m
             <span>Archived Readings</span>[m
         </a>[m
[32m+[m[32m        <a href="#profileSection" data-section="profileSection"[m
[32m+[m[32m            class="nav-link text-black font-medium rounded-xl p-3 mb-2 hover:bg-gradient-to-r hover:from-[#9466ff] hover:to-[#4f46e5] cursor-pointer flex items-center space-x-3">[m
[32m+[m[32m            <i class="fas fa-user-circle"></i>[m
[32m+[m[32m            <span>Profile</span>[m
[32m+[m[32m        </a>[m
 [m
     </div>[m
 @endsection[m
[36m@@ -70,12 +79,9 @@[m [mclass="nav-link text-black font-medium rounded-xl p-3 mb-2 hover:bg-gradient-to-[m
                 <h3 class="text-lg md:text-xl font-bold text-gray-800 flex items-center gap-2">[m
                     <i class="fas fa-tasks"></i> Pending Tasks[m
                 </h3>[m
[31m-                <div class="status-badge status-pending text-xs md:text-sm mt-2 md:mt-0">Today's[m
[31m-                    Assignments[m
[31m-                </div>[m
             </div>[m
 [m
[31m-            <p>Please refer to the tables below for today's Assignments and[m
[32m+[m[32m            <p>Please refer to the tables below for pending tasks and[m
                 upcoming schedules for electricity readings</p>[m
 [m
             <div>[m
[36m@@ -356,4 +362,96 @@[m [mclass="px-6 py-2 bg-amber-400 text-amber-900 font-bold rounded-lg shadow-sm hove[m
             </div>[m
         </div>[m
     </div>[m
[32m+[m
[32m+[m[32m    {{-- Profile Section --}}[m
[32m+[m[32m    <div id="profileSection" class="dashboard-section">[m
[32m+[m[32m        @include('layouts.partials.content-header', ['title' => 'User Profile'])[m
[32m+[m[41m        [m
[32m+[m[32m        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">[m
[32m+[m[32m            {{-- Profile Picture & Information --}}[m
[32m+[m[32m            <div class="bg-white rounded-2xl shadow-lg p-6">[m
[32m+[m[32m                {{-- Profile Picture Section --}}[m
[32m+[m[32m                <div class="mb-6 text-center">[m
[32m+[m[32m                    <div class="relative inline-block">[m
[32m+[m[32m                        <div id="profilePictureContainer" class="w-32 h-32 rounded-full overflow-hidden bg-gray-200 mx-auto mb-4 border-4 border-market-primary shadow-lg">[m
[32m+[m[32m                            @if(auth()->user()->profile_picture)[m
[32m+[m[32m                                <img id="profilePictureImg" src="{{ Storage::url(auth()->user()->profile_picture) }}"[m[41m [m
[32m+[m[32m                                     alt="Profile Picture" class="w-full h-full object-cover">[m
[32m+[m[32m                            @else[m
[32m+[m[32m                                <div id="profilePicturePlaceholder" class="w-full h-full flex items-center justify-center">[m
[32m+[m[32m                                    <i class="fas fa-user text-6xl text-gray-400"></i>[m
[32m+[m[32m                                </div>[m
[32m+[m[32m                            @endif[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                        <label for="profilePictureInput" class="absolute bottom-0 right-0 bg-market-primary text-white rounded-full p-2 cursor-pointer hover:bg-market-secondary transition-colors shadow-lg">[m
[32m+[m[32m                            <i class="fas fa-camera"></i>[m
[32m+[m[32m                            <input type="file" id="profilePictureInput" accept="image/*" class="hidden">[m
[32m+[m[32m                        </label>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                    <button id="removeProfilePictureBtn" class="text-sm text-red-600 hover:text-red-800 {{ auth()->user()->profile_picture ? '' : 'hidden' }}">[m
[32m+[m[32m                        <i class="fas fa-trash"></i> Remove Picture[m
[32m+[m[32m                    </button>[m
[32m+[m[32m                </div>[m
[32m+[m
[32m+[m[32m                <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2">[m
[32m+[m[32m                    <i class="fas fa-user text-market-primary"></i>[m
[32m+[m[32m                    Profile Information[m
[32m+[m[32m                </h3>[m
[32m+[m[32m                <div class="space-y-4">[m
[32m+[m[32m                    @php[m
[32m+[m[32m                        $user = auth()->user();[m
[32m+[m[32m                        $profileDetails = [[m
[32m+[m[32m                            ['icon' => 'fa-user', 'label' => 'Name', 'value' => $user->name],[m
[32m+[m[32m                            ['icon' => 'fa-at', 'label' => 'Username', 'value' => $user->username],[m
[32m+[m[32m                            ['icon' => 'fa-user-tag', 'label' => 'Role', 'value' => $user->role->name ?? 'N/A'],[m
[32m+[m[32m                            ['icon' => 'fa-phone', 'label' => 'Contact Number', 'value' => $user->contact_number ?? 'Not set'],[m
[32m+[m[32m                            ['icon' => 'fa-calendar', 'label' => 'Last Login', 'value' => $user->last_login ? \Carbon\Carbon::parse($user->last_login)->format('F j, Y g:i A') : 'Never'],[m
[32m+[m[32m                            ['icon' => 'fa-info-circle', 'label' => 'Status', 'value' => ucfirst($user->status ?? 'active')],[m
[32m+[m[32m                        ];[m
[32m+[m[32m                    @endphp[m
[32m+[m[32m                    @foreach ($profileDetails as $detail)[m
[32m+[m[32m                        <div class="flex items-center p-3 bg-gray-50 rounded-lg">[m
[32m+[m[32m                            <i class="fas {{ $detail['icon'] }} text-market-primary w-8 text-center"></i>[m
[32m+[m[32m                            <div class="flex-1 ml-4">[m
[32m+[m[32m                                <span class="text-sm text-gray-600">{{ $detail['label'] }}</span>[m
[32m+[m[32m                                <p class="font-semibold text-gray-800">{{ $detail['value'] }}</p>[m
[32m+[m[32m                            </div>[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                    @endforeach[m
[32m+[m[32m                </div>[m
[32m+[m[32m            </div>[m
[32m+[m
[32m+[m[32m            {{-- Change Password --}}[m
[32m+[m[32m            <div class="bg-white rounded-2xl shadow-lg p-6">[m
[32m+[m[32m                <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2">[m
[32m+[m[32m                    <i class="fas fa-key text-market-primary"></i>[m
[32m+[m[32m                    Change Password[m
[32m+[m[32m                </h3>[m
[32m+[m[32m                <form id="changePasswordForm">[m
[32m+[m[32m                    @csrf[m
[32m+[m[32m                    <div class="mb-4">[m
[32m+[m[32m                        <label for="currentPassword" class="block text-gray-700 font-medium mb-2">Current Password</label>[m
[32m+[m[32m                        <input type="password" id="currentPassword" name="current_password" required[m
[32m+[m[32m                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-market-primary focus:border-transparent">[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                    <div class="mb-4">[m
[32m+[m[32m                        <label for="newPassword" class="block text-gray-700 font-medium mb-2">New Password</label>[m
[32m+[m[32m                        <input type="password" id="newPassword" name="password" required[m
[32m+[m[32m                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-market-primary focus:border-transparent">[m
[32m+[m[32m                        <p class="text-xs text-gray-500 mt-1">Must be at least 8 characters with letters, numbers, symbols, and mixed case</p>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                    <div class="mb-6">[m
[32m+[m[32m                        <label for="confirmPassword" class="block text-gray-700 font-medium mb-2">Confirm New Password</label>[m
[32m+[m[32m                        <input type="password" id="confirmPassword" name="password_confirmation" required[m
[32m+[m[32m                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-market-primary focus:border-transparent">[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                    <button type="submit" id="changePasswordBtn"[m
[32m+[m[32m                        class="w-full bg-gradient-to-r from-market-primary to-market-secondary text-white py-3 rounded-xl font-medium hover:shadow-lg transition-all duration-200 flex items-center justify-center gap-2">[m
[32m+[m[32m                        <i class="fas fa-key"></i>[m
[32m+[m[32m                        <span>Change Password</span>[m
[32m+[m[32m                    </button>[m
[32m+[m[32m                </form>[m
[32m+[m[32m            </div>[m
[32m+[m[32m        </div>[m
[32m+[m[32m    </div>[m
 @endsection[m
[1mdiff --git a/resources/views/printing/report.blade.php b/resources/views/printing/report.blade.php[m
[1mindex 660f517..fe68a40 100644[m
[1m--- a/resources/views/printing/report.blade.php[m
[1m+++ b/resources/views/printing/report.blade.php[m
[36m@@ -4,9 +4,12 @@[m
 <head>[m
     <meta charset="UTF-8">[m
     <title>Monthly Report</title>[m
[31m-    {{-- Load libraries via CDN for client-side generation --}}[m
[31m-    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>[m
[31m-    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>[m
[32m+[m[32m    {{-- Inline the compiled JavaScript for PDF generation --}}[m
[32m+[m[32m    @if (!empty($chartJsContent))[m
[32m+[m[32m        <script>[m
[32m+[m[32m            {!! $chartJsContent !!}[m
[32m+[m[32m        </script>[m
[32m+[m[32m    @endif[m
     <style>[m
         body {[m
             font-family: 'Roboto', sans-serif;[m
[36m@@ -183,7 +186,18 @@[m
     </div>[m
 [m
     <script>[m
[32m+[m[32m        // This script will run inside the headless browser to generate the charts[m
         document.addEventListener('DOMContentLoaded', function() {[m
[32m+[m[32m            // Debug: Check if Chart.js is loaded[m
[32m+[m[32m            console.log('Chart.js loaded:', typeof Chart !== 'undefined');[m
[32m+[m[32m            console.log('Chart object:', typeof Chart);[m
[32m+[m
[32m+[m[32m            // Ensure Chart.js is loaded[m
[32m+[m[32m            if (typeof Chart === 'undefined') {[m
[32m+[m[32m                console.error('Chart.js is not loaded');[m
[32m+[m[32m                return;[m
[32m+[m[32m            }[m
[32m+[m
             const chartData = @json($data['chart_data']);[m
             const utilityColors = {[m
                 Rent: {[m
[36m@@ -251,29 +265,6 @@[m
                 createBarChart(`${util.toLowerCase()}Chart`, `${util} Collections`, data, utilityColors[[m
                     util]);[m
             });[m
[31m-[m
[31m-            // Auto-generate PDF after charts are rendered[m
[31m-            setTimeout(() => {[m
[31m-                const element = document.body;[m
[31m-                const opt = {[m
[31m-                    margin: 0.5,[m
[31m-                    filename: '{{ $filename }}',[m
[31m-                    image: { type: 'jpeg', quality: 0.98 },[m
[31m-                    html2canvas: { scale: 2 },[m
[31m-                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }[m
[31m-                };[m
[31m-                [m
[31m-                // Show a message to the user[m
[31m-                const msg = document.createElement('div');[m
[31m-                msg.innerHTML = '<div style="position:fixed;top:0;left:0;width:100%;background:#4f46e5;color:white;text-align:center;padding:10px;font-size:14px;z-index:9999;">Generating PDF... Please wait.</div>';[m
[31m-                document.body.prepend(msg);[m
[31m-[m
[31m-                html2pdf().set(opt).from(element).save().then(() => {[m
[31m-                    msg.remove();[m
[31m-                    // Optional: Close window after download? [m
[31m-                    // window.close(); [m
[31m-                });[m
[31m-            }, 1500); // 1.5s delay to ensure charts are fully drawn[m
         });[m
     </script>[m
 </body>[m
[1mdiff --git a/resources/views/staff_portal/partials/_payment-history-partial.blade.php b/resources/views/staff_portal/partials/_payment-history-partial.blade.php[m
[1mindex 0f93f03..1fcb901 100644[m
[1m--- a/resources/views/staff_portal/partials/_payment-history-partial.blade.php[m
[1m+++ b/resources/views/staff_portal/partials/_payment-history-partial.blade.php[m
[36m@@ -56,8 +56,6 @@[m [mclass="search-input w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md"[m
                     <th class="px-4 py-2 text-center">Period Covered</th>[m
                     <th class="px-4 py-2 text-center">Bill Amount</th>[m
                     <th class="px-4 py-2 text-center">Due Date</th>[m
[31m-                    <th class="px-4 py-2 text-center">Amount After Due</th>[m
[31m-                    <th class="px-4 py-2 text-center">Disconnection Date</th>[m
                     <th class="px-4 py-2 text-center">Payment Status</th>[m
                 </tr>[m
             </thead>[m
[1mdiff --git a/resources/views/staff_portal/partials/_view-as-vendor-partial.blade.php b/resources/views/staff_portal/partials/_view-as-vendor-partial.blade.php[m
[1mindex 6e3f536..69f415f 100644[m
[1m--- a/resources/views/staff_portal/partials/_view-as-vendor-partial.blade.php[m
[1m+++ b/resources/views/staff_portal/partials/_view-as-vendor-partial.blade.php[m
[36m@@ -1,6 +1,7 @@[m
 <script>[m
[31m-    // Make billing settings globally available for the modal calculation script[m
[32m+[m[32m    // Make billing settings and utility rates globally available for the modal calculation script[m
     window.BILLING_SETTINGS = @json($billingSettings);[m
[32m+[m[32m    window.UTILITY_RATES = @json($utilityRates);[m
 </script>[m
 [m
 [m
[1mdiff --git a/resources/views/staff_portal/partials/payment_history.blade.php b/resources/views/staff_portal/partials/payment_history.blade.php[m
[1mindex 4e5e330..35b8333 100644[m
[1m--- a/resources/views/staff_portal/partials/payment_history.blade.php[m
[1m+++ b/resources/views/staff_portal/partials/payment_history.blade.php[m
[36m@@ -18,24 +18,29 @@[m [mclass="bg-white/20 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:b[m
         <table class="min-w-full">[m
             <thead>[m
                 <tr class="table-header">[m
[31m-                    <th class="px-4 py-2 text-left">Period</th>[m
[31m-                    <th class="px-4 py-2 text-left">Utility</th>[m
[31m-                    <th class="px-4 py-2 text-right">Amount Paid</th>[m
[31m-                    <th class="px-4 py-2 text-center">Payment Date</th>[m
[32m+[m[32m                    <th class="px-4 py-2 text-left">Category</th>[m
[32m+[m[32m                    <th class="px-4 py-2 text-left">Period Covered</th>[m
[32m+[m[32m                    <th class="px-4 py-2 text-right">Bill Amount</th>[m
[32m+[m[32m                    <th class="px-4 py-2 text-center">Due Date</th>[m
[32m+[m[32m                    <th class="px-4 py-2 text-center">Payment Status</th>[m
                 </tr>[m
             </thead>[m
             <tbody>[m
                 @forelse ($paymentHistory as $bill)[m
                     <tr class="table-row">[m
[31m-                        <td class="px-4 py-2">{{ \Carbon\Carbon::parse($bill->period_start)->format('M Y') }}</td>[m
                         <td class="px-4 py-2">{{ $bill->utility_type }}</td>[m
[32m+[m[32m                        <td class="px-4 py-2">{{ \Carbon\Carbon::parse($bill->period_start)->format('M d, Y') }} - {{ \Carbon\Carbon::parse($bill->period_end)->format('M d, Y') }}</td>[m
                         <td class="px-4 py-2 text-right">â‚±{{ number_format($bill->payment->amount_paid, 2) }}</td>[m
[32m+[m[32m                        <td class="px-4 py-2 text-center">{{ \Carbon\Carbon::parse($bill->due_date)->format('M d, Y') }}</td>[m
                         <td class="px-4 py-2 text-center">[m
[31m-                            {{ \Carbon\Carbon::parse($bill->payment->payment_date)->format('M d, Y') }}</td>[m
[32m+[m[32m                            <span class="whitespace-nowrap px-4 py-1.5 text-xs font-semibold text-white bg-gray-800 rounded-full">[m
[32m+[m[32m                                Paid on {{ \Carbon\Carbon::parse($bill->payment->payment_date)->format('M d, Y') }}[m
[32m+[m[32m                            </span>[m
[32m+[m[32m                        </td>[m
                     </tr>[m
                 @empty[m
                     <tr class="table-row">[m
[31m-                        <td colspan="4" class="text-center py-8 text-gray-500">No payment history found.</td>[m
[32m+[m[32m                        <td colspan="5" class="text-center py-8 text-gray-500">No payment history found.</td>[m
                     </tr>[m
                 @endforelse[m
             </tbody>[m
[1mdiff --git a/resources/views/staff_portal/staff.blade.php b/resources/views/staff_portal/staff.blade.php[m
[1mindex a299f0b..ff40a78 100644[m
[1m--- a/resources/views/staff_portal/staff.blade.php[m
[1m+++ b/resources/views/staff_portal/staff.blade.php[m
[36m@@ -1,5 +1,9 @@[m
 @extends('layouts.app')[m
 [m
[32m+[m[32m@php[m
[32m+[m[32m    use Illuminate\Support\Facades\Storage;[m
[32m+[m[32m@endphp[m
[32m+[m
 @section('title', 'Virac Public Market - Admin Aide Dashboard')[m
 [m
 @vite('resources/js/staff.js')[m
[36m@@ -14,8 +18,8 @@[m
     <div class="flex-grow">[m
         <a href="#homeSection" data-section="homeSection"[m
             class="nav-link text-black font-medium rounded-xl p-3 mb-2 hover:bg-gradient-to-r hover:from-[#9466ff] hover:to-[#4f46e5] cursor-pointer transition-smooth flex items-center space-x-3">[m
[31m-            <i class="fas fa-home"></i>[m
[31m-            <span>Home</span>[m
[32m+[m[32m            <i class="fas fa-tasks"></i>[m
[32m+[m[32m            <span>Pending Tasks</span>[m
         </a>[m
         <a href="#vendorManagementSection" data-section="vendorManagementSection"[m
             class="nav-link text-black font-medium rounded-xl p-3 mb-2 hover:bg-gradient-to-r hover:from-[#9466ff] hover:to-[#4f46e5] cursor-pointer transition-smooth flex items-center space-x-3">[m
[36m@@ -37,10 +41,22 @@[m [mclass="nav-link text-black font-medium rounded-xl p-3 mb-2 hover:bg-gradient-to-[m
             <i class="fas fa-chart-line"></i>[m
             <span>Reports</span>[m
         </a>[m
[32m+[m[32m        <a href="#notificationsSection" data-section="notificationsSection"[m
[32m+[m[32m            class="nav-link text-black font-medium rounded-xl p-3 mb-2 hover:bg-gradient-to-r hover:from-[#9466ff] hover:to-[#4f46e5] cursor-pointer transition-smooth flex items-center space-x-3">[m
[32m+[m[32m            <i class="fas fa-bell"></i>[m
[32m+[m[32m            <span>Notifications</span>[m
[32m+[m[32m        </a>[m
[32m+[m[32m        <a href="#profileSection" data-section="profileSection"[m
[32m+[m[32m            class="nav-link text-black font-medium rounded-xl p-3 mb-2 hover:bg-gradient-to-r hover:from-[#9466ff] hover:to-[#4f46e5] cursor-pointer transition-smooth flex items-center space-x-3">[m
[32m+[m[32m            <i class="fas fa-user-circle"></i>[m
[32m+[m[32m            <span>Profile</span>[m
[32m+[m[32m        </a>[m
     </div>[m
 @endsection[m
 [m
 @section('content')[m
[32m+[m[32m    {{-- Announcement banner removed - announcements now appear as notifications in the bell dropdown --}}[m
[32m+[m
     <style>[m
         @media print {[m
 [m
[36m@@ -66,17 +82,39 @@[m [mclass="nav-link text-black font-medium rounded-xl p-3 mb-2 hover:bg-gradient-to-[m
         window.STAFF_PORTAL_STATE = @json($initialState ?? null);[m
         window.DASHBOARD_STATE = @json($dashboardState ?? null);[m
         window.BILLING_SETTINGS = @json($billingSettings ?? null);[m
[32m+[m[32m        window.UTILITY_RATES = @json($utilityRates ?? null);[m
     </script>[m
 [m
     {{-- Home Section --}}[m
     <div id="homeSection" class="dashboard-section">[m
         <div[m
[31m-            class="bg-gradient-to-r from-market-primary to-market-secondary text-white p-6 md:p-8 rounded-2xl mb-8 shadow-lg relative overflow-hidden">[m
[32m+[m[32m            class="bg-gradient-to-r from-market-primary to-market-secondary text-white p-6 md:p-8 rounded-2xl mb-8 shadow-lg relative overflow-visible">[m
             <div class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full transform translate-x-32 -translate-y-32">[m
             </div>[m
             <div class="absolute bottom-0 right-16 w-32 h-32 bg-white/10 rounded-full transform translate-y-16">[m
             </div>[m
[31m-            <h2 id="homeHeader" class="text-2xl md:text-3xl font-semibold relative z-10">Hello, Market Staff!</h2>[m
[32m+[m[32m            <div class="flex items-center justify-between relative z-10">[m
[32m+[m[32m                <h2 id="homeHeader" class="text-2xl md:text-3xl font-semibold">Hello, Market Staff!</h2>[m
[32m+[m[32m                {{-- Notification Bell --}}[m
[32m+[m[32m                <div class="notificationBell relative">[m
[32m+[m[32m                    <button[m
[32m+[m[32m                        class="relative text-white hover:text-gray-200 focus:outline-none transition-transform transform hover:scale-110">[m
[32m+[m[32m                        <i class="fas fa-bell text-2xl"></i>[m
[32m+[m[32m                        <span[m
[32m+[m[32m                            class="notificationDot absolute -top-1 -right-1 block h-3 w-3 rounded-full bg-red-500 border-2 border-white hidden animate-pulse"></span>[m
[32m+[m[32m                    </button>[m
[32m+[m[32m                    {{-- Notification Dropdown Panel --}}[m
[32m+[m[32m                    <div[m
[32m+[m[32m                        class="notificationDropdown hidden absolute top-full right-0 mt-2 w-96 bg-white rounded-lg shadow-2xl border border-gray-200 z-[9999]">[m
[32m+[m[32m                        <div class="p-3 font-semibold text-gray-800 border-b">[m
[32m+[m[32m                            Notifications[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                        <div class="notificationList max-h-96 overflow-y-auto">[m
[32m+[m[32m                            {{-- Notification items will be inserted here by JS --}}[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                </div>[m
[32m+[m[32m            </div>[m
         </div>[m
 [m
         <div class="bg-white p-4 md:p-8 rounded-2xl shadow-soft">[m
[36m@@ -85,9 +123,6 @@[m [mclass="bg-gradient-to-r from-market-primary to-market-secondary text-white p-6 m[m
                     <i class="fas fa-list-ul"></i>[m
                     Pending Tasks[m
                 </h3>[m
[31m-                <div class="status-badge status-pending text-xs md:text-sm mt-2 md:mt-0">[m
[31m-                    Today's Assignments[m
[31m-                </div>[m
             </div>[m
 [m
             <p class="text-gray-600 mb-6">Please refer to the table below for current billing and receipt printing.</p>[m
[36m@@ -141,13 +176,34 @@[m [mclass="px-6 py-3 text-center text-sm font-semibold uppercase tracking-wider">[m
         {{-- List View (This should be here) --}}[m
         <div id="vendorListView">[m
             <div[m
[31m-                class="bg-gradient-to-r from-market-primary to-market-secondary text-white p-6 md:p-8 rounded-2xl mb-8 shadow-lg relative overflow-hidden">[m
[32m+[m[32m                class="bg-gradient-to-r from-market-primary to-market-secondary text-white p-6 md:p-8 rounded-2xl mb-8 shadow-lg relative overflow-visible">[m
                 <div[m
                     class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full transform translate-x-32 -translate-y-32">[m
                 </div>[m
                 <div class="absolute bottom-0 right-16 w-32 h-32 bg-white/10 rounded-full transform translate-y-16">[m
                 </div>[m
[31m-                <h2 id="vendorManagementHeader" class="text-3xl font-semibold relative z-10">Vendor Management</h2>[m
[32m+[m[32m                <div class="flex items-center justify-between relative z-10">[m
[32m+[m[32m                    <h2 id="vendorManagementHeader" class="text-3xl font-semibold">Vendor Management</h2>[m
[32m+[m[32m                    {{-- Notification Bell --}}[m
[32m+[m[32m                    <div class="notificationBell relative">[m
[32m+[m[32m                        <button[m
[32m+[m[32m                            class="relative text-white hover:text-gray-200 focus:outline-none transition-transform transform hover:scale-110">[m
[32m+[m[32m                            <i class="fas fa-bell text-2xl"></i>[m
[32m+[m[32m                            <span[m
[32m+[m[32m                                class="notificationDot absolute -top-1 -right-1 block h-3 w-3 rounded-full bg-red-500 border-2 border-white hidden animate-pulse"></span>[m
[32m+[m[32m                        </button>[m
[32m+[m[32m                        {{-- Notification Dropdown Panel --}}[m
[32m+[m[32m                        <div[m
[32m+[m[32m                            class="notificationDropdown hidden absolute top-full right-0 mt-2 w-96 bg-white rounded-lg shadow-2xl border border-gray-200 z-[9999]">[m
[32m+[m[32m                            <div class="p-3 font-semibold text-gray-800 border-b">[m
[32m+[m[32m                                Notifications[m
[32m+[m[32m                            </div>[m
[32m+[m[32m                            <div class="notificationList max-h-96 overflow-y-auto">[m
[32m+[m[32m                                {{-- Notification items will be inserted here by JS --}}[m
[32m+[m[32m                            </div>[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                </div>[m
             </div>[m
             <div class="card-table p-6 rounded-2xl shadow-soft h-auto max-w-6xl mx-auto">[m
                 <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-6">[m
[36m@@ -195,19 +251,40 @@[m [mclass="block w-full pl-10 pr-10 py-2 border-gray-200 border rounded-lg leading-5[m
         {{-- Detail View (This should be here) --}}[m
         <div id="vendorDetailSection" class="hidden">[m
             <div[m
[31m-                class="bg-gradient-to-r from-market-primary to-market-secondary text-white p-6 md:p-8 rounded-2xl mb-8 shadow-lg relative overflow-hidden">[m
[32m+[m[32m                class="bg-gradient-to-r from-market-primary to-market-secondary text-white p-6 md:p-8 rounded-2xl mb-8 shadow-lg relative overflow-visible">[m
                 <div[m
                     class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full transform translate-x-32 -translate-y-32">[m
                 </div>[m
                 <div class="absolute bottom-0 right-16 w-32 h-32 bg-white/10 rounded-full transform translate-y-16">[m
                 </div>[m
                 <div class="flex justify-between items-center relative z-10">[m
[31m-                    <h2 class="text-3xl font-semibold relative z-10">Vendor Information</h2>[m
[32m+[m[32m                    <h2 class="text-3xl font-semibold">Vendor Information</h2>[m
[32m+[m[32m                    <div class="flex items-center gap-3">[m
[32m+[m[32m                        {{-- Notification Bell --}}[m
[32m+[m[32m                        <div class="notificationBell relative">[m
[32m+[m[32m                            <button[m
[32m+[m[32m                                class="relative text-white hover:text-gray-200 focus:outline-none transition-transform transform hover:scale-110">[m
[32m+[m[32m                                <i class="fas fa-bell text-2xl"></i>[m
[32m+[m[32m                                <span[m
[32m+[m[32m                                    class="notificationDot absolute -top-1 -right-1 block h-3 w-3 rounded-full bg-red-500 border-2 border-white hidden animate-pulse"></span>[m
[32m+[m[32m                            </button>[m
[32m+[m[32m                            {{-- Notification Dropdown Panel --}}[m
[32m+[m[32m                            <div[m
[32m+[m[32m                                class="notificationDropdown hidden absolute top-full right-0 mt-2 w-96 bg-white rounded-lg shadow-2xl border border-gray-200 z-[9999]">[m
[32m+[m[32m                                <div class="p-3 font-semibold text-gray-800 border-b">[m
[32m+[m[32m                                    Notifications[m
[32m+[m[32m                                </div>[m
[32m+[m[32m                                <div class="notificationList max-h-96 overflow-y-auto">[m
[32m+[m[32m                                    {{-- Notification items will be inserted here by JS --}}[m
[32m+[m[32m                                </div>[m
[32m+[m[32m                            </div>[m
[32m+[m[32m                        </div>[m
                     <button id="backToVendorList"[m
                         class="bg-white/20 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-white/30 transition-smooth flex items-center gap-2">[m
                         <i class="fas fa-arrow-left"></i>[m
                         Back to List[m
                     </button>[m
[32m+[m[32m                    </div>[m
                 </div>[m
             </div>[m
             <div class="bg-white p-4 md:p-8 rounded-2xl shadow-soft">[m
[36m@@ -280,13 +357,36 @@[m [mclass="font-semibold text-gray-800 info-span"></span>[m
     </div>[m
 [m
     <div id="stallAssignmentSection" class="dashboard-section">[m
[31m-        <div class="bg-gradient-to-r from-market-primary to-market-secondary text-white p-6 md:p-8 rounded-2xl mb-8 shadow-lg">[m
[31m-            <h2 class="text-3xl font-semibold">Stall Assignment</h2>[m
[31m-            <p class="text-lg">Assign available stalls to unassigned vendors.</p>[m
[32m+[m[32m        <div class="bg-gradient-to-r from-market-primary to-market-secondary text-white p-4 md:p-6 rounded-2xl mb-4 shadow-lg relative overflow-hidden">[m
[32m+[m[32m            <div class="flex items-start justify-between">[m
[32m+[m[32m                <div>[m
[32m+[m[32m            <h2 class="text-2xl md:text-3xl font-semibold">Stall Assignment</h2>[m
[32m+[m[32m                    <p class="text-base md:text-lg mt-1">Assign available stalls to unassigned vendors.</p>[m
[32m+[m[32m                </div>[m
[32m+[m[32m                {{-- Notification Bell --}}[m
[32m+[m[32m                <div class="notificationBell relative">[m
[32m+[m[32m                    <button[m
[32m+[m[32m                        class="relative text-white hover:text-gray-200 focus:outline-none transition-transform transform hover:scale-110">[m
[32m+[m[32m                        <i class="fas fa-bell text-2xl"></i>[m
[32m+[m[32m                        <span[m
[32m+[m[32m                            class="notificationDot absolute -top-1 -right-1 block h-3 w-3 rounded-full bg-red-500 border-2 border-white hidden animate-pulse"></span>[m
[32m+[m[32m                    </button>[m
[32m+[m[32m                    {{-- Notification Dropdown Panel --}}[m
[32m+[m[32m                    <div[m
[32m+[m[32m                        class="notificationDropdown hidden absolute top-full right-0 mt-2 w-96 bg-white rounded-lg shadow-2xl border border-gray-200 z-[9999]">[m
[32m+[m[32m                        <div class="p-3 font-semibold text-gray-800 border-b">[m
[32m+[m[32m                            Notifications[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                        <div class="notificationList max-h-96 overflow-y-auto">[m
[32m+[m[32m                            {{-- Notification items will be inserted here by JS --}}[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                </div>[m
[32m+[m[32m            </div>[m
         </div>[m
 [m
[31m-        <div class="card-table p-4 md:p-8 rounded-2xl shadow-soft max-w-4xl mx-auto">[m
[31m-            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-end">[m
[32m+[m[32m        <div class="card-table p-4 md:p-6 rounded-2xl shadow-soft">[m
[32m+[m[32m            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 items-end">[m
 [m
                 {{-- Vendor Selection --}}[m
                 <div>[m
[36m@@ -315,8 +415,8 @@[m [mclass="flex-grow p-3 border border-gray-300 rounded-md bg-white">[m
                 </div>[m
             </div>[m
 [m
[31m-            <div class="mt-8 text-center">[m
[31m-                <button id="assignStallBtn" class="action-button w-full md:w-1/2">[m
[32m+[m[32m            <div class="mt-6 text-center">[m
[32m+[m[32m                <button id="assignStallBtn" class="action-button w-full">[m
                     <i class="fas fa-link"></i>[m
                     Assign Stall to Vendor[m
                 </button>[m
[36m@@ -328,12 +428,33 @@[m [mclass="flex-grow p-3 border border-gray-300 rounded-md bg-white">[m
     <div id="dashboardSection" class="dashboard-section">[m
         {{-- Header --}}[m
         <div[m
[31m-            class="bg-gradient-to-r from-market-primary to-market-secondary text-white p-6 md:p-8 rounded-2xl mb-8 shadow-lg relative overflow-hidden">[m
[32m+[m[32m            class="bg-gradient-to-r from-market-primary to-market-secondary text-white p-6 md:p-8 rounded-2xl mb-8 shadow-lg relative overflow-visible">[m
             <div[m
                 class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full transform translate-x-32 -translate-y-32">[m
             </div>[m
             <div class="absolute bottom-0 right-16 w-32 h-32 bg-white/10 rounded-full transform translate-y-16"></div>[m
[31m-            <h2 class="text-2xl md:text-3xl font-semibold relative z-10">Dashboard</h2>[m
[32m+[m[32m            <div class="flex items-center justify-between relative z-10">[m
[32m+[m[32m                <h2 class="text-2xl md:text-3xl font-semibold">Dashboard</h2>[m
[32m+[m[32m                {{-- Notification Bell --}}[m
[32m+[m[32m                <div class="notificationBell relative">[m
[32m+[m[32m                    <button[m
[32m+[m[32m                        class="relative text-white hover:text-gray-200 focus:outline-none transition-transform transform hover:scale-110">[m
[32m+[m[32m                        <i class="fas fa-bell text-2xl"></i>[m
[32m+[m[32m                        <span[m
[32m+[m[32m                            class="notificationDot absolute -top-1 -right-1 block h-3 w-3 rounded-full bg-red-500 border-2 border-white hidden animate-pulse"></span>[m
[32m+[m[32m                    </button>[m
[32m+[m[32m                    {{-- Notification Dropdown Panel --}}[m
[32m+[m[32m                    <div[m
[32m+[m[32m                        class="notificationDropdown hidden absolute top-full right-0 mt-2 w-96 bg-white rounded-lg shadow-2xl border border-gray-200 z-[9999]">[m
[32m+[m[32m                        <div class="p-3 font-semibold text-gray-800 border-b">[m
[32m+[m[32m                            Notifications[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                        <div class="notificationList max-h-96 overflow-y-auto">[m
[32m+[m[32m                            {{-- Notification items will be inserted here by JS --}}[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                </div>[m
[32m+[m[32m            </div>[m
         </div>[m
 [m
         {{-- Sub-header with Title and Year Filter --}}[m
[36m@@ -426,13 +547,34 @@[m [mclass="text-sm bg-gray-50 border border-gray-300 rounded-lg px-3 py-1 focus:outl[m
     <div id="reportsSection" class="dashboard-section">[m
         {{-- Header remains the same --}}[m
         <div[m
[31m-            class="bg-gradient-to-r from-market-primary to-market-secondary text-white p-6 md:p-8 rounded-2xl mb-8 shadow-lg relative overflow-hidden">[m
[32m+[m[32m            class="bg-gradient-to-r from-market-primary to-market-secondary text-white p-6 md:p-8 rounded-2xl mb-8 shadow-lg relative overflow-visible">[m
             <div[m
                 class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full transform translate-x-32 -translate-y-32">[m
             </div>[m
             <div class="absolute bottom-0 right-16 w-32 h-32 bg-white/10 rounded-full transform translate-y-16">[m
             </div>[m
[31m-            <h2 id="reportsHeader" class="text-3xl font-semibold relative z-10">Reports</h2>[m
[32m+[m[32m            <div class="flex items-center justify-between relative z-10">[m
[32m+[m[32m                <h2 id="reportsHeader" class="text-3xl font-semibold">Reports</h2>[m
[32m+[m[32m                {{-- Notification Bell --}}[m
[32m+[m[32m                <div class="notificationBell relative">[m
[32m+[m[32m                    <button[m
[32m+[m[32m                        class="relative text-white hover:text-gray-200 focus:outline-none transition-transform transform hover:scale-110">[m
[32m+[m[32m                        <i class="fas fa-bell text-2xl"></i>[m
[32m+[m[32m                        <span[m
[32m+[m[32m                            class="notificationDot absolute -top-1 -right-1 block h-3 w-3 rounded-full bg-red-500 border-2 border-white hidden animate-pulse"></span>[m
[32m+[m[32m                    </button>[m
[32m+[m[32m                    {{-- Notification Dropdown Panel --}}[m
[32m+[m[32m                    <div[m
[32m+[m[32m                        class="notificationDropdown hidden absolute top-full right-0 mt-2 w-96 bg-white rounded-lg shadow-2xl border border-gray-200 z-[9999]">[m
[32m+[m[32m                        <div class="p-3 font-semibold text-gray-800 border-b">[m
[32m+[m[32m                            Notifications[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                        <div class="notificationList max-h-96 overflow-y-auto">[m
[32m+[m[32m                            {{-- Notification items will be inserted here by JS --}}[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                </div>[m
[32m+[m[32m            </div>[m
         </div>[m
 [m
         <div class="bg-white p-4 md:p-8 rounded-2xl shadow-soft">[m
[36m@@ -619,6 +761,137 @@[m [mclass="modal-container hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex it[m
         </div>[m
     </div>[m
 [m
[32m+[m[32m    {{-- Profile Section --}}[m
[32m+[m[32m    <div id="profileSection" class="dashboard-section">[m
[32m+[m[32m        @include('layouts.partials.content-header', ['title' => 'User Profile'])[m
[32m+[m[41m        [m
[32m+[m[32m        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">[m
[32m+[m[32m            {{-- Profile Picture & Information --}}[m
[32m+[m[32m            <div class="bg-white rounded-2xl shadow-lg p-6">[m
[32m+[m[32m                {{-- Profile Picture Section --}}[m
[32m+[m[32m                <div class="mb-6 text-center">[m
[32m+[m[32m                    <div class="relative inline-block">[m
[32m+[m[32m                        <div id="profilePictureContainer" class="w-32 h-32 rounded-full overflow-hidden bg-gray-200 mx-auto mb-4 border-4 border-market-primary shadow-lg">[m
[32m+[m[32m                            @if(auth()->user()->profile_picture)[m
[32m+[m[32m                                <img id="profilePictureImg" src="{{ Storage::url(auth()->user()->profile_picture) }}"[m[41m [m
[32m+[m[32m                                     alt="Profile Picture" class="w-full h-full object-cover">[m
[32m+[m[32m                            @else[m
[32m+[m[32m                                <div id="profilePicturePlaceholder" class="w-full h-full flex items-center justify-center">[m
[32m+[m[32m                                    <i class="fas fa-user text-6xl text-gray-400"></i>[m
[32m+[m[32m                                </div>[m
[32m+[m[32m                            @endif[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                        <label for="profilePictureInput" class="absolute bottom-0 right-0 bg-market-primary text-white rounded-full p-2 cursor-pointer hover:bg-market-secondary transition-colors shadow-lg">[m
[32m+[m[32m                            <i class="fas fa-camera"></i>[m
[32m+[m[32m                            <input type="file" id="profilePictureInput" accept="image/*" class="hidden">[m
[32m+[m[32m                        </label>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                    <button id="removeProfilePictureBtn" class="text-sm text-red-600 hover:text-red-800 {{ auth()->user()->profile_picture ? '' : 'hidden' }}">[m
[32m+[m[32m                        <i class="fas fa-trash"></i> Remove Picture[m
[32m+[m[32m                    </button>[m
[32m+[m[32m                </div>[m
[32m+[m
[32m+[m[32m                <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2">[m
[32m+[m[32m                    <i class="fas fa-user text-market-primary"></i>[m
[32m+[m[32m                    Profile Information[m
[32m+[m[32m                </h3>[m
[32m+[m[32m                <div class="space-y-4">[m
[32m+[m[32m                    @php[m
[32m+[m[32m                        $user = auth()->user();[m
[32m+[m[32m                        $profileDetails = [[m
[32m+[m[32m                            ['icon' => 'fa-user', 'label' => 'Name', 'value' => $user->name],[m
[32m+[m[32m                            ['icon' => 'fa-at', 'label' => 'Username', 'value' => $user->username],[m
[32m+[m[32m                            ['icon' => 'fa-user-tag', 'label' => 'Role', 'value' => $user->role->name ?? 'N/A'],[m
[32m+[m[32m                            ['icon' => 'fa-phone', 'label' => 'Contact Number', 'value' => $user->contact_number ?? 'Not set'],[m
[32m+[m[32m                            ['icon' => 'fa-calendar', 'label' => 'Last Login', 'value' => $user->last_login ? \Carbon\Carbon::parse($user->last_login)->format('F j, Y g:i A') : 'Never'],[m
[32m+[m[32m                            ['icon' => 'fa-info-circle', 'label' => 'Status', 'value' => ucfirst($user->status ?? 'active')],[m
[32m+[m[32m                        ];[m
[32m+[m[32m                    @endphp[m
[32m+[m[32m                    @foreach ($profileDetails as $detail)[m
[32m+[m[32m                        <div class="flex items-center p-3 bg-gray-50 rounded-lg">[m
[32m+[m[32m                            <i class="fas {{ $detail['icon'] }} text-market-primary w-8 text-center"></i>[m
[32m+[m[32m                            <div class="flex-1 ml-4">[m
[32m+[m[32m                                <span class="text-sm text-gray-600">{{ $detail['label'] }}</span>[m
[32m+[m[32m                                <p class="font-semibold text-gray-800">{{ $detail['value'] }}</p>[m
[32m+[m[32m                            </div>[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                    @endforeach[m
[32m+[m[32m                </div>[m
[32m+[m[32m            </div>[m
[32m+[m
[32m+[m[32m            {{-- Change Password --}}[m
[32m+[m[32m            <div class="bg-white rounded-2xl shadow-lg p-6">[m
[32m+[m[32m                <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2">[m
[32m+[m[32m                    <i class="fas fa-key text-market-primary"></i>[m
[32m+[m[32m                    Change Password[m
[32m+[m[32m                </h3>[m
[32m+[m[32m                <form id="changePasswordForm">[m
[32m+[m[32m                    @csrf[m
[32m+[m[32m                    <div class="mb-4">[m
[32m+[m[32m                        <label for="currentPassword" class="block text-gray-700 font-medium mb-2">Current Password</label>[m
[32m+[m[32m                        <input type="password" id="currentPassword" name="current_password" required[m
[32m+[m[32m                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-market-primary focus:border-transparent">[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                    <div class="mb-4">[m
[32m+[m[32m                        <label for="newPassword" class="block text-gray-700 font-medium mb-2">New Password</label>[m
[32m+[m[32m                        <input type="password" id="newPassword" name="password" required[m
[32m+[m[32m                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-market-primary focus:border-transparent">[m
[32m+[m[32m                        <p class="text-xs text-gray-500 mt-1">Must be at least 8 characters with letters, numbers, symbols, and mixed case</p>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                    <div class="mb-6">[m
[32m+[m[32m                        <label for="confirmPassword" class="block text-gray-700 font-medium mb-2">Confirm New Password</label>[m
[32m+[m[32m                        <input type="password" id="confirmPassword" name="password_confirmation" required[m
[32m+[m[32m                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-market-primary focus:border-transparent">[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                    <button type="submit" id="changePasswordBtn"[m
[32m+[m[32m                        class="w-full bg-gradient-to-r from-market-primary to-market-secondary text-white py-3 rounded-xl font-medium hover:shadow-lg transition-all duration-200 flex items-center justify-center gap-2">[m
[32m+[m[32m                        <i class="fas fa-key"></i>[m
[32m+[m[32m                        <span>Change Password</span>[m
[32m+[m[32m                    </button>[m
[32m+[m[32m                </form>[m
[32m+[m[32m            </div>[m
[32m+[m[32m        </div>[m
[32m+[m[32m    </div>[m
[32m+[m
[32m+[m[32m    {{-- Notifications Section --}}[m
[32m+[m[32m    <div id="notificationsSection" class="dashboard-section">[m
[32m+[m[32m        <div class="bg-gradient-to-r from-market-primary to-market-secondary text-white p-4 md:p-6 rounded-2xl mb-4 shadow-lg relative overflow-hidden">[m
[32m+[m[32m            <div class="flex items-start justify-between">[m
[32m+[m[32m                <div>[m
[32m+[m[32m                    <h2 class="text-2xl md:text-3xl font-semibold">Notifications</h2>[m
[32m+[m[32m                    <p class="text-base md:text-lg mt-1">View all your notifications</p>[m
[32m+[m[32m                </div>[m
[32m+[m[32m            </div>[m
[32m+[m[32m        </div>[m
[32m+[m
[32m+[m[32m        <div class="card-table p-4 md:p-6 rounded-2xl shadow-soft">[m
[32m+[m[32m            <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4 mb-6">[m
[32m+[m[32m                <div class="flex items-center gap-4">[m
[32m+[m[32m                    <button id="markAllAsReadBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold px-4 py-2 rounded-lg transition-smooth flex items-center gap-2">[m
[32m+[m[32m                        <i class="fas fa-check-double"></i>[m
[32m+[m[32m                        <span>Mark All as Read</span>[m
[32m+[m[32m                    </button>[m
[32m+[m[32m                    <span id="unreadCountBadge" class="bg-red-500 text-white px-3 py-1 rounded-full text-sm font-semibold hidden">[m
[32m+[m[32m                        <span id="unreadCountText">0</span> unread[m
[32m+[m[32m                    </span>[m
[32m+[m[32m                </div>[m
[32m+[m[32m            </div>[m
[32m+[m
[32m+[m[32m            <div id="notificationsLoader" class="text-center py-8 text-gray-500">[m
[32m+[m[32m                <i class="fas fa-spinner fa-spin mr-2"></i>Loading notifications...[m
[32m+[m[32m            </div>[m
[32m+[m
[32m+[m[32m            <div id="notificationsList" class="space-y-3 hidden">[m
[32m+[m[32m                {{-- Notifications will be populated by JavaScript --}}[m
[32m+[m[32m            </div>[m
[32m+[m
[32m+[m[32m            <div id="noNotificationsMessage" class="text-center py-8 text-gray-500 hidden">[m
[32m+[m[32m                <i class="fas fa-bell-slash text-4xl mb-4 text-gray-400"></i>[m
[32m+[m[32m                <p class="text-lg">You have no notifications.</p>[m
[32m+[m[32m            </div>[m
[32m+[m[32m        </div>[m
[32m+[m[32m    </div>[m
[32m+[m
     {{-- Toast Notification --}}[m
     <div id="toastContainer" class="fixed top-4 right-4 z-[100] space-y-2"></div>[m
 @endsection[m
[1mdiff --git a/resources/views/superadmin_portal/superadmin.blade.php b/resources/views/superadmin_portal/superadmin.blade.php[m
[1mindex 44a1016..55f6626 100644[m
[1m--- a/resources/views/superadmin_portal/superadmin.blade.php[m
[1m+++ b/resources/views/superadmin_portal/superadmin.blade.php[m
[36m@@ -1,5 +1,9 @@[m
 @extends('layouts.app')[m
 [m
[32m+[m[32m@php[m
[32m+[m[32m    use Illuminate\Support\Facades\Storage;[m
[32m+[m[32m@endphp[m
[32m+[m
 @section('title', 'Virac Public Market - Superadmin Dashboard')[m
 [m
 @vite('resources/js/superadmin.js')[m
[36m@@ -76,6 +80,11 @@[m [mclass="nav-link text-black font-medium rounded-xl p-3 mb-3 hover:bg-gradient-to-[m
         <i class="fas fa-clipboard-list"></i>[m
         <span>Audit Trails</span>[m
     </a>[m
[32m+[m[32m    <a href="#profileSection" data-section="profileSection"[m
[32m+[m[32m        class="nav-link text-black font-medium rounded-xl p-3 mb-3 hover:bg-gradient-to-r hover:from-[#9466ff] hover:to-[#4f46e5] cursor-pointer transition-smooth flex items-center space-x-3">[m
[32m+[m[32m        <i class="fas fa-user-circle"></i>[m
[32m+[m[32m        <span>Profile</span>[m
[32m+[m[32m    </a>[m
 @endsection[m
 [m
 @section('content')[m
[36m@@ -350,6 +359,34 @@[m [mclass="flex-1 bg-gray-500 text-white py-3 rounded-lg font-medium hover:bg-gray-6[m
             </div>[m
         </div>[m
 [m
[32m+[m[32m        {{-- History Log Card --}}[m
[32m+[m[32m        <div class="bg-white rounded-2xl shadow-lg p-6">[m
[32m+[m[32m            <h3 class="text-2xl font-semibold text-gray-800 mb-6">History Logs</h3>[m
[32m+[m[32m            <div id="rentalRateHistoryContainer" class="history-log-container">[m
[32m+[m[32m                <div class="overflow-x-auto">[m
[32m+[m[32m                    <table class="w-full border-collapse responsive-table">[m
[32m+[m[32m                        <thead>[m
[32m+[m[32m                            <tr class="bg-gradient-to-r from-gray-50 to-gray-100">[m
[32m+[m[32m                                <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-700">Date & Time</th>[m
[32m+[m[32m                                <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-700">Action</th>[m
[32m+[m[32m                                <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-700">Table Number</th>[m
[32m+[m[32m                                <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-700">Section</th>[m
[32m+[m[32m                                <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-700">Old Daily Rate</th>[m
[32m+[m[32m                                <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-700">New Daily Rate</th>[m
[32m+[m[32m                                <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-700">Old Monthly Rate</th>[m
[32m+[m[32m                                <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-700">New Monthly Rate</th>[m
[32m+[m[32m                            </tr>[m
[32m+[m[32m                        </thead>[m
[32m+[m[32m                        <tbody id="rentalRateHistoryTableBody">[m
[32m+[m[32m                            {{-- History rows will be populated by JavaScript --}}[m
[32m+[m[32m                        </tbody>[m
[32m+[m[32m                    </table>[m
[32m+[m[32m                </div>[m
[32m+[m[32m            </div>[m
[32m+[m[32m            <div id="rentalRateHistoryLoader" class="history-log-loader">[m
[32m+[m[32m                <i class="fas fa-spinner fa-spin"></i> Loading...[m
[32m+[m[32m            </div>[m
[32m+[m[32m        </div>[m
     </div>[m
 [m
     {{-- =================================================================== --}}[m
[36m@@ -358,7 +395,7 @@[m [mclass="flex-1 bg-gray-500 text-white py-3 rounded-lg font-medium hover:bg-gray-6[m
     <div id="electricityWaterRatesSection" class="dashboard-section overflow-visible">[m
         @include('layouts.partials.content-header', [[m
             'title' => 'Billing Management',[m
[31m-            'subtitle' => 'Market Stall/Table Rental Rates',[m
[32m+[m[32m            'subtitle' => 'Electricity and Water Rates',[m
             'icon' => 'fa-file-invoice-dollar',[m
         ])[m
 [m
[36m@@ -691,7 +728,7 @@[m [mclass="template-editor w-full border border-gray-300 rounded-lg p-3 focus:ring-2[m
                             <label class="block text-gray-800 font-semibold mb-2">Live Preview</label>[m
                             <div class="w-full max-w-xs h-64 bg-gray-800 rounded-2xl p-2 shadow-lg">[m
                                 <div data-preview-for="templateBillStatementWet"[m
[31m-                                    class="bg-white rounded-lg h-full p-3 text-gray-800 break-words">[m
[32m+[m[32m                                    class="bg-white rounded-lg h-full p-3 text-gray-800 break-words overflow-y-auto overflow-x-hidden whitespace-pre-wrap">[m
                                     Your message preview will appear here.[m
                                 </div>[m
                             </div>[m
[36m@@ -713,7 +750,7 @@[m [mclass="template-editor w-full border border-gray-300 rounded-lg p-3 focus:ring-2[m
                             <label class="block text-gray-800 font-semibold mb-2">Live Preview</label>[m
                             <div class="w-full max-w-xs h-64 bg-gray-800 rounded-2xl p-2 shadow-lg">[m
                                 <div data-preview-for="templateBillStatementDry"[m
[31m-                                    class="bg-white rounded-lg h-full p-3 text-gray-800 break-words">[m
[32m+[m[32m                                    class="bg-white rounded-lg h-full p-3 text-gray-800 break-words overflow-y-auto overflow-x-hidden whitespace-pre-wrap">[m
                                     Your message preview will appear here.[m
                                 </div>[m
                             </div>[m
[36m@@ -739,7 +776,7 @@[m [mclass="template-editor w-full border border-gray-300 rounded-lg p-3 focus:ring-2[m
                             <label class="block text-gray-800 font-semibold mb-2">Live Preview</label>[m
                             <div class="w-full max-w-xs h-64 bg-gray-800 rounded-2xl p-2 shadow-lg">[m
                                 <div data-preview-for="templatePaymentReminder"[m
[31m-                                    class="bg-white rounded-lg h-full p-3 text-gray-800 break-words"></div>[m
[32m+[m[32m                                    class="bg-white rounded-lg h-full p-3 text-gray-800 break-words overflow-y-auto overflow-x-hidden whitespace-pre-wrap"></div>[m
                             </div>[m
                         </div>[m
                     </div>[m
[36m@@ -762,7 +799,7 @@[m [mclass="template-editor w-full border border-gray-300 rounded-lg p-3 focus:ring-2[m
                             <label class="block text-gray-800 font-semibold mb-2">Live Preview</label>[m
                             <div class="w-full max-w-xs h-64 bg-gray-800 rounded-2xl p-2 shadow-lg">[m
                                 <div data-preview-for="templateOverdueAlert"[m
[31m-                                    class="bg-white rounded-lg h-full p-3 text-gray-800 break-words"></div>[m
[32m+[m[32m                                    class="bg-white rounded-lg h-full p-3 text-gray-800 break-words overflow-y-auto overflow-x-hidden whitespace-pre-wrap"></div>[m
                             </div>[m
                         </div>[m
                     </div>[m
[36m@@ -771,35 +808,112 @@[m [mclass="bg-white rounded-lg h-full p-3 text-gray-800 break-words"></div>[m
 [m
             {{-- Placeholder Guide and Save Button --}}[m
             <div class="mt-8 pt-6 border-t border-gray-200">[m
[31m-                <h4 class="text-lg font-semibold text-gray-800 mb-3">Click to Insert Placeholders</h4>[m
[31m-                <div id="placeholderButtons" class="flex flex-wrap gap-2 mb-6">[m
[31m-                    {{-- These will now be buttons --}}[m
[31m-                    <button[m
[31m-                        class="placeholder-btn bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-market-primary hover:text-white transition-colors">@{{ vendor_name }}</button>[m
[31m-                    <button[m
[31m-                        class="placeholder-btn bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-market-primary hover:text-white transition-colors">@{{ stall_number }}</button>[m
[31m-                    <button[m
[31m-                        class="placeholder-btn bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-market-primary hover:text-white transition-colors">@{{ due_date }}</button>[m
[31m-                    <button[m
[31m-                        class="placeholder-btn bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-market-primary hover:text-white transition-colors">@{{ disconnection_date }}</button>[m
[31m-                    <button[m
[31m-                        class="placeholder-btn bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-market-primary hover:text-white transition-colors">@{{ total_due }}</button>[m
[31m-                    <button[m
[31m-                        class="placeholder-btn bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-market-primary hover:text-white transition-colors">@{{ unpaid_items }}</button>[m
[31m-                    <button[m
[31m-                        class="placeholder-btn bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-market-primary hover:text-white transition-colors">@{{ rent_amount }}</button>[m
[31m-                    <button[m
[31m-                        class="placeholder-btn bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-market-primary hover:text-white transition-colors">@{{ water_amount }}</button>[m
[31m-                    <button[m
[31m-                        class="placeholder-btn bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-market-primary hover:text-white transition-colors">@{{ electricity_amount }}</button>[m
[31m-                    <button[m
[31m-                        class="placeholder-btn bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-market-primary hover:text-white transition-colors">@{{ new_total_due }}</button>[m
[31m-                    <button[m
[31m-                        class="placeholder-btn bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-market-primary hover:text-white transition-colors">@{{ bill_details }}</button>[m
[31m-                    <button[m
[31m-                        class="placeholder-btn bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-market-primary hover:text-white transition-colors">@{{ upcoming_bill_details }}</button>[m
[31m-                    <button[m
[31m-                        class="placeholder-btn bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-market-primary hover:text-white transition-colors">@{{ overdue_bill_details }}</button>[m
[32m+[m[32m                <div class="flex items-center justify-between mb-4">[m
[32m+[m[32m                    <h4 class="text-lg font-semibold text-gray-800">Available Placeholders</h4>[m
[32m+[m[32m                    <input type="text" id="placeholderSearch" placeholder="Search placeholders..."[m[41m [m
[32m+[m[32m                        class="px-3 py-1 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-market-primary focus:border-market-primary">[m
[32m+[m[32m                </div>[m
[32m+[m[41m                [m
[32m+[m[32m                <div id="placeholderButtons" class="space-y-4 mb-6">[m
[32m+[m[32m                    {{-- Basic Information --}}[m
[32m+[m[32m                    <div class="placeholder-category">[m
[32m+[m[32m                        <h5 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">[m
[32m+[m[32m                            <i class="fas fa-user text-market-primary"></i>[m
[32m+[m[32m                            Basic Information[m
[32m+[m[32m                        </h5>[m
[32m+[m[32m                        <div class="flex flex-wrap gap-2">[m
[32m+[m[32m                            <button class="placeholder-btn bg-blue-50 text-blue-700 px-3 py-1.5 rounded-md hover:bg-blue-100 border border-blue-200 transition-colors text-sm font-mono"[m[41m [m
[32m+[m[32m                                data-category="basic" title="Vendor's full name">@{{ vendor_name }}</button>[m
[32m+[m[32m                            <button class="placeholder-btn bg-blue-50 text-blue-700 px-3 py-1.5 rounded-md hover:bg-blue-100 border border-blue-200 transition-colors text-sm font-mono"[m[41m [m
[32m+[m[32m                                data-category="basic" title="Stall/Table number">@{{ stall_number }}</button>[m
[32m+[m[32m                            <button class="placeholder-btn bg-blue-50 text-blue-700 px-3 py-1.5 rounded-md hover:bg-blue-100 border border-blue-200 transition-colors text-sm font-mono"[m[41m [m
[32m+[m[32m                                data-category="basic" title="Current timestamp">@{{ timestamp }}</button>[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                    </div>[m
[32m+[m
[32m+[m[32m                    {{-- Bill Month & Dates --}}[m
[32m+[m[32m                    <div class="placeholder-category">[m
[32m+[m[32m                        <h5 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">[m
[32m+[m[32m                            <i class="fas fa-calendar text-market-primary"></i>[m
[32m+[m[32m                            Dates & Period[m
[32m+[m[32m                        </h5>[m
[32m+[m[32m                        <div class="flex flex-wrap gap-2">[m
[32m+[m[32m                            <button class="placeholder-btn bg-green-50 text-green-700 px-3 py-1.5 rounded-md hover:bg-green-100 border border-green-200 transition-colors text-sm font-mono"[m[41m [m
[32m+[m[32m                                data-category="dates" title="Billing month (e.g., September 2025)">@{{ bill_month }}</button>[m
[32m+[m[32m                            <button class="placeholder-btn bg-green-50 text-green-700 px-3 py-1.5 rounded-md hover:bg-green-100 border border-green-200 transition-colors text-sm font-mono"[m[41m [m
[32m+[m[32m                                data-category="dates" title="Earliest due date">@{{ due_date }}</button>[m
[32m+[m[32m                            <button class="placeholder-btn bg-green-50 text-green-700 px-3 py-1.5 rounded-md hover:bg-green-100 border border-green-200 transition-colors text-sm font-mono"[m[41m [m
[32m+[m[32m                                data-category="dates" title="Electricity disconnection date">@{{ disconnection_date }}</button>[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                    </div>[m
[32m+[m
[32m+[m[32m                    {{-- Detailed Bill Information --}}[m
[32m+[m[32m                    <div class="placeholder-category">[m
[32m+[m[32m                        <h5 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">[m
[32m+[m[32m                            <i class="fas fa-file-invoice-dollar text-market-primary"></i>[m
[32m+[m[32m                            Detailed Bill Information[m
[32m+[m[32m                        </h5>[m
[32m+[m[32m                        <div class="flex flex-wrap gap-2">[m
[32m+[m[32m                            <button class="placeholder-btn bg-purple-50 text-purple-700 px-3 py-1.5 rounded-md hover:bg-purple-100 border border-purple-200 transition-colors text-sm font-mono"[m[41m [m
[32m+[m[32m                                data-category="details" title="Rent details with original, discounted amount, and due date">@{{ rent_details }}</button>[m
[32m+[m[32m                            <button class="placeholder-btn bg-purple-50 text-purple-700 px-3 py-1.5 rounded-md hover:bg-purple-100 border border-purple-200 transition-colors text-sm font-mono"[m[41m [m
[32m+[m[32m                                data-category="details" title="Water bill amount and due date">@{{ water_details }}</button>[m
[32m+[m[32m                            <button class="placeholder-btn bg-purple-50 text-purple-700 px-3 py-1.5 rounded-md hover:bg-purple-100 border border-purple-200 transition-colors text-sm font-mono"[m[41m [m
[32m+[m[32m                                data-category="details" title="Electricity calculation, amount, due date, and disconnection date">@{{ electricity_details }}</button>[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                    </div>[m
[32m+[m
[32m+[m[32m                    {{-- Amounts & Totals --}}[m
[32m+[m[32m                    <div class="placeholder-category">[m
[32m+[m[32m                        <h5 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">[m
[32m+[m[32m                            <i class="fas fa-money-bill-wave text-market-primary"></i>[m
[32m+[m[32m                            Amounts & Totals[m
[32m+[m[32m                        </h5>[m
[32m+[m[32m                        <div class="flex flex-wrap gap-2">[m
[32m+[m[32m                            <button class="placeholder-btn bg-yellow-50 text-yellow-700 px-3 py-1.5 rounded-md hover:bg-yellow-100 border border-yellow-200 transition-colors text-sm font-mono"[m[41m [m
[32m+[m[32m                                data-category="amounts" title="Total amount due">@{{ total_due }}</button>[m
[32m+[m[32m                            <button class="placeholder-btn bg-yellow-50 text-yellow-700 px-3 py-1.5 rounded-md hover:bg-yellow-100 border border-yellow-200 transition-colors text-sm font-mono"[m[41m [m
[32m+[m[32m                                data-category="amounts" title="New total due (with penalties)">@{{ new_total_due }}</button>[m
[32m+[m[32m                            <button class="placeholder-btn bg-yellow-50 text-yellow-700 px-3 py-1.5 rounded-md hover:bg-yellow-100 border border-yellow-200 transition-colors text-sm font-mono"[m[41m [m
[32m+[m[32m                                data-category="amounts" title="Rent amount only">@{{ rent_amount }}</button>[m
[32m+[m[32m                            <button class="placeholder-btn bg-yellow-50 text-yellow-700 px-3 py-1.5 rounded-md hover:bg-yellow-100 border border-yellow-200 transition-colors text-sm font-mono"[m[41m [m
[32m+[m[32m                                data-category="amounts" title="Water amount only">@{{ water_amount }}</button>[m
[32m+[m[32m                            <button class="placeholder-btn bg-yellow-50 text-yellow-700 px-3 py-1.5 rounded-md hover:bg-yellow-100 border border-yellow-200 transition-colors text-sm font-mono"[m[41m [m
[32m+[m[32m                                data-category="amounts" title="Electricity amount only">@{{ electricity_amount }}</button>[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                    </div>[m
[32m+[m
[32m+[m[32m                    {{-- Bill Summaries --}}[m
[32m+[m[32m                    <div class="placeholder-category">[m
[32m+[m[32m                        <h5 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">[m
[32m+[m[32m                            <i class="fas fa-list text-market-primary"></i>[m
[32m+[m[32m                            Bill Summaries[m
[32m+[m[32m                        </h5>[m
[32m+[m[32m                        <div class="flex flex-wrap gap-2">[m
[32m+[m[32m                            <button class="placeholder-btn bg-orange-50 text-orange-700 px-3 py-1.5 rounded-md hover:bg-orange-100 border border-orange-200 transition-colors text-sm font-mono"[m[41m [m
[32m+[m[32m                                data-category="summaries" title="All unpaid bills with amounts and due dates">@{{ bill_details }}</button>[m
[32m+[m[32m                            <button class="placeholder-btn bg-orange-50 text-orange-700 px-3 py-1.5 rounded-md hover:bg-orange-100 border border-orange-200 transition-colors text-sm font-mono"[m[41m [m
[32m+[m[32m                                data-category="summaries" title="Upcoming bills (not yet due)">@{{ upcoming_bill_details }}</button>[m
[32m+[m[32m                            <button class="placeholder-btn bg-orange-50 text-orange-700 px-3 py-1.5 rounded-md hover:bg-orange-100 border border-orange-200 transition-colors text-sm font-mono"[m[41m [m
[32m+[m[32m                                data-category="summaries" title="Overdue bills">@{{ overdue_bill_details }}</button>[m
[32m+[m[32m                            <button class="placeholder-btn bg-orange-50 text-orange-700 px-3 py-1.5 rounded-md hover:bg-orange-100 border border-orange-200 transition-colors text-sm font-mono"[m[41m [m
[32m+[m[32m                                data-category="summaries" title="List of unpaid utility types">@{{ unpaid_items }}</button>[m
[32m+[m[32m                            <button class="placeholder-btn bg-orange-50 text-orange-700 px-3 py-1.5 rounded-md hover:bg-orange-100 border border-orange-200 transition-colors text-sm font-mono"[m[41m [m
[32m+[m[32m                                data-category="summaries" title="List of overdue utility types">@{{ overdue_items }}</button>[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                    </div>[m
[32m+[m
[32m+[m[32m                    {{-- Links & Other --}}[m
[32m+[m[32m                    <div class="placeholder-category">[m
[32m+[m[32m                        <h5 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">[m
[32m+[m[32m                            <i class="fas fa-link text-market-primary"></i>[m
[32m+[m[32m                            Links & Other[m
[32m+[m[32m                        </h5>[m
[32m+[m[32m                        <div class="flex flex-wrap gap-2">[m
[32m+[m[32m                            <button class="placeholder-btn bg-gray-50 text-gray-700 px-3 py-1.5 rounded-md hover:bg-gray-100 border border-gray-200 transition-colors text-sm font-mono"[m[41m [m
[32m+[m[32m                                data-category="other" title="Vendor portal website URL">@{{ website_url }}</button>[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                    </div>[m
                 </div>[m
                 <div class="text-right">[m
                     <button id="saveTemplatesBtn"[m
[36m@@ -816,7 +930,7 @@[m [mclass="bg-green-500 text-white px-8 py-3 rounded-xl font-semibold hover:bg-green[m
             <div class="flex justify-between items-center mb-4">[m
                 <div>[m
                     <h3 class="text-xl font-bold text-gray-800">SMS Sending Schedule</h3>[m
[31m-                    <p class="text-gray-500">Set the time of day for automated SMS notifications (Philippine Time).</p>[m
[32m+[m[32m                    <p class="text-gray-500">Set the days and time for automated SMS notifications (Philippine Time).</p>[m
                 </div>[m
                 <div id="smsSchedulesDefaultButtons">[m
                     <button id="editSmsSchedulesBtn"[m
[36m@@ -843,6 +957,8 @@[m [mclass="bg-gray-500 hover:bg-gray-600 text-white font-bold px-5 py-2 rounded-lg t[m
                             <tr class="table-header">[m
                                 <th class="px-6 py-4 text-left text-sm font-medium uppercase tracking-wider">Notification[m
                                     Type</th>[m
[32m+[m[32m                                <th class="px-6 py-4 text-left text-sm font-medium uppercase tracking-wider">Scheduled Days[m
[32m+[m[32m                                </th>[m
                                 <th class="px-6 py-4 text-left text-sm font-medium uppercase tracking-wider">Scheduled Time[m
                                 </th>[m
                             </tr>[m
[36m@@ -865,9 +981,9 @@[m [mclass="card-table shadow-soft overflow-hidden max-h-96 overflow-y-auto">[m
                                         Time</th>[m
                                     <th class="px-6 py-4 text-left text-sm font-medium uppercase tracking-wider">Item[m
                                         Changed</th>[m
[31m-                                    <th class="px-6 py-4 text-left text-sm font-medium uppercase tracking-wider">Old Time[m
[32m+[m[32m                                    <th class="px-6 py-4 text-left text-sm font-medium uppercase tracking-wider">Old Value[m
                                     </th>[m
[31m-                                    <th class="px-6 py-4 text-left text-sm font-medium uppercase tracking-wider">New Time[m
[32m+[m[32m                                    <th class="px-6 py-4 text-left text-sm font-medium uppercase tracking-wider">New Value[m
                                     </th>[m
                                 </tr>[m
                             </thead>[m
[36m@@ -1075,50 +1191,94 @@[m [mclass="bg-gray-500 text-white px-6 py-2 rounded-xl font-medium hover:bg-gray-600[m
     <div id="announcementSection" class="dashboard-section overflow-visible">[m
         @include('layouts.partials.content-header', ['title' => 'Announcements'])[m
 [m
[31m-        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">[m
[31m-            {{-- Create Announcement Form --}}[m
[31m-            <div class="lg:col-span-1">[m
[31m-                <div class="bg-white rounded-2xl shadow-lg p-6">[m
[31m-                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Create Announcement</h3>[m
[31m-                    <form id="createAnnouncementForm">[m
[31m-                        <div class="mb-4">[m
[31m-                            <label for="announcementTitle" class="block text-gray-700 font-medium mb-2">Title *</label>[m
[31m-                            <input type="text" id="announcementTitle" required[m
[31m-                                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-market-primary focus:border-transparent"[m
[31m-                                placeholder="Enter title...">[m
[31m-                        </div>[m
[31m-                        <div class="mb-4">[m
[31m-                            <label for="announcementContent" class="block text-gray-700 font-medium mb-2">Content *</label>[m
[31m-                            <textarea id="announcementContent" required rows="6"[m
[31m-                                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-market-primary focus:border-transparent"[m
[31m-                                placeholder="Enter announcement details..."></textarea>[m
[31m-                        </div>[m
[31m-                        <div class="mb-6">[m
[31m-                            <label class="flex items-center space-x-2 cursor-pointer">[m
[31m-                                <input type="checkbox" id="announcementIsActive" checked[m
[31m-                                    class="form-checkbox h-5 w-5 text-market-primary rounded focus:ring-market-primary">[m
[31m-                                <span class="text-gray-700">Publish Immediately</span>[m
[31m-                            </label>[m
[32m+[m[32m        <div class="space-y-6">[m
[32m+[m[32m            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">[m
[32m+[m[32m                {{-- Left Column: Create Announcement Form --}}[m
[32m+[m[32m                <div>[m
[32m+[m[32m                    <div class="bg-white rounded-2xl shadow-lg p-6 h-full">[m
[32m+[m[32m                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Create Announcement</h3>[m
[32m+[m[32m                        <form id="createAnnouncementForm">[m
[32m+[m[32m                            <div class="mb-4">[m
[32m+[m[32m                                <label for="announcementTitle" class="block text-gray-700 font-medium mb-2">Title *</label>[m
[32m+[m[32m                                <input type="text" id="announcementTitle" required[m
[32m+[m[32m                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-market-primary focus:border-transparent"[m
[32m+[m[32m                                    placeholder="Enter title...">[m
[32m+[m[32m                            </div>[m
[32m+[m[32m                            <div class="mb-4">[m
[32m+[m[32m                                <label for="announcementContent" class="block text-gray-700 font-medium mb-2">Content *</label>[m
[32m+[m[32m                                <textarea id="announcementContent" required rows="8"[m
[32m+[m[32m                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-market-primary focus:border-transparent"[m
[32m+[m[32m                                    placeholder="Enter announcement details..."></textarea>[m
[32m+[m[32m                            </div>[m
[32m+[m[32m                            <div class="mb-4">[m
[32m+[m[32m                                <label class="block text-gray-700 font-medium mb-2">Recipients *</label>[m
[32m+[m[32m                                <div class="space-y-2">[m
[32m+[m[32m                                    <label class="flex items-center space-x-2 cursor-pointer">[m
[32m+[m[32m                                        <input type="checkbox" id="recipientStaff" checked[m
[32m+[m[32m                                            class="recipient-checkbox form-checkbox h-5 w-5 text-market-primary rounded focus:ring-market-primary">[m
[32m+[m[32m                                        <span class="text-gray-700">Staff</span>[m
[32m+[m[32m                                    </label>[m
[32m+[m[32m                                    <label class="flex items-center space-x-2 cursor-pointer">[m
[32m+[m[32m                                        <input type="checkbox" id="recipientAllSections" checked[m
[32m+[m[32m                                            class="recipient-checkbox form-checkbox h-5 w-5 text-market-primary rounded focus:ring-market-primary">[m
[32m+[m[32m                                        <span class="text-gray-700">All Sections</span>[m
[32m+[m[32m                                    </label>[m
[32m+[m[32m                                    <label class="flex items-center space-x-2 cursor-pointer">[m
[32m+[m[32m                                        <input type="checkbox" id="recipientWetSection"[m
[32m+[m[32m                                            class="recipient-checkbox form-checkbox h-5 w-5 text-market-primary rounded focus:ring-market-primary">[m
[32m+[m[32m                                        <span class="text-gray-700">Wet Section</span>[m
[32m+[m[32m                                    </label>[m
[32m+[m[32m                                    <label class="flex items-center space-x-2 cursor-pointer">[m
[32m+[m[32m                                        <input type="checkbox" id="recipientDrySection"[m
[32m+[m[32m                                            class="recipient-checkbox form-checkbox h-5 w-5 text-market-primary rounded focus:ring-market-primary">[m
[32m+[m[32m                                        <span class="text-gray-700">Dry Section</span>[m
[32m+[m[32m                                    </label>[m
[32m+[m[32m                                    <label class="flex items-center space-x-2 cursor-pointer">[m
[32m+[m[32m                                        <input type="checkbox" id="recipientSemiWetSection"[m
[32m+[m[32m                                            class="recipient-checkbox form-checkbox h-5 w-5 text-market-primary rounded focus:ring-market-primary">[m
[32m+[m[32m                                        <span class="text-gray-700">Semi-Wet Section</span>[m
[32m+[m[32m                                    </label>[m
[32m+[m[32m                                </div>[m
[32m+[m[32m                            </div>[m
[32m+[m[32m                            <div class="mb-4">[m
[32m+[m[32m                                <label class="flex items-center space-x-2 cursor-pointer">[m
[32m+[m[32m                                    <input type="checkbox" id="announcementIsActive" checked[m
[32m+[m[32m                                        class="form-checkbox h-5 w-5 text-market-primary rounded focus:ring-market-primary">[m
[32m+[m[32m                                    <span class="text-gray-700">Publish Immediately</span>[m
[32m+[m[32m                                </label>[m
[32m+[m[32m                            </div>[m
[32m+[m[32m                            <button type="submit" id="saveAnnouncementBtn"[m
[32m+[m[32m                                class="w-full bg-gradient-to-r from-market-primary to-market-secondary text-white py-3 rounded-xl font-medium hover:shadow-lg transition-all duration-200 flex items-center justify-center gap-2">[m
[32m+[m[32m                                <i class="fas fa-paper-plane"></i>[m
[32m+[m[32m                                <span>Post Announcement</span>[m
[32m+[m[32m                            </button>[m
[32m+[m[32m                        </form>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                </div>[m
[32m+[m
[32m+[m[32m                {{-- Right Column: Draft Announcements --}}[m
[32m+[m[32m                <div>[m
[32m+[m[32m                    <div class="bg-white rounded-2xl shadow-lg p-6 h-full">[m
[32m+[m[32m                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Draft Announcements</h3>[m
[32m+[m[32m                        <div id="draftAnnouncementsList" class="space-y-4 max-h-[calc(100vh-400px)] overflow-y-auto pr-2">[m
[32m+[m[32m                            {{-- Draft announcements will be populated by JS --}}[m
[32m+[m[32m                            <div class="text-center text-gray-500 py-8">[m
[32m+[m[32m                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>[m
[32m+[m[32m                                <p>Loading announcements...</p>[m
[32m+[m[32m                            </div>[m
                         </div>[m
[31m-                        <button type="submit" id="saveAnnouncementBtn"[m
[31m-                            class="w-full bg-gradient-to-r from-market-primary to-market-secondary text-white py-3 rounded-xl font-medium hover:shadow-lg transition-all duration-200 flex items-center justify-center gap-2">[m
[31m-                            <i class="fas fa-paper-plane"></i>[m
[31m-                            <span>Post Announcement</span>[m
[31m-                        </button>[m
[31m-                    </form>[m
[32m+[m[32m                    </div>[m
                 </div>[m
             </div>[m
 [m
[31m-            {{-- Active Announcements List --}}[m
[31m-            <div class="lg:col-span-2">[m
[31m-                <div class="bg-white rounded-2xl shadow-lg p-6">[m
[31m-                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Active Announcements</h3>[m
[31m-                    <div id="announcementsList" class="space-y-4 max-h-[600px] overflow-y-auto pr-2">[m
[31m-                        {{-- Announcements will be populated by JS --}}[m
[31m-                        <div class="text-center text-gray-500 py-8">[m
[31m-                            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>[m
[31m-                            <p>Loading announcements...</p>[m
[31m-                        </div>[m
[32m+[m[32m            {{-- Sent Announcements List - Full Width at Bottom --}}[m
[32m+[m[32m            <div class="bg-white rounded-2xl shadow-lg p-6">[m
[32m+[m[32m                <h3 class="text-xl font-semibold text-gray-800 mb-4">Sent Announcements</h3>[m
[32m+[m[32m                <div id="sentAnnouncementsList" class="space-y-4 max-h-[calc(100vh-500px)] overflow-y-auto pr-2">[m
[32m+[m[32m                    {{-- Sent announcements will be populated by JS --}}[m
[32m+[m[32m                    <div class="text-center text-gray-500 py-8">[m
[32m+[m[32m                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>[m
[32m+[m[32m                        <p>Loading announcements...</p>[m
                     </div>[m
                 </div>[m
             </div>[m
[36m@@ -1367,5 +1527,99 @@[m [mclass="flex-1 bg-gray-500 text-white py-3 rounded-lg font-medium hover:bg-gray-6[m
         </div>[m
     </div>[m
 [m
[32m+[m[32m    {{-- =================================================================== --}}[m
[32m+[m[32m    {{-- PROFILE SECTION --}}[m
[32m+[m[32m    {{-- =================================================================== --}}[m
[32m+[m[32m    <div id="profileSection" class="dashboard-section overflow-visible">[m
[32m+[m[32m        @include('layouts.partials.content-header', ['title' => 'User Profile'])[m
[32m+[m[41m        [m
[32m+[m[32m        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">[m
[32m+[m[32m            {{-- Profile Picture & Information --}}[m
[32m+[m[32m            <div class="bg-white rounded-2xl shadow-lg p-6">[m
[32m+[m[32m                {{-- Profile Picture Section --}}[m
[32m+[m[32m                <div class="mb-6 text-center">[m
[32m+[m[32m                    <div class="relative inline-block">[m
[32m+[m[32m                        <div id="profilePictureContainer" class="w-32 h-32 rounded-full overflow-hidden bg-gray-200 mx-auto mb-4 border-4 border-market-primary shadow-lg">[m
[32m+[m[32m                            @if(auth()->user()->profile_picture)[m
[32m+[m[32m                                <img id="profilePictureImg" src="{{ Storage::url(auth()->user()->profile_picture) }}"[m[41m [m
[32m+[m[32m                                     alt="Profile Picture" class="w-full h-full object-cover">[m
[32m+[m[32m                            @else[m
[32m+[m[32m                                <div id="profilePicturePlaceholder" class="w-full h-full flex items-center justify-center">[m
[32m+[m[32m                                    <i class="fas fa-user text-6xl text-gray-400"></i>[m
[32m+[m[32m                                </div>[m
[32m+[m[32m                            @endif[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                        <label for="profilePictureInput" class="absolute bottom-0 right-0 bg-market-primary text-white rounded-full p-2 cursor-pointer hover:bg-market-secondary transition-colors shadow-lg">[m
[32m+[m[32m                            <i class="fas fa-camera"></i>[m
[32m+[m[32m                            <input type="file" id="profilePictureInput" accept="image/*" class="hidden">[m
[32m+[m[32m                        </label>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                    <button id="removeProfilePictureBtn" class="text-sm text-red-600 hover:text-red-800 {{ auth()->user()->profile_picture ? '' : 'hidden' }}">[m
[32m+[m[32m                        <i class="fas fa-trash"></i> Remove Picture[m
[32m+[m[32m                    </button>[m
[32m+[m[32m                </div>[m
[32m+[m
[32m+[m[32m                <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2">[m
[32m+[m[32m                    <i class="fas fa-user text-market-primary"></i>[m
[32m+[m[32m                    Profile Information[m
[32m+[m[32m                </h3>[m
[32m+[m[32m                <div class="space-y-4">[m
[32m+[m[32m                    @php[m
[32m+[m[32m                        $user = auth()->user();[m
[32m+[m[32m                        $profileDetails = [[m
[32m+[m[32m                            ['icon' => 'fa-user', 'label' => 'Name', 'value' => $user->name],[m
[32m+[m[32m                            ['icon' => 'fa-at', 'label' => 'Username', 'value' => $user->username],[m
[32m+[m[32m                            ['icon' => 'fa-user-tag', 'label' => 'Role', 'value' => $user->role->name ?? 'N/A'],[m
[32m+[m[32m                            ['icon' => 'fa-phone', 'label' => 'Contact Number', 'value' => $user->contact_number ?? 'Not set'],[m
[32m+[m[32m                            ['icon' => 'fa-calendar', 'label' => 'Last Login', 'value' => $user->last_login ? \Carbon\Carbon::parse($user->last_login)->format('F j, Y g:i A') : 'Never'],[m
[32m+[m[32m                            ['icon' => 'fa-info-circle', 'label' => 'Status', 'value' => ucfirst($user->status ?? 'active')],[m
[32m+[m[32m                        ];[m
[32m+[m[32m                    @endphp[m
[32m+[m[32m                    @foreach ($profileDetails as $detail)[m
[32m+[m[32m                        <div class="flex items-center p-3 bg-gray-50 rounded-lg">[m
[32m+[m[32m                            <i class="fas {{ $detail['icon'] }} text-market-primary w-8 text-center"></i>[m
[32m+[m[32m                            <div class="flex-1 ml-4">[m
[32m+[m[32m                                <span class="text-sm text-gray-600">{{ $detail['label'] }}</span>[m
[32m+[m[32m                                <p class="font-semibold text-gray-800">{{ $detail['value'] }}</p>[m
[32m+[m[32m                            </div>[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                    @endforeach[m
[32m+[m[32m                </div>[m
[32m+[m[32m            </div>[m
[32m+[m
[32m+[m[32m            {{-- Change Password --}}[m
[32m+[m[32m            <div class="bg-white rounded-2xl shadow-lg p-6">[m
[32m+[m[32m                <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2">[m
[32m+[m[32m                    <i class="fas fa-key text-market-primary"></i>[m
[32m+[m[32m                    Change Password[m
[32m+[m[32m                </h3>[m
[32m+[m[32m                <form id="changePasswordForm">[m
[32m+[m[32m                    @csrf[m
[32m+[m[32m                    <div class="mb-4">[m
[32m+[m[32m                        <label for="currentPassword" class="block text-gray-700 font-medium mb-2">Current Password</label>[m
[32m+[m[32m                        <input type="password" id="currentPassword" name="current_password" required[m
[32m+[m[32m                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-market-primary focus:border-transparent">[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                    <div class="mb-4">[m
[32m+[m[32m                        <label for="newPassword" class="block text-gray-700 font-medium mb-2">New Password</label>[m
[32m+[m[32m                        <input type="password" id="newPassword" name="password" required[m
[32m+[m[32m                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-market-primary focus:border-transparent">[m
[32m+[m[32m                        <p class="text-xs text-gray-500 mt-1">Must be at least 8 characters with letters, numbers, symbols, and mixed case</p>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                    <div class="mb-6">[m
[32m+[m[32m                        <label for="confirmPassword" class="block text-gray-700 font-medium mb-2">Confirm New Password</label>[m
[32m+[m[32m                        <input type="password" id="confirmPassword" name="password_confirmation" required[m
[32m+[m[32m                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-market-primary focus:border-transparent">[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                    <button type="submit" id="changePasswordBtn"[m
[32m+[m[32m                        class="w-full bg-gradient-to-r from-market-primary to-market-secondary text-white py-3 rounded-xl font-medium hover:shadow-lg transition-all duration-200 flex items-center justify-center gap-2">[m
[32m+[m[32m                        <i class="fas fa-key"></i>[m
[32m+[m[32m                        <span>Change Password</span>[m
[32m+[m[32m                    </button>[m
[32m+[m[32m                </form>[m
[32m+[m[32m            </div>[m
[32m+[m[32m        </div>[m
[32m+[m[32m    </div>[m
[32m+[m
     <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>[m
 @endsection[m
[1mdiff --git a/resources/views/vendor_portal/vendor.blade.php b/resources/views/vendor_portal/vendor.blade.php[m
[1mindex 27de562..85a51e7 100644[m
[1m--- a/resources/views/vendor_portal/vendor.blade.php[m
[1m+++ b/resources/views/vendor_portal/vendor.blade.php[m
[36m@@ -16,8 +16,8 @@[m
 @section('navigation')[m
     <a href="#homeSection" data-section="homeSection"[m
         class="nav-link active text-black font-medium rounded-xl p-3 mb-3 hover:bg-gradient-to-r hover:from-[#9466ff] hover:to-[#4f46e5] cursor-pointer transition-smooth flex items-center space-x-3">[m
[31m-        <i class="fas fa-home"></i>[m
[31m-        <span>Home</span>[m
[32m+[m[32m        <i class="fas fa-wallet"></i>[m
[32m+[m[32m        <span>Outstanding Balance</span>[m
     </a>[m
     <a href="#profileSection" data-section="profileSection"[m
         class="nav-link text-black font-medium rounded-xl p-3 mb-3 hover:bg-gradient-to-r hover:from-[#9466ff] hover:to-[#4f46e5] cursor-pointer transition-smooth flex items-center space-x-3">[m
[36m@@ -29,6 +29,16 @@[m [mclass="nav-link text-black font-medium rounded-xl p-3 mb-3 hover:bg-gradient-to-[m
         <i class="fas fa-history"></i>[m
         <span>Payment History</span>[m
     </a>[m
[32m+[m[32m    <a href="#analyticsSection" data-section="analyticsSection"[m
[32m+[m[32m        class="nav-link text-black font-medium rounded-xl p-3 mb-3 hover:bg-gradient-to-r hover:from-[#9466ff] hover:to-[#4f46e5] cursor-pointer transition-smooth flex items-center space-x-3">[m
[32m+[m[32m        <i class="fas fa-chart-line"></i>[m
[32m+[m[32m        <span>Analytics</span>[m
[32m+[m[32m    </a>[m
[32m+[m[32m    <a href="#notificationsSection" data-section="notificationsSection"[m
[32m+[m[32m        class="nav-link text-black font-medium rounded-xl p-3 mb-3 hover:bg-gradient-to-r hover:from-[#9466ff] hover:to-[#4f46e5] cursor-pointer transition-smooth flex items-center space-x-3">[m
[32m+[m[32m        <i class="fas fa-bell"></i>[m
[32m+[m[32m        <span>Notifications</span>[m
[32m+[m[32m    </a>[m
 @endsection[m
 [m
 @section('content')[m
[36m@@ -40,10 +50,13 @@[m [mclass="nav-link text-black font-medium rounded-xl p-3 mb-3 hover:bg-gradient-to-[m
         const utilityRatesData = @json($utilityRates);[m
         const stallData = @json($stallData);[m
         const billingSettingsData = @json($billingSettings);[m
[32m+[m[32m        const paymentHistoryInitialData = @json($paymentHistoryInitial ?? ['data' => [], 'total' => 0, 'has_more' => false]);[m
     </script>[m
 [m
     <div id="toastContainer" class="fixed top-4 right-4 z-[100] space-y-2"></div>[m
 [m
[32m+[m[32m    {{-- Announcement banner removed - announcements now appear as notifications in the bell dropdown --}}[m
[32m+[m
     {{-- Success/Info Messages --}}[m
     @if (session('success'))[m
         <div class="fixed top-4 right-4 z-[100] bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg flex items-center gap-3 animate-fade-in-down"[m
[36m@@ -71,19 +84,40 @@[m [mclass="ml-4 text-white hover:text-gray-200">[m
     @endif[m
 [m
     {{-- =================================================================== --}}[m
[31m-    {{-- HOME SECTION --}}[m
[32m+[m[32m    {{-- OUTSTANDING BALANCE SECTION --}}[m
     {{-- =================================================================== --}}[m
     <div id="homeSection" class="dashboard-section active">[m
         <div id="homeContent">[m
             <div[m
[31m-                class="bg-gradient-to-r from-market-primary to-market-secondary text-white p-8 rounded-2xl mb-8 shadow-lg relative overflow-hidden">[m
[32m+[m[32m                class="bg-gradient-to-r from-market-primary to-market-secondary text-white p-8 rounded-2xl mb-8 shadow-lg relative overflow-visible">[m
                 <div[m
                     class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full transform translate-x-32 -translate-y-32">[m
                 </div>[m
                 <div class="absolute bottom-0 right-16 w-32 h-32 bg-white/10 rounded-full transform translate-y-16"></div>[m
[32m+[m[32m                <div class="flex items-center justify-between relative z-10">[m
                 <div class="flex items-center gap-2">[m
                     <i class="fa-sharp fa-solid fa-coins"></i>[m
[31m-                    <h2 class="text-3xl font-semibold relative z-10">Outstanding Balance</h2>[m
[32m+[m[32m                        <h2 class="text-3xl font-semibold">Outstanding Balance</h2>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                    {{-- Notification Bell --}}[m
[32m+[m[32m                    <div class="notificationBell relative">[m
[32m+[m[32m                        <button[m
[32m+[m[32m                            class="relative text-white hover:text-gray-200 focus:outline-none transition-transform transform hover:scale-110">[m
[32m+[m[32m                            <i class="fas fa-bell text-2xl"></i>[m
[32m+[m[32m                            <span[m
[32m+[m[32m                                class="notificationDot absolute -top-1 -right-1 block h-3 w-3 rounded-full bg-red-500 border-2 border-white hidden animate-pulse"></span>[m
[32m+[m[32m                        </button>[m
[32m+[m[32m                        {{-- Notification Dropdown Panel --}}[m
[32m+[m[32m                        <div[m
[32m+[m[32m                            class="notificationDropdown hidden absolute top-full right-0 mt-2 w-96 bg-white rounded-lg shadow-2xl border border-gray-200 z-[9999]">[m
[32m+[m[32m                            <div class="p-3 font-semibold text-gray-800 border-b">[m
[32m+[m[32m                                Notifications[m
[32m+[m[32m                            </div>[m
[32m+[m[32m                            <div class="notificationList max-h-96 overflow-y-auto">[m
[32m+[m[32m                                {{-- Notification items will be inserted here by JS --}}[m
[32m+[m[32m                            </div>[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                    </div>[m
                 </div>[m
             </div>[m
 [m
[36m@@ -226,38 +260,47 @@[m [mclass="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-[m
 [m
         <div id="profileContent">[m
             <div[m
[31m-                class="bg-gradient-to-r from-market-primary to-market-secondary text-white p-4 md:p-8 rounded-2xl mb-8 shadow-lg relative overflow-hidden">[m
[32m+[m[32m                class="bg-gradient-to-r from-market-primary to-market-secondary text-white p-4 md:p-8 rounded-2xl mb-8 shadow-lg relative overflow-visible">[m
                 <div[m
                     class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full transform translate-x-32 -translate-y-32">[m
                 </div>[m
                 <div class="absolute bottom-0 right-16 w-32 h-32 bg-white/10 rounded-full transform translate-y-16"></div>[m
[31m-                <h2 class="text-3xl font-semibold relative z-10">Hello, {{ $vendor->name }}</h2>[m
[32m+[m[32m                <div class="flex items-center justify-between relative z-10">[m
[32m+[m[32m                    <h2 class="text-3xl font-semibold">Hello, {{ $vendor->name }}</h2>[m
[32m+[m[32m                    {{-- Notification Bell --}}[m
[32m+[m[32m                    <div class="notificationBell relative">[m
[32m+[m[32m                        <button[m
[32m+[m[32m                            class="relative text-white hover:text-gray-200 focus:outline-none transition-transform transform hover:scale-110">[m
[32m+[m[32m                            <i class="fas fa-bell text-2xl"></i>[m
[32m+[m[32m                            <span[m
[32m+[m[32m                                class="notificationDot absolute -top-1 -right-1 block h-3 w-3 rounded-full bg-red-500 border-2 border-white hidden animate-pulse"></span>[m
[32m+[m[32m                        </button>[m
[32m+[m[32m                        {{-- Notification Dropdown Panel --}}[m
[32m+[m[32m                        <div[m
[32m+[m[32m                            class="notificationDropdown hidden absolute top-full right-0 mt-2 w-96 bg-white rounded-lg shadow-2xl border border-gray-200 z-[9999]">[m
[32m+[m[32m                            <div class="p-3 font-semibold text-gray-800 border-b">[m
[32m+[m[32m                                Notifications[m
[32m+[m[32m                            </div>[m
[32m+[m[32m                            <div class="notificationList max-h-96 overflow-y-auto">[m
[32m+[m[32m                                {{-- Notification items will be inserted here by JS --}}[m
[32m+[m[32m                            </div>[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                </div>[m
             </div>[m
             <div class="flex flex-col lg:flex-row gap-8 items-center">[m
                 {{-- Profile Image --}}[m
[31m-                @php[m
[31m-                    $profilePictureUrl = null;[m
[31m-                    if ($vendor->profile_picture) {[m
[31m-                        if (str_starts_with($vendor->profile_picture, 'data:')) {[m
[31m-                            // Legacy base64 data[m
[31m-                            $profilePictureUrl = $vendor->profile_picture;[m
[31m-                        } else {[m
[31m-                            // B2 path - generate temporary signed URL[m
[31m-                            $profilePictureUrl = Storage::disk('b2')->temporaryUrl([m
[31m-                                $vendor->profile_picture,[m
[31m-                                now()->addDays(7)[m
[31m-                            );[m
[31m-                        }[m
[31m-                    }[m
[31m-                @endphp[m
[31m-                <div[m
[31m-                    class="w-72 h-72 rounded-2xl shadow-inner overflow-hidden bg-gray-200 relative flex items-center justify-center flex-shrink-0">[m
[31m-                    @if($profilePictureUrl)[m
[31m-                        <img id="profileSectionImg" src="{{ $profilePictureUrl }}" alt="Profile" class="w-full h-full object-cover">[m
[31m-                    @else[m
[31m-                        <img id="profileSectionImg" src="" alt="Profile" class="w-full h-full object-cover hidden">[m
[31m-                        <i id="profileSectionIcon" class="fas fa-user-circle text-9xl text-gray-400"></i>[m
[31m-                    @endif[m
[32m+[m[32m                <div class="relative">[m
[32m+[m[32m                    <div[m
[32m+[m[32m                        class="w-72 h-72 rounded-2xl shadow-inner overflow-hidden bg-gray-200 relative flex items-center justify-center flex-shrink-0">[m
[32m+[m[32m                        @if($vendor->profile_picture)[m
[32m+[m[32m                            <img id="profileSectionImg" src="{{ Storage::url($vendor->profile_picture) }}" alt="Profile" class="w-full h-full object-cover">[m
[32m+[m[32m                            <i id="profileSectionIcon" class="fas fa-user-circle text-9xl text-gray-400 hidden"></i>[m
[32m+[m[32m                        @else[m
[32m+[m[32m                            <img id="profileSectionImg" src="" alt="Profile" class="w-full h-full object-cover hidden">[m
[32m+[m[32m                            <i id="profileSectionIcon" class="fas fa-user-circle text-9xl text-gray-400"></i>[m
[32m+[m[32m                        @endif[m
[32m+[m[32m                    </div>[m
                 </div>[m
                 {{-- Profile Details --}}[m
                 <div class="flex-1 card-gradient p-8 rounded-2xl shadow-soft">[m
[36m@@ -295,6 +338,38 @@[m [mclass="w-72 h-72 rounded-2xl shadow-inner overflow-hidden bg-gray-200 relative f[m
                     </div>[m
                 </div>[m
             </div>[m
[32m+[m
[32m+[m[32m            {{-- Change Password --}}[m
[32m+[m[32m            <div class="mt-8 bg-white rounded-2xl shadow-lg p-6">[m
[32m+[m[32m                <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2">[m
[32m+[m[32m                    <i class="fas fa-key text-market-primary"></i>[m
[32m+[m[32m                    Change Password[m
[32m+[m[32m                </h3>[m
[32m+[m[32m                <form id="changePasswordForm">[m
[32m+[m[32m                    @csrf[m
[32m+[m[32m                    <div class="mb-4">[m
[32m+[m[32m                        <label for="currentPassword" class="block text-gray-700 font-medium mb-2">Current Password</label>[m
[32m+[m[32m                        <input type="password" id="currentPassword" name="current_password" required[m
[32m+[m[32m                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-market-primary focus:border-transparent">[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                    <div class="mb-4">[m
[32m+[m[32m                        <label for="newPassword" class="block text-gray-700 font-medium mb-2">New Password</label>[m
[32m+[m[32m                        <input type="password" id="newPassword" name="password" required[m
[32m+[m[32m                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-market-primary focus:border-transparent">[m
[32m+[m[32m                        <p class="text-xs text-gray-500 mt-1">Must be at least 8 characters with letters, numbers, symbols, and mixed case</p>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                    <div class="mb-6">[m
[32m+[m[32m                        <label for="confirmPassword" class="block text-gray-700 font-medium mb-2">Confirm New Password</label>[m
[32m+[m[32m                        <input type="password" id="confirmPassword" name="password_confirmation" required[m
[32m+[m[32m                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-market-primary focus:border-transparent">[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                    <button type="submit" id="changePasswordBtn"[m
[32m+[m[32m                        class="w-full bg-gradient-to-r from-market-primary to-market-secondary text-white py-3 rounded-xl font-medium hover:shadow-lg transition-all duration-200 flex items-center justify-center gap-2">[m
[32m+[m[32m                        <i class="fas fa-key"></i>[m
[32m+[m[32m                        <span>Change Password</span>[m
[32m+[m[32m                    </button>[m
[32m+[m[32m                </form>[m
[32m+[m[32m            </div>[m
         </div>[m
     </div>[m
 [m
[36m@@ -305,12 +380,33 @@[m [mclass="w-72 h-72 rounded-2xl shadow-inner overflow-hidden bg-gray-200 relative f[m
 [m
         <div id="paymentHistoryContent">[m
             <div[m
[31m-                class="bg-gradient-to-r from-market-primary to-market-secondary text-white p-8 rounded-2xl mb-8 shadow-lg relative overflow-hidden">[m
[32m+[m[32m                class="bg-gradient-to-r from-market-primary to-market-secondary text-white p-8 rounded-2xl mb-8 shadow-lg relative overflow-visible">[m
                 <div[m
                     class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full transform translate-x-32 -translate-y-32">[m
                 </div>[m
                 <div class="absolute bottom-0 right-16 w-32 h-32 bg-white/10 rounded-full transform translate-y-16"></div>[m
[31m-                <h2 class="text-3xl font-semibold relative z-10">Payment History</h2>[m
[32m+[m[32m                <div class="flex items-center justify-between relative z-10">[m
[32m+[m[32m                    <h2 class="text-3xl font-semibold">Payment History</h2>[m
[32m+[m[32m                    {{-- Notification Bell --}}[m
[32m+[m[32m                    <div class="notificationBell relative">[m
[32m+[m[32m                        <button[m
[32m+[m[32m                            class="relative text-white hover:text-gray-200 focus:outline-none transition-transform transform hover:scale-110">[m
[32m+[m[32m                            <i class="fas fa-bell text-2xl"></i>[m
[32m+[m[32m                            <span[m
[32m+[m[32m                                class="notificationDot absolute -top-1 -right-1 block h-3 w-3 rounded-full bg-red-500 border-2 border-white hidden animate-pulse"></span>[m
[32m+[m[32m                        </button>[m
[32m+[m[32m                        {{-- Notification Dropdown Panel --}}[m
[32m+[m[32m                        <div[m
[32m+[m[32m                            class="notificationDropdown hidden absolute top-full right-0 mt-2 w-96 bg-white rounded-lg shadow-2xl border border-gray-200 z-[9999]">[m
[32m+[m[32m                            <div class="p-3 font-semibold text-gray-800 border-b">[m
[32m+[m[32m                                Notifications[m
[32m+[m[32m                            </div>[m
[32m+[m[32m                            <div class="notificationList max-h-96 overflow-y-auto">[m
[32m+[m[32m                                {{-- Notification items will be inserted here by JS --}}[m
[32m+[m[32m                            </div>[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                </div>[m
             </div>[m
             <div class="card-table p-8 rounded-2xl shadow-soft">[m
                 {{-- Filters --}}[m
[36m@@ -350,11 +446,6 @@[m [mclass="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full transform trans[m
                                 </th>[m
                                 <th class="px-6 py-4 text-center text-sm font-medium uppercase tracking-wider">DUE DATE[m
                                 </th>[m
[31m-                                <th class="px-6 py-4 text-center text-sm font-medium uppercase tracking-wider">AMOUNT AFTER[m
[31m-                                    DUE[m
[31m-                                    DATE</th>[m
[31m-                                <th class="px-6 py-4 text-center text-sm font-medium uppercase tracking-wider">[m
[31m-                                    DISCONNECTION DATE</th>[m
                                 <th class="px-6 py-4 text-center text-sm font-medium uppercase tracking-wider">PAYMENT[m
                                     STATUS[m
                                 </th>[m
[36m@@ -459,5 +550,134 @@[m [mclass="bg-white border border-black shadow-md rounded-2xl w-full max-w-5xl max-h[m
             </div>[m
         </div>[m
     </div>[m
[32m+[m
[32m+[m[32m    {{-- =================================================================== --}}[m
[32m+[m[32m    {{-- ANALYTICS SECTION --}}[m
[32m+[m[32m    {{-- =================================================================== --}}[m
[32m+[m[32m    <div id="analyticsSection" class="dashboard-section">[m
[32m+[m[32m        <div id="analyticsContent">[m
[32m+[m[32m            <div[m
[32m+[m[32m                class="bg-gradient-to-r from-market-primary to-market-secondary text-white p-8 rounded-2xl mb-8 shadow-lg relative overflow-visible">[m
[32m+[m[32m                <div[m
[32m+[m[32m                    class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full transform translate-x-32 -translate-y-32">[m
[32m+[m[32m                </div>[m
[32m+[m[32m                <div class="absolute bottom-0 right-16 w-32 h-32 bg-white/10 rounded-full transform translate-y-16"></div>[m
[32m+[m[32m                <div class="flex items-center justify-between relative z-10">[m
[32m+[m[32m                    <h2 class="text-3xl font-semibold">Analytics & Insights</h2>[m
[32m+[m[32m                    {{-- Notification Bell --}}[m
[32m+[m[32m                    <div class="notificationBell relative">[m
[32m+[m[32m                        <button[m
[32m+[m[32m                            class="relative text-white hover:text-gray-200 focus:outline-none transition-transform transform hover:scale-110">[m
[32m+[m[32m                            <i class="fas fa-bell text-2xl"></i>[m
[32m+[m[32m                            <span[m
[32m+[m[32m                                class="notificationDot absolute -top-1 -right-1 block h-3 w-3 rounded-full bg-red-500 border-2 border-white hidden animate-pulse"></span>[m
[32m+[m[32m                        </button>[m
[32m+[m[32m                        {{-- Notification Dropdown Panel --}}[m
[32m+[m[32m                        <div[m
[32m+[m[32m                            class="notificationDropdown hidden absolute top-full right-0 mt-2 w-96 bg-white rounded-lg shadow-2xl border border-gray-200 z-[9999]">[m
[32m+[m[32m                            <div class="p-3 font-semibold text-gray-800 border-b">[m
[32m+[m[32m                                Notifications[m
[32m+[m[32m                            </div>[m
[32m+[m[32m                            <div class="notificationList max-h-96 overflow-y-auto">[m
[32m+[m[32m                                {{-- Notification items will be inserted here by JS --}}[m
[32m+[m[32m                            </div>[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                </div>[m
[32m+[m[32m            </div>[m
[32m+[m
[32m+[m[32m            {{-- Electricity Consumption Chart --}}[m
[32m+[m[32m            <div class="card-table p-8 rounded-2xl shadow-soft mb-8">[m
[32m+[m[32m                <h3 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center gap-3">[m
[32m+[m[32m                    <i class="fas fa-bolt text-yellow-500"></i>[m
[32m+[m[32m                    Electricity Consumption Trend[m
[32m+[m[32m                </h3>[m
[32m+[m[32m                <div class="relative h-96">[m
[32m+[m[32m                    <canvas id="electricityConsumptionChart"></canvas>[m
[32m+[m[32m                </div>[m
[32m+[m[32m                <p class="text-sm text-gray-500 mt-4 text-center">[m
[32m+[m[32m                    <i class="fas fa-info-circle"></i>[m
[32m+[m[32m                    Shows your monthly electricity consumption in kWh over the past 12 months[m
[32m+[m[32m                </p>[m
[32m+[m[32m            </div>[m
[32m+[m
[32m+[m[32m            {{-- Payment Tracking Charts --}}[m
[32m+[m[32m            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">[m
[32m+[m[32m                {{-- Payment Status Pie Chart --}}[m
[32m+[m[32m                <div class="card-table p-8 rounded-2xl shadow-soft">[m
[32m+[m[32m                    <h3 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center gap-3">[m
[32m+[m[32m                        <i class="fas fa-chart-pie text-blue-500"></i>[m
[32m+[m[32m                        Payment Performance[m
[32m+[m[32m                    </h3>[m
[32m+[m[32m                    <div class="relative h-80">[m
[32m+[m[32m                        <canvas id="paymentStatusChart"></canvas>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                    <div id="paymentStats" class="mt-4 text-center space-y-2">[m
[32m+[m[32m                        <p class="text-sm text-gray-600">[m
[32m+[m[32m                            <span class="font-semibold text-green-600" id="onTimeCount">0</span> payments on time[m
[32m+[m[32m                        </p>[m
[32m+[m[32m                        <p class="text-sm text-gray-600">[m
[32m+[m[32m                            <span class="font-semibold text-red-600" id="lateCount">0</span> late payments[m
[32m+[m[32m                        </p>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                </div>[m
[32m+[m
[32m+[m[32m                {{-- Payment Timeline Chart --}}[m
[32m+[m[32m                <div class="card-table p-8 rounded-2xl shadow-soft">[m
[32m+[m[32m                    <h3 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center gap-3">[m
[32m+[m[32m                        <i class="fas fa-calendar-alt text-purple-500"></i>[m
[32m+[m[32m                        Payment Timeline[m
[32m+[m[32m                    </h3>[m
[32m+[m[32m                    <div class="relative h-80">[m
[32m+[m[32m                        <canvas id="paymentTimelineChart"></canvas>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                    <p class="text-sm text-gray-500 mt-4 text-center">[m
[32m+[m[32m                        <i class="fas fa-info-circle"></i>[m
[32m+[m[32m                        Monthly breakdown of on-time vs late payments[m
[32m+[m[32m                    </p>[m
[32m+[m[32m                </div>[m
[32m+[m[32m            </div>[m
[32m+[m[32m        </div>[m
[32m+[m[32m    </div>[m
[32m+[m
[32m+[m[32m    {{-- Notifications Section --}}[m
[32m+[m[32m    <div id="notificationsSection" class="dashboard-section">[m
[32m+[m[32m        <div class="bg-gradient-to-r from-market-primary to-market-secondary text-white p-4 md:p-6 rounded-2xl mb-4 shadow-lg relative overflow-hidden">[m
[32m+[m[32m            <div class="flex items-start justify-between">[m
[32m+[m[32m                <div>[m
[32m+[m[32m                    <h2 class="text-2xl md:text-3xl font-semibold">Notifications</h2>[m
[32m+[m[32m                    <p class="text-base md:text-lg mt-1">View all your notifications</p>[m
[32m+[m[32m                </div>[m
[32m+[m[32m            </div>[m
[32m+[m[32m        </div>[m
[32m+[m
[32m+[m[32m        <div class="card-table p-4 md:p-6 rounded-2xl shadow-soft">[m
[32m+[m[32m            <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4 mb-6">[m
[32m+[m[32m                <div class="flex items-center gap-4">[m
[32m+[m[32m                    <button id="markAllAsReadBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold px-4 py-2 rounded-lg transition-smooth flex items-center gap-2">[m
[32m+[m[32m                        <i class="fas fa-check-double"></i>[m
[32m+[m[32m                        <span>Mark All as Read</span>[m
[32m+[m[32m                    </button>[m
[32m+[m[32m                    <span id="unreadCountBadge" class="bg-red-500 text-white px-3 py-1 rounded-full text-sm font-semibold hidden">[m
[32m+[m[32m                        <span id="unreadCountText">0</span> unread[m
[32m+[m[32m                    </span>[m
[32m+[m[32m                </div>[m
[32m+[m[32m            </div>[m
[32m+[m
[32m+[m[32m            <div id="notificationsLoader" class="text-center py-8 text-gray-500">[m
[32m+[m[32m                <i class="fas fa-spinner fa-spin mr-2"></i>Loading notifications...[m
[32m+[m[32m            </div>[m
[32m+[m
[32m+[m[32m            <div id="notificationsList" class="space-y-3 hidden">[m
[32m+[m[32m                {{-- Notifications will be populated by JavaScript --}}[m
[32m+[m[32m            </div>[m
[32m+[m
[32m+[m[32m            <div id="noNotificationsMessage" class="text-center py-8 text-gray-500 hidden">[m
[32m+[m[32m                <i class="fas fa-bell-slash text-4xl mb-4 text-gray-400"></i>[m
[32m+[m[32m                <p class="text-lg">You have no notifications.</p>[m
[32m+[m[32m            </div>[m
[32m+[m[32m        </div>[m
[32m+[m[32m    </div>[m
[32m+[m
     <div id="toastContainer" class="fixed top-4 right-4 z-[100] space-y-2"></div>[m
 @endsection[m
[1mdiff --git a/routes/api.php b/routes/api.php[m
[1mindex cc0c229..f8ae963 100644[m
[1m--- a/routes/api.php[m
[1m+++ b/routes/api.php[m
[36m@@ -31,12 +31,14 @@[m
     Route::get('/vendors/{user}/payment-history-filtered', [StaffController::class, 'getFilteredPaymentHistory']);[m
     Route::post('/bills/{billingId}/pay', [StaffController::class, 'markAsPaid']);[m
     Route::get('/vendor/{user}/dashboard-data', [StaffController::class, 'getVendorDashboardData']);[m
[32m+[m[32m    Route::get('/vendor/{user}/analytics', [StaffController::class, 'getVendorAnalytics']);[m
     Route::get('/vendors/{user}/payment-years', [StaffController::class, 'getPaymentYears']);[m
     Route::get('/reports/monthly', [StaffController::class, 'getMonthlyReport']);[m
     Route::get('/unassigned-vendors', [StaffController::class, 'getUnassignedVendors']);[m
     Route::get('/available-stalls', [StaffController::class, 'getAvailableStalls']);[m
     Route::post('/assign-stall', [StaffController::class, 'assignStall']);[m
[31m-    Route::post('/upload-profile-picture', [StaffController::class, 'uploadProfilePicture']);[m
[32m+[m[32m    Route::post('/vendors/{vendorId}/upload-profile-picture', [StaffController::class, 'uploadVendorProfilePicture']);[m
[32m+[m[32m    Route::delete('/vendors/{vendorId}/remove-profile-picture', [StaffController::class, 'removeVendorProfilePicture']);[m
 });[m
 [m
 [m
[36m@@ -49,6 +51,7 @@[m
 Route::put('/rental-rates/{stall}', [RentalRateController::class, 'update']);[m
 Route::delete('/rental-rates/{stall}', [RentalRateController::class, 'destroy']);[m
 Route::get('/sections/{sectionName}/next-table-number', [RentalRateController::class, 'getNextTableNumber']);[m
[32m+[m[32mRoute::get('/rental-rates/history', [RentalRateController::class, 'history']);[m
 [m
 [m
 use App\Http\Controllers\Api\UtilityRateController;[m
[36m@@ -109,6 +112,13 @@[m
 Route::get('/user-settings/role-contacts', [UserSettingsController::class, 'getRoleContacts']);[m
 Route::put('/user-settings/role-contacts', [UserSettingsController::class, 'updateRoleContacts']);[m
 [m
[32m+[m[32m// Route for changing user password (authenticated users)[m
[32m+[m[32mRoute::post('/user-settings/change-password', [UserSettingsController::class, 'changePassword'])->middleware('auth:sanctum');[m
[32m+[m
[32m+[m[32m// Routes for profile picture management[m
[32m+[m[32mRoute::post('/user-settings/upload-profile-picture', [UserSettingsController::class, 'uploadProfilePicture'])->middleware('auth:sanctum');[m
[32m+[m[32mRoute::delete('/user-settings/remove-profile-picture', [UserSettingsController::class, 'removeProfilePicture'])->middleware('auth:sanctum');[m
[32m+[m
 use App\Http\Controllers\Api\AuditTrailController;[m
 [m
 // route for fetching audit trail logs[m
[36m@@ -126,6 +136,7 @@[m
     Route::get('/sections', [\App\Http\Controllers\Api\SectionController::class, 'index']);[m
 });[m
 [m
[32m+[m
 use App\Http\Controllers\Api\AnnouncementController;[m
 [m
 Route::prefix('admin/announcements')->middleware(['auth:sanctum', 'role:Admin'])->group(function () {[m
[36m@@ -133,4 +144,9 @@[m
     Route::post('/', [AnnouncementController::class, 'store']);[m
     Route::put('/{announcement}', [AnnouncementController::class, 'update']);[m
     Route::delete('/{announcement}', [AnnouncementController::class, 'destroy']);[m
[31m-});[m
\ No newline at end of file[m
[32m+[m[32m});[m
[32m+[m
[32m+[m[32m// Public endpoint for vendors and staff to fetch active announcements[m
[32m+[m[32mRoute::get('/announcements/active', [AnnouncementController::class, 'active'])->middleware('auth:sanctum');[m
[32m+[m[32mRoute::get('/announcements/all-for-user', [AnnouncementController::class, 'allForUser'])->middleware('auth:sanctum');[m
[32m+[m[32mRoute::post('/announcements/{announcement}/dismiss', [AnnouncementController::class, 'dismiss'])->middleware('auth:sanctum');[m
\ No newline at end of file[m
[1mdiff --git a/routes/console.php b/routes/console.php[m
[1mindex 843c605..d65b036 100644[m
[1m--- a/routes/console.php[m
[1m+++ b/routes/console.php[m
[36m@@ -51,9 +51,13 @@[m
     }[m
 }[m
 [m
[31m-// ðŸš€ SEND BILLING STATEMENTS: Use dynamic time, default to 08:00 if not set[m
[31m-$billingStatementTime = $smsSchedules->get('SMS - Billing Statements')?->description ?? '08:00';[m
[31m-Schedule::command('sms:send-billing-statements')->monthlyOn(1, $billingStatementTime);[m
[32m+[m[32m// ðŸš€ SEND BILLING STATEMENTS: Use dynamic day and time from database[m
[32m+[m[32m$billingStatementSchedule = $smsSchedules->get('SMS - Billing Statements');[m
[32m+[m[32m$billingStatementTime = $billingStatementSchedule?->description ?? '08:00';[m
[32m+[m[32m$billingStatementDay = $billingStatementSchedule?->schedule_day ?? 1;[m
[32m+[m[32m// Ensure day is valid (1-31)[m
[32m+[m[32m$billingStatementDay = ($billingStatementDay >= 1 && $billingStatementDay <= 31) ? $billingStatementDay : 1;[m
[32m+[m[32mSchedule::command('sms:send-billing-statements')->monthlyOn($billingStatementDay, $billingStatementTime);[m
 [m
 // â° SEND PAYMENT REMINDERS: Use dynamic time, default to 08:00 if not set[m
 $paymentReminderTime = $smsSchedules->get('SMS - Payment Reminders')?->description ?? '08:00';[m
[1mdiff --git a/routes/web.php b/routes/web.php[m
[1mindex 4c77cb3..acb071f 100644[m
[1m--- a/routes/web.php[m
[1m+++ b/routes/web.php[m
[36m@@ -16,127 +16,90 @@[m
     use App\Http\Controllers\ReportController;[m
     use App\Http\Controllers\Api\SystemUserController;[m
     use App\Http\Controllers\Api\RoleController;[m
[32m+[m[32m    use Illuminate\Support\Facades\Storage;[m
[32m+[m[32m    use Illuminate\Support\Facades\Response;[m
     //--For CRON JOBS--//[m
[31m-    use App\Console\Commands\GenerateMonthlyBills;[m
[31m-    use App\Console\Commands\SendBillingStatements;[m
[31m-    use App\Console\Commands\SendOverdueAlerts;[m
[31m-    use App\Console\Commands\SendPaymentReminders;[m
[31m-    use Illuminate\Support\Facades\Artisan;[m
[31m-[m
[31m-    Route::get('/admin/run-command/{command}', function ($command) {[m
[31m-        // Security check[m
[31m-        if (request()->input('secret') !== env('ADMIN_SECRET')) {[m
[31m-            abort(403, 'Unauthorized - Invalid secret key!');[m
[32m+[m[32m    // Secured admin command routes - moved to controller with improved security[m
[32m+[m[32m    use App\Http\Controllers\AdminCommandController;[m
[32m+[m[41m    [m
[32m+[m[32m    // Serve storage files (fallback if symbolic link doesn't exist)[m
[32m+[m[32m    Route::get('/storage/{path}', function ($path) {[m
[32m+[m[32m        $filePath = storage_path('app/public/' . $path);[m
[32m+[m[32m        if (file_exists($filePath) && is_file($filePath)) {[m
[32m+[m[32m            return Response::file($filePath);[m
         }[m
[31m-        [m
[31m-        $result = ['success' => false, 'message' => ''];[m
[31m-        [m
[31m-        try {[m
[31m-            switch ($command) {[m
[31m-                case 'billing:generate':[m
[31m-                case 'sms:send-billing-statements':[m
[31m-                case 'sms:send-overdue-alerts':[m
[31m-                case 'sms:send-payment-reminders':[m
[31m-                    Artisan::call($command);[m
[31m-                    $output = Artisan::output();[m
[31m-                    $result = [[m
[31m-                        'success' => true,[m
[31m-                        'message' => "Command '{$command}' executed successfully!",[m
[31m-                        'output' => $output[m
[31m-                    ];[m
[31m-                    break;[m
[31m-                    [m
[31m-                default:[m
[31m-                    $result = [[m
[32m+[m[32m        abort(404);[m
[32m+[m[32m    })->where('path', '.*')->name('storage.serve');[m
[32m+[m[41m    [m
[32m+[m[32m    // POST routes (secret in body, not URL) with rate limiting[m
[32m+[m[32m    Route::post('/admin/run-command/{command}', [AdminCommandController::class, 'runCommand'])[m
[32m+[m[32m        ->name('admin.run-command');[m
[32m+[m[41m    [m
[32m+[m[32m    Route::post('/admin/run-monthly-tasks', [AdminCommandController::class, 'runMonthlyTasks'])[m
[32m+[m[32m        ->name('admin.run-monthly-tasks');[m
[32m+[m[41m    [m
[32m+[m[32m    // Legacy GET routes (deprecated - will be removed in future version)[m
[32m+[m[32m    // Kept for backward compatibility but should use POST instead[m
[32m+[m[32m    Route::get('/admin/run-command/{command}', function ($command) {[m
[32m+[m[32m        \Log::warning('Deprecated GET route used for admin command', [[m
[32m+[m[32m            'command' => $command,[m
[32m+[m[32m            'ip' => request()->ip()[m
[32m+[m[32m        ]);[m
[32m+[m[32m        return response()->json([[m
                         'success' => false,[m
[31m-                        'message' => 'Unknown command: ' . $command[m
[31m-                    ];[m
[31m-            }[m
[31m-        } catch (\Exception $e) {[m
[31m-            $result = [[m
[31m-                'success' => false,[m
[31m-                'message' => 'Error: ' . $e->getMessage()[m
[31m-            ];[m
[31m-        }[m
[31m-        [m
[31m-        return response()->json($result);[m
[31m-    })->name('admin.run-command');[m
[32m+[m[32m            'message' => 'This route is deprecated. Please use POST method instead.'[m
[32m+[m[32m        ], 400);[m
[32m+[m[32m    });[m
     [m
[31m-    // Run multiple commands at once (for monthly tasks)[m
     Route::get('/admin/run-monthly-tasks', function () {[m
[31m-        // Security check[m
[31m-        if (request()->input('secret') !== env('ADMIN_SECRET')) {[m
[31m-            abort(403, 'Unauthorized - Invalid secret key!');[m
[31m-        }[m
[31m-        [m
[31m-        $results = [];[m
[31m-        [m
[31m-        try {[m
[31m-            // 1. Generate monthly bills[m
[31m-            Artisan::call('billing:generate');[m
[31m-            $results[] = [[m
[31m-                'command' => 'Generate Monthly Bills',[m
[31m-                'success' => true,[m
[31m-                'output' => Artisan::output()[m
[31m-            ];[m
[31m-            [m
[31m-            // Small delay to ensure bills are generated before sending statements[m
[31m-            sleep(2);[m
[31m-            [m
[31m-            // 2. Send billing statements[m
[31m-            Artisan::call('sms:send-billing-statements');[m
[31m-            $results[] = [[m
[31m-                'command' => 'Send Billing Statements',[m
[31m-                'success' => true,[m
[31m-                'message' => 'Statements sent',[m
[31m-                'output' => Artisan::output()[m
[31m-            ];[m
[31m-            [m
[31m-            // 3. Send overdue alerts (for existing unpaid bills)[m
[31m-            Artisan::call('sms:send-overdue-alerts');[m
[31m-            $results[] = [[m
[31m-                'command' => 'Send Overdue Alerts',[m
[31m-                'success' => true,[m
[31m-                'message' => 'Overdue alerts sent',[m
[31m-                'output' => Artisan::output()[m
[31m-            ];[m
[31m-            [m
[31m-            return response()->json([[m
[31m-                'success' => true,[m
[31m-                'message' => 'All monthly tasks completed successfully!',[m
[31m-                'results' => $results[m
[31m-            ]);[m
[31m-            [m
[31m-        } catch (\Exception $e) {[m
[32m+[m[32m        \Log::warning('Deprecated GET route used for monthly tasks', [[m
[32m+[m[32m            'ip' => request()->ip()[m
[32m+[m[32m        ]);[m
             return response()->json([[m
                 'success' => false,[m
[31m-                'message' => 'Error during monthly tasks: ' . $e->getMessage(),[m
[31m-                'results' => $results[m
[31m-            ]);[m
[31m-        }[m
[31m-    })->name('admin.run-monthly-tasks');[m
[32m+[m[32m            'message' => 'This route is deprecated. Please use POST method instead.'[m
[32m+[m[32m        ], 400);[m
[32m+[m[32m    });[m
     [m
     // Dashboard to show all available commands (optional - for convenience)[m
[32m+[m[32m    // Note: Commands should be executed via POST with secret in request body[m
     Route::get('/admin/commands-dashboard', function () {[m
         // Security check[m
         if (request()->input('secret') !== env('ADMIN_SECRET')) {[m
             abort(403, 'Unauthorized - Invalid secret key!');[m
         }[m
         [m
[31m-        $secret = request()->input('secret');[m
[31m-        $baseUrl = url('/admin/run-command');[m
[31m-        [m
         return response()->json([[m
             'message' => 'Available Commands',[m
[31m-            'commands' => [[m
[31m-                // âœ… FIX: These keys must match the 'case' statements in the route above[m
[31m-                'Run All Monthly Tasks (Recommended for Nov 1)' => url('/admin/run-monthly-tasks') . "?secret={$secret}",[m
[31m-                'Generate Monthly Bills Only' => "{$baseUrl}/billing:generate?secret={$secret}",[m
[31m-                'Send Billing Statements Only' => "{$baseUrl}/sms:send-billing-statements?secret={$secret}",[m
[31m-                'Send Overdue Alerts Only' => "{$baseUrl}/sms:send-overdue-alerts?secret={$secret}",[m
[31m-                'Send Payment Reminders' => "{$baseUrl}/sms:send-payment-reminders?secret={$secret}",[m
[32m+[m[32m            'note' => 'Use POST method to execute commands. Secret should be in request body, not URL.',[m
[32m+[m[32m            'endpoints' => [[m
[32m+[m[32m                'Run All Monthly Tasks' => [[m
[32m+[m[32m                    'method' => 'POST',[m
[32m+[m[32m                    'url' => url('/admin/run-monthly-tasks'),[m
[32m+[m[32m                    'body' => ['secret' => 'YOUR_SECRET_KEY'][m
[32m+[m[32m                ],[m
[32m+[m[32m                'Generate Monthly Bills' => [[m
[32m+[m[32m                    'method' => 'POST',[m
[32m+[m[32m                    'url' => url('/admin/run-command/billing:generate'),[m
[32m+[m[32m                    'body' => ['secret' => 'YOUR_SECRET_KEY'][m
[32m+[m[32m                ],[m
[32m+[m[32m                'Send Billing Statements' => [[m
[32m+[m[32m                    'method' => 'POST',[m
[32m+[m[32m                    'url' => url('/admin/run-command/sms:send-billing-statements'),[m
[32m+[m[32m                    'body' => ['secret' => 'YOUR_SECRET_KEY'][m
[32m+[m[32m                ],[m
[32m+[m[32m                'Send Overdue Alerts' => [[m
[32m+[m[32m                    'method' => 'POST',[m
[32m+[m[32m                    'url' => url('/admin/run-command/sms:send-overdue-alerts'),[m
[32m+[m[32m                    'body' => ['secret' => 'YOUR_SECRET_KEY'][m
[32m+[m[32m                ],[m
[32m+[m[32m                'Send Payment Reminders' => [[m
[32m+[m[32m                    'method' => 'POST',[m
[32m+[m[32m                    'url' => url('/admin/run-command/sms:send-payment-reminders'),[m
[32m+[m[32m                    'body' => ['secret' => 'YOUR_SECRET_KEY'][m
[32m+[m[32m                ],[m
             ],[m
[31m-            'note' => 'Click any URL to execute that command'[m
[32m+[m[32m            'security_note' => 'GET routes are deprecated and will return an error. Use POST with secret in request body.'[m
         ]);[m
     })->name('admin.commands-dashboard');[m
 [m
[36m@@ -176,6 +139,7 @@[m
         Route::get('/payments', [VendorController::class, 'paymentHistoryApi'])->name('api.vendor.payments');[m
         Route::get('/payment-years', [VendorController::class, 'paymentYearsApi'])->name('api.vendor.payment_years');[m
         Route::get('/dashboard-data', [VendorController::class, 'getDashboardData'])->name('api.vendor.dashboard_data');[m
[32m+[m[32m        Route::get('/analytics', [VendorController::class, 'analytics'])->name('api.vendor.analytics');[m
     });[m
 [m
     Route::get('/meter', [MeterReaderController::class, 'index'])[m
[36m@@ -223,7 +187,9 @@[m
     //In-App and SMS Notification[m
     Route::middleware(['auth'])->group(function () {[m
         Route::get('/notifications/fetch', [NotificationController::class, 'fetch'])->name('notifications.fetch');[m
[32m+[m[32m        Route::get('/notifications/fetch-all', [NotificationController::class, 'fetchAll'])->name('notifications.fetchAll');[m
         Route::post('/notifications/mark-as-read', [NotificationController::class, 'markAsRead'])->name('notifications.markAsRead');[m
[32m+[m[32m        Route::post('/notifications/{id}/mark-as-read', [NotificationController::class, 'markNotificationAsRead'])->name('notifications.markNotificationAsRead');[m
     });[m
 [m
     Route::get('/login', function () {[m
[36m@@ -249,9 +215,14 @@[m
     Route::post('reset-password', [ResetPasswordController::class, 'reset'])[m
         ->name('password.update');[m
 [m
[31m-[m
[31m-[m
[31m-[m
[32m+[m[32m    Route::get('/db-test', function () {[m
[32m+[m[32m        try {[m
[32m+[m[32m            DB::connection()->getPdo();[m
[32m+[m[32m            return "âœ… Connected to MySQL! Database: " . DB::connection()->getDatabaseName();[m
[32m+[m[32m        } catch (\Exception $e) {[m
[32m+[m[32m            return "âŒ Database connection failed: " . $e->getMessage();[m
[32m+[m[32m        }[m
[32m+[m[32m    });[m
 [m
     Route::get('/send-sms', [VendorController::class, 'sendSms']);[m
 [m
[36m@@ -259,21 +230,3 @@[m
         Route::apiResource('/system-users', SystemUserController::class);[m
         Route::get('/roles', [RoleController::class, 'index']);[m
     });[m
[31m-[m
[31m-    Route::get('/nuclear-reset', function () {[m
[31m-    // 1. Generate a fresh, valid Bcrypt hash for 'password'[m
[31m-    $newPassword = \Illuminate\Support\Facades\Hash::make('password');[m
[31m-[m
[31m-    // 2. Direct SQL Update (Bypassing User Model)[m
[31m-    $affected = \Illuminate\Support\Facades\DB::table('users')[m
[31m-        ->where('username', 'admin')[m
[31m-        ->update(['password' => $newPassword]);[m
[31m-[m
[31m-    // 3. Also reset Beyonce just in case[m
[31m-    $newBeyoncePass = \Illuminate\Support\Facades\Hash::make('D3ch@vez');[m
[31m-    \Illuminate\Support\Facades\DB::table('users')[m
[31m-        ->where('username', 'beyonce')[m
[31m-        ->update(['password' => $newBeyoncePass]);[m
[31m-[m
[31m-    return "Reset Complete. Rows affected: $affected. <br>You can now login with 'admin' / 'password' <br>or 'beyonce' / 'D3ch@vez'. <br><a href='/login'>Go to Login</a>";[m
[31m-});[m
\ No newline at end of file[m
